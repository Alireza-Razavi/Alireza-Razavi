# Report

Audit report for **2024-01-renft** generated by *ubl4nk_bot*.

## Medium Issues


*Total <b>1</b> instance over <b>1</b> issue:*

|ID|Issue|Instances|
|-|:-|:-:|
| [M-1](#M-1) | Unchecked return value of low-level `call()`/`delegatecall()` | 1 |

## Low Issues


*Total <b>194</b> instances over <b>19</b> issues:*

|ID|Issue|Instances|
|-|:-|:-:|
| [L-1](#L-1) | Missing zero address check in functions with address parameters | 43 |
| [L-2](#L-2) | Array is `push()`ed but not `pop()`ed | 3 |
| [L-3](#L-3) | Division by zero not prevented | 1 |
| [L-4](#L-4) | Consider implementing two-step procedure for updating protocol addresses | 10 |
| [L-5](#L-5) | Constructor / initialization function lacks parameter validation | 5 |
| [L-6](#L-6) | Code does not follow the best practice of check-effects-interaction | 10 |
| [L-7](#L-7) | External function calls within loops | 8 |
| [L-8](#L-8) | Governance functions should be controlled by time locks | 4 |
| [L-9](#L-9) | Loss of precision in divisions | 1 |
| [L-10](#L-10) | Missing checks for state variable assignments | 21 |
| [L-11](#L-11) | Missing zero address check in constructor | 5 |
| [L-12](#L-12) | Consider some checks for `address(0)` when setting address state variables | 13 |
| [L-13](#L-13) | Numbers downcast to `address`es may result in collisions | 1 |
| [L-14](#L-14) | Solidity version 0.8.20 or above may not work on other chains due to PUSH0 | 12 |
| [L-15](#L-15) | Unsafe downcast | 3 |
| [L-16](#L-16) | Using zero as a parameter | 2 |
| [L-17](#L-17) | Vulnerable versions of packages are being used | 1 |
| [L-18](#L-18) |  `abi.encodePacked()` should not be used with dynamic types when passing the result to a hash function such as `keccak256()` | 3 |
| [L-19](#L-19) | Centralization Risk for trusted owners | 48 |

## Non Critical Issues


*Total <b>939</b> instances over <b>78</b> issues:*

|ID|Issue|Instances|
|-|:-|:-:|
| [NC-1](#NC-1) | Assembly blocks should have extensive comments | 7 |
| [NC-2](#NC-2) | `abi.encodePacked()` should be replaced with `bytes.concat()` | 12 |
| [NC-3](#NC-3) | Add inline comments for unnamed variables | 1 |
| [NC-4](#NC-4) | Avoid the use of sensitive terms | 28 |
| [NC-5](#NC-5) | Complex casting | 1 |
| [NC-6](#NC-6) | Consider adding a block/deny-list | 17 |
| [NC-7](#NC-7) | Consider adding emergency-stop functionality | 11 |
| [NC-8](#NC-8) | Consider adding formal verification proofs | 1 |
| [NC-9](#NC-9) | Consider bounding input array length | 12 |
| [NC-10](#NC-10) | Consider using descriptive `constant`s when passing zero as a function argument | 6 |
| [NC-11](#NC-11) | Constants should be put on the left side of comparisons | 20 |
| [NC-12](#NC-12) | Variable names for `constant`s should use CONSTANT_CASE | 1 |
| [NC-13](#NC-13) | `Constructor` should emit an event | 10 |
| [NC-14](#NC-14) | Contract does not follow the Solidity Style Guide's suggested layout ordering | 18 |
| [NC-15](#NC-15) | Contract should expose an `interface` | 73 |
| [NC-16](#NC-16) | Contracts should each be defined in separate files | 8 |
| [NC-17](#NC-17) | Contracts should have full test coverage | 1 |
| [NC-18](#NC-18) | Duplicated `require()`/`revert()` checks should be refactored | 3 |
| [NC-19](#NC-19) | Empty bytes check is missing | 10 |
| [NC-20](#NC-20) | Enable IR-based code generation | 1 |
| [NC-21](#NC-21) | Enum values should be used instead of constant array indexes | 25 |
| [NC-22](#NC-22) | Events are emitted without the sender information | 7 |
| [NC-23](#NC-23) | Events may be emitted out of order due to reentrancy | 2 |
| [NC-24](#NC-24) | Execution at deadlines should be allowed | 1 |
| [NC-25](#NC-25) | External call recipient can consume all remaining gas | 1 |
| [NC-26](#NC-26) |  Function ordering does not follow the Solidity Style Guide | 38 |
| [NC-27](#NC-27) | Functions and modifiers should be named in mixedCase style | 9 |
| [NC-28](#NC-28) | Functions with array parameters should have length checks in place | 12 |
| [NC-29](#NC-29) | High cyclomatic complexity | 1 |
| [NC-30](#NC-30) | Variable names for `immutable`s should use CONSTANT_CASE | 6 |
| [NC-31](#NC-31) | Inconsistent spacing in comments | 62 |
| [NC-32](#NC-32) | Large or complicated code bases should implement invariant tests | 1 |
| [NC-33](#NC-33) | Large numeric literals should use underscores for readability | 4 |
| [NC-34](#NC-34) | Long functions should be refactored into multiple, smaller, functions | 10 |
| [NC-35](#NC-35) | Magic numbers should be replaced with constants | 24 |
| [NC-36](#NC-36) | Missing contract existence checks before low-level calls | 1 |
| [NC-37](#NC-37) | Named mappings are recommended | 9 |
| [NC-38](#NC-38) | Named imports of parent contracts are missing | 4 |
| [NC-39](#NC-39) | Missing NatSpec `@author` from contract declaration | 17 |
| [NC-40](#NC-40) | Missing NatSpec `@dev` from contract declaration | 17 |
| [NC-41](#NC-41) | Missing NatSpec `@dev` from function declaration | 70 |
| [NC-42](#NC-42) | Public variable declarations should have NatSpec descriptions | 37 |
| [NC-43](#NC-43) | Missing NatSpec `@notice` from function declaration | 70 |
| [NC-44](#NC-44) | Missing NatSpec `@notice` from modifier declaration | 5 |
| [NC-45](#NC-45) | Missing NatSpec `@param` from modifier declaration | 1 |
| [NC-46](#NC-46) | Missing NatSpec `@return` from function declaration | 20 |
| [NC-47](#NC-47) | There is no need to initialize variables with 0 | 18 |
| [NC-48](#NC-48) | Potential Re-org Attack Vector | 3 |
| [NC-49](#NC-49) | Put all system-wide constants in one file | 3 |
| [NC-50](#NC-50) | Setters should prevent re-setting the same value | 4 |
| [NC-51](#NC-51) | State variables should include comments | 14 |
| [NC-52](#NC-52) | Lines are too long | 2 |
| [NC-53](#NC-53) | Typos | 6 |
| [NC-54](#NC-54) | Unsafe solidity low-level call can cause gas grief attack | 1 |
| [NC-55](#NC-55) | Unused arguments should be removed or implemented | 2 |
| [NC-56](#NC-56) | Unused named return | 6 |
| [NC-57](#NC-57) | Unused contract variables | 2 |
| [NC-58](#NC-58) | Use `abi.encodeCall()` instead of `abi.encodeWithSignature()`/`abi.encodeWithSelector()` | 2 |
| [NC-59](#NC-59) | Consider using `delete` rather than assigning zero/false to clear values | 1 |
| [NC-60](#NC-60) | Solidity compiler version is not fixed | 12 |
| [NC-61](#NC-61) | Expressions for constant values should use `immutable` rather than `constant` | 3 |
| [NC-62](#NC-62) | Use `@inheritdoc` for overridden functions | 5 |
| [NC-63](#NC-63) | Upgrade `openzeppelin` to the latest version (`5.0.1`) | 1 |
| [NC-64](#NC-64) | Use the latest solidity version for deployment (`0.8.23`) | 12 |
| [NC-65](#NC-65) | Consider using modifiers for address control | 4 |
| [NC-66](#NC-66) | Use of `override` is unnecessary | 7 |
| [NC-67](#NC-67) | Returning a struct instead of a bunch of variables is better | 2 |
| [NC-68](#NC-68) | Use a struct to encapsulate multiple function parameters | 1 |
| [NC-69](#NC-69) | Variable names that consist of all capital letters should be reserved for `constant`/`immutable` variables | 8 |
| [NC-70](#NC-70) | Visibility of state variables is not explicitly defined | 1 |
| [NC-71](#NC-71) | Common functions should be refactored to a common base contract | 15 |
| [NC-72](#NC-72) | Empty body - Consider commenting why | 16 |
| [NC-73](#NC-73) | Names of `private`/`internal` functions should be prefixed with an underscore | 1 |
| [NC-74](#NC-74) | Names of `private`/`internal` state variables should be prefixed with an underscore | 2 |
| [NC-75](#NC-75) | Internal function calls within for loops | 5 |
| [NC-76](#NC-76) |  `require()` / `revert()` statements should have descriptive reason strings | 72 |
| [NC-77](#NC-77) | Variables should be named in mixedCase style | 8 |
| [NC-78](#NC-78) | Functions not used internally could be marked `external` | 5 |

## Gas Optimizations


*Total <b>505</b> instances over <b>42</b> issues:*

|ID|Issue|Instances|Gas|
|-|:-|:-:|:-:|
| [GAS-1](#GAS-1) | Assigning to structs can be more efficient | 22 | 132 |
| [GAS-2](#GAS-2) | Optimize gas by using do-while loops | 29 | 7395 |
| [GAS-3](#GAS-3) | Consider activating via-ir for deploying | 1 | - |
| [GAS-4](#GAS-4) | Divisions can be `unchecked` to save gas | 3 | 60 |
| [GAS-5](#GAS-5) | Do not calculate constants | 1 | - |
| [GAS-6](#GAS-6) | Duplicated `require()`/`revert()` checks should be refactored to a modifier or function to save gas | 3 | - |
| [GAS-7](#GAS-7) | Increments can be `unchecked` to save gas | 29 | 1740 |
| [GAS-8](#GAS-8) | Inline `modifier`s that are only used once, to save gas | 1 | - |
| [GAS-9](#GAS-9) | `internal` functions only called once can be inlined to save gas | 29 | 870 |
| [GAS-10](#GAS-10) | Low level `call` can be optimized with assembly | 1 | 248 |
| [GAS-11](#GAS-11) | Multiple accesses of the same mapping/array key/index should be cached | 11 | 462 |
| [GAS-12](#GAS-12) | Newer versions of solidity are more gas efficient | 12 | - |
| [GAS-13](#GAS-13) | Operator `>=`/`<=` costs less gas than operator `>`/`<` | 39 | 117 |
| [GAS-14](#GAS-14) | Optimize Gas by splitting `if() revert` statements | 5 | - |
| [GAS-15](#GAS-15) | Optimize names to save gas | 9 | 198 |
| [GAS-16](#GAS-16) | Redundant state variable getters | 1 | - |
| [GAS-17](#GAS-17) | Remove or replace unused state variables | 2 | - |
| [GAS-18](#GAS-18) | The result of a function call should be cached rather than re-calling the function | 8 | 800 |
| [GAS-19](#GAS-19) | State variables access within a loop | 3 | 795 |
| [GAS-20](#GAS-20) | Unlimited gas consumption risk due to external call recipients | 1 | - |
| [GAS-21](#GAS-21) | Unused named return variables without optimizer waste gas | 6 | 54 |
| [GAS-22](#GAS-22) | Optimize external calls with assembly for memory efficiency | 33 | 7260 |
| [GAS-23](#GAS-23) | Use assembly to compute hashes to save gas | 22 | 1760 |
| [GAS-24](#GAS-24) | Use assembly to emit events | 7 | 266 |
| [GAS-25](#GAS-25) | Use assembly to validate `msg.sender` | 4 | - |
| [GAS-26](#GAS-26) | Use assembly to write address/contract type storage values | 22 | 1100 |
| [GAS-27](#GAS-27) | Using a double `if` statement instead of a logical AND (`&&`) | 6 | 180 |
| [GAS-28](#GAS-28) | Use a more recent version of solidity | 12 | - |
| [GAS-29](#GAS-29) | Use `storage` instead of `memory` for structs/arrays | 12 | 50400 |
| [GAS-30](#GAS-30) | Use `uint256(1)`/`uint256(2)` instead of `true`/`false` to save gas for changes | 8 | 68400 |
| [GAS-31](#GAS-31) | Using bitmap to store bool states can save gas | 7 | - |
| [GAS-32](#GAS-32) | `abi.encodePacked` is more gas efficient than `abi.encode` | 9 | - |
| [GAS-33](#GAS-33) | Using bools for storage incurs overhead | 8 | 800 |
| [GAS-34](#GAS-34) | Cache array length outside of loop | 21 | - |
| [GAS-35](#GAS-35) | State variables should be cached in stack variables rather than re-reading them from storage | 3 | 291 |
| [GAS-36](#GAS-36) | Use `calldata` instead of `memory` for function arguments that do not get mutated | 8 | - |
| [GAS-37](#GAS-37) | Don't initialize variables with default value | 18 | - |
| [GAS-38](#GAS-38) | Usage of `int`s/`uint`s smaller than 32 bytes incurs overhead | 23 | 1265 |
| [GAS-39](#GAS-39) | Constructors can be marked as `payable` to save deployment gas | 12 | 252 |
| [GAS-40](#GAS-40) | Functions guaranteed to revert when called by normal users can be marked `payable` | 21 | 441 |
| [GAS-41](#GAS-41) | Using assembly to check for zero can save gas | 24 | 144 |
| [GAS-42](#GAS-42) | `internal` functions not called by the contract should be removed | 9 | - |

## Medium Issues

<a name="M-1"></a> 
### [M-1] Unchecked return value of low-level `call()`/`delegatecall()`
The function being called may revert, which will be indicated by the return value to `call()`/`delegatecall()`. If the return value is not checked, the code will continue on as if there was no error, rather than reverting with the error encountered.

*There is one instance of this issue:*
```solidity
File: src/modules/PaymentEscrow.sol

/// @audit `success` is not checked
102:         (bool success, bytes memory data) = token.call(

```



## Low Issues

<a name="L-1"></a> 
### [L-1] Missing zero address check in functions with address parameters
Adding a zero address check for each address type parameter can prevent errors.

<details>
<summary>
There are <b>43</b> instances (click to show):
</summary>

```solidity
File: src/Create2Deployer.sol

/// @audit missing zero check for `sender`
107:     function generateSaltWithSender(
             address sender,
             bytes12 data
         ) public pure returns (bytes32 salt) {

```

```solidity
File: src/Kernel.sol

/// @audit missing zero check for `newKernel_`
54:     function changeKernel(Kernel newKernel_) external onlyKernel {

/// @audit missing zero check for `addr_`
310:     function grantRole(Role role_, address addr_) public onlyAdmin {

/// @audit missing zero check for `addr_`
333:     function revokeRole(Role role_, address addr_) public onlyAdmin {

/// @audit missing zero check for `newModule_`
356:     function _installModule(Module newModule_) internal {

/// @audit missing zero check for `newModule_`
383:     function _upgradeModule(Module newModule_) internal {

/// @audit missing zero check for `policy_`
560:     function _setPolicyPermissions(
             Policy policy_,
             Permissions[] memory requests_,
             bool grant_
         ) internal {

/// @audit missing zero check for `policy_`
586:     function _pruneFromDependents(Policy policy_) internal {

```

```solidity
File: src/modules/PaymentEscrow.sol

/// @audit missing zero check for `kernel_`
58:     function MODULE_PROXY_INSTANTIATION(
            Kernel kernel_
        ) external onlyByProxy onlyUninitialized {

/// @audit missing zero check for `token`
/// @audit missing zero check for `to`
100:     function _safeTransfer(address token, address to, uint256 value) internal {

/// @audit missing zero check for `token`
/// @audit missing zero check for `lender`
/// @audit missing zero check for `renter`
159:     function _settlePaymentProRata(
             address token,
             uint256 amount,
             address lender,
             address renter,
             uint256 elapsedTime,
             uint256 totalTime
         ) internal {

/// @audit missing zero check for `token`
/// @audit missing zero check for `lender`
/// @audit missing zero check for `renter`
190:     function _settlePaymentInFull(
             address token,
             uint256 amount,
             SettleTo settleTo,
             address lender,
             address renter
         ) internal {

/// @audit missing zero check for `lender`
/// @audit missing zero check for `renter`
215:     function _settlePayment(
             Item[] calldata items,
             OrderType orderType,
             address lender,
             address renter,
             uint256 start,
             uint256 end
         ) internal {

/// @audit missing zero check for `token`
292:     function _decreaseDeposit(address token, uint256 amount) internal {

/// @audit missing zero check for `token`
304:     function _increaseDeposit(address token, uint256 amount) internal {

/// @audit missing zero check for `token`
361:     function increaseDeposit(
             address token,
             uint256 amount
         ) external onlyByProxy permissioned {

/// @audit missing zero check for `to`
397:     function skim(address token, address to) external onlyByProxy permissioned {

```

```solidity
File: src/modules/Storage.sol

/// @audit missing zero check for `kernel_`
86:     function MODULE_PROXY_INSTANTIATION(
            Kernel kernel_
        ) external onlyByProxy onlyUninitialized {

/// @audit missing zero check for `recipient`
/// @audit missing zero check for `token`
118:     function isRentedOut(
             address recipient,
             address token,
             uint256 identifier
         ) external view returns (bool) {

/// @audit missing zero check for `to`
135:     function contractToHook(address to) external view returns (address) {

/// @audit missing zero check for `hook`
149:     function hookOnTransaction(address hook) external view returns (bool) {

/// @audit missing zero check for `hook`
159:     function hookOnStart(address hook) external view returns (bool) {

/// @audit missing zero check for `hook`
169:     function hookOnStop(address hook) external view returns (bool) {

/// @audit missing zero check for `safe`
274:     function addRentalSafe(address safe) external onlyByProxy permissioned {

/// @audit missing zero check for `delegate`
334:     function toggleWhitelistDelegate(
             address delegate,
             bool isEnabled
         ) external onlyByProxy permissioned {

/// @audit missing zero check for `extension`
347:     function toggleWhitelistExtension(
             address extension,
             bool isEnabled
         ) external onlyByProxy permissioned {

```

```solidity
File: src/packages/Reclaimer.sol

/// @audit missing zero check for `recipient`
32:     function _transferERC721(Item memory item, address recipient) private {

/// @audit missing zero check for `recipient`
42:     function _transferERC1155(Item memory item, address recipient) private {

```

```solidity
File: src/packages/Signer.sol

/// @audit missing zero check for `intendedFulfiller`
/// @audit missing zero check for `actualFulfiller`
76:     function _validateFulfiller(
            address intendedFulfiller,
            address actualFulfiller
        ) internal pure {

```

```solidity
File: src/policies/Admin.sol

/// @audit missing zero check for `delegate`
99:     function toggleWhitelistDelegate(
            address delegate,
            bool isEnabled
        ) external onlyRole("ADMIN_ADMIN") {

/// @audit missing zero check for `extension`
113:     function toggleWhitelistExtension(
             address extension,
             bool isEnabled
         ) external onlyRole("ADMIN_ADMIN") {

/// @audit missing zero check for `token`
/// @audit missing zero check for `to`
164:     function skim(address token, address to) external onlyRole("ADMIN_ADMIN") {

```

```solidity
File: src/policies/Create.sol

/// @audit missing zero check for `rentalWallet`
464:     function _addHooks(
             Hook[] memory hooks,
             SpentItem[] memory offerItems,
             address rentalWallet
         ) internal {

/// @audit missing zero check for `expectedRecipient`
666:     function _checkExpectedRecipient(
             ReceivedItem memory execution,
             address expectedRecipient
         ) internal pure {

/// @audit missing zero check for `expectedRentalSafe`
691:     function _executionInvariantChecks(
             ReceivedItem[] memory executions,
             address expectedRentalSafe
         ) internal view {

```

```solidity
File: src/policies/Guard.sol

/// @audit missing zero check for `safe`
/// @audit missing zero check for `token`
126:     function _revertSelectorOnActiveRental(
             bytes4 selector,
             address safe,
             address token,
             uint256 tokenId
         ) private view {

/// @audit missing zero check for `safe`
/// @audit missing zero check for `to`
159:     function _forwardToHook(
             address hook,
             address safe,
             address to,
             uint256 value,
             bytes memory data
         ) private {

/// @audit missing zero check for `from`
/// @audit missing zero check for `to`
195:     function _checkTransaction(address from, address to, bytes memory data) private view {

/// @audit missing zero check for `to`
/// @audit missing zero check for `hook`
362:     function updateHookPath(address to, address hook) external onlyRole("GUARD_ADMIN") {

/// @audit missing zero check for `hook`
373:     function updateHookStatus(
             address hook,
             uint8 bitmap
         ) external onlyRole("GUARD_ADMIN") {

```

```solidity
File: src/policies/Stop.sol

/// @audit missing zero check for `stopper`
111:     function _emitRentalOrderStopped(bytes32 seaportOrderHash, address stopper) internal {

/// @audit missing zero check for `expectedLender`
126:     function _validateRentalCanBeStoped(
             OrderType orderType,
             uint256 endTimestamp,
             address expectedLender
         ) internal view {

/// @audit missing zero check for `rentalWallet`
194:     function _removeHooks(
             Hook[] calldata hooks,
             Item[] calldata rentalItems,
             address rentalWallet
         ) internal {

```

</details>


<a name="L-2"></a> 
### [L-2] Array is `push()`ed but not `pop()`ed
There is no limit specified on the amount of gas used, so the recipient can use up all of the remaining gas (`gasleft()`), causing it to revert. Therefore, when calling an external contract, it is necessary to specify a limited amount of gas to forward.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/Kernel.sol

372:         allKeycodes.push(keycode);

428:         activePolicies.push(policy_);

442:             moduleDependents[keycode].push(policy_);

```


<a name="L-3"></a> 
### [L-3] Division by zero not prevented
The divisions below take an input parameter that has no zero-value checks, which can cause the functions reverting if zero is passed.

*There is one instance of this issue:*
```solidity
File: src/modules/PaymentEscrow.sol

/// @audit `totalTime`
142:         renterAmount = ((numerator / totalTime) + 500) / 1000;

```


<a name="L-4"></a> 
### [L-4] Consider implementing two-step procedure for updating protocol addresses
A copy-paste error or a typo may end up bricking protocol functionality, or sending tokens to an address with no known private key. Consider implementing a two-step procedure for updating protocol addresses, where the recipient is set as pending, and must "accept" the assignment by making an affirmative call. A straight forward way of doing this would be to have the target contracts implement [EIP-165](https://eips.ethereum.org/EIPS/eip-165), and to have the "set" functions ensure that the recipient is of the right interface type.

*There are <b>10</b> instances of this issue:*
```solidity
File: src/Kernel.sol

/// @audit `kernel`
54:     function changeKernel(Kernel newKernel_) external onlyKernel {

/// @audit `admin`
/// @audit `executor`
277:     function executeAction(Actions action_, address target_) external onlyExecutor {

```

```solidity
File: src/modules/PaymentEscrow.sol

/// @audit `kernel`
58:     function MODULE_PROXY_INSTANTIATION(
            Kernel kernel_
        ) external onlyByProxy onlyUninitialized {

```

```solidity
File: src/modules/Storage.sol

/// @audit `kernel`
86:     function MODULE_PROXY_INSTANTIATION(
            Kernel kernel_
        ) external onlyByProxy onlyUninitialized {

/// @audit `_contractToHook`
294:     function updateHookPath(address to, address hook) external onlyByProxy permissioned {

```

```solidity
File: src/policies/Admin.sol

/// @audit `STORE`
/// @audit `ESCRW`
40:     function configureDependencies()
            external
            override
            onlyKernel
            returns (Keycode[] memory dependencies)
        {

```

```solidity
File: src/policies/Create.sol

/// @audit `STORE`
/// @audit `ESCRW`
72:     function configureDependencies()
            external
            override
            onlyKernel
            returns (Keycode[] memory dependencies)
        {

```

```solidity
File: src/policies/Factory.sol

/// @audit `STORE`
73:     function configureDependencies()
            external
            override
            onlyKernel
            returns (Keycode[] memory dependencies)
        {

```

```solidity
File: src/policies/Guard.sol

/// @audit `STORE`
63:     function configureDependencies()
            external
            override
            onlyKernel
            returns (Keycode[] memory dependencies)
        {

```

```solidity
File: src/policies/Stop.sol

/// @audit `STORE`
/// @audit `ESCRW`
63:     function configureDependencies()
            external
            override
            onlyKernel
            returns (Keycode[] memory dependencies)
        {

```


<a name="L-5"></a> 
### [L-5] Constructor / initialization function lacks parameter validation
Constructors and initialization functions play a critical role in contracts by setting important initial states when the contract is first deployed before the system starts. The parameters passed to the constructor and initialization functions directly affect the behavior of the contract / protocol. If incorrect parameters are provided, the system may fail to run, behave abnormally, be unstable, or lack security. Therefore, it's crucial to carefully check each parameter in the constructor and initialization functions. If an exception is found, the transaction should be rolled back.

*There are <b>5</b> instances of this issue:*
```solidity
File: src/Kernel.sol

/// @audit `kernel_` not validated
33:     constructor(Kernel kernel_) {

/// @audit `kernel_` not validated
71:     constructor(Kernel kernel_) KernelAdapter(kernel_) {}

/// @audit `kernel_` not validated
124:     constructor(Kernel kernel_) KernelAdapter(kernel_) {}

/// @audit `_executor` not validated
/// @audit `_admin` not validated
242:     constructor(address _executor, address _admin) {

```

```solidity
File: src/policies/Factory.sol

/// @audit `stopPolicy_` not validated
/// @audit `guardPolicy_` not validated
/// @audit `fallbackHandler_` not validated
/// @audit `safeProxyFactory_` not validated
/// @audit `safeSingleton_` not validated
49:     constructor(

```


<a name="L-6"></a> 
### [L-6] Code does not follow the best practice of check-effects-interaction
Code should follow the best-practice of [check-effects-interaction](https://blockchain-academy.hs-mittweida.de/courses/solidity-coding-beginners-to-intermediate/lessons/solidity-11-coding-patterns/topic/checks-effects-interactions/), where state variables are updated before any external calls are made. Doing so prevents a large class of reentrancy bugs.

*There are <b>10</b> instances of this issue:*
```solidity
File: src/Kernel.sol

/// @audit `.KEYCODE(...)` is called on line 358
366:         getModuleForKeycode[keycode] = newModule_;

/// @audit `.KEYCODE(...)` is called on line 358
369:         getKeycodeForModule[newModule_] = keycode;

/// @audit `.KEYCODE(...)` is called on line 385
397:         getKeycodeForModule[oldModule] = Keycode.wrap(bytes5(0));

/// @audit `.KEYCODE(...)` is called on line 385
400:         getKeycodeForModule[newModule_] = keycode;

/// @audit `.KEYCODE(...)` is called on line 385
403:         getModuleForKeycode[keycode] = newModule_;

/// @audit `.isActive(...)` is called on line 420
/// @audit `.requestPermissions(...)` is called on line 424
431:         getPolicyIndex[policy_] = activePolicies.length - 1;

/// @audit `.isActive(...)` is called on line 420
/// @audit `.requestPermissions(...)` is called on line 424
/// @audit `.configureDependencies(...)` is called on line 434
445:             getDependentIndex[keycode][policy_] = moduleDependents[keycode].length - 1;

/// @audit `.isActive(...)` is called on line 458
/// @audit `.requestPermissions(...)` is called on line 462
472:         activePolicies[idx] = lastPolicy;

/// @audit `.isActive(...)` is called on line 458
/// @audit `.requestPermissions(...)` is called on line 462
479:         getPolicyIndex[lastPolicy] = idx;

/// @audit `.configureDependencies(...)` is called on line 588
611:             getDependentIndex[keycode][lastPolicy] = origIndex;

```


<a name="L-7"></a> 
### [L-7] External function calls within loops
Calling external functions within loops can easily result in insufficient gas. This greatly increases the likelihood of transaction failures, DOS attacks, and other unexpected actions. It is recommended to limit the number of loops within loops that call external functions, and to limit the gas line for each external call.

*There are <b>8</b> instances of this issue:*
```solidity
File: src/Kernel.sol

/// @audit `.changeKernel(...)`
516:             module.changeKernel(newKernel_);

/// @audit `.setActiveStatus(...)`
526:             policy.setActiveStatus(false);

/// @audit `.changeKernel(...)`
529:             policy.changeKernel(newKernel_);

```

```solidity
File: src/policies/Create.sol

/// @audit `.hookOnStart(...)`
480:             if (!STORE.hookOnStart(target)) {

/// @audit `.onStart(...)`
497:                 IHook(target).onStart(

/// @audit `.increaseDeposit(...)`
601:                     ESCRW.increaseDeposit(items[i].token, items[i].amount);

```

```solidity
File: src/policies/Stop.sol

/// @audit `.hookOnStop(...)`
210:             if (!STORE.hookOnStop(target)) {

/// @audit `.onStop(...)`
227:                 IHook(target).onStop(

```


<a name="L-8"></a> 
### [L-8] Governance functions should be controlled by time locks
Governance functions (such as upgrading contracts, setting critical parameters) should be controlled using time locks to introduce a delay between a proposal and its execution. This gives users time to exit before a potentially dangerous or malicious operation is applied.

*There are <b>4</b> instances of this issue:*
```solidity
File: src/Kernel.sol

192:     function setActiveStatus(bool activate_) external onlyKernel {

```

```solidity
File: src/modules/PaymentEscrow.sol

380:     function setFee(uint256 feeNumerator) external onlyByProxy permissioned {

```

```solidity
File: src/modules/Storage.sol

274:     function addRentalSafe(address safe) external onlyByProxy permissioned {

```

```solidity
File: src/policies/Admin.sol

173:     function setFee(uint256 feeNumerator) external onlyRole("ADMIN_ADMIN") {

```


<a name="L-9"></a> 
### [L-9] Loss of precision in divisions
Division by large numbers may result in the result being zero, due to solidity not supporting fractions. Consider requiring a minimum amount for the numerator to ensure that it is always larger than the denominator.

*There is one instance of this issue:*
```solidity
File: src/modules/PaymentEscrow.sol

138:         uint256 numerator = (amount * elapsedTime) * 1000;

```


<a name="L-10"></a> 
### [L-10] Missing checks for state variable assignments
There are some missing checks in these functions, and this could lead to unexpected scenarios. Consider always adding a sanity check for state variables.

<details>
<summary>
There are <b>21</b> instances (click to show):
</summary>

```solidity
File: src/Kernel.sol

/// @audit `kernel_`
34:         kernel = kernel_;

/// @audit `newKernel_`
55:         kernel = newKernel_;

/// @audit `activate_`
193:         isActive = activate_;

/// @audit `_executor`
243:         executor = _executor;

/// @audit `_admin`
244:         admin = _admin;

/// @audit `target_`
296:             executor = target_;

/// @audit `target_`
298:             admin = target_;

/// @audit `newModule_`
366:         getModuleForKeycode[keycode] = newModule_;

/// @audit `newModule_`
403:         getModuleForKeycode[keycode] = newModule_;

```

```solidity
File: src/modules/PaymentEscrow.sol

/// @audit `kernel_`
61:         kernel = kernel_;

/// @audit `feeNumerator`
387:         fee = feeNumerator;

```

```solidity
File: src/modules/Storage.sol

/// @audit `kernel_`
89:         kernel = kernel_;

/// @audit `hook`
302:         _contractToHook[to] = hook;

/// @audit `bitmap`
325:         hookStatus[hook] = bitmap;

/// @audit `isEnabled`
338:         whitelistedDelegates[delegate] = isEnabled;

/// @audit `isEnabled`
351:         whitelistedExtensions[extension] = isEnabled;

```

```solidity
File: src/policies/Factory.sol

/// @audit `stopPolicy_`
57:         stopPolicy = stopPolicy_;

/// @audit `guardPolicy_`
58:         guardPolicy = guardPolicy_;

/// @audit `fallbackHandler_`
59:         fallbackHandler = fallbackHandler_;

/// @audit `safeProxyFactory_`
60:         safeProxyFactory = safeProxyFactory_;

/// @audit `safeSingleton_`
61:         safeSingleton = safeSingleton_;

```

</details>


<a name="L-11"></a> 
### [L-11] Missing zero address check in constructor
Constructors often take address parameters to initialize important components of a contract, such as owner or linked contracts. However, without a checking, there's a risk that an address parameter could be mistakenly set to the zero address (0x0). This could be due to an error or oversight during contract deployment. A zero address in a crucial role can cause serious issues, as it cannot perform actions like a normal address, and any funds sent to it will be irretrievable. It's therefore crucial to include a zero address check in constructors to prevent such potential problems. If a zero address is detected, the constructor should revert the transaction.

*There are <b>5</b> instances of this issue:*
```solidity
File: src/Kernel.sol

/// @audit missing zero check for `kernel_`
33:     constructor(Kernel kernel_) {

/// @audit missing zero check for `kernel_`
71:     constructor(Kernel kernel_) KernelAdapter(kernel_) {}

/// @audit missing zero check for `kernel_`
124:     constructor(Kernel kernel_) KernelAdapter(kernel_) {}

/// @audit missing zero check for `_executor`
/// @audit missing zero check for `_admin`
242:     constructor(address _executor, address _admin) {

```

```solidity
File: src/policies/Factory.sol

/// @audit missing zero check for `stopPolicy_`
/// @audit missing zero check for `guardPolicy_`
/// @audit missing zero check for `fallbackHandler_`
/// @audit missing zero check for `safeProxyFactory_`
/// @audit missing zero check for `safeSingleton_`
49:     constructor(
            Kernel kernel_,
            Stop stopPolicy_,
            Guard guardPolicy_,
            TokenCallbackHandler fallbackHandler_,
            SafeProxyFactory safeProxyFactory_,
            SafeL2 safeSingleton_
        ) Policy(kernel_) {

```


<a name="L-12"></a> 
### [L-12] Consider some checks for `address(0)` when setting address state variables
Check for zero-address to avoid the risk of setting `address(0)` for state variables after an update.

<details>
<summary>
There are <b>13</b> instances (click to show):
</summary>

```solidity
File: src/Kernel.sol

/// @audit `kernel_`
34:         kernel = kernel_;

/// @audit `newKernel_`
55:         kernel = newKernel_;

/// @audit `_executor`
243:         executor = _executor;

/// @audit `_admin`
244:         admin = _admin;

/// @audit `target_`
296:             executor = target_;

/// @audit `target_`
298:             admin = target_;

```

```solidity
File: src/modules/PaymentEscrow.sol

/// @audit `kernel_`
61:         kernel = kernel_;

```

```solidity
File: src/modules/Storage.sol

/// @audit `kernel_`
89:         kernel = kernel_;

```

```solidity
File: src/policies/Factory.sol

/// @audit `stopPolicy_`
57:         stopPolicy = stopPolicy_;

/// @audit `guardPolicy_`
58:         guardPolicy = guardPolicy_;

/// @audit `fallbackHandler_`
59:         fallbackHandler = fallbackHandler_;

/// @audit `safeProxyFactory_`
60:         safeProxyFactory = safeProxyFactory_;

/// @audit `safeSingleton_`
61:         safeSingleton = safeSingleton_;

```

</details>


<a name="L-13"></a> 
### [L-13] Numbers downcast to `address`es may result in collisions
If a number is downcast to an `address` the upper bytes are truncated, which may mean that more than one value will map to the `address`.

*There is one instance of this issue:*
```solidity
File: src/Create2Deployer.sol

94:         return address(uint160(uint256(addressHash)));

```


<a name="L-14"></a> 
### [L-14] Solidity version 0.8.20 or above may not work on other chains due to PUSH0
Solidity version 0.8.20 or above uses the new [Shanghai EVM](https://blog.soliditylang.org/2023/05/10/solidity-0.8.20-release-announcement/#important-note) which introduces the PUSH0 opcode. This op code may not yet be implemented on all evm-chains or Layer2s, so deployment on these chains will fail. Consider using an earlier solidity version.

<details>
<summary>
There are <b>12</b> instances (click to show):
</summary>

```solidity
File: src/Create2Deployer.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/Kernel.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/modules/PaymentEscrow.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/modules/Storage.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/packages/Accumulator.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/packages/Reclaimer.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/packages/Signer.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/policies/Admin.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/policies/Create.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/policies/Factory.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/policies/Guard.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/policies/Stop.sol

2: pragma solidity ^0.8.20;

```

</details>


<a name="L-15"></a> 
### [L-15] Unsafe downcast
When a type is downcast to a smaller type, the higher order bits are truncated, effectively applying a modulo to the original value. Without any other checks, this wrapping will lead to unexpected behavior and bugs.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/Create2Deployer.sol

/// @audit uint256 -> uint160
94:         return address(uint160(uint256(addressHash)));

```

```solidity
File: src/policies/Guard.sol

/// @audit uint256 -> uint160
246:                 uint160(

/// @audit uint256 -> uint160
258:                 uint160(

```


<a name="L-16"></a> 
### [L-16] Using zero as a parameter
Taking `0` as a valid argument in Solidity without checks can lead to severe security issues. A historical example is the infamous `0x0` address bug where numerous tokens were lost. This happens because 0 can be interpreted as an uninitialized `address`, leading to transfers to the 0x0 address, effectively burning tokens. Moreover, `0` as a denominator in division operations would cause a runtime exception. It's also often indicative of a logical error in the caller's code. It's important to always validate input and handle edge cases like `0` appropriately. Use `require()` statements to enforce conditions and provide clear error messages to facilitate debugging and safer code.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/policies/Create.sol

422:             _processBaseOrderOffer(items, offers, 0);

430:             _processPayOrderOffer(items, offers, 0);

```


<a name="L-17"></a> 
### [L-17] Vulnerable versions of packages are being used
This project is using specific package versions which are vulnerable to the specific CVEs listed below. Consider switching to more recent versions of these packages that don't have these vulnerabilities.
- [CVE-2023-40014](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-40014) - **MEDIUM** - (`openzeppelin-solidity >=4.0.0 <4.9.3`): OpenZeppelin Contracts is a library for secure smart contract development. Starting in version 4.0.0 and prior to version 4.9.3, contracts using `ERC2771Context` along with a custom trusted forwarder may see `_msgSender` return `address(0)` in calls that originate from the forwarder with calldata shorter than 20 bytes. This combination of circumstances does not appear to be common, in particular it is not the case for `MinimalForwarder` from OpenZeppelin Contracts, or any deployed forwarder the team is aware of, given that the signer address is appended to all calls that originate from these forwarders. The problem has been patched in v4.9.3.

- [CVE-2023-34459](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-34459) - **MEDIUM** - (`openzeppelin-solidity >=4.7.0 <4.9.2`): OpenZeppelin Contracts is a library for smart contract development. Starting in version 4.7.0 and prior to version 4.9.2, when the `verifyMultiProof`, `verifyMultiProofCalldata`, `procesprocessMultiProof`, or `processMultiProofCalldat` functions are in use, it is possible to construct merkle trees that allow forging a valid multiproof for an arbitrary set of leaves. A contract may be vulnerable if it uses multiproofs for verification and the merkle tree that is processed includes a node with value 0 at depth 1 (just under the root). This could happen inadvertedly for balanced trees with 3 leaves or less, if the leaves are not hashed. This could happen deliberately if a malicious tree builder includes such a node in the tree. A contract is not vulnerable if it uses single-leaf proving (`verify`, `verifyCalldata`, `processProof`, or `processProofCalldata`), or if it uses multiproofs with a known tree that has hashed leaves. Standard merkle trees produced or validated with the @openzeppelin/merkle-tree library are safe. The problem has been patched in version 4.9.2. Some workarounds are available. For those using multiproofs: When constructing merkle trees hash the leaves and do not insert empty nodes in your trees. Using the @openzeppelin/merkle-tree package eliminates this issue. Do not accept user-provided merkle roots without reconstructing at least the first level of the tree. Verify the merkle tree structure by reconstructing it from the leaves.

*There is one instance of this issue:*
```solidity

Global finding

```


<a name="L-18"></a> 
### [L-18]  `abi.encodePacked()` should not be used with dynamic types when passing the result to a hash function such as `keccak256()`
Use `abi.encode()` instead which will pad items to 32 bytes, which will [prevent hash collisions](https://docs.soliditylang.org/en/v0.8.13/abi-spec.html#non-standard-packed-mode) (e.g. `abi.encodePacked(0x123,0x456)` => `0x123456` => `abi.encodePacked(0x1,0x23456)`, but `abi.encode(0x123,0x456)` => `0x0...1230...456`). "Unless there is a compelling reason, `abi.encode` should be preferred". If there is only one argument to `abi.encodePacked()` it can often be cast to `bytes()` or `bytes32()` [instead](https://ethereum.stackexchange.com/questions/30912/how-to-compare-strings-in-solidity#answer-82739).
If all arguments are strings and or bytes, `bytes.concat()` should be used instead

*There are <b>3</b> instances of this issue:*
```solidity
File: src/packages/Signer.sol

186:                     keccak256(abi.encodePacked(itemHashes)),

187:                     keccak256(abi.encodePacked(hookHashes)),

236:                     keccak256(abi.encodePacked(hookHashes))

```


<a name="L-19"></a> 
### [L-19] Centralization Risk for trusted owners
Contracts have owners with privileged rights to perform admin tasks and need to be trusted to not perform malicious updates or drain funds.

<details>
<summary>
There are <b>48</b> instances (click to show):
</summary>

```solidity
File: src/Kernel.sol

54:     function changeKernel(Kernel newKernel_) external onlyKernel {

106:     function INIT() external virtual onlyKernel {}

148:     function configureDependencies()
             external
             virtual
             onlyKernel

166:     function requestPermissions()
             external
             view
             virtual
             onlyKernel

192:     function setActiveStatus(bool activate_) external onlyKernel {

277:     function executeAction(Actions action_, address target_) external onlyExecutor {

310:     function grantRole(Role role_, address addr_) public onlyAdmin {

333:     function revokeRole(Role role_, address addr_) public onlyAdmin {

```

```solidity
File: src/modules/PaymentEscrow.sol

58:     function MODULE_PROXY_INSTANTIATION(
            Kernel kernel_
        ) external onlyByProxy onlyUninitialized {

320:     function settlePayment(RentalOrder calldata order) external onlyByProxy permissioned {

337:     function settlePaymentBatch(
             RentalOrder[] calldata orders
         ) external onlyByProxy permissioned {

361:     function increaseDeposit(
             address token,
             uint256 amount
         ) external onlyByProxy permissioned {

380:     function setFee(uint256 feeNumerator) external onlyByProxy permissioned {

397:     function skim(address token, address to) external onlyByProxy permissioned {

420:     function upgrade(address newImplementation) external onlyByProxy permissioned {

429:     function freeze() external onlyByProxy permissioned {

```

```solidity
File: src/modules/Storage.sol

86:     function MODULE_PROXY_INSTANTIATION(
            Kernel kernel_
        ) external onlyByProxy onlyUninitialized {

189:     function addRentals(
             bytes32 orderHash,
             RentalAssetUpdate[] memory rentalAssetUpdates
         ) external onlyByProxy permissioned {

216:     function removeRentals(
             bytes32 orderHash,
             RentalAssetUpdate[] calldata rentalAssetUpdates
         ) external onlyByProxy permissioned {

244:     function removeRentalsBatch(
             bytes32[] calldata orderHashes,
             RentalAssetUpdate[] calldata rentalAssetUpdates
         ) external onlyByProxy permissioned {

274:     function addRentalSafe(address safe) external onlyByProxy permissioned {

294:     function updateHookPath(address to, address hook) external onlyByProxy permissioned {

313:     function updateHookStatus(
             address hook,
             uint8 bitmap
         ) external onlyByProxy permissioned {

334:     function toggleWhitelistDelegate(
             address delegate,
             bool isEnabled
         ) external onlyByProxy permissioned {

347:     function toggleWhitelistExtension(
             address extension,
             bool isEnabled
         ) external onlyByProxy permissioned {

360:     function upgrade(address newImplementation) external onlyByProxy permissioned {

369:     function freeze() external onlyByProxy permissioned {

```

```solidity
File: src/policies/Admin.sol

40:     function configureDependencies()
            external
            override
            onlyKernel

64:     function requestPermissions()
            external
            view
            override
            onlyKernel

99:     function toggleWhitelistDelegate(
            address delegate,
            bool isEnabled
        ) external onlyRole("ADMIN_ADMIN") {

113:     function toggleWhitelistExtension(
             address extension,
             bool isEnabled
         ) external onlyRole("ADMIN_ADMIN") {

126:     function upgradeStorage(address newImplementation) external onlyRole("ADMIN_ADMIN") {

134:     function freezeStorage() external onlyRole("ADMIN_ADMIN") {

144:     function upgradePaymentEscrow(
             address newImplementation
         ) external onlyRole("ADMIN_ADMIN") {

154:     function freezePaymentEscrow() external onlyRole("ADMIN_ADMIN") {

164:     function skim(address token, address to) external onlyRole("ADMIN_ADMIN") {

173:     function setFee(uint256 feeNumerator) external onlyRole("ADMIN_ADMIN") {

```

```solidity
File: src/policies/Create.sol

72:     function configureDependencies()
            external
            override
            onlyKernel

96:     function requestPermissions()
            external
            view
            override
            onlyKernel

733:     function validateOrder(
             ZoneParameters calldata zoneParams
         ) external override onlyRole("SEAPORT") returns (bytes4 validOrderMagicValue) {

```

```solidity
File: src/policies/Factory.sol

73:     function configureDependencies()
            external
            override
            onlyKernel

94:     function requestPermissions()
            external
            view
            override
            onlyKernel

```

```solidity
File: src/policies/Guard.sol

63:     function configureDependencies()
            external
            override
            onlyKernel

84:     function requestPermissions()
            external
            view
            override
            onlyKernel

362:     function updateHookPath(address to, address hook) external onlyRole("GUARD_ADMIN") {

373:     function updateHookStatus(
             address hook,
             uint8 bitmap
         ) external onlyRole("GUARD_ADMIN") {

```

```solidity
File: src/policies/Stop.sol

63:     function configureDependencies()
            external
            override
            onlyKernel

87:     function requestPermissions()
            external
            view
            override
            onlyKernel

```

</details>



## Non Critical Issues

<a name="NC-1"></a> 
### [NC-1] Assembly blocks should have extensive comments
Assembly blocks take a lot more time to audit than normal Solidity code, and often have gotchas and side-effects that the Solidity versions of the same code do not. Consider adding more comments explaining what is being done in every step of the assembly code, and describe why assembly is being used instead of Solidity.

*There are <b>7</b> instances of this issue:*
```solidity
File: src/Create2Deployer.sol

53:         assembly {

111:         assembly {

```

```solidity
File: src/packages/Accumulator.sol

40:         assembly {

104:         assembly {

126:             assembly {

```

```solidity
File: src/policies/Guard.sol

113:         assembly {

199:         assembly {

```


<a name="NC-2"></a> 
### [NC-2] `abi.encodePacked()` should be replaced with `bytes.concat()`
Solidity version 0.8.4 introduces `bytes.concat()`, which can be used to replace `abi.encodePacked()` on bytes/strings. It can make the intended operation clearer, leading to less reviewer confusion.

<details>
<summary>
There are <b>12</b> instances (click to show):
</summary>

```solidity
File: src/Create2Deployer.sol

90:             abi.encodePacked(create2_ff, address(this), salt, keccak256(initCode))

```

```solidity
File: src/packages/Signer.sol

186:                     keccak256(abi.encodePacked(itemHashes)),

187:                     keccak256(abi.encodePacked(hookHashes)),

236:                     keccak256(abi.encodePacked(hookHashes))

316:             abi.encodePacked(

352:         bytes memory itemTypeString = abi.encodePacked(

357:         bytes memory hookTypeString = abi.encodePacked(

362:         bytes memory rentalOrderTypeString = abi.encodePacked(

379:             bytes memory orderFulfillmentTypeString = abi.encodePacked(

384:             bytes memory orderMetadataTypeString = abi.encodePacked(

389:             bytes memory rentPayloadTypeString = abi.encodePacked(

395:                 abi.encodePacked(

```

</details>


<a name="NC-3"></a> 
### [NC-3] Add inline comments for unnamed variables
`function foo(address x, address)` -> `function foo(address x, address /* y */)`

*There is one instance of this issue:*
```solidity
File: src/policies/Guard.sol

309:     function checkTransaction(
             address to,
             uint256 value,
             bytes memory data,
             Enum.Operation operation,
             uint256,
             uint256,
             uint256,
             address,
             address payable,
             bytes memory,
             address
         ) external override {

```


<a name="NC-4"></a> 
### [NC-4] Avoid the use of sensitive terms
Use [alternative variants](https://www.zdnet.com/article/mysql-drops-master-slave-and-blacklist-whitelist-terminology/), e.g. allowlist/denylist instead of whitelist/blacklist

<details>
<summary>
There are <b>28</b> instances (click to show):
</summary>

```solidity
File: src/modules/Storage.sol

50:     //                            Whitelist Storage                                //

55:     mapping(address delegate => bool isWhitelisted) public whitelistedDelegates;

58:     mapping(address extension => bool isWhitelisted) public whitelistedExtensions;

64:  *         storage for active rentals, deployed rental safes, hooks, and whitelists.

334:     function toggleWhitelistDelegate(

338:         whitelistedDelegates[delegate] = isEnabled;

342:      * @notice Toggles whether an extension is whitelisted.

347:     function toggleWhitelistExtension(

351:         whitelistedExtensions[extension] = isEnabled;

```

```solidity
File: src/packages/Reclaimer.sol

63:      *         only be made to addresses which have been explicitly whitelisted by the

64:      *         Admin policy. Further, since the Stop policy is a whitelisted module on

```

```solidity
File: src/policies/Admin.sol

13:  *         and whitelist management.

74:             STORE.toggleWhitelistExtension.selector

78:             STORE.toggleWhitelistDelegate.selector

99:     function toggleWhitelistDelegate(

103:         STORE.toggleWhitelistDelegate(delegate, isEnabled);

107:      * @notice Toggle whether an extension is whitelisted. An extension is any contract

113:     function toggleWhitelistExtension(

117:         STORE.toggleWhitelistExtension(extension, isEnabled);

```

```solidity
File: src/policies/Guard.sol

139:      * @dev Reverts if the extension is not whitelisted.

143:     function _revertNonWhitelistedExtension(address extension) private view {

144:         // Check if the extension is whitelisted.

145:         if (!STORE.whitelistedExtensions(extension)) {

253:             // Check if the extension is whitelisted.

254:             _revertNonWhitelistedExtension(extension);

265:             // Check if the extension is whitelisted.

266:             _revertNonWhitelistedExtension(extension);

324:         if (operation == Enum.Operation.DelegateCall && !STORE.whitelistedDelegates(to)) {

```

</details>


<a name="NC-5"></a> 
### [NC-5] Complex casting
Consider whether the number of casts is really necessary, or whether using a different type would be more appropriate. Alternatively, add comments to explain in detail why the casts are necessary, and any implicit reasons why the cast does not introduce an overflow.

*There is one instance of this issue:*
```solidity
File: src/Create2Deployer.sol

94:         return address(uint160(uint256(addressHash)));

```


<a name="NC-6"></a> 
### [NC-6] Consider adding a block/deny-list
Doing so will significantly increase centralization, but will help to prevent hackers from using stolen tokens.

<details>
<summary>
There are <b>17</b> instances (click to show):
</summary>

```solidity
File: src/Create2Deployer.sol

14: contract Create2Deployer {

```

```solidity
File: src/Kernel.sol

23: abstract contract KernelAdapter {

64: abstract contract Module is KernelAdapter {

114: abstract contract Policy is KernelAdapter {

206: contract Kernel {

```

```solidity
File: src/modules/PaymentEscrow.sol

23: contract PaymentEscrowBase {

37: contract PaymentEscrow is Proxiable, Module, PaymentEscrowBase {

```

```solidity
File: src/modules/Storage.sol

14: contract StorageBase {

66: contract Storage is Proxiable, Module, StorageBase {

```

```solidity
File: src/packages/Accumulator.sol

12: abstract contract Accumulator {

```

```solidity
File: src/packages/Reclaimer.sol

15: abstract contract Reclaimer {

```

```solidity
File: src/packages/Signer.sol

21: abstract contract Signer {

```

```solidity
File: src/policies/Admin.sol

15: contract Admin is Policy {

```

```solidity
File: src/policies/Create.sol

41: contract Create is Policy, Signer, Zone, Accumulator {

```

```solidity
File: src/policies/Factory.sol

22: contract Factory is Policy {

```

```solidity
File: src/policies/Guard.sol

39: contract Guard is Policy, BaseGuard {

```

```solidity
File: src/policies/Stop.sol

34: contract Stop is Policy, Signer, Reclaimer, Accumulator {

```

</details>


<a name="NC-7"></a> 
### [NC-7] Consider adding emergency-stop functionality
Consider adding `Pausable` to the following contracts so it's possible to stop them in case of an emergency.

<details>
<summary>
There are <b>11</b> instances (click to show):
</summary>

```solidity
File: src/Create2Deployer.sol

14: contract Create2Deployer {

```

```solidity
File: src/Kernel.sol

206: contract Kernel {

```

```solidity
File: src/modules/PaymentEscrow.sol

23: contract PaymentEscrowBase {

37: contract PaymentEscrow is Proxiable, Module, PaymentEscrowBase {

```

```solidity
File: src/modules/Storage.sol

14: contract StorageBase {

66: contract Storage is Proxiable, Module, StorageBase {

```

```solidity
File: src/policies/Admin.sol

15: contract Admin is Policy {

```

```solidity
File: src/policies/Create.sol

41: contract Create is Policy, Signer, Zone, Accumulator {

```

```solidity
File: src/policies/Factory.sol

22: contract Factory is Policy {

```

```solidity
File: src/policies/Guard.sol

39: contract Guard is Policy, BaseGuard {

```

```solidity
File: src/policies/Stop.sol

34: contract Stop is Policy, Signer, Reclaimer, Accumulator {

```

</details>


<a name="NC-8"></a> 
### [NC-8] Consider adding formal verification proofs
Formal verification is the act of proving or disproving the correctness of intended algorithms underlying a system with respect to a certain formal specification/property/invariant, using formal methods of mathematics.

Some tools that are currently available to perform these tests on smart contracts are [SMTChecker](https://docs.soliditylang.org/en/latest/smtchecker.html) and [Certora Prover](https://www.certora.com/).

*There is one instance of this issue:*
```solidity

Global finding

```


<a name="NC-9"></a> 
### [NC-9] Consider bounding input array length
The functions below take in an unbounded array, and make function calls for entries in the array. While the function will revert if it eventually runs out of gas, it may be a nicer user experience to require() that the length of the array is below some reasonable maximum, so that the user doesn't have to use up a full transaction's gas only to see that the transaction reverts.

<details>
<summary>
There are <b>12</b> instances (click to show):
</summary>

```solidity
File: src/modules/PaymentEscrow.sol

/// @audit consider length check for `items`
231:         for (uint256 i = 0; i < items.length; ++i) {

/// @audit consider length check for `orders`
341:         for (uint256 i = 0; i < orders.length; ++i) {

```

```solidity
File: src/modules/Storage.sol

/// @audit consider length check for `rentalAssetUpdates`
197:         for (uint256 i = 0; i < rentalAssetUpdates.length; ++i) {

/// @audit consider length check for `rentalAssetUpdates`
229:         for (uint256 i = 0; i < rentalAssetUpdates.length; ++i) {

/// @audit consider length check for `orderHashes`
249:         for (uint256 i = 0; i < orderHashes.length; ++i) {

/// @audit consider length check for `rentalAssetUpdates`
260:         for (uint256 i = 0; i < rentalAssetUpdates.length; ++i) {

```

```solidity
File: src/policies/Create.sol

/// @audit consider length check for `offers`
261:         for (uint256 i; i < offers.length; ++i) {

/// @audit consider length check for `considerations`
375:         for (uint256 i; i < considerations.length; ++i) {

/// @audit consider length check for `hooks`
475:         for (uint256 i = 0; i < hooks.length; ++i) {

/// @audit consider length check for `executions`
695:         for (uint256 i = 0; i < executions.length; ++i) {

```

```solidity
File: src/policies/Stop.sol

/// @audit consider length check for `hooks`
205:         for (uint256 i = 0; i < hooks.length; ++i) {

/// @audit consider length check for `orders`
324:         for (uint256 i = 0; i < orders.length; ++i) {

```

</details>


<a name="NC-10"></a> 
### [NC-10] Consider using descriptive `constant`s when passing zero as a function argument
Passing zero as a function argument can sometimes result in a security issue (e.g. passing zero as the slippage parameter). Consider using a `constant` variable with a descriptive name, so it's clear that the argument is intentionally being used, and for the right reasons.

*There are <b>6</b> instances of this issue:*
```solidity
File: src/policies/Create.sol

422:             _processBaseOrderOffer(items, offers, 0);

430:             _processPayOrderOffer(items, offers, 0);

563:             bytes memory rentalAssetUpdates = new bytes(0);

```

```solidity
File: src/policies/Stop.sol

168:         bool success = ISafe(order.rentalWallet).execTransactionFromModule(
                 // Stop policy inherits the reclaimer package.
                 address(this),
                 // value.
                 0,

272:         bytes memory rentalAssetUpdates = new bytes(0);

320:         bytes memory rentalAssetUpdates = new bytes(0);

```


<a name="NC-11"></a> 
### [NC-11] Constants should be put on the left side of comparisons
Putting constants on the left side of comparison statements is a best practice known as [Yoda conditions](https://en.wikipedia.org/wiki/Yoda_conditions). Although solidity's static typing system prevents accidental assignments within conditionals, adopting this practice can improve code readability and consistency, especially when working across multiple languages.

<details>
<summary>
There are <b>20</b> instances (click to show):
</summary>

```solidity
File: src/Kernel.sol

182:         if (moduleForKeycode == address(0))

361:         if (address(getModuleForKeycode[keycode]) != address(0)) {

392:         if (address(oldModule) == address(0) || oldModule == newModule_) {

```

```solidity
File: src/modules/PaymentEscrow.sol

115:         if (!success || (data.length != 0 && !abi.decode(data, (bool)))) {

242:                 if (fee != 0) {

366:         if (amount == 0) {

```

```solidity
File: src/modules/Storage.sol

151:         return (uint8(1) & hookStatus[hook]) != 0;

161:         return uint8(2) & hookStatus[hook] != 0;

171:         return uint8(4) & hookStatus[hook] != 0;

296:         if (to.code.length == 0) revert Errors.StorageModule_NotContract(to);

299:         if (hook.code.length == 0) revert Errors.StorageModule_NotContract(hook);

318:         if (hook.code.length == 0) revert Errors.StorageModule_NotContract(hook);

```

```solidity
File: src/policies/Create.sol

201:         if (offers.length == 0) {

311:         if (totalRentals == 0 || totalPayments == 0) {

332:         if (considerations.length == 0) {

396:         if (totalRentals == 0 || totalPayments == 0) {

631:         if (metadata.rentDuration == 0) {

649:         if (STORE.deployedSafes(safe) == 0) {

```

```solidity
File: src/policies/Factory.sol

143:         if (threshold == 0 || threshold > owners.length) {

```

```solidity
File: src/policies/Guard.sol

338:         if (hook != address(0) && isActive) {

```

</details>


<a name="NC-12"></a> 
### [NC-12] Variable names for `constant`s should use CONSTANT_CASE
For `constant` variable names, each word should use all capital letters, with underscores separating each word (CONSTANT_CASE)

*There is one instance of this issue:*
```solidity
File: src/Create2Deployer.sol

19:     bytes1 constant create2_ff = 0xff;

```


<a name="NC-13"></a> 
### [NC-13] `Constructor` should emit an event
Use events to signal significant changes to off-chain monitoring tools.

*There are <b>10</b> instances of this issue:*
```solidity
File: src/Kernel.sol

33:     constructor(Kernel kernel_) {

```

```solidity
File: src/modules/PaymentEscrow.sol

51:     constructor(Kernel kernel_) Module(kernel_) {}

```

```solidity
File: src/modules/Storage.sol

79:     constructor(Kernel kernel_) Module(kernel_) {}

```

```solidity
File: src/packages/Reclaimer.sol

22:     constructor() {

```

```solidity
File: src/packages/Signer.sol

44:     constructor() {

```

```solidity
File: src/policies/Admin.sol

29:     constructor(Kernel kernel_) Policy(kernel_) {}

```

```solidity
File: src/policies/Create.sol

61:     constructor(Kernel kernel_) Policy(kernel_) Signer() Zone() {}

```

```solidity
File: src/policies/Factory.sol

49:     constructor(

```

```solidity
File: src/policies/Guard.sol

52:     constructor(Kernel kernel_) Policy(kernel_) {}

```

```solidity
File: src/policies/Stop.sol

52:     constructor(Kernel kernel_) Policy(kernel_) Signer() Reclaimer() {}

```


<a name="NC-14"></a> 
### [NC-14] Contract does not follow the Solidity Style Guide's suggested layout ordering
The [style guide](https://docs.soliditylang.org/en/v0.8.16/style-guide.html#order-of-layout) says that, within a contract, the ordering should be `1) Type declarations`, `2) State variables`, `3) Events`, `4) Modifiers`, and `5) Functions`, but the contract(s) below do not follow this ordering

<details>
<summary>
There are <b>18</b> instances (click to show):
</summary>

```solidity
File: src/Kernel.sol

/// @audit function `constructor` came earlier
40:     modifier onlyKernel() {

/// @audit function `constructor` came earlier
/// @audit function `changeKernel` came earlier
/// @audit function `constructor` came earlier
77:     modifier permissioned() {

/// @audit modifier `onlyKernel` came earlier
/// @audit modifier `permissioned` came earlier
/// @audit function `constructor` came earlier
/// @audit function `changeKernel` came earlier
/// @audit function `constructor` came earlier
/// @audit function `KEYCODE` came earlier
/// @audit function `VERSION` came earlier
/// @audit function `INIT` came earlier
116:     bool public isActive;

/// @audit function `constructor` came earlier
/// @audit function `changeKernel` came earlier
/// @audit function `constructor` came earlier
/// @audit function `KEYCODE` came earlier
/// @audit function `VERSION` came earlier
/// @audit function `INIT` came earlier
/// @audit function `constructor` came earlier
130:     modifier onlyRole(bytes32 role_) {

/// @audit modifier `onlyKernel` came earlier
/// @audit modifier `permissioned` came earlier
/// @audit modifier `onlyRole` came earlier
/// @audit function `constructor` came earlier
/// @audit function `changeKernel` came earlier
/// @audit function `constructor` came earlier
/// @audit function `KEYCODE` came earlier
/// @audit function `VERSION` came earlier
/// @audit function `INIT` came earlier
/// @audit function `constructor` came earlier
/// @audit function `configureDependencies` came earlier
/// @audit function `requestPermissions` came earlier
/// @audit function `getModuleAddress` came earlier
/// @audit function `setActiveStatus` came earlier
208:     address public executor;

/// @audit modifier `onlyKernel` came earlier
/// @audit modifier `permissioned` came earlier
/// @audit modifier `onlyRole` came earlier
/// @audit function `constructor` came earlier
/// @audit function `changeKernel` came earlier
/// @audit function `constructor` came earlier
/// @audit function `KEYCODE` came earlier
/// @audit function `VERSION` came earlier
/// @audit function `INIT` came earlier
/// @audit function `constructor` came earlier
/// @audit function `configureDependencies` came earlier
/// @audit function `requestPermissions` came earlier
/// @audit function `getModuleAddress` came earlier
/// @audit function `setActiveStatus` came earlier
209:     address public admin;

/// @audit modifier `onlyKernel` came earlier
/// @audit modifier `permissioned` came earlier
/// @audit modifier `onlyRole` came earlier
/// @audit function `constructor` came earlier
/// @audit function `changeKernel` came earlier
/// @audit function `constructor` came earlier
/// @audit function `KEYCODE` came earlier
/// @audit function `VERSION` came earlier
/// @audit function `INIT` came earlier
/// @audit function `constructor` came earlier
/// @audit function `configureDependencies` came earlier
/// @audit function `requestPermissions` came earlier
/// @audit function `getModuleAddress` came earlier
/// @audit function `setActiveStatus` came earlier
212:     Keycode[] public allKeycodes;

/// @audit modifier `onlyKernel` came earlier
/// @audit modifier `permissioned` came earlier
/// @audit modifier `onlyRole` came earlier
/// @audit function `constructor` came earlier
/// @audit function `changeKernel` came earlier
/// @audit function `constructor` came earlier
/// @audit function `KEYCODE` came earlier
/// @audit function `VERSION` came earlier
/// @audit function `INIT` came earlier
/// @audit function `constructor` came earlier
/// @audit function `configureDependencies` came earlier
/// @audit function `requestPermissions` came earlier
/// @audit function `getModuleAddress` came earlier
/// @audit function `setActiveStatus` came earlier
213:     mapping(Keycode => Module) public getModuleForKeycode; // get contract for module keycode.

/// @audit modifier `onlyKernel` came earlier
/// @audit modifier `permissioned` came earlier
/// @audit modifier `onlyRole` came earlier
/// @audit function `constructor` came earlier
/// @audit function `changeKernel` came earlier
/// @audit function `constructor` came earlier
/// @audit function `KEYCODE` came earlier
/// @audit function `VERSION` came earlier
/// @audit function `INIT` came earlier
/// @audit function `constructor` came earlier
/// @audit function `configureDependencies` came earlier
/// @audit function `requestPermissions` came earlier
/// @audit function `getModuleAddress` came earlier
/// @audit function `setActiveStatus` came earlier
214:     mapping(Module => Keycode) public getKeycodeForModule; // get module keycode for contract.

/// @audit modifier `onlyKernel` came earlier
/// @audit modifier `permissioned` came earlier
/// @audit modifier `onlyRole` came earlier
/// @audit function `constructor` came earlier
/// @audit function `changeKernel` came earlier
/// @audit function `constructor` came earlier
/// @audit function `KEYCODE` came earlier
/// @audit function `VERSION` came earlier
/// @audit function `INIT` came earlier
/// @audit function `constructor` came earlier
/// @audit function `configureDependencies` came earlier
/// @audit function `requestPermissions` came earlier
/// @audit function `getModuleAddress` came earlier
/// @audit function `setActiveStatus` came earlier
217:     mapping(Keycode => Policy[]) public moduleDependents;

/// @audit modifier `onlyKernel` came earlier
/// @audit modifier `permissioned` came earlier
/// @audit modifier `onlyRole` came earlier
/// @audit function `constructor` came earlier
/// @audit function `changeKernel` came earlier
/// @audit function `constructor` came earlier
/// @audit function `KEYCODE` came earlier
/// @audit function `VERSION` came earlier
/// @audit function `INIT` came earlier
/// @audit function `constructor` came earlier
/// @audit function `configureDependencies` came earlier
/// @audit function `requestPermissions` came earlier
/// @audit function `getModuleAddress` came earlier
/// @audit function `setActiveStatus` came earlier
218:     mapping(Keycode => mapping(Policy => uint256)) public getDependentIndex;

/// @audit modifier `onlyKernel` came earlier
/// @audit modifier `permissioned` came earlier
/// @audit modifier `onlyRole` came earlier
/// @audit function `constructor` came earlier
/// @audit function `changeKernel` came earlier
/// @audit function `constructor` came earlier
/// @audit function `KEYCODE` came earlier
/// @audit function `VERSION` came earlier
/// @audit function `INIT` came earlier
/// @audit function `constructor` came earlier
/// @audit function `configureDependencies` came earlier
/// @audit function `requestPermissions` came earlier
/// @audit function `getModuleAddress` came earlier
/// @audit function `setActiveStatus` came earlier
221:     mapping(Keycode => mapping(Policy => mapping(bytes4 => bool)))

/// @audit modifier `onlyKernel` came earlier
/// @audit modifier `permissioned` came earlier
/// @audit modifier `onlyRole` came earlier
/// @audit function `constructor` came earlier
/// @audit function `changeKernel` came earlier
/// @audit function `constructor` came earlier
/// @audit function `KEYCODE` came earlier
/// @audit function `VERSION` came earlier
/// @audit function `INIT` came earlier
/// @audit function `constructor` came earlier
/// @audit function `configureDependencies` came earlier
/// @audit function `requestPermissions` came earlier
/// @audit function `getModuleAddress` came earlier
/// @audit function `setActiveStatus` came earlier
225:     Policy[] public activePolicies;

/// @audit modifier `onlyKernel` came earlier
/// @audit modifier `permissioned` came earlier
/// @audit modifier `onlyRole` came earlier
/// @audit function `constructor` came earlier
/// @audit function `changeKernel` came earlier
/// @audit function `constructor` came earlier
/// @audit function `KEYCODE` came earlier
/// @audit function `VERSION` came earlier
/// @audit function `INIT` came earlier
/// @audit function `constructor` came earlier
/// @audit function `configureDependencies` came earlier
/// @audit function `requestPermissions` came earlier
/// @audit function `getModuleAddress` came earlier
/// @audit function `setActiveStatus` came earlier
226:     mapping(Policy => uint256) public getPolicyIndex;

/// @audit modifier `onlyKernel` came earlier
/// @audit modifier `permissioned` came earlier
/// @audit modifier `onlyRole` came earlier
/// @audit function `constructor` came earlier
/// @audit function `changeKernel` came earlier
/// @audit function `constructor` came earlier
/// @audit function `KEYCODE` came earlier
/// @audit function `VERSION` came earlier
/// @audit function `INIT` came earlier
/// @audit function `constructor` came earlier
/// @audit function `configureDependencies` came earlier
/// @audit function `requestPermissions` came earlier
/// @audit function `getModuleAddress` came earlier
/// @audit function `setActiveStatus` came earlier
229:     mapping(address => mapping(Role => bool)) public hasRole;

/// @audit modifier `onlyKernel` came earlier
/// @audit modifier `permissioned` came earlier
/// @audit modifier `onlyRole` came earlier
/// @audit function `constructor` came earlier
/// @audit function `changeKernel` came earlier
/// @audit function `constructor` came earlier
/// @audit function `KEYCODE` came earlier
/// @audit function `VERSION` came earlier
/// @audit function `INIT` came earlier
/// @audit function `constructor` came earlier
/// @audit function `configureDependencies` came earlier
/// @audit function `requestPermissions` came earlier
/// @audit function `getModuleAddress` came earlier
/// @audit function `setActiveStatus` came earlier
230:     mapping(Role => bool) public isRole;

/// @audit function `constructor` came earlier
/// @audit function `changeKernel` came earlier
/// @audit function `constructor` came earlier
/// @audit function `KEYCODE` came earlier
/// @audit function `VERSION` came earlier
/// @audit function `INIT` came earlier
/// @audit function `constructor` came earlier
/// @audit function `configureDependencies` came earlier
/// @audit function `requestPermissions` came earlier
/// @audit function `getModuleAddress` came earlier
/// @audit function `setActiveStatus` came earlier
/// @audit function `constructor` came earlier
254:     modifier onlyExecutor() {

/// @audit function `constructor` came earlier
/// @audit function `changeKernel` came earlier
/// @audit function `constructor` came earlier
/// @audit function `KEYCODE` came earlier
/// @audit function `VERSION` came earlier
/// @audit function `INIT` came earlier
/// @audit function `constructor` came earlier
/// @audit function `configureDependencies` came earlier
/// @audit function `requestPermissions` came earlier
/// @audit function `getModuleAddress` came earlier
/// @audit function `setActiveStatus` came earlier
/// @audit function `constructor` came earlier
262:     modifier onlyAdmin() {

```

</details>


<a name="NC-15"></a> 
### [NC-15] Contract should expose an `interface`
All `external`/`public` functions should extend an `interface`. This is useful to make sure that the whole API is extracted.

*Note:* It is possible that the interface is out-of-scope and has not been seen by the bot.

<details>
<summary>
There are <b>73</b> instances (click to show):
</summary>

```solidity
File: src/Create2Deployer.sol

32:     function deploy(

84:     function getCreate2Address(

107:     function generateSaltWithSender(

```

```solidity
File: src/Kernel.sol

54:     function changeKernel(Kernel newKernel_) external onlyKernel {

90:     function KEYCODE() public pure virtual returns (Keycode);

100:     function VERSION() external pure virtual returns (uint8 major, uint8 minor) {}

106:     function INIT() external virtual onlyKernel {}

148:     function configureDependencies()

166:     function requestPermissions()

192:     function setActiveStatus(bool activate_) external onlyKernel {

277:     function executeAction(Actions action_, address target_) external onlyExecutor {

310:     function grantRole(Role role_, address addr_) public onlyAdmin {

333:     function revokeRole(Role role_, address addr_) public onlyAdmin {

```

```solidity
File: src/modules/PaymentEscrow.sol

58:     function MODULE_PROXY_INSTANTIATION(

68:     function VERSION() external pure override returns (uint8 major, uint8 minor) {

75:     function KEYCODE() public pure override returns (Keycode) {

320:     function settlePayment(RentalOrder calldata order) external onlyByProxy permissioned {

337:     function settlePaymentBatch(

361:     function increaseDeposit(

380:     function setFee(uint256 feeNumerator) external onlyByProxy permissioned {

397:     function skim(address token, address to) external onlyByProxy permissioned {

420:     function upgrade(address newImplementation) external onlyByProxy permissioned {

429:     function freeze() external onlyByProxy permissioned {

```

```solidity
File: src/modules/Storage.sol

86:     function MODULE_PROXY_INSTANTIATION(

96:     function VERSION() external pure override returns (uint8 major, uint8 minor) {

103:     function KEYCODE() public pure override returns (Keycode) {

118:     function isRentedOut(

135:     function contractToHook(address to) external view returns (address) {

149:     function hookOnTransaction(address hook) external view returns (bool) {

159:     function hookOnStart(address hook) external view returns (bool) {

169:     function hookOnStop(address hook) external view returns (bool) {

189:     function addRentals(

216:     function removeRentals(

244:     function removeRentalsBatch(

274:     function addRentalSafe(address safe) external onlyByProxy permissioned {

294:     function updateHookPath(address to, address hook) external onlyByProxy permissioned {

313:     function updateHookStatus(

334:     function toggleWhitelistDelegate(

347:     function toggleWhitelistExtension(

360:     function upgrade(address newImplementation) external onlyByProxy permissioned {

369:     function freeze() external onlyByProxy permissioned {

```

```solidity
File: src/packages/Reclaimer.sol

71:     function reclaimRentalOrder(RentalOrder calldata rentalOrder) external {

```

```solidity
File: src/policies/Admin.sol

40:     function configureDependencies()

64:     function requestPermissions()

99:     function toggleWhitelistDelegate(

113:     function toggleWhitelistExtension(

126:     function upgradeStorage(address newImplementation) external onlyRole("ADMIN_ADMIN") {

134:     function freezeStorage() external onlyRole("ADMIN_ADMIN") {

144:     function upgradePaymentEscrow(

154:     function freezePaymentEscrow() external onlyRole("ADMIN_ADMIN") {

164:     function skim(address token, address to) external onlyRole("ADMIN_ADMIN") {

173:     function setFee(uint256 feeNumerator) external onlyRole("ADMIN_ADMIN") {

```

```solidity
File: src/policies/Create.sol

72:     function configureDependencies()

96:     function requestPermissions()

117:     function domainSeparator() external view returns (bytes32) {

126:     function getRentalOrderHash(

137:     function getRentPayloadHash(

148:     function getOrderMetadataHash(

733:     function validateOrder(

```

```solidity
File: src/policies/Factory.sol

73:     function configureDependencies()

94:     function requestPermissions()

122:     function initializeRentalSafe(address _stopPolicy, address _guardPolicy) external {

138:     function deployRentalSafe(

```

```solidity
File: src/policies/Guard.sol

63:     function configureDependencies()

84:     function requestPermissions()

309:     function checkTransaction(

353:     function checkAfterExecution(bytes32 txHash, bool success) external override {}

362:     function updateHookPath(address to, address hook) external onlyRole("GUARD_ADMIN") {

373:     function updateHookStatus(

```

```solidity
File: src/policies/Stop.sol

63:     function configureDependencies()

87:     function requestPermissions()

265:     function stopRent(RentalOrder calldata order) external {

313:     function stopRentBatch(RentalOrder[] calldata orders) external {

```

</details>


<a name="NC-16"></a> 
### [NC-16] Contracts should each be defined in separate files
Keeping each contract in a separate file makes it easier to work with multiple people, makes the code easier to maintain, and is a common practice on most projects. The following files each contains more than one contract/library/interface.

*There are <b>8</b> instances of this issue:*
```solidity
File: src/Kernel.sol

/// @audit another contract/library/interface is defined in this file
23: abstract contract KernelAdapter {

/// @audit another contract/library/interface is defined in this file
64: abstract contract Module is KernelAdapter {

/// @audit another contract/library/interface is defined in this file
114: abstract contract Policy is KernelAdapter {

/// @audit another contract/library/interface is defined in this file
206: contract Kernel {

```

```solidity
File: src/modules/PaymentEscrow.sol

/// @audit another contract/library/interface is defined in this file
23: contract PaymentEscrowBase {

/// @audit another contract/library/interface is defined in this file
37: contract PaymentEscrow is Proxiable, Module, PaymentEscrowBase {

```

```solidity
File: src/modules/Storage.sol

/// @audit another contract/library/interface is defined in this file
14: contract StorageBase {

/// @audit another contract/library/interface is defined in this file
66: contract Storage is Proxiable, Module, StorageBase {

```


<a name="NC-17"></a> 
### [NC-17] Contracts should have full test coverage
While 100% code coverage does not guarantee that there are no bugs, it often will catch easy-to-find bugs, and will ensure that there are fewer regressions when the code invariably has to be modified. Furthermore, in order to get full coverage, code authors will often have to re-organize their code so that it is more modular, so that each component can be tested separately, which reduces interdependencies between modules and layers, and makes for code that is easier to reason about and audit.

*There is one instance of this issue:*
```solidity

Global finding

```


<a name="NC-18"></a> 
### [NC-18] Duplicated `require()`/`revert()` checks should be refactored
Refactoring duplicate `require()`/`revert()` checks into a modifier or function can make the code more concise, readable and maintainable, and less likely to make errors or omissions when modifying the `require()` or `revert()`.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/policies/Create.sol

/// @audit duplicated on line 297
223:                 revert Errors.CreatePolicy_SeaportItemTypeNotSupported(offer.itemType);

/// @audit duplicated on line 397
312:             revert Errors.CreatePolicy_ItemCountZero(totalRentals, totalPayments);

```

```solidity
File: src/policies/Stop.sol

/// @audit duplicated on line 149
141:                 revert Errors.StopPolicy_CannotStopOrder(block.timestamp, msg.sender);

```


<a name="NC-19"></a> 
### [NC-19] Empty bytes check is missing
Passing empty bytes to a function can cause unexpected behavior, such as certain operations failing, producing incorrect results, or wasting gas. It is recommended to check that all byte parameters are not empty.

*There are <b>10</b> instances of this issue:*
```solidity
File: src/Create2Deployer.sol

/// @audit missing empty check for `initCode`
32:     function deploy(
            bytes32 salt,
            bytes memory initCode
        ) external payable returns (address deploymentAddress) {

/// @audit missing empty check for `initCode`
84:     function getCreate2Address(
            bytes32 salt,
            bytes memory initCode
        ) public view returns (address) {

```

```solidity
File: src/packages/Accumulator.sol

/// @audit missing empty check for `rentalAssets`
32:     function _insert(
            bytes memory rentalAssets,
            RentalId rentalId,
            uint256 rentalAssetAmount
        ) internal pure {

/// @audit missing empty check for `rentalAssetUpdates`
96:     function _convertToStatic(
            bytes memory rentalAssetUpdates
        ) internal pure returns (RentalAssetUpdate[] memory updates) {

```

```solidity
File: src/packages/Signer.sol

/// @audit missing empty check for `signature`
107:     function _recoverSignerFromPayload(
             bytes32 payloadHash,
             bytes memory signature
         ) internal view returns (address) {

```

```solidity
File: src/policies/Create.sol

/// @audit missing empty check for `extraData`
165:     function _emitRentalOrderStarted(
             RentalOrder memory order,
             bytes32 orderHash,
             bytes memory extraData
         ) internal {

```

```solidity
File: src/policies/Guard.sol

/// @audit missing empty check for `data`
108:     function _loadValueFromCalldata(
             bytes memory data,
             uint256 offset
         ) private pure returns (bytes32 value) {

/// @audit missing empty check for `data`
159:     function _forwardToHook(
             address hook,
             address safe,
             address to,
             uint256 value,
             bytes memory data
         ) private {

/// @audit missing empty check for `data`
195:     function _checkTransaction(address from, address to, bytes memory data) private view {

/// @audit missing empty check for `data`
/// @audit missing empty check for ``
309:     function checkTransaction(
             address to,
             uint256 value,
             bytes memory data,
             Enum.Operation operation,
             uint256,
             uint256,
             uint256,
             address,
             address payable,
             bytes memory,
             address
         ) external override {

```


<a name="NC-20"></a> 
### [NC-20] Enable IR-based code generation
The IR-based code generator was introduced with an aim to not only allow code generation to be more transparent and auditable but also to enable more powerful optimization passes that span across functions. You can enable it on the command line using `--via-ir` or with the option `{"viaIR": true}`. This will take longer to compile, but you can just simple test it before deploying and if you got a better benchmark then you can add --via-ir to your deploy command More on: https://docs.soliditylang.org/en/v0.8.17/ir-breaking-changes.html

*There is one instance of this issue:*
```solidity

Global finding

```


<a name="NC-21"></a> 
### [NC-21] Enum values should be used instead of constant array indexes
Create a commented enum value to use instead of constant array indexes, this makes the code far easier to understand.

<details>
<summary>
There are <b>25</b> instances (click to show):
</summary>

```solidity
File: src/policies/Admin.sol

48:         dependencies[0] = toKeycode("STORE");

51:         dependencies[1] = toKeycode("ESCRW");

72:         requests[0] = Permissions(

76:         requests[1] = Permissions(

80:         requests[2] = Permissions(toKeycode("STORE"), STORE.upgrade.selector);

81:         requests[3] = Permissions(toKeycode("STORE"), STORE.freeze.selector);

83:         requests[4] = Permissions(toKeycode("ESCRW"), ESCRW.skim.selector);

84:         requests[5] = Permissions(toKeycode("ESCRW"), ESCRW.setFee.selector);

85:         requests[6] = Permissions(toKeycode("ESCRW"), ESCRW.upgrade.selector);

86:         requests[7] = Permissions(toKeycode("ESCRW"), ESCRW.freeze.selector);

```

```solidity
File: src/policies/Create.sol

80:         dependencies[0] = toKeycode("STORE");

83:         dependencies[1] = toKeycode("ESCRW");

104:         requests[0] = Permissions(toKeycode("STORE"), STORE.addRentals.selector);

105:         requests[1] = Permissions(toKeycode("ESCRW"), ESCRW.increaseDeposit.selector);

```

```solidity
File: src/policies/Factory.sol

81:         dependencies[0] = toKeycode("STORE");

102:         requests[0] = Permissions(toKeycode("STORE"), STORE.addRentalSafe.selector);

```

```solidity
File: src/policies/Guard.sol

71:         dependencies[0] = toKeycode("STORE");

92:         requests[0] = Permissions(toKeycode("STORE"), STORE.updateHookPath.selector);

93:         requests[1] = Permissions(toKeycode("STORE"), STORE.updateHookStatus.selector);

```

```solidity
File: src/policies/Stop.sol

71:         dependencies[0] = toKeycode("STORE");

74:         dependencies[1] = toKeycode("ESCRW");

95:         requests[0] = Permissions(toKeycode("STORE"), STORE.removeRentals.selector);

96:         requests[1] = Permissions(toKeycode("STORE"), STORE.removeRentalsBatch.selector);

97:         requests[2] = Permissions(toKeycode("ESCRW"), ESCRW.settlePayment.selector);

98:         requests[3] = Permissions(toKeycode("ESCRW"), ESCRW.settlePaymentBatch.selector);

```

</details>


<a name="NC-22"></a> 
### [NC-22] Events are emitted without the sender information
When an action is triggered based on a user's action, not being able to filter based on who triggered the action makes event processing a lot more cumbersome. Including the `msg.sender` the events of these types of action will make events much more useful to end users, especially when `msg.sender` is not `tx.origin`.

*There are <b>7</b> instances of this issue:*
```solidity
File: src/Kernel.sol

301:         emit Events.ActionExecuted(action_, target_);

324:         emit Events.RoleGranted(role_, addr_);

344:         emit Events.RoleRevoked(role_, addr_);

```

```solidity
File: src/modules/PaymentEscrow.sol

411:         emit Events.FeeTaken(token, skimmedBalance);

```

```solidity
File: src/policies/Create.sol

171:         emit Events.RentalOrderStarted(

```

```solidity
File: src/policies/Factory.sol

192:         emit Events.RentalSafeDeployment(safe, owners, threshold);

```

```solidity
File: src/policies/Stop.sol

113:         emit Events.RentalOrderStopped(seaportOrderHash, stopper);

```


<a name="NC-23"></a> 
### [NC-23] Events may be emitted out of order due to reentrancy
Ensure that events follow the best practice of check-effects-interaction, and are emitted before external calls.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/modules/PaymentEscrow.sol

/// @audit `.balanceOf(...)` is called on line 402
411:         emit Events.FeeTaken(token, skimmedBalance);

```

```solidity
File: src/policies/Factory.sol

/// @audit `.totalSafes(...)` is called on line 184
/// @audit `.createProxyWithNonce(...)` is called on line 181
/// @audit `.addRentalSafe(...)` is called on line 189
192:         emit Events.RentalSafeDeployment(safe, owners, threshold);

```


<a name="NC-24"></a> 
### [NC-24] Execution at deadlines should be allowed
The condition may be wrong in these cases, as when `block.timestamp` is equal to the compared `>` or `<` variable these blocks will not be executed.

*There is one instance of this issue:*
```solidity
File: src/packages/Signer.sol

96:         if (block.timestamp > expiration) {

```


<a name="NC-25"></a> 
### [NC-25] External call recipient can consume all remaining gas
There is no limit specified on the amount of gas used, so the recipient can use up all of the remaining gas (`gasleft()`), causing it to revert. Therefore, when calling an external contract, it is necessary to specify a limited amount of gas to forward.

*There is one instance of this issue:*
```solidity
File: src/modules/PaymentEscrow.sol

102:         (bool success, bytes memory data) = token.call(

```


<a name="NC-26"></a> 
### [NC-26]  Function ordering does not follow the Solidity Style Guide
According to the [solidity style guide](https://docs.soliditylang.org/en/v0.8.17/style-guide.html#order-of-functions), functions should be laid out in the following order: `constructor()`, `receive()`, `fallback()`, `external`, `public`, `internal`, `private`, but the cases below do not follow this pattern

<details>
<summary>
There are <b>38</b> instances (click to show):
</summary>

```solidity
File: src/Kernel.sol

/// @audit public function `KEYCODE` came earlier from this external function
100:     function VERSION() external pure virtual returns (uint8 major, uint8 minor) {}

/// @audit public function `KEYCODE` came earlier from this external function
106:     function INIT() external virtual onlyKernel {}

/// @audit public function `KEYCODE` came earlier from this external function
148:     function configureDependencies()

/// @audit public function `KEYCODE` came earlier from this external function
166:     function requestPermissions()

/// @audit public function `KEYCODE` came earlier from this external function
/// @audit internal function `getModuleAddress` came earlier from this external function
192:     function setActiveStatus(bool activate_) external onlyKernel {

/// @audit public function `KEYCODE` came earlier from this external function
/// @audit internal function `getModuleAddress` came earlier from this external function
277:     function executeAction(Actions action_, address target_) external onlyExecutor {

/// @audit internal function `getModuleAddress` came earlier from this public function
310:     function grantRole(Role role_, address addr_) public onlyAdmin {

/// @audit internal function `getModuleAddress` came earlier from this public function
333:     function revokeRole(Role role_, address addr_) public onlyAdmin {

```

```solidity
File: src/modules/PaymentEscrow.sol

/// @audit public function `KEYCODE` came earlier from this external function
/// @audit internal function `_calculateFee` came earlier from this external function
/// @audit internal function `_safeTransfer` came earlier from this external function
/// @audit internal function `_calculatePaymentProRata` came earlier from this external function
/// @audit internal function `_settlePaymentProRata` came earlier from this external function
/// @audit internal function `_settlePaymentInFull` came earlier from this external function
/// @audit internal function `_settlePayment` came earlier from this external function
/// @audit internal function `_decreaseDeposit` came earlier from this external function
/// @audit internal function `_increaseDeposit` came earlier from this external function
320:     function settlePayment(RentalOrder calldata order) external onlyByProxy permissioned {

/// @audit public function `KEYCODE` came earlier from this external function
/// @audit internal function `_calculateFee` came earlier from this external function
/// @audit internal function `_safeTransfer` came earlier from this external function
/// @audit internal function `_calculatePaymentProRata` came earlier from this external function
/// @audit internal function `_settlePaymentProRata` came earlier from this external function
/// @audit internal function `_settlePaymentInFull` came earlier from this external function
/// @audit internal function `_settlePayment` came earlier from this external function
/// @audit internal function `_decreaseDeposit` came earlier from this external function
/// @audit internal function `_increaseDeposit` came earlier from this external function
337:     function settlePaymentBatch(

/// @audit public function `KEYCODE` came earlier from this external function
/// @audit internal function `_calculateFee` came earlier from this external function
/// @audit internal function `_safeTransfer` came earlier from this external function
/// @audit internal function `_calculatePaymentProRata` came earlier from this external function
/// @audit internal function `_settlePaymentProRata` came earlier from this external function
/// @audit internal function `_settlePaymentInFull` came earlier from this external function
/// @audit internal function `_settlePayment` came earlier from this external function
/// @audit internal function `_decreaseDeposit` came earlier from this external function
/// @audit internal function `_increaseDeposit` came earlier from this external function
361:     function increaseDeposit(

/// @audit public function `KEYCODE` came earlier from this external function
/// @audit internal function `_calculateFee` came earlier from this external function
/// @audit internal function `_safeTransfer` came earlier from this external function
/// @audit internal function `_calculatePaymentProRata` came earlier from this external function
/// @audit internal function `_settlePaymentProRata` came earlier from this external function
/// @audit internal function `_settlePaymentInFull` came earlier from this external function
/// @audit internal function `_settlePayment` came earlier from this external function
/// @audit internal function `_decreaseDeposit` came earlier from this external function
/// @audit internal function `_increaseDeposit` came earlier from this external function
380:     function setFee(uint256 feeNumerator) external onlyByProxy permissioned {

/// @audit public function `KEYCODE` came earlier from this external function
/// @audit internal function `_calculateFee` came earlier from this external function
/// @audit internal function `_safeTransfer` came earlier from this external function
/// @audit internal function `_calculatePaymentProRata` came earlier from this external function
/// @audit internal function `_settlePaymentProRata` came earlier from this external function
/// @audit internal function `_settlePaymentInFull` came earlier from this external function
/// @audit internal function `_settlePayment` came earlier from this external function
/// @audit internal function `_decreaseDeposit` came earlier from this external function
/// @audit internal function `_increaseDeposit` came earlier from this external function
397:     function skim(address token, address to) external onlyByProxy permissioned {

/// @audit public function `KEYCODE` came earlier from this external function
/// @audit internal function `_calculateFee` came earlier from this external function
/// @audit internal function `_safeTransfer` came earlier from this external function
/// @audit internal function `_calculatePaymentProRata` came earlier from this external function
/// @audit internal function `_settlePaymentProRata` came earlier from this external function
/// @audit internal function `_settlePaymentInFull` came earlier from this external function
/// @audit internal function `_settlePayment` came earlier from this external function
/// @audit internal function `_decreaseDeposit` came earlier from this external function
/// @audit internal function `_increaseDeposit` came earlier from this external function
420:     function upgrade(address newImplementation) external onlyByProxy permissioned {

/// @audit public function `KEYCODE` came earlier from this external function
/// @audit internal function `_calculateFee` came earlier from this external function
/// @audit internal function `_safeTransfer` came earlier from this external function
/// @audit internal function `_calculatePaymentProRata` came earlier from this external function
/// @audit internal function `_settlePaymentProRata` came earlier from this external function
/// @audit internal function `_settlePaymentInFull` came earlier from this external function
/// @audit internal function `_settlePayment` came earlier from this external function
/// @audit internal function `_decreaseDeposit` came earlier from this external function
/// @audit internal function `_increaseDeposit` came earlier from this external function
429:     function freeze() external onlyByProxy permissioned {

```

```solidity
File: src/modules/Storage.sol

/// @audit public function `KEYCODE` came earlier from this external function
118:     function isRentedOut(

/// @audit public function `KEYCODE` came earlier from this external function
135:     function contractToHook(address to) external view returns (address) {

/// @audit public function `KEYCODE` came earlier from this external function
149:     function hookOnTransaction(address hook) external view returns (bool) {

/// @audit public function `KEYCODE` came earlier from this external function
159:     function hookOnStart(address hook) external view returns (bool) {

/// @audit public function `KEYCODE` came earlier from this external function
169:     function hookOnStop(address hook) external view returns (bool) {

/// @audit public function `KEYCODE` came earlier from this external function
189:     function addRentals(

/// @audit public function `KEYCODE` came earlier from this external function
216:     function removeRentals(

/// @audit public function `KEYCODE` came earlier from this external function
244:     function removeRentalsBatch(

/// @audit public function `KEYCODE` came earlier from this external function
274:     function addRentalSafe(address safe) external onlyByProxy permissioned {

/// @audit public function `KEYCODE` came earlier from this external function
294:     function updateHookPath(address to, address hook) external onlyByProxy permissioned {

/// @audit public function `KEYCODE` came earlier from this external function
313:     function updateHookStatus(

/// @audit public function `KEYCODE` came earlier from this external function
334:     function toggleWhitelistDelegate(

/// @audit public function `KEYCODE` came earlier from this external function
347:     function toggleWhitelistExtension(

/// @audit public function `KEYCODE` came earlier from this external function
360:     function upgrade(address newImplementation) external onlyByProxy permissioned {

/// @audit public function `KEYCODE` came earlier from this external function
369:     function freeze() external onlyByProxy permissioned {

```

```solidity
File: src/packages/Reclaimer.sol

/// @audit private function `_transferERC721` came earlier from this external function
/// @audit private function `_transferERC1155` came earlier from this external function
71:     function reclaimRentalOrder(RentalOrder calldata rentalOrder) external {

```

```solidity
File: src/policies/Create.sol

/// @audit internal function `_emitRentalOrderStarted` came earlier from this external function
/// @audit internal function `_processBaseOrderOffer` came earlier from this external function
/// @audit internal function `_processPayOrderOffer` came earlier from this external function
/// @audit internal function `_processBaseOrderConsideration` came earlier from this external function
/// @audit internal function `_processPayeeOrderConsideration` came earlier from this external function
/// @audit internal function `_convertToItems` came earlier from this external function
/// @audit internal function `_addHooks` came earlier from this external function
/// @audit internal function `_rentFromZone` came earlier from this external function
/// @audit internal function `_isValidOrderMetadata` came earlier from this external function
/// @audit internal function `_isValidSafeOwner` came earlier from this external function
/// @audit internal function `_checkExpectedRecipient` came earlier from this external function
/// @audit internal function `_executionInvariantChecks` came earlier from this external function
733:     function validateOrder(

```

```solidity
File: src/policies/Guard.sol

/// @audit private function `_loadValueFromCalldata` came earlier from this external function
/// @audit private function `_revertSelectorOnActiveRental` came earlier from this external function
/// @audit private function `_revertNonWhitelistedExtension` came earlier from this external function
/// @audit private function `_forwardToHook` came earlier from this external function
/// @audit private function `_checkTransaction` came earlier from this external function
309:     function checkTransaction(

/// @audit private function `_loadValueFromCalldata` came earlier from this external function
/// @audit private function `_revertSelectorOnActiveRental` came earlier from this external function
/// @audit private function `_revertNonWhitelistedExtension` came earlier from this external function
/// @audit private function `_forwardToHook` came earlier from this external function
/// @audit private function `_checkTransaction` came earlier from this external function
353:     function checkAfterExecution(bytes32 txHash, bool success) external override {}

/// @audit private function `_loadValueFromCalldata` came earlier from this external function
/// @audit private function `_revertSelectorOnActiveRental` came earlier from this external function
/// @audit private function `_revertNonWhitelistedExtension` came earlier from this external function
/// @audit private function `_forwardToHook` came earlier from this external function
/// @audit private function `_checkTransaction` came earlier from this external function
362:     function updateHookPath(address to, address hook) external onlyRole("GUARD_ADMIN") {

/// @audit private function `_loadValueFromCalldata` came earlier from this external function
/// @audit private function `_revertSelectorOnActiveRental` came earlier from this external function
/// @audit private function `_revertNonWhitelistedExtension` came earlier from this external function
/// @audit private function `_forwardToHook` came earlier from this external function
/// @audit private function `_checkTransaction` came earlier from this external function
373:     function updateHookStatus(

```

```solidity
File: src/policies/Stop.sol

/// @audit internal function `_emitRentalOrderStopped` came earlier from this external function
/// @audit internal function `_validateRentalCanBeStoped` came earlier from this external function
/// @audit internal function `_reclaimRentedItems` came earlier from this external function
/// @audit internal function `_removeHooks` came earlier from this external function
265:     function stopRent(RentalOrder calldata order) external {

/// @audit internal function `_emitRentalOrderStopped` came earlier from this external function
/// @audit internal function `_validateRentalCanBeStoped` came earlier from this external function
/// @audit internal function `_reclaimRentedItems` came earlier from this external function
/// @audit internal function `_removeHooks` came earlier from this external function
313:     function stopRentBatch(RentalOrder[] calldata orders) external {

```

</details>


<a name="NC-27"></a> 
### [NC-27] Functions and modifiers should be named in mixedCase style
As the [Solidity Style Guide](https://docs.soliditylang.org/en/v0.8.21/style-guide.html#function-names) suggests: functions and modifiers should be named in mixedCase style.

*There are <b>9</b> instances of this issue:*
```solidity
File: src/Kernel.sol

90:     function KEYCODE() public pure virtual returns (Keycode);

100:     function VERSION() external pure virtual returns (uint8 major, uint8 minor) {}

106:     function INIT() external virtual onlyKernel {}

```

```solidity
File: src/modules/PaymentEscrow.sol

58:     function MODULE_PROXY_INSTANTIATION(

68:     function VERSION() external pure override returns (uint8 major, uint8 minor) {

75:     function KEYCODE() public pure override returns (Keycode) {

```

```solidity
File: src/modules/Storage.sol

86:     function MODULE_PROXY_INSTANTIATION(

96:     function VERSION() external pure override returns (uint8 major, uint8 minor) {

103:     function KEYCODE() public pure override returns (Keycode) {

```


<a name="NC-28"></a> 
### [NC-28] Functions with array parameters should have length checks in place

<details>
<summary>
There are <b>12</b> instances (click to show):
</summary>

```solidity
File: src/modules/PaymentEscrow.sol

/// @audit `items`
215:     function _settlePayment(

/// @audit `orders`
337:     function settlePaymentBatch(

```

```solidity
File: src/modules/Storage.sol

/// @audit `rentalAssetUpdates`
189:     function addRentals(

/// @audit `rentalAssetUpdates`
216:     function removeRentals(

/// @audit `orderHashes`
/// @audit `rentalAssetUpdates`
244:     function removeRentalsBatch(

```

```solidity
File: src/policies/Create.sol

/// @audit `rentalItems`
195:     function _processBaseOrderOffer(

/// @audit `rentalItems`
/// @audit `offers`
247:     function _processPayOrderOffer(

/// @audit `rentalItems`
326:     function _processBaseOrderConsideration(

/// @audit `considerations`
367:     function _processPayeeOrderConsideration(

/// @audit `hooks`
/// @audit `offerItems`
464:     function _addHooks(

/// @audit `executions`
691:     function _executionInvariantChecks(

```

```solidity
File: src/policies/Stop.sol

/// @audit `hooks`
/// @audit `rentalItems`
194:     function _removeHooks(

```

</details>


<a name="NC-29"></a> 
### [NC-29] High cyclomatic complexity
Consider breaking down these blocks into more manageable units, by splitting things into utility functions, by reducing nesting, and by using early returns

*There is one instance of this issue:*
```solidity
File: src/policies/Guard.sol

/// @audit Number of blocks: 13
195:     function _checkTransaction(address from, address to, bytes memory data) private view {

```


<a name="NC-30"></a> 
### [NC-30] Variable names for `immutable`s should use CONSTANT_CASE
For `immutable` variable names, each word should use all capital letters, with underscores separating each word (CONSTANT_CASE)

*There are <b>6</b> instances of this issue:*
```solidity
File: src/packages/Reclaimer.sol

17:     address private immutable original;

```

```solidity
File: src/policies/Factory.sol

31:     Stop public immutable stopPolicy;

32:     Guard public immutable guardPolicy;

35:     TokenCallbackHandler public immutable fallbackHandler;

36:     SafeProxyFactory public immutable safeProxyFactory;

37:     SafeL2 public immutable safeSingleton;

```


<a name="NC-31"></a> 
### [NC-31] Inconsistent spacing in comments
Some lines use `// x` and some use `//x`. The instances below point out the usages that don't follow the majority, within each file

<details>
<summary>
There are <b>62</b> instances (click to show):
</summary>

```solidity
File: src/Kernel.sol

14: /////////////////////////////////////////////////////////////////////////////////

16: /////////////////////////////////////////////////////////////////////////////////

197: /////////////////////////////////////////////////////////////////////////////////

199: /////////////////////////////////////////////////////////////////////////////////

232:     /////////////////////////////////////////////////////////////////////////////////

234:     /////////////////////////////////////////////////////////////////////////////////

247:     /////////////////////////////////////////////////////////////////////////////////

249:     /////////////////////////////////////////////////////////////////////////////////

267:     /////////////////////////////////////////////////////////////////////////////////

269:     /////////////////////////////////////////////////////////////////////////////////

347:     /////////////////////////////////////////////////////////////////////////////////

349:     /////////////////////////////////////////////////////////////////////////////////

571:             //emit Events.PermissionsUpdated(

576:             //);

```

```solidity
File: src/modules/PaymentEscrow.sol

41:     /////////////////////////////////////////////////////////////////////////////////

43:     /////////////////////////////////////////////////////////////////////////////////

79:     /////////////////////////////////////////////////////////////////////////////////

81:     /////////////////////////////////////////////////////////////////////////////////

309:     /////////////////////////////////////////////////////////////////////////////////

311:     /////////////////////////////////////////////////////////////////////////////////

```

```solidity
File: src/modules/Storage.sol

15:     /////////////////////////////////////////////////////////////////////////////////

17:     /////////////////////////////////////////////////////////////////////////////////

28:     /////////////////////////////////////////////////////////////////////////////////

30:     /////////////////////////////////////////////////////////////////////////////////

38:     /////////////////////////////////////////////////////////////////////////////////

40:     /////////////////////////////////////////////////////////////////////////////////

49:     /////////////////////////////////////////////////////////////////////////////////

51:     /////////////////////////////////////////////////////////////////////////////////

69:     /////////////////////////////////////////////////////////////////////////////////

71:     /////////////////////////////////////////////////////////////////////////////////

107:     /////////////////////////////////////////////////////////////////////////////////

109:     /////////////////////////////////////////////////////////////////////////////////

174:     /////////////////////////////////////////////////////////////////////////////////

176:     /////////////////////////////////////////////////////////////////////////////////

```

```solidity
File: src/policies/Admin.sol

16:     /////////////////////////////////////////////////////////////////////////////////

18:     /////////////////////////////////////////////////////////////////////////////////

89:     /////////////////////////////////////////////////////////////////////////////////

91:     /////////////////////////////////////////////////////////////////////////////////

```

```solidity
File: src/policies/Create.sol

48:     /////////////////////////////////////////////////////////////////////////////////

50:     /////////////////////////////////////////////////////////////////////////////////

108:     /////////////////////////////////////////////////////////////////////////////////

110:     /////////////////////////////////////////////////////////////////////////////////

154:     /////////////////////////////////////////////////////////////////////////////////

156:     /////////////////////////////////////////////////////////////////////////////////

716:     /////////////////////////////////////////////////////////////////////////////////

718:     /////////////////////////////////////////////////////////////////////////////////

```

```solidity
File: src/policies/Factory.sol

23:     /////////////////////////////////////////////////////////////////////////////////

25:     /////////////////////////////////////////////////////////////////////////////////

105:     /////////////////////////////////////////////////////////////////////////////////

107:     /////////////////////////////////////////////////////////////////////////////////

```

```solidity
File: src/policies/Guard.sol

40:     /////////////////////////////////////////////////////////////////////////////////

42:     /////////////////////////////////////////////////////////////////////////////////

96:     /////////////////////////////////////////////////////////////////////////////////

98:     /////////////////////////////////////////////////////////////////////////////////

295:     /////////////////////////////////////////////////////////////////////////////////

297:     /////////////////////////////////////////////////////////////////////////////////

```

```solidity
File: src/policies/Stop.sol

39:     /////////////////////////////////////////////////////////////////////////////////

41:     /////////////////////////////////////////////////////////////////////////////////

101:     /////////////////////////////////////////////////////////////////////////////////

103:     /////////////////////////////////////////////////////////////////////////////////

252:     /////////////////////////////////////////////////////////////////////////////////

254:     /////////////////////////////////////////////////////////////////////////////////

```

</details>


<a name="NC-32"></a> 
### [NC-32] Large or complicated code bases should implement invariant tests
This includes: large code bases, or code with lots of inline-assembly, complicated math, or complicated interactions between multiple contracts. Invariant fuzzers such as Echidna require the test writer to come up with invariants which should not be violated under any circumstances, and the fuzzer tests various inputs and function calls to ensure that the invariants always hold. Even code with 100% code coverage can still have bugs due to the order of the operations a user performs, and invariant fuzzers may help significantly.

*There is one instance of this issue:*
```solidity

Global finding

```


<a name="NC-33"></a> 
### [NC-33] Large numeric literals should use underscores for readability
Large hardcoded numbers in code can be difficult to read. Consider using underscores for number literals to improve readability (e.g `1234567` -> `1_234_567`). Consider using an underscore for every third digit from the right.

*There are <b>4</b> instances of this issue:*
```solidity
File: src/modules/PaymentEscrow.sol

90:         return (amount * fee) / 10000;

138:         uint256 numerator = (amount * elapsedTime) * 1000;

142:         renterAmount = ((numerator / totalTime) + 500) / 1000;

382:         if (feeNumerator > 10000) {

```


<a name="NC-34"></a> 
### [NC-34] Long functions should be refactored into multiple, smaller, functions

*There are <b>10</b> instances of this issue:*
```solidity
File: src/modules/PaymentEscrow.sol

/// @audit 68 lines
215:     function _settlePayment(
             Item[] calldata items,
             OrderType orderType,
             address lender,
             address renter,
             uint256 start,
             uint256 end
         ) internal {

```

```solidity
File: src/packages/Accumulator.sol

/// @audit 53 lines
32:     function _insert(
            bytes memory rentalAssets,
            RentalId rentalId,
            uint256 rentalAssetAmount
        ) internal pure {

```

```solidity
File: src/packages/Signer.sol

/// @audit 69 lines
339:     function _deriveRentalTypehashes()
             internal
             pure
             returns (
                 bytes32 itemTypeHash,
                 bytes32 hookTypeHash,
                 bytes32 rentalOrderTypeHash,
                 bytes32 orderFulfillmentTypeHash,
                 bytes32 orderMetadataTypeHash,
                 bytes32 rentPayloadTypeHash
             )
         {

```

```solidity
File: src/policies/Create.sol

/// @audit 67 lines
247:     function _processPayOrderOffer(
             Item[] memory rentalItems,
             SpentItem[] memory offers,
             uint256 startIndex
         ) internal pure {

/// @audit 56 lines
464:     function _addHooks(
             Hook[] memory hooks,
             SpentItem[] memory offerItems,
             address rentalWallet
         ) internal {

/// @audit 87 lines
530:     function _rentFromZone(
             RentPayload memory payload,
             SeaportPayload memory seaportPayload
         ) internal {

```

```solidity
File: src/policies/Factory.sol

/// @audit 55 lines
138:     function deployRentalSafe(
             address[] calldata owners,
             uint256 threshold
         ) external returns (address safe) {

```

```solidity
File: src/policies/Guard.sol

/// @audit 98 lines
195:     function _checkTransaction(address from, address to, bytes memory data) private view {

```

```solidity
File: src/policies/Stop.sol

/// @audit 56 lines
194:     function _removeHooks(
             Hook[] calldata hooks,
             Item[] calldata rentalItems,
             address rentalWallet
         ) internal {

/// @audit 51 lines
313:     function stopRentBatch(RentalOrder[] calldata orders) external {

```


<a name="NC-35"></a> 
### [NC-35] Magic numbers should be replaced with constants
Magic numbers are hard-coded values in code that can make it difficult for developers and maintainers to understand the code, and can also cause confusion or errors. To improve the readability and maintainability of code, it is recommended to replace magic numbers with constants that have good readability.

<details>
<summary>
There are <b>24</b> instances (click to show):
</summary>

```solidity
File: src/modules/PaymentEscrow.sol

// @audit `10000`
90:         return (amount * fee) / 10000;

// @audit `1000`
138:         uint256 numerator = (amount * elapsedTime) * 1000;

// @audit `500`
142:         renterAmount = ((numerator / totalTime) + 500) / 1000;

// @audit `1000`
142:         renterAmount = ((numerator / totalTime) + 500) / 1000;

// @audit `10000`
382:         if (feeNumerator > 10000) {

```

```solidity
File: src/modules/Storage.sol

// @audit `2`
161:         return uint8(2) & hookStatus[hook] != 0;

// @audit `4`
171:         return uint8(4) & hookStatus[hook] != 0;

// @audit `7`
321:         if (bitmap > uint8(7))

```

```solidity
File: src/policies/Admin.sol

// @audit `2`
46:         dependencies = new Keycode[](2);

// @audit `8`
71:         requests = new Permissions[](8);

// @audit `2`
80:         requests[2] = Permissions(toKeycode("STORE"), STORE.upgrade.selector);

// @audit `3`
81:         requests[3] = Permissions(toKeycode("STORE"), STORE.freeze.selector);

// @audit `4`
83:         requests[4] = Permissions(toKeycode("ESCRW"), ESCRW.skim.selector);

// @audit `5`
84:         requests[5] = Permissions(toKeycode("ESCRW"), ESCRW.setFee.selector);

// @audit `6`
85:         requests[6] = Permissions(toKeycode("ESCRW"), ESCRW.upgrade.selector);

// @audit `7`
86:         requests[7] = Permissions(toKeycode("ESCRW"), ESCRW.freeze.selector);

```

```solidity
File: src/policies/Create.sol

// @audit `2`
78:         dependencies = new Keycode[](2);

// @audit `2`
103:         requests = new Permissions[](2);

```

```solidity
File: src/policies/Guard.sol

// @audit `2`
91:         requests = new Permissions[](2);

// @audit `4`
329:         if (data.length < 4) {

```

```solidity
File: src/policies/Stop.sol

// @audit `2`
69:         dependencies = new Keycode[](2);

// @audit `4`
94:         requests = new Permissions[](4);

// @audit `2`
97:         requests[2] = Permissions(toKeycode("ESCRW"), ESCRW.settlePayment.selector);

// @audit `3`
98:         requests[3] = Permissions(toKeycode("ESCRW"), ESCRW.settlePaymentBatch.selector);

```

</details>


<a name="NC-36"></a> 
### [NC-36] Missing contract existence checks before low-level calls
Low-level calls return success if there is no code present at the specified address. In addition to the zero-address checks, add a check to verify that `<address>.code.length > 0`

*There is one instance of this issue:*
```solidity
File: src/modules/PaymentEscrow.sol

102:         (bool success, bytes memory data) = token.call(

```


<a name="NC-37"></a> 
### [NC-37] Named mappings are recommended
[Named mappings](https://docs.soliditylang.org/en/v0.8.18/types.html#mapping-types) (with syntax `mapping(KeyType KeyName? => ValueType ValueName?)`) are recommended.It can make the mapping variables clearer, more readable and easier to maintain.

*There are <b>9</b> instances of this issue:*
```solidity
File: src/Create2Deployer.sol

16:     mapping(address => bool) public deployed;

```

```solidity
File: src/Kernel.sol

213:     mapping(Keycode => Module) public getModuleForKeycode; // get contract for module keycode.

214:     mapping(Module => Keycode) public getKeycodeForModule; // get module keycode for contract.

217:     mapping(Keycode => Policy[]) public moduleDependents;

218:     mapping(Keycode => mapping(Policy => uint256)) public getDependentIndex;

221:     mapping(Keycode => mapping(Policy => mapping(bytes4 => bool)))

226:     mapping(Policy => uint256) public getPolicyIndex;

229:     mapping(address => mapping(Role => bool)) public hasRole;

230:     mapping(Role => bool) public isRole;

```


<a name="NC-38"></a> 
### [NC-38] Named imports of parent contracts are missing

*There are <b>4</b> instances of this issue:*
```solidity
File: src/Kernel.sol

/// @audit `KernelAdapter`
64: abstract contract Module is KernelAdapter {

/// @audit `KernelAdapter`
114: abstract contract Policy is KernelAdapter {

```

```solidity
File: src/modules/PaymentEscrow.sol

/// @audit `PaymentEscrowBase`
37: contract PaymentEscrow is Proxiable, Module, PaymentEscrowBase {

```

```solidity
File: src/modules/Storage.sol

/// @audit `StorageBase`
66: contract Storage is Proxiable, Module, StorageBase {

```


<a name="NC-39"></a> 
### [NC-39] Missing NatSpec `@author` from contract declaration
Some contract definitions have an incomplete NatSpec: add a `@author` notation to improve the code documentation.

<details>
<summary>
There are <b>17</b> instances (click to show):
</summary>

```solidity
File: src/Create2Deployer.sol

14: contract Create2Deployer {

```

```solidity
File: src/Kernel.sol

23: abstract contract KernelAdapter {

64: abstract contract Module is KernelAdapter {

114: abstract contract Policy is KernelAdapter {

206: contract Kernel {

```

```solidity
File: src/modules/PaymentEscrow.sol

23: contract PaymentEscrowBase {

37: contract PaymentEscrow is Proxiable, Module, PaymentEscrowBase {

```

```solidity
File: src/modules/Storage.sol

14: contract StorageBase {

66: contract Storage is Proxiable, Module, StorageBase {

```

```solidity
File: src/packages/Accumulator.sol

12: abstract contract Accumulator {

```

```solidity
File: src/packages/Reclaimer.sol

15: abstract contract Reclaimer {

```

```solidity
File: src/packages/Signer.sol

21: abstract contract Signer {

```

```solidity
File: src/policies/Admin.sol

15: contract Admin is Policy {

```

```solidity
File: src/policies/Create.sol

41: contract Create is Policy, Signer, Zone, Accumulator {

```

```solidity
File: src/policies/Factory.sol

22: contract Factory is Policy {

```

```solidity
File: src/policies/Guard.sol

39: contract Guard is Policy, BaseGuard {

```

```solidity
File: src/policies/Stop.sol

34: contract Stop is Policy, Signer, Reclaimer, Accumulator {

```

</details>


<a name="NC-40"></a> 
### [NC-40] Missing NatSpec `@dev` from contract declaration
Some contract definitions have an incomplete NatSpec: add a `@dev` notation to improve the code documentation.

<details>
<summary>
There are <b>17</b> instances (click to show):
</summary>

```solidity
File: src/Create2Deployer.sol

14: contract Create2Deployer {

```

```solidity
File: src/Kernel.sol

23: abstract contract KernelAdapter {

64: abstract contract Module is KernelAdapter {

114: abstract contract Policy is KernelAdapter {

206: contract Kernel {

```

```solidity
File: src/modules/PaymentEscrow.sol

23: contract PaymentEscrowBase {

37: contract PaymentEscrow is Proxiable, Module, PaymentEscrowBase {

```

```solidity
File: src/modules/Storage.sol

14: contract StorageBase {

66: contract Storage is Proxiable, Module, StorageBase {

```

```solidity
File: src/packages/Accumulator.sol

12: abstract contract Accumulator {

```

```solidity
File: src/packages/Reclaimer.sol

15: abstract contract Reclaimer {

```

```solidity
File: src/packages/Signer.sol

21: abstract contract Signer {

```

```solidity
File: src/policies/Admin.sol

15: contract Admin is Policy {

```

```solidity
File: src/policies/Create.sol

41: contract Create is Policy, Signer, Zone, Accumulator {

```

```solidity
File: src/policies/Factory.sol

22: contract Factory is Policy {

```

```solidity
File: src/policies/Guard.sol

39: contract Guard is Policy, BaseGuard {

```

```solidity
File: src/policies/Stop.sol

34: contract Stop is Policy, Signer, Reclaimer, Accumulator {

```

</details>


<a name="NC-41"></a> 
### [NC-41] Missing NatSpec `@dev` from function declaration
Some function definitions have an incomplete NatSpec: add a `@dev` notation to improve the code documentation.

<details>
<summary>
There are <b>70</b> instances (click to show):
</summary>

```solidity
File: src/Create2Deployer.sol

32:     function deploy(

84:     function getCreate2Address(

107:     function generateSaltWithSender(

```

```solidity
File: src/Kernel.sol

54:     function changeKernel(Kernel newKernel_) external onlyKernel {

90:     function KEYCODE() public pure virtual returns (Keycode);

100:     function VERSION() external pure virtual returns (uint8 major, uint8 minor) {}

106:     function INIT() external virtual onlyKernel {}

148:     function configureDependencies()

166:     function requestPermissions()

192:     function setActiveStatus(bool activate_) external onlyKernel {

```

```solidity
File: src/modules/PaymentEscrow.sol

58:     function MODULE_PROXY_INSTANTIATION(

68:     function VERSION() external pure override returns (uint8 major, uint8 minor) {

75:     function KEYCODE() public pure override returns (Keycode) {

320:     function settlePayment(RentalOrder calldata order) external onlyByProxy permissioned {

337:     function settlePaymentBatch(

361:     function increaseDeposit(

380:     function setFee(uint256 feeNumerator) external onlyByProxy permissioned {

397:     function skim(address token, address to) external onlyByProxy permissioned {

420:     function upgrade(address newImplementation) external onlyByProxy permissioned {

429:     function freeze() external onlyByProxy permissioned {

```

```solidity
File: src/modules/Storage.sol

86:     function MODULE_PROXY_INSTANTIATION(

96:     function VERSION() external pure override returns (uint8 major, uint8 minor) {

103:     function KEYCODE() public pure override returns (Keycode) {

118:     function isRentedOut(

135:     function contractToHook(address to) external view returns (address) {

149:     function hookOnTransaction(address hook) external view returns (bool) {

159:     function hookOnStart(address hook) external view returns (bool) {

169:     function hookOnStop(address hook) external view returns (bool) {

189:     function addRentals(

216:     function removeRentals(

244:     function removeRentalsBatch(

274:     function addRentalSafe(address safe) external onlyByProxy permissioned {

294:     function updateHookPath(address to, address hook) external onlyByProxy permissioned {

313:     function updateHookStatus(

334:     function toggleWhitelistDelegate(

347:     function toggleWhitelistExtension(

360:     function upgrade(address newImplementation) external onlyByProxy permissioned {

369:     function freeze() external onlyByProxy permissioned {

```

```solidity
File: src/packages/Reclaimer.sol

71:     function reclaimRentalOrder(RentalOrder calldata rentalOrder) external {

```

```solidity
File: src/policies/Admin.sol

40:     function configureDependencies()

64:     function requestPermissions()

99:     function toggleWhitelistDelegate(

113:     function toggleWhitelistExtension(

126:     function upgradeStorage(address newImplementation) external onlyRole("ADMIN_ADMIN") {

134:     function freezeStorage() external onlyRole("ADMIN_ADMIN") {

144:     function upgradePaymentEscrow(

154:     function freezePaymentEscrow() external onlyRole("ADMIN_ADMIN") {

164:     function skim(address token, address to) external onlyRole("ADMIN_ADMIN") {

173:     function setFee(uint256 feeNumerator) external onlyRole("ADMIN_ADMIN") {

```

```solidity
File: src/policies/Create.sol

72:     function configureDependencies()

96:     function requestPermissions()

117:     function domainSeparator() external view returns (bytes32) {

126:     function getRentalOrderHash(

137:     function getRentPayloadHash(

148:     function getOrderMetadataHash(

733:     function validateOrder(

```

```solidity
File: src/policies/Factory.sol

73:     function configureDependencies()

94:     function requestPermissions()

122:     function initializeRentalSafe(address _stopPolicy, address _guardPolicy) external {

138:     function deployRentalSafe(

```

```solidity
File: src/policies/Guard.sol

63:     function configureDependencies()

84:     function requestPermissions()

309:     function checkTransaction(

353:     function checkAfterExecution(bytes32 txHash, bool success) external override {}

362:     function updateHookPath(address to, address hook) external onlyRole("GUARD_ADMIN") {

373:     function updateHookStatus(

```

```solidity
File: src/policies/Stop.sol

63:     function configureDependencies()

87:     function requestPermissions()

265:     function stopRent(RentalOrder calldata order) external {

313:     function stopRentBatch(RentalOrder[] calldata orders) external {

```

</details>


<a name="NC-42"></a> 
### [NC-42] Public variable declarations should have NatSpec descriptions

<details>
<summary>
There are <b>37</b> instances (click to show):
</summary>

```solidity
File: src/Create2Deployer.sol

16:     mapping(address => bool) public deployed;

```

```solidity
File: src/Kernel.sol

25:     Kernel public kernel;

116:     bool public isActive;

208:     address public executor;

209:     address public admin;

212:     Keycode[] public allKeycodes;

213:     mapping(Keycode => Module) public getModuleForKeycode; // get contract for module keycode.

214:     mapping(Module => Keycode) public getKeycodeForModule; // get module keycode for contract.

217:     mapping(Keycode => Policy[]) public moduleDependents;

218:     mapping(Keycode => mapping(Policy => uint256)) public getDependentIndex;

221:     mapping(Keycode => mapping(Policy => mapping(bytes4 => bool)))

225:     Policy[] public activePolicies;

226:     mapping(Policy => uint256) public getPolicyIndex;

229:     mapping(address => mapping(Role => bool)) public hasRole;

230:     mapping(Role => bool) public isRole;

```

```solidity
File: src/modules/PaymentEscrow.sol

25:     mapping(address token => uint256 amount) public balanceOf;

28:     uint256 public fee;

```

```solidity
File: src/modules/Storage.sol

20:     mapping(bytes32 orderHash => bool isActive) public orders;

26:     mapping(RentalId itemId => uint256 amount) public rentedAssets;

33:     mapping(address safe => uint256 nonce) public deployedSafes;

36:     uint256 public totalSafes;

47:     mapping(address hook => uint8 enabled) public hookStatus;

55:     mapping(address delegate => bool isWhitelisted) public whitelistedDelegates;

58:     mapping(address extension => bool isWhitelisted) public whitelistedExtensions;

```

```solidity
File: src/policies/Admin.sol

21:     Storage public STORE;

22:     PaymentEscrow public ESCRW;

```

```solidity
File: src/policies/Create.sol

53:     Storage public STORE;

54:     PaymentEscrow public ESCRW;

```

```solidity
File: src/policies/Factory.sol

28:     Storage public STORE;

31:     Stop public immutable stopPolicy;

32:     Guard public immutable guardPolicy;

35:     TokenCallbackHandler public immutable fallbackHandler;

36:     SafeProxyFactory public immutable safeProxyFactory;

37:     SafeL2 public immutable safeSingleton;

```

```solidity
File: src/policies/Guard.sol

45:     Storage public STORE;

```

```solidity
File: src/policies/Stop.sol

44:     Storage public STORE;

45:     PaymentEscrow public ESCRW;

```

</details>


<a name="NC-43"></a> 
### [NC-43] Missing NatSpec `@notice` from function declaration
Some function definitions have an incomplete NatSpec: add a `@notice` notation to improve the code documentation.

<details>
<summary>
There are <b>70</b> instances (click to show):
</summary>

```solidity
File: src/Kernel.sol

33:     constructor(Kernel kernel_) {

71:     constructor(Kernel kernel_) KernelAdapter(kernel_) {}

124:     constructor(Kernel kernel_) KernelAdapter(kernel_) {}

180:     function getModuleAddress(Keycode keycode_) internal view returns (address) {

242:     constructor(address _executor, address _admin) {

277:     function executeAction(Actions action_, address target_) external onlyExecutor {

310:     function grantRole(Role role_, address addr_) public onlyAdmin {

333:     function revokeRole(Role role_, address addr_) public onlyAdmin {

356:     function _installModule(Module newModule_) internal {

383:     function _upgradeModule(Module newModule_) internal {

418:     function _activatePolicy(Policy policy_) internal {

457:     function _deactivatePolicy(Policy policy_) internal {

508:     function _migrateKernel(Kernel newKernel_) internal {

540:     function _reconfigurePolicies(Keycode keycode_) internal {

560:     function _setPolicyPermissions(

586:     function _pruneFromDependents(Policy policy_) internal {

```

```solidity
File: src/modules/PaymentEscrow.sol

51:     constructor(Kernel kernel_) Module(kernel_) {}

88:     function _calculateFee(uint256 amount) internal view returns (uint256) {

100:     function _safeTransfer(address token, address to, uint256 value) internal {

132:     function _calculatePaymentProRata(

159:     function _settlePaymentProRata(

190:     function _settlePaymentInFull(

215:     function _settlePayment(

292:     function _decreaseDeposit(address token, uint256 amount) internal {

304:     function _increaseDeposit(address token, uint256 amount) internal {

```

```solidity
File: src/modules/Storage.sol

79:     constructor(Kernel kernel_) Module(kernel_) {}

```

```solidity
File: src/packages/Accumulator.sol

32:     function _insert(

96:     function _convertToStatic(

```

```solidity
File: src/packages/Reclaimer.sol

22:     constructor() {

32:     function _transferERC721(Item memory item, address recipient) private {

42:     function _transferERC1155(Item memory item, address recipient) private {

```

```solidity
File: src/packages/Signer.sol

44:     constructor() {

76:     function _validateFulfiller(

94:     function _validateProtocolSignatureExpiration(uint256 expiration) internal view {

107:     function _recoverSignerFromPayload(

125:     function _deriveItemHash(Item memory item) internal view returns (bytes32) {

147:     function _deriveHookHash(Hook memory hook) internal view returns (bytes32) {

162:     function _deriveRentalOrderHash(

204:     function _deriveOrderFulfillmentHash(

218:     function _deriveOrderMetadataHash(

248:     function _deriveRentPayloadHash(

273:     function _deriveDomainSeparator(

298:     function _deriveTypehashes()

339:     function _deriveRentalTypehashes()

```

```solidity
File: src/policies/Admin.sol

29:     constructor(Kernel kernel_) Policy(kernel_) {}

```

```solidity
File: src/policies/Create.sol

61:     constructor(Kernel kernel_) Policy(kernel_) Signer() Zone() {}

165:     function _emitRentalOrderStarted(

195:     function _processBaseOrderOffer(

247:     function _processPayOrderOffer(

326:     function _processBaseOrderConsideration(

367:     function _processPayeeOrderConsideration(

411:     function _convertToItems(

464:     function _addHooks(

530:     function _rentFromZone(

626:     function _isValidOrderMetadata(

647:     function _isValidSafeOwner(address owner, address safe) internal view {

666:     function _checkExpectedRecipient(

691:     function _executionInvariantChecks(

```

```solidity
File: src/policies/Factory.sol

49:     constructor(

```

```solidity
File: src/policies/Guard.sol

52:     constructor(Kernel kernel_) Policy(kernel_) {}

108:     function _loadValueFromCalldata(

126:     function _revertSelectorOnActiveRental(

143:     function _revertNonWhitelistedExtension(address extension) private view {

159:     function _forwardToHook(

195:     function _checkTransaction(address from, address to, bytes memory data) private view {

```

```solidity
File: src/policies/Stop.sol

52:     constructor(Kernel kernel_) Policy(kernel_) Signer() Reclaimer() {}

111:     function _emitRentalOrderStopped(bytes32 seaportOrderHash, address stopper) internal {

126:     function _validateRentalCanBeStoped(

166:     function _reclaimRentedItems(RentalOrder memory order) internal {

194:     function _removeHooks(

```

</details>


<a name="NC-44"></a> 
### [NC-44] Missing NatSpec `@notice` from modifier declaration
Some modifier definitions have an incomplete NatSpec: add a `@notice` notation to improve the code documentation.

*There are <b>5</b> instances of this issue:*
```solidity
File: src/Kernel.sol

40:     modifier onlyKernel() {

77:     modifier permissioned() {

130:     modifier onlyRole(bytes32 role_) {

254:     modifier onlyExecutor() {

262:     modifier onlyAdmin() {

```


<a name="NC-45"></a> 
### [NC-45] Missing NatSpec `@param` from modifier declaration
Some modifier definitions have an incomplete NatSpec: add a `@param` notation to improve the code documentation.

*There is one instance of this issue:*
```solidity
File: src/Kernel.sol

130:     modifier onlyRole(bytes32 role_) {

```


<a name="NC-46"></a> 
### [NC-46] Missing NatSpec `@return` from function declaration
Some function definitions have an incomplete NatSpec: add a `@return` notation to improve the code documentation.

<details>
<summary>
There are <b>20</b> instances (click to show):
</summary>

```solidity
File: src/Create2Deployer.sol

107:     function generateSaltWithSender(
             address sender,
             bytes12 data
         ) public pure returns (bytes32 salt) {

```

```solidity
File: src/Kernel.sol

148:     function configureDependencies()
             external
             virtual
             onlyKernel
             returns (Keycode[] memory dependencies)
         {}

166:     function requestPermissions()
             external
             view
             virtual
             onlyKernel
             returns (Permissions[] memory requests)
         {}

180:     function getModuleAddress(Keycode keycode_) internal view returns (address) {

```

```solidity
File: src/modules/PaymentEscrow.sol

68:     function VERSION() external pure override returns (uint8 major, uint8 minor) {

75:     function KEYCODE() public pure override returns (Keycode) {

88:     function _calculateFee(uint256 amount) internal view returns (uint256) {

```

```solidity
File: src/modules/Storage.sol

96:     function VERSION() external pure override returns (uint8 major, uint8 minor) {

103:     function KEYCODE() public pure override returns (Keycode) {

118:     function isRentedOut(
             address recipient,
             address token,
             uint256 identifier
         ) external view returns (bool) {

135:     function contractToHook(address to) external view returns (address) {

149:     function hookOnTransaction(address hook) external view returns (bool) {

159:     function hookOnStart(address hook) external view returns (bool) {

169:     function hookOnStop(address hook) external view returns (bool) {

```

```solidity
File: src/packages/Signer.sol

107:     function _recoverSignerFromPayload(
             bytes32 payloadHash,
             bytes memory signature
         ) internal view returns (address) {

```

```solidity
File: src/policies/Create.sol

126:     function getRentalOrderHash(
             RentalOrder memory order
         ) external view returns (bytes32) {

137:     function getRentPayloadHash(
             RentPayload memory payload
         ) external view returns (bytes32) {

148:     function getOrderMetadataHash(
             OrderMetadata memory metadata
         ) external view returns (bytes32) {

411:     function _convertToItems(
             SpentItem[] memory offers,
             ReceivedItem[] memory considerations,
             OrderType orderType
         ) internal pure returns (Item[] memory items) {

```

```solidity
File: src/policies/Factory.sol

138:     function deployRentalSafe(
             address[] calldata owners,
             uint256 threshold
         ) external returns (address safe) {

```

</details>


<a name="NC-47"></a> 
### [NC-47] There is no need to initialize variables with 0
Since the variables are automatically set to 0 when created, it is redundant to initialize it with 0 again.

<details>
<summary>
There are <b>18</b> instances (click to show):
</summary>

```solidity
File: src/Kernel.sol

566:         for (uint256 i = 0; i < reqLength; ++i) {

```

```solidity
File: src/modules/PaymentEscrow.sol

231:         for (uint256 i = 0; i < items.length; ++i) {

341:         for (uint256 i = 0; i < orders.length; ++i) {

```

```solidity
File: src/modules/Storage.sol

197:         for (uint256 i = 0; i < rentalAssetUpdates.length; ++i) {

229:         for (uint256 i = 0; i < rentalAssetUpdates.length; ++i) {

249:         for (uint256 i = 0; i < orderHashes.length; ++i) {

260:         for (uint256 i = 0; i < rentalAssetUpdates.length; ++i) {

```

```solidity
File: src/packages/Accumulator.sol

120:         for (uint256 i = 0; i < rentalAssetUpdateLength; ++i) {

```

```solidity
File: src/packages/Reclaimer.sol

90:         for (uint256 i = 0; i < itemCount; ++i) {

```

```solidity
File: src/packages/Signer.sol

170:         for (uint256 i = 0; i < order.items.length; ++i) {

176:         for (uint256 i = 0; i < order.hooks.length; ++i) {

225:         for (uint256 i = 0; i < metadata.hooks.length; ++i) {

```

```solidity
File: src/policies/Create.sol

475:         for (uint256 i = 0; i < hooks.length; ++i) {

599:             for (uint256 i = 0; i < items.length; ++i) {

695:         for (uint256 i = 0; i < executions.length; ++i) {

```

```solidity
File: src/policies/Stop.sol

205:         for (uint256 i = 0; i < hooks.length; ++i) {

324:         for (uint256 i = 0; i < orders.length; ++i) {

333:             for (uint256 j = 0; j < orders[i].items.length; ++j) {

```

</details>


<a name="NC-48"></a> 
### [NC-48] Potential Re-org Attack Vector
The contract appears to deploy new contracts using the `new` keyword. In a re-org attack scenario, such deployments can be exploited by a malicious actor who might rewrite the blockchain's history and deploy the contract at an expected address.

Consider deploying the contract via `CREATE2` opcode with a specific salt that includes `msg.sender` and the existing contract address. This will ensure a predictable contract address, reducing the chances of such an attack.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/policies/Create.sol

563:             bytes memory rentalAssetUpdates = new bytes(0);

```

```solidity
File: src/policies/Stop.sol

272:         bytes memory rentalAssetUpdates = new bytes(0);

320:         bytes memory rentalAssetUpdates = new bytes(0);

```


<a name="NC-49"></a> 
### [NC-49] Put all system-wide constants in one file
Putting all the system-wide constants in a single file improves code readability, makes it easier to understand the basic configuration and limitations of the system, and makes maintenance easier.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/Create2Deployer.sol

19:     bytes1 constant create2_ff = 0xff;

```

```solidity
File: src/packages/Signer.sol

25:     string internal constant _NAME = "ReNFT-Rentals";

26:     string internal constant _VERSION = "1.0.0";

```


<a name="NC-50"></a> 
### [NC-50] Setters should prevent re-setting the same value
Not only is wasteful in terms of gas, but this is especially problematic when an event is emitted and the old and new values set are the same, as listeners might not expect this kind of scenario.

*There are <b>4</b> instances of this issue:*
```solidity
File: src/Kernel.sol

193:         isActive = activate_;

```

```solidity
File: src/modules/PaymentEscrow.sol

387:         fee = feeNumerator;

```

```solidity
File: src/modules/Storage.sol

302:         _contractToHook[to] = hook;

325:         hookStatus[hook] = bitmap;

```


<a name="NC-51"></a> 
### [NC-51] State variables should include comments
Consider adding some comments on critical state variables to explain what they are supposed to do: this will help for future code reviews.

<details>
<summary>
There are <b>14</b> instances (click to show):
</summary>

```solidity
File: src/packages/Reclaimer.sol

17:     address private immutable original;

```

```solidity
File: src/packages/Signer.sol

25:     string internal constant _NAME = "ReNFT-Rentals";

26:     string internal constant _VERSION = "1.0.0";

29:     bytes32 internal immutable _NAME_HASH;

30:     bytes32 internal immutable _VERSION_HASH;

31:     bytes32 internal immutable _EIP_712_DOMAIN_TYPEHASH;

32:     uint256 internal immutable _CHAIN_ID;

33:     bytes32 internal immutable _DOMAIN_SEPARATOR;

34:     bytes32 internal immutable _ITEM_TYPEHASH;

35:     bytes32 internal immutable _HOOK_TYPEHASH;

36:     bytes32 internal immutable _RENTAL_ORDER_TYPEHASH;

37:     bytes32 internal immutable _ORDER_FULFILLMENT_TYPEHASH;

38:     bytes32 internal immutable _ORDER_METADATA_TYPEHASH;

39:     bytes32 internal immutable _RENT_PAYLOAD_TYPEHASH;

```

</details>


<a name="NC-52"></a> 
### [NC-52] Lines are too long
The [solidity style guide](https://docs.soliditylang.org/en/v0.8.17/style-guide.html#maximum-line-length) recommends a maximum line length of 120 characters. Lines of code that are longer than 120 should be wrapped.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/packages/Signer.sol

363:             "RentalOrder(bytes32 seaportOrderHash,Item[] items,Hook[] hooks,uint8 orderType,address lender,address renter,address rentalWallet,uint256 startTimestamp,uint256 endTimestamp)"

390:                 "RentPayload(OrderFulfillment fulfillment,OrderMetadata metadata,uint256 expiration,address intendedFulfiller)"

```


<a name="NC-53"></a> 
### [NC-53] Typos

*There are <b>6</b> instances of this issue:*
```solidity
File: src/Create2Deployer.sol

/// @audit `addres`
30:      * @return deploymentAddress The addres of the deployed contract.

/// @audit `sendder`
99:      *         This function ties the deployment sendder to the salt of the CREATE2

```

```solidity
File: src/modules/PaymentEscrow.sol

/// @audit `renturn`
94:      * @dev Safe transfer for ERC20 tokens that do not consistently renturn true/false.

/// @audit `amoutn`
130:      * @return lenderAmount Payment amoutn to send to the lender.

/// @audit `ordesr`
335:      * @param orders Rental ordesr for which to settle payments.

```

```solidity
File: src/packages/Signer.sol

/// @audit `fulfilmment`
207:         // Derive and return the fulfilmment hash as specified by EIP-712

```


<a name="NC-54"></a> 
### [NC-54] Unsafe solidity low-level call can cause gas grief attack
Using the low-level calls of a solidity address can leave the contract open to gas grief attacks. These attacks occur when the called contract returns a large amount of data. So when calling an external contract, it is necessary to check the length of the return data before reading/copying it (using `returndatasize()`).

*There is one instance of this issue:*
```solidity
File: src/modules/PaymentEscrow.sol

102:         (bool success, bytes memory data) = token.call(

```


<a name="NC-55"></a> 
### [NC-55] Unused arguments should be removed or implemented
Some arguments are never used: if this is intentional, consider removing these arguments from the function. Otherwise, implement the missing logic accordingly.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/policies/Create.sol

/// @audit `zoneParams`
733:     function validateOrder(

```

```solidity
File: src/policies/Guard.sol

/// @audit `txHash`
/// @audit `success`
353:     function checkAfterExecution(bytes32 txHash, bool success) external override {}

```


<a name="NC-56"></a> 
### [NC-56] Unused named return
Declaring named returns, but not using them, is confusing to the reader. Consider either completely removing them (by declaring just the type without a name), or remove the return statement and do a variable assignment. This would improve the readability of the code, and it may also help reduce regressions during future code refactors.

*There are <b>6</b> instances of this issue:*
```solidity
File: src/Kernel.sol

/// @audit `major` not used
/// @audit `minor` not used
100:     function VERSION() external pure virtual returns (uint8 major, uint8 minor) {}

/// @audit `dependencies` not used
148:     function configureDependencies()
             external
             virtual
             onlyKernel
             returns (Keycode[] memory dependencies)
         {}

/// @audit `requests` not used
166:     function requestPermissions()
             external
             view
             virtual
             onlyKernel
             returns (Permissions[] memory requests)
         {}

```

```solidity
File: src/modules/PaymentEscrow.sol

/// @audit `major` not used
/// @audit `minor` not used
68:     function VERSION() external pure override returns (uint8 major, uint8 minor) {

```

```solidity
File: src/modules/Storage.sol

/// @audit `major` not used
/// @audit `minor` not used
96:     function VERSION() external pure override returns (uint8 major, uint8 minor) {

```

```solidity
File: src/policies/Create.sol

/// @audit `validOrderMagicValue` not used
733:     function validateOrder(
             ZoneParameters calldata zoneParams
         ) external override onlyRole("SEAPORT") returns (bytes4 validOrderMagicValue) {

```


<a name="NC-57"></a> 
### [NC-57] Unused contract variables
The following state variables are defined but not used. It is recommended to check the code for logical omissions that cause them not to be used. If it's determined that they are not needed anywhere, it's best to remove them from the codebase to improve code clarity and minimize confusion.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/packages/Signer.sol

29:     bytes32 internal immutable _NAME_HASH;

30:     bytes32 internal immutable _VERSION_HASH;

```


<a name="NC-58"></a> 
### [NC-58] Use `abi.encodeCall()` instead of `abi.encodeWithSignature()`/`abi.encodeWithSelector()`
`abi.encodeCall()` has compiler type safety, whereas the other two functions do not

*There are <b>2</b> instances of this issue:*
```solidity
File: src/modules/PaymentEscrow.sol

103:             abi.encodeWithSelector(IERC20.transfer.selector, to, value)

```

```solidity
File: src/policies/Stop.sol

174:             abi.encodeWithSelector(this.reclaimRentalOrder.selector, order),

```


<a name="NC-59"></a> 
### [NC-59] Consider using `delete` rather than assigning zero/false to clear values
The `delete` keyword more closely matches the semantics of what is being done, and draws more attention to the changing of state, which may lead to a more thorough audit of its associated logic.

*There is one instance of this issue:*
```solidity
File: src/Kernel.sol

342:         hasRole[addr_][role_] = false;

```


<a name="NC-60"></a> 
### [NC-60] Solidity compiler version is not fixed
To prevent the actual contracts deployed from behaving differently depending on the compiler version, it is recommended to use a fixed solidity version.

<details>
<summary>
There are <b>12</b> instances (click to show):
</summary>

```solidity
File: src/Create2Deployer.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/Kernel.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/modules/PaymentEscrow.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/modules/Storage.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/packages/Accumulator.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/packages/Reclaimer.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/packages/Signer.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/policies/Admin.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/policies/Create.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/policies/Factory.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/policies/Guard.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/policies/Stop.sol

2: pragma solidity ^0.8.20;

```

</details>


<a name="NC-61"></a> 
### [NC-61] Expressions for constant values should use `immutable` rather than `constant`
While it doesn't save any gas because the compiler knows that developers often make this mistake, it's still best to use the right tool for the task at hand. There is a difference between `constant` variables and `immutable` variables, and they should each be used in their appropriate contexts. `constants` should be used for literal values written into the code, and `immutable` variables should be used for expressions, or values calculated in, or passed into the constructor.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/Create2Deployer.sol

19:     bytes1 constant create2_ff = 0xff;

```

```solidity
File: src/packages/Signer.sol

25:     string internal constant _NAME = "ReNFT-Rentals";

26:     string internal constant _VERSION = "1.0.0";

```


<a name="NC-62"></a> 
### [NC-62] Use `@inheritdoc` for overridden functions

*There are <b>5</b> instances of this issue:*
```solidity
File: src/modules/PaymentEscrow.sol

68:     function VERSION() external pure override returns (uint8 major, uint8 minor) {

75:     function KEYCODE() public pure override returns (Keycode) {

```

```solidity
File: src/modules/Storage.sol

96:     function VERSION() external pure override returns (uint8 major, uint8 minor) {

103:     function KEYCODE() public pure override returns (Keycode) {

```

```solidity
File: src/policies/Guard.sol

353:     function checkAfterExecution(bytes32 txHash, bool success) external override {}

```


<a name="NC-63"></a> 
### [NC-63] Upgrade `openzeppelin` to the latest version (`5.0.1`)
These contracts import contracts from openzeppelin contracts but they are not using the latest version. For more information, please visit: [OpenZeppelin GitHub Releases](https://github.com/OpenZeppelin/openzeppelin-contracts/releases) It is recommended to always use the latest version to take advantage of updates and security fixes.

*There is one instance of this issue:*
```solidity

Global finding

```


<a name="NC-64"></a> 
### [NC-64] Use the latest solidity version for deployment (`0.8.23`)
Upgrading to a newer Solidity release can optimize gas usage, take advantage of new features and improve overall contract efficiency. Where possible, based on compatibility requirements, it is recommended to use newer/latest solidity version to take advantage of the latest optimizations and features.

<details>
<summary>
There are <b>12</b> instances (click to show):
</summary>

```solidity
File: src/Create2Deployer.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/Kernel.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/modules/PaymentEscrow.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/modules/Storage.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/packages/Accumulator.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/packages/Reclaimer.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/packages/Signer.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/policies/Admin.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/policies/Create.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/policies/Factory.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/policies/Guard.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/policies/Stop.sol

2: pragma solidity ^0.8.20;

```

</details>


<a name="NC-65"></a> 
### [NC-65] Consider using modifiers for address control
Modifiers in Solidity can improve code readability and modularity by encapsulating repetitive checks, such as address validity checks, into a reusable construct. For example, an `onlyOwner` modifier can be used to replace repetitive `require(msg.sender == owner)` checks across several functions, reducing code redundancy and enhancing maintainability. To implement, define a modifier with the check, then apply the modifier to relevant functions.

*There are <b>4</b> instances of this issue:*
```solidity
File: src/Create2Deployer.sol

37:         if (address(bytes20(salt)) != msg.sender) {

```

```solidity
File: src/Kernel.sol

41:         if (msg.sender != address(kernel))

255:         if (msg.sender != executor) revert Errors.Kernel_OnlyExecutor(msg.sender);

263:         if (msg.sender != admin) revert Errors.Kernel_OnlyAdmin(msg.sender);

```


<a name="NC-66"></a> 
### [NC-66] Use of `override` is unnecessary
Starting with Solidity version [0.8.8](https://docs.soliditylang.org/en/v0.8.20/contracts.html#function-overriding), using the `override` keyword when the function solely overrides an interface function, and the function doesn't exist in multiple base contracts, is unnecessary.

*There are <b>7</b> instances of this issue:*
```solidity
File: src/modules/PaymentEscrow.sol

68:     function VERSION() external pure override returns (uint8 major, uint8 minor) {

75:     function KEYCODE() public pure override returns (Keycode) {

```

```solidity
File: src/modules/Storage.sol

96:     function VERSION() external pure override returns (uint8 major, uint8 minor) {

103:     function KEYCODE() public pure override returns (Keycode) {

```

```solidity
File: src/policies/Create.sol

735:     ) external override onlyRole("SEAPORT") returns (bytes4 validOrderMagicValue) {

```

```solidity
File: src/policies/Guard.sol

321:     ) external override {

353:     function checkAfterExecution(bytes32 txHash, bool success) external override {}

```


<a name="NC-67"></a> 
### [NC-67] Returning a struct instead of a bunch of variables is better
If a function returns [too many variables](https://docs.soliditylang.org/en/v0.8.21/contracts.html#returning-multiple-values), replacing them with a struct can improve code readability, maintainability and reusability.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/packages/Signer.sol

/// @audit 4 return variables
298:     function _deriveTypehashes()
             internal
             view
             returns (
                 bytes32 nameHash,
                 bytes32 versionHash,
                 bytes32 eip712DomainTypehash,
                 bytes32 domainSeparator
             )
         {

/// @audit 6 return variables
339:     function _deriveRentalTypehashes()
             internal
             pure
             returns (
                 bytes32 itemTypeHash,
                 bytes32 hookTypeHash,
                 bytes32 rentalOrderTypeHash,
                 bytes32 orderFulfillmentTypeHash,
                 bytes32 orderMetadataTypeHash,
                 bytes32 rentPayloadTypeHash
             )
         {

```


<a name="NC-68"></a> 
### [NC-68] Use a struct to encapsulate multiple function parameters
If a function has too many parameters, replacing them with a struct can improve code readability and maintainability, increase reusability, and reduce the likelihood of errors when passing the parameters.

*There is one instance of this issue:*
```solidity
File: src/policies/Guard.sol

/// @audit 11 parameters
309:     function checkTransaction(
             address to,
             uint256 value,
             bytes memory data,
             Enum.Operation operation,
             uint256,
             uint256,
             uint256,
             address,
             address payable,
             bytes memory,
             address
         ) external override {

```


<a name="NC-69"></a> 
### [NC-69] Variable names that consist of all capital letters should be reserved for `constant`/`immutable` variables

*There are <b>8</b> instances of this issue:*
```solidity
File: src/policies/Admin.sol

21:     Storage public STORE;

22:     PaymentEscrow public ESCRW;

```

```solidity
File: src/policies/Create.sol

53:     Storage public STORE;

54:     PaymentEscrow public ESCRW;

```

```solidity
File: src/policies/Factory.sol

28:     Storage public STORE;

```

```solidity
File: src/policies/Guard.sol

45:     Storage public STORE;

```

```solidity
File: src/policies/Stop.sol

44:     Storage public STORE;

45:     PaymentEscrow public ESCRW;

```


<a name="NC-70"></a> 
### [NC-70] Visibility of state variables is not explicitly defined
To avoid misunderstandings and unexpected state accesses, it is recommended to explicitly define the visibility of each state variable.

*There is one instance of this issue:*
```solidity
File: src/Create2Deployer.sol

19:     bytes1 constant create2_ff = 0xff;

```


<a name="NC-71"></a> 
### [NC-71] Common functions should be refactored to a common base contract
The functions below have the same implementation as is seen in other files. The functions should be refactored into functions of a common base contract.

<details>
<summary>
There are <b>15</b> instances (click to show):
</summary>

```solidity
File: src/modules/PaymentEscrow.sol

/// @audit seen in src/modules/Storage.sol
58:     function MODULE_PROXY_INSTANTIATION(
            Kernel kernel_
        ) external onlyByProxy onlyUninitialized {

/// @audit seen in src/modules/Storage.sol
68:     function VERSION() external pure override returns (uint8 major, uint8 minor) {

/// @audit seen in src/modules/Storage.sol
420:     function upgrade(address newImplementation) external onlyByProxy permissioned {

/// @audit seen in src/modules/Storage.sol
429:     function freeze() external onlyByProxy permissioned {

```

```solidity
File: src/modules/Storage.sol

/// @audit seen in src/modules/PaymentEscrow.sol
86:     function MODULE_PROXY_INSTANTIATION(
            Kernel kernel_
        ) external onlyByProxy onlyUninitialized {

/// @audit seen in src/modules/PaymentEscrow.sol
96:     function VERSION() external pure override returns (uint8 major, uint8 minor) {

/// @audit seen in src/modules/PaymentEscrow.sol
360:     function upgrade(address newImplementation) external onlyByProxy permissioned {

/// @audit seen in src/modules/PaymentEscrow.sol
369:     function freeze() external onlyByProxy permissioned {

```

```solidity
File: src/policies/Admin.sol

/// @audit seen in src/policies/Create.sol
40:     function configureDependencies()
            external
            override
            onlyKernel
            returns (Keycode[] memory dependencies)
        {

```

```solidity
File: src/policies/Create.sol

/// @audit seen in src/policies/Admin.sol
72:     function configureDependencies()
            external
            override
            onlyKernel
            returns (Keycode[] memory dependencies)
        {

/// @audit seen in src/policies/Guard.sol
733:     function validateOrder(
             ZoneParameters calldata zoneParams
         ) external override onlyRole("SEAPORT") returns (bytes4 validOrderMagicValue) {

```

```solidity
File: src/policies/Factory.sol

/// @audit seen in src/policies/Guard.sol
73:     function configureDependencies()
            external
            override
            onlyKernel
            returns (Keycode[] memory dependencies)
        {

```

```solidity
File: src/policies/Guard.sol

/// @audit seen in src/policies/Factory.sol
63:     function configureDependencies()
            external
            override
            onlyKernel
            returns (Keycode[] memory dependencies)
        {

/// @audit seen in src/policies/Create.sol
353:     function checkAfterExecution(bytes32 txHash, bool success) external override {}

```

```solidity
File: src/policies/Stop.sol

/// @audit seen in src/policies/Admin.sol
63:     function configureDependencies()
            external
            override
            onlyKernel
            returns (Keycode[] memory dependencies)
        {

```

</details>


<a name="NC-72"></a> 
### [NC-72] Empty body - Consider commenting why

<details>
<summary>
There are <b>16</b> instances (click to show):
</summary>

```solidity
File: src/Kernel.sol

71:     constructor(Kernel kernel_) KernelAdapter(kernel_) {}

100:     function VERSION() external pure virtual returns (uint8 major, uint8 minor) {}

106:     function INIT() external virtual onlyKernel {}

124:     constructor(Kernel kernel_) KernelAdapter(kernel_) {}

153:     {}

172:     {}

```

```solidity
File: src/modules/PaymentEscrow.sol

51:     constructor(Kernel kernel_) Module(kernel_) {}

```

```solidity
File: src/modules/Storage.sol

79:     constructor(Kernel kernel_) Module(kernel_) {}

```

```solidity
File: src/policies/Admin.sol

29:     constructor(Kernel kernel_) Policy(kernel_) {}

```

```solidity
File: src/policies/Create.sol

61:     constructor(Kernel kernel_) Policy(kernel_) Signer() Zone() {}

504:             {} catch Error(string memory revertReason) {

```

```solidity
File: src/policies/Guard.sol

52:     constructor(Kernel kernel_) Policy(kernel_) {}

167:         try IHook(hook).onTransaction(safe, to, value, data) {} catch Error(

353:     function checkAfterExecution(bytes32 txHash, bool success) external override {}

```

```solidity
File: src/policies/Stop.sol

52:     constructor(Kernel kernel_) Policy(kernel_) Signer() Reclaimer() {}

234:             {} catch Error(string memory revertReason) {

```

</details>


<a name="NC-73"></a> 
### [NC-73] Names of `private`/`internal` functions should be prefixed with an underscore
It is recommended by the [Solidity Style Guide](https://docs.soliditylang.org/en/v0.8.20/style-guide.html#underscore-prefix-for-non-external-functions-and-variables)

*There is one instance of this issue:*
```solidity
File: src/Kernel.sol

180:     function getModuleAddress(Keycode keycode_) internal view returns (address) {

```


<a name="NC-74"></a> 
### [NC-74] Names of `private`/`internal` state variables should be prefixed with an underscore
It is recommended by the [Solidity Style Guide](https://docs.soliditylang.org/en/v0.8.20/style-guide.html#underscore-prefix-for-non-external-functions-and-variables)

*There are <b>2</b> instances of this issue:*
```solidity
File: src/Create2Deployer.sol

19:     bytes1 constant create2_ff = 0xff;

```

```solidity
File: src/packages/Reclaimer.sol

17:     address private immutable original;

```


<a name="NC-75"></a> 
### [NC-75] Internal function calls within for loops
Making function calls or external calls within loops in Solidity can lead to inefficient gas usage, potential bottlenecks, and increased vulnerability to attacks. Each function call or external call consumes gas, and when executed within a loop, the gas cost multiplies, potentially causing the transaction to run out of gas or exceed block gas limits. This can result in transaction failure or unpredictable behavior.

*There are <b>5</b> instances of this issue:*
```solidity
File: src/modules/PaymentEscrow.sol

/// @audit `_calculateFee`
/// @audit `_decreaseDeposit`
/// @audit `_settlePaymentInFull`
/// @audit `_settlePaymentProRata`
/// @audit `_settlePayment`
341:         for (uint256 i = 0; i < orders.length; ++i) {

```

```solidity
File: src/packages/Reclaimer.sol

/// @audit `_transferERC721`
/// @audit `_transferERC1155`
90:         for (uint256 i = 0; i < itemCount; ++i) {

```

```solidity
File: src/packages/Signer.sol

/// @audit `_deriveItemHash`
/// @audit `_deriveHookHash`
/// @audit `_deriveHookHash`
225:         for (uint256 i = 0; i < metadata.hooks.length; ++i) {

```

```solidity
File: src/policies/Create.sol

/// @audit `_checkExpectedRecipient`
/// @audit `_checkExpectedRecipient`
695:         for (uint256 i = 0; i < executions.length; ++i) {

```

```solidity
File: src/policies/Stop.sol

/// @audit `_validateRentalCanBeStoped`
/// @audit `_removeHooks`
/// @audit `_reclaimRentedItems`
/// @audit `_emitRentalOrderStopped`
333:             for (uint256 j = 0; j < orders[i].items.length; ++j) {

```


<a name="NC-76"></a> 
### [NC-76]  `require()` / `revert()` statements should have descriptive reason strings

<details>
<summary>
There are <b>72</b> instances (click to show):
</summary>

```solidity
File: src/Create2Deployer.sol

38:             revert Errors.Create2Deployer_UnauthorizedSender(msg.sender, salt);

46:             revert Errors.Create2Deployer_AlreadyDeployed(targetDeploymentAddress, salt);

68:             revert Errors.Create2Deployer_MismatchedDeploymentAddress(

```

```solidity
File: src/Kernel.sol

42:             revert Errors.KernelAdapter_OnlyKernel(msg.sender);

79:             revert Errors.Module_PolicyNotAuthorized(msg.sender);

133:             revert Errors.Policy_OnlyRole(role);

183:             revert Errors.Policy_ModuleDoesNotExist(keycode_);

255:         if (msg.sender != executor) revert Errors.Kernel_OnlyExecutor(msg.sender);

263:         if (msg.sender != admin) revert Errors.Kernel_OnlyAdmin(msg.sender);

313:             revert Errors.Kernel_AddressAlreadyHasRole(addr_, role_);

335:         if (!isRole[role_]) revert Errors.Kernel_RoleDoesNotExist(role_);

339:             revert Errors.Kernel_AddressDoesNotHaveRole(addr_, role_);

362:             revert Errors.Kernel_ModuleAlreadyInstalled(keycode);

393:             revert Errors.Kernel_InvalidModuleUpgrade(keycode);

421:             revert Errors.Kernel_PolicyAlreadyApproved(address(policy_));

458:         if (!policy_.isActive()) revert Errors.Kernel_PolicyNotApproved(address(policy_));

```

```solidity
File: src/modules/PaymentEscrow.sol

116:             revert Errors.PaymentEscrowModule_PaymentTransferFailed(token, to, value);

279:                     revert Errors.Shared_OrderTypeNotSupported(uint8(orderType));

367:             revert Errors.PaymentEscrow_ZeroPayment();

383:             revert Errors.PaymentEscrow_InvalidFeeNumerator();

```

```solidity
File: src/modules/Storage.sol

222:             revert Errors.StorageModule_OrderDoesNotExist(orderHash);

252:                 revert Errors.StorageModule_OrderDoesNotExist(orderHashes[i]);

296:         if (to.code.length == 0) revert Errors.StorageModule_NotContract(to);

299:         if (hook.code.length == 0) revert Errors.StorageModule_NotContract(hook);

318:         if (hook.code.length == 0) revert Errors.StorageModule_NotContract(hook);

322:             revert Errors.StorageModule_InvalidHookStatusBitmap(bitmap);

```

```solidity
File: src/packages/Reclaimer.sol

74:             revert Errors.ReclaimerPackage_OnlyDelegateCallAllowed();

81:             revert Errors.ReclaimerPackage_OnlyRentalSafeAllowed(

```

```solidity
File: src/packages/Signer.sol

82:             revert Errors.SignerPackage_UnauthorizedFulfiller(

97:             revert Errors.SignerPackage_SignatureExpired(block.timestamp, expiration);

```

```solidity
File: src/policies/Create.sol

202:             revert Errors.CreatePolicy_OfferCountZero();

223:                 revert Errors.CreatePolicy_SeaportItemTypeNotSupported(offer.itemType);

297:                 revert Errors.CreatePolicy_SeaportItemTypeNotSupported(offer.itemType);

312:             revert Errors.CreatePolicy_ItemCountZero(totalRentals, totalPayments);

333:             revert Errors.CreatePolicy_ConsiderationCountZero();

343:                 revert Errors.CreatePolicy_SeaportItemTypeNotSupported(

389:                 revert Errors.CreatePolicy_SeaportItemTypeNotSupported(

397:             revert Errors.CreatePolicy_ItemCountZero(totalRentals, totalPayments);

434:                 revert Errors.CreatePolicy_ConsiderationCountNonZero(

443:                 revert Errors.CreatePolicy_OfferCountNonZero(offers.length);

451:             revert Errors.Shared_OrderTypeNotSupported(uint8(orderType));

481:                 revert Errors.Shared_DisabledHook(target);

492:                 revert Errors.Shared_NonRentalHookItem(itemIndex);

506:                 revert Errors.Shared_HookFailString(revertReason);

512:                 revert Errors.Shared_HookFailString(

517:                 revert Errors.Shared_HookFailBytes(revertData);

632:             revert Errors.CreatePolicy_RentDurationZero();

637:             revert Errors.CreatePolicy_InvalidOrderMetadataHash();

650:             revert Errors.CreatePolicy_InvalidRentalSafe(safe);

655:             revert Errors.CreatePolicy_InvalidSafeOwner(owner, safe);

671:             revert Errors.CreatePolicy_UnexpectedTokenRecipient(

709:                 revert Errors.CreatePolicy_SeaportItemTypeNotSupported(

```

```solidity
File: src/policies/Factory.sol

144:             revert Errors.FactoryPolicy_InvalidSafeThreshold(threshold, owners.length);

```

```solidity
File: src/policies/Guard.sol

134:             revert Errors.GuardPolicy_UnauthorizedSelector(selector);

146:             revert Errors.GuardPolicy_UnauthorizedExtension(extension);

171:             revert Errors.Shared_HookFailString(revertReason);

177:             revert Errors.Shared_HookFailString(

182:             revert Errors.Shared_HookFailBytes(revertData);

271:                 revert Errors.GuardPolicy_UnauthorizedSelector(

281:                 revert Errors.GuardPolicy_UnauthorizedSelector(

288:                 revert Errors.GuardPolicy_UnauthorizedSelector(

325:             revert Errors.GuardPolicy_UnauthorizedDelegateCall(to);

330:             revert Errors.GuardPolicy_FunctionSelectorRequired();

```

```solidity
File: src/policies/Stop.sol

141:                 revert Errors.StopPolicy_CannotStopOrder(block.timestamp, msg.sender);

149:                 revert Errors.StopPolicy_CannotStopOrder(block.timestamp, msg.sender);

154:             revert Errors.Shared_OrderTypeNotSupported(uint8(orderType));

181:             revert Errors.StopPolicy_ReclaimFailed();

211:                 revert Errors.Shared_DisabledHook(target);

222:                 revert Errors.Shared_NonRentalHookItem(itemIndex);

236:                 revert Errors.Shared_HookFailString(revertReason);

242:                 revert Errors.Shared_HookFailString(

247:                 revert Errors.Shared_HookFailBytes(revertData);

```

</details>


<a name="NC-77"></a> 
### [NC-77] Variables should be named in mixedCase style
As the [Solidity Style Guide](https://docs.soliditylang.org/en/latest/style-guide.html#naming-styles) suggests: `arguments`, `local variables` and `mutable state variables` should be named in mixedCase style.

*There are <b>8</b> instances of this issue:*
```solidity
File: src/policies/Admin.sol

/// @audit `STORE`
21:     Storage public STORE;

/// @audit `ESCRW`
22:     PaymentEscrow public ESCRW;

```

```solidity
File: src/policies/Create.sol

/// @audit `STORE`
53:     Storage public STORE;

/// @audit `ESCRW`
54:     PaymentEscrow public ESCRW;

```

```solidity
File: src/policies/Factory.sol

/// @audit `STORE`
28:     Storage public STORE;

```

```solidity
File: src/policies/Guard.sol

/// @audit `STORE`
45:     Storage public STORE;

```

```solidity
File: src/policies/Stop.sol

/// @audit `STORE`
44:     Storage public STORE;

/// @audit `ESCRW`
45:     PaymentEscrow public ESCRW;

```


<a name="NC-78"></a> 
### [NC-78] Functions not used internally could be marked `external`

*There are <b>5</b> instances of this issue:*
```solidity
File: src/Create2Deployer.sol

107:     function generateSaltWithSender(

```

```solidity
File: src/Kernel.sol

310:     function grantRole(Role role_, address addr_) public onlyAdmin {

333:     function revokeRole(Role role_, address addr_) public onlyAdmin {

```

```solidity
File: src/modules/PaymentEscrow.sol

75:     function KEYCODE() public pure override returns (Keycode) {

```

```solidity
File: src/modules/Storage.sol

103:     function KEYCODE() public pure override returns (Keycode) {

```



## Gas Optimizations

<a name="GAS-1"></a> 
### [GAS-1] Assigning to structs can be more efficient
By changing the pattern of assigning value to the structure, gas savings of ~130 per instance are achieved. In addition, this use will provide significant savings in distribution costs. Instead of:
```solidity
MyStruct memory myStruct = MyStruct(_a, _b, _c);
```
write:
```solidity
MyStruct memory myStruct;
myStruct.a = _a;
myStruct.b = _b;
myStruct.c = _c;
```

<details>
<summary>
There are <b>22</b> instances (click to show):
</summary>

```solidity
File: src/packages/Accumulator.sol

143:             updates[i] = RentalAssetUpdate(rentalId, amount);

```

```solidity
File: src/policies/Admin.sol

72:         requests[0] = Permissions(
                toKeycode("STORE"),
                STORE.toggleWhitelistExtension.selector

76:         requests[1] = Permissions(
                toKeycode("STORE"),
                STORE.toggleWhitelistDelegate.selector

80:         requests[2] = Permissions(toKeycode("STORE"), STORE.upgrade.selector);

81:         requests[3] = Permissions(toKeycode("STORE"), STORE.freeze.selector);

83:         requests[4] = Permissions(toKeycode("ESCRW"), ESCRW.skim.selector);

84:         requests[5] = Permissions(toKeycode("ESCRW"), ESCRW.setFee.selector);

85:         requests[6] = Permissions(toKeycode("ESCRW"), ESCRW.upgrade.selector);

86:         requests[7] = Permissions(toKeycode("ESCRW"), ESCRW.freeze.selector);

```

```solidity
File: src/policies/Create.sol

104:         requests[0] = Permissions(toKeycode("STORE"), STORE.addRentals.selector);

105:         requests[1] = Permissions(toKeycode("ESCRW"), ESCRW.increaseDeposit.selector);

228:             rentalItems[i + startIndex] = Item({
                     itemType: itemType,
                     settleTo: SettleTo.LENDER,
                     token: offer.token,
                     amount: offer.amount,
                     identifier: offer.identifier

301:             rentalItems[i + startIndex] = Item({
                     itemType: itemType,
                     settleTo: settleTo,
                     token: offer.token,
                     amount: offer.amount,
                     identifier: offer.identifier

350:             rentalItems[i + startIndex] = Item({
                     itemType: ItemType.ERC20,
                     settleTo: SettleTo.LENDER,
                     token: consideration.token,
                     amount: consideration.amount,
                     identifier: consideration.identifier

579:             RentalOrder memory order = RentalOrder({
                     seaportOrderHash: seaportPayload.orderHash,
                     items: items,
                     hooks: payload.metadata.hooks,
                     orderType: payload.metadata.orderType,
                     lender: seaportPayload.offerer,
                     renter: payload.intendedFulfiller,
                     rentalWallet: payload.fulfillment.recipient,
                     startTimestamp: block.timestamp,
                     endTimestamp: block.timestamp + payload.metadata.rentDuration

```

```solidity
File: src/policies/Factory.sol

102:         requests[0] = Permissions(toKeycode("STORE"), STORE.addRentalSafe.selector);

```

```solidity
File: src/policies/Guard.sol

92:         requests[0] = Permissions(toKeycode("STORE"), STORE.updateHookPath.selector);

93:         requests[1] = Permissions(toKeycode("STORE"), STORE.updateHookStatus.selector);

```

```solidity
File: src/policies/Stop.sol

95:         requests[0] = Permissions(toKeycode("STORE"), STORE.removeRentals.selector);

96:         requests[1] = Permissions(toKeycode("STORE"), STORE.removeRentalsBatch.selector);

97:         requests[2] = Permissions(toKeycode("ESCRW"), ESCRW.settlePayment.selector);

98:         requests[3] = Permissions(toKeycode("ESCRW"), ESCRW.settlePaymentBatch.selector);

```

</details>


<a name="GAS-2"></a> 
### [GAS-2] Optimize gas by using do-while loops
Using `do-while` loops instead of `for` loops can be more gas-efficient. Even if you add an `if` condition to account for the case where the loop doesn't execute at all, a `do-while` loop can still be cheaper in terms of gas.

<details>
<summary>
There are <b>29</b> instances (click to show):
</summary>

```solidity
File: src/Kernel.sol

438:         for (uint256 i; i < depLength; ++i) {

512:         for (uint256 i; i < keycodeLen; ++i) {

521:         for (uint256 j; j < policiesLen; ++j) {

546:         for (uint256 i; i < depLength; ++i) {

566:         for (uint256 i = 0; i < reqLength; ++i) {

592:         for (uint256 i; i < depcLength; ++i) {

```

```solidity
File: src/modules/PaymentEscrow.sol

231:         for (uint256 i = 0; i < items.length; ++i) {

341:         for (uint256 i = 0; i < orders.length; ++i) {

```

```solidity
File: src/modules/Storage.sol

197:         for (uint256 i = 0; i < rentalAssetUpdates.length; ++i) {

229:         for (uint256 i = 0; i < rentalAssetUpdates.length; ++i) {

249:         for (uint256 i = 0; i < orderHashes.length; ++i) {

260:         for (uint256 i = 0; i < rentalAssetUpdates.length; ++i) {

```

```solidity
File: src/packages/Accumulator.sol

120:         for (uint256 i = 0; i < rentalAssetUpdateLength; ++i) {

```

```solidity
File: src/packages/Reclaimer.sol

90:         for (uint256 i = 0; i < itemCount; ++i) {

```

```solidity
File: src/packages/Signer.sol

170:         for (uint256 i = 0; i < order.items.length; ++i) {

176:         for (uint256 i = 0; i < order.hooks.length; ++i) {

225:         for (uint256 i = 0; i < metadata.hooks.length; ++i) {

```

```solidity
File: src/policies/Create.sol

209:         for (uint256 i; i < offers.length; ++i) {

261:         for (uint256 i; i < offers.length; ++i) {

337:         for (uint256 i; i < considerations.length; ++i) {

375:         for (uint256 i; i < considerations.length; ++i) {

475:         for (uint256 i = 0; i < hooks.length; ++i) {

567:             for (uint256 i; i < items.length; ++i) {

599:             for (uint256 i = 0; i < items.length; ++i) {

695:         for (uint256 i = 0; i < executions.length; ++i) {

```

```solidity
File: src/policies/Stop.sol

205:         for (uint256 i = 0; i < hooks.length; ++i) {

276:         for (uint256 i; i < order.items.length; ++i) {

324:         for (uint256 i = 0; i < orders.length; ++i) {

333:             for (uint256 j = 0; j < orders[i].items.length; ++j) {

```

</details>


<a name="GAS-3"></a> 
### [GAS-3] Consider activating via-ir for deploying
By using `--via-ir` or `{"viaIR": true}`, the compiler is able to use more advanced [multi-function optimizations](https://docs.soliditylang.org/en/v0.8.17/ir-breaking-changes.html#solidity-ir-based-codegen-changes), for extra gas savings.

*There is one instance of this issue:*
```solidity

Global finding

```


<a name="GAS-4"></a> 
### [GAS-4] Divisions can be `unchecked` to save gas
The expression `type(int).min/(-1)` is the only case where division causes an overflow. Therefore, uncheck can be used to [save gas](https://gist.github.com/DadeKuma/3bc597338ae774b8b3bd43280d55271f) in scenarios where it is certain that such an overflow will not occur.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/modules/PaymentEscrow.sol

90:         return (amount * fee) / 10000;

142:         renterAmount = ((numerator / totalTime) + 500) / 1000;

142:         renterAmount = ((numerator / totalTime) + 500) / 1000;

```


<a name="GAS-5"></a> 
### [GAS-5] Do not calculate constants
Due to how constant variables are implemented (replacements at compile-time), an expression assigned to a constant variable is recomputed each time that the variable is used, which wastes some gas.

*There is one instance of this issue:*
```solidity
File: src/packages/Signer.sol

25:     string internal constant _NAME = "ReNFT-Rentals";

```


<a name="GAS-6"></a> 
### [GAS-6] Duplicated `require()`/`revert()` checks should be refactored to a modifier or function to save gas
Saves deployment costs.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/policies/Create.sol

/// @audit duplicated on line 297
223:                 revert Errors.CreatePolicy_SeaportItemTypeNotSupported(offer.itemType);

/// @audit duplicated on line 397
312:             revert Errors.CreatePolicy_ItemCountZero(totalRentals, totalPayments);

```

```solidity
File: src/policies/Stop.sol

/// @audit duplicated on line 149
141:                 revert Errors.StopPolicy_CannotStopOrder(block.timestamp, msg.sender);

```


<a name="GAS-7"></a> 
### [GAS-7] Increments can be `unchecked` to save gas
Using `unchecked` increments can save gas by bypassing the built-in overflow checks. This can save 30-40 gas per iteration. So it is recommended to use unchecked increments when overflow is not possible.

<details>
<summary>
There are <b>29</b> instances (click to show):
</summary>

```solidity
File: src/Kernel.sol

438:         for (uint256 i; i < depLength; ++i) {

512:         for (uint256 i; i < keycodeLen; ++i) {

521:         for (uint256 j; j < policiesLen; ++j) {

546:         for (uint256 i; i < depLength; ++i) {

566:         for (uint256 i = 0; i < reqLength; ++i) {

592:         for (uint256 i; i < depcLength; ++i) {

```

```solidity
File: src/modules/PaymentEscrow.sol

231:         for (uint256 i = 0; i < items.length; ++i) {

341:         for (uint256 i = 0; i < orders.length; ++i) {

```

```solidity
File: src/modules/Storage.sol

197:         for (uint256 i = 0; i < rentalAssetUpdates.length; ++i) {

229:         for (uint256 i = 0; i < rentalAssetUpdates.length; ++i) {

249:         for (uint256 i = 0; i < orderHashes.length; ++i) {

260:         for (uint256 i = 0; i < rentalAssetUpdates.length; ++i) {

```

```solidity
File: src/packages/Accumulator.sol

120:         for (uint256 i = 0; i < rentalAssetUpdateLength; ++i) {

```

```solidity
File: src/packages/Reclaimer.sol

90:         for (uint256 i = 0; i < itemCount; ++i) {

```

```solidity
File: src/packages/Signer.sol

170:         for (uint256 i = 0; i < order.items.length; ++i) {

176:         for (uint256 i = 0; i < order.hooks.length; ++i) {

225:         for (uint256 i = 0; i < metadata.hooks.length; ++i) {

```

```solidity
File: src/policies/Create.sol

209:         for (uint256 i; i < offers.length; ++i) {

261:         for (uint256 i; i < offers.length; ++i) {

337:         for (uint256 i; i < considerations.length; ++i) {

375:         for (uint256 i; i < considerations.length; ++i) {

475:         for (uint256 i = 0; i < hooks.length; ++i) {

567:             for (uint256 i; i < items.length; ++i) {

599:             for (uint256 i = 0; i < items.length; ++i) {

695:         for (uint256 i = 0; i < executions.length; ++i) {

```

```solidity
File: src/policies/Stop.sol

205:         for (uint256 i = 0; i < hooks.length; ++i) {

276:         for (uint256 i; i < order.items.length; ++i) {

324:         for (uint256 i = 0; i < orders.length; ++i) {

333:             for (uint256 j = 0; j < orders[i].items.length; ++j) {

```

</details>


<a name="GAS-8"></a> 
### [GAS-8] Inline `modifier`s that are only used once, to save gas

*There is one instance of this issue:*
```solidity
File: src/Kernel.sol

254:     modifier onlyExecutor() {

```


<a name="GAS-9"></a> 
### [GAS-9] `internal` functions only called once can be inlined to save gas
If an `internal` function is only used once, there is no need to modularize it, unless the function calling it would otherwise be too long and complex. Not inlining costs 20 to 40 gas because of two extra JUMP instructions and additional stack operations needed for function calls.

<details>
<summary>
There are <b>29</b> instances (click to show):
</summary>

```solidity
File: src/Kernel.sol

/// @audit `_installModule` is used only once
356:     function _installModule(Module newModule_) internal {

/// @audit `_upgradeModule` is used only once
383:     function _upgradeModule(Module newModule_) internal {

/// @audit `_activatePolicy` is used only once
418:     function _activatePolicy(Policy policy_) internal {

/// @audit `_deactivatePolicy` is used only once
457:     function _deactivatePolicy(Policy policy_) internal {

/// @audit `_migrateKernel` is used only once
508:     function _migrateKernel(Kernel newKernel_) internal {

/// @audit `_reconfigurePolicies` is used only once
540:     function _reconfigurePolicies(Keycode keycode_) internal {

/// @audit `_pruneFromDependents` is used only once
586:     function _pruneFromDependents(Policy policy_) internal {

```

```solidity
File: src/modules/PaymentEscrow.sol

/// @audit `_calculateFee` is used only once
88:     function _calculateFee(uint256 amount) internal view returns (uint256) {

/// @audit `_calculatePaymentProRata` is used only once
132:     function _calculatePaymentProRata(

/// @audit `_settlePaymentProRata` is used only once
159:     function _settlePaymentProRata(

/// @audit `_settlePaymentInFull` is used only once
190:     function _settlePaymentInFull(

/// @audit `_decreaseDeposit` is used only once
292:     function _decreaseDeposit(address token, uint256 amount) internal {

/// @audit `_increaseDeposit` is used only once
304:     function _increaseDeposit(address token, uint256 amount) internal {

```

```solidity
File: src/packages/Signer.sol

/// @audit `_deriveItemHash` is used only once
125:     function _deriveItemHash(Item memory item) internal view returns (bytes32) {

/// @audit `_deriveOrderFulfillmentHash` is used only once
204:     function _deriveOrderFulfillmentHash(

/// @audit `_deriveRentPayloadHash` is used only once
248:     function _deriveRentPayloadHash(

/// @audit `_deriveDomainSeparator` is used only once
273:     function _deriveDomainSeparator(

/// @audit `_deriveTypehashes` is used only once
298:     function _deriveTypehashes()

/// @audit `_deriveRentalTypehashes` is used only once
339:     function _deriveRentalTypehashes()

```

```solidity
File: src/policies/Create.sol

/// @audit `_emitRentalOrderStarted` is used only once
165:     function _emitRentalOrderStarted(

/// @audit `_processBaseOrderOffer` is used only once
195:     function _processBaseOrderOffer(

/// @audit `_processPayOrderOffer` is used only once
247:     function _processPayOrderOffer(

/// @audit `_processBaseOrderConsideration` is used only once
326:     function _processBaseOrderConsideration(

/// @audit `_processPayeeOrderConsideration` is used only once
367:     function _processPayeeOrderConsideration(

/// @audit `_convertToItems` is used only once
411:     function _convertToItems(

/// @audit `_addHooks` is used only once
464:     function _addHooks(

/// @audit `_isValidOrderMetadata` is used only once
626:     function _isValidOrderMetadata(

/// @audit `_isValidSafeOwner` is used only once
647:     function _isValidSafeOwner(address owner, address safe) internal view {

/// @audit `_executionInvariantChecks` is used only once
691:     function _executionInvariantChecks(

```

</details>


<a name="GAS-10"></a> 
### [GAS-10] Low level `call` can be optimized with assembly
When using low-level calls, the `returnData` is copied to memory even if the variable is not utilized. The proper way to handle this is through a low level assembly call.

*There is one instance of this issue:*
```solidity
File: src/modules/PaymentEscrow.sol

102:         (bool success, bytes memory data) = token.call(

```


<a name="GAS-11"></a> 
### [GAS-11] Multiple accesses of the same mapping/array key/index should be cached
The instances below point to the second+ access of a value inside a mapping/array, within a function. Caching a mapping's value in a local `storage` or `calldata` variable when the value is accessed [multiple times](https://gist.github.com/IllIllI000/ec23a57daa30a8f8ca8b9681c8ccefb0), saves ~42 gas per access due to not having to recalculate the key's keccak256 hash (Gkeccak256 - 30 gas) and that calculation's associated stack operations. Caching an array's struct avoids recalculating the array offsets into memory/calldata

<details>
<summary>
There are <b>11</b> instances (click to show):
</summary>

```solidity
File: src/Create2Deployer.sol

/// @audit `deployed[targetDeploymentAddress]` is also accessed on line 45
50:         deployed[targetDeploymentAddress] = true;

```

```solidity
File: src/Kernel.sol

/// @audit `hasRole[addr_]` is also accessed on line 312
322:         hasRole[addr_][role_] = true;

/// @audit `hasRole[addr_]` is also accessed on line 338
342:         hasRole[addr_][role_] = false;

/// @audit `getModuleForKeycode[keycode]` is also accessed on line 361
366:         getModuleForKeycode[keycode] = newModule_;

/// @audit `getModuleForKeycode[keycode]` is also accessed on line 388
403:         getModuleForKeycode[keycode] = newModule_;

/// @audit `[policy_] = ` is also accessed on line 431
445:             getDependentIndex[keycode][policy_] = moduleDependents[keycode].length - 1;

/// @audit `getPolicyIndex[policy_]` is also accessed on line 466
482:         delete getPolicyIndex[policy_];

/// @audit `getDependentIndex[keycode]` is also accessed on line 598
611:             getDependentIndex[keycode][lastPolicy] = origIndex;

/// @audit `getDependentIndex[keycode]` is also accessed on line 598
614:             delete getDependentIndex[keycode][policy_];

```

```solidity
File: src/modules/Storage.sol

/// @audit `orders[orderHash]` is also accessed on line 221
225:             delete orders[orderHash];

/// @audit `orders[orderHashes[i]` is also accessed on line 251
255:                 delete orders[orderHashes[i]];

```

</details>


<a name="GAS-12"></a> 
### [GAS-12] Newer versions of solidity are more gas efficient
The solidity language continues to pursue more efficient gas optimization schemes. Adopting a newer version of solidity can be more gas efficient.

<details>
<summary>
There are <b>12</b> instances (click to show):
</summary>

```solidity
File: src/Create2Deployer.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/Kernel.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/modules/PaymentEscrow.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/modules/Storage.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/packages/Accumulator.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/packages/Reclaimer.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/packages/Signer.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/policies/Admin.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/policies/Create.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/policies/Factory.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/policies/Guard.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/policies/Stop.sol

2: pragma solidity ^0.8.20;

```

</details>


<a name="GAS-13"></a> 
### [GAS-13] Operator `>=`/`<=` costs less gas than operator `>`/`<`
The compiler uses opcodes `GT` and `ISZERO` for code that uses `>`, but only requires `LT` for `>=`. A similar behavior applies for `>`, which uses opcodes `LT` and `ISZERO`, but only requires `GT` for `<=`. It can save 3 gas for each. It should be converted to the `<=`/`>=` equivalent when comparing against integer literals.

<details>
<summary>
There are <b>39</b> instances (click to show):
</summary>

```solidity
File: src/Kernel.sol

438:         for (uint256 i; i < depLength; ++i) {

512:         for (uint256 i; i < keycodeLen; ++i) {

521:         for (uint256 j; j < policiesLen; ++j) {

546:         for (uint256 i; i < depLength; ++i) {

566:         for (uint256 i = 0; i < reqLength; ++i) {

592:         for (uint256 i; i < depcLength; ++i) {

```

```solidity
File: src/modules/PaymentEscrow.sol

231:         for (uint256 i = 0; i < items.length; ++i) {

341:         for (uint256 i = 0; i < orders.length; ++i) {

382:         if (feeNumerator > 10000) {

```

```solidity
File: src/modules/Storage.sol

197:         for (uint256 i = 0; i < rentalAssetUpdates.length; ++i) {

229:         for (uint256 i = 0; i < rentalAssetUpdates.length; ++i) {

249:         for (uint256 i = 0; i < orderHashes.length; ++i) {

260:         for (uint256 i = 0; i < rentalAssetUpdates.length; ++i) {

321:         if (bitmap > uint8(7))

```

```solidity
File: src/packages/Accumulator.sol

120:         for (uint256 i = 0; i < rentalAssetUpdateLength; ++i) {

```

```solidity
File: src/packages/Reclaimer.sol

90:         for (uint256 i = 0; i < itemCount; ++i) {

```

```solidity
File: src/packages/Signer.sol

96:         if (block.timestamp > expiration) {

170:         for (uint256 i = 0; i < order.items.length; ++i) {

176:         for (uint256 i = 0; i < order.hooks.length; ++i) {

225:         for (uint256 i = 0; i < metadata.hooks.length; ++i) {

```

```solidity
File: src/policies/Create.sol

209:         for (uint256 i; i < offers.length; ++i) {

261:         for (uint256 i; i < offers.length; ++i) {

337:         for (uint256 i; i < considerations.length; ++i) {

375:         for (uint256 i; i < considerations.length; ++i) {

433:             if (considerations.length > 0) {

442:             if (offers.length > 0) {

475:         for (uint256 i = 0; i < hooks.length; ++i) {

567:             for (uint256 i; i < items.length; ++i) {

599:             for (uint256 i = 0; i < items.length; ++i) {

606:             if (payload.metadata.hooks.length > 0) {

695:         for (uint256 i = 0; i < executions.length; ++i) {

```

```solidity
File: src/policies/Factory.sol

143:         if (threshold == 0 || threshold > owners.length) {

```

```solidity
File: src/policies/Guard.sol

329:         if (data.length < 4) {

```

```solidity
File: src/policies/Stop.sol

205:         for (uint256 i = 0; i < hooks.length; ++i) {

276:         for (uint256 i; i < order.items.length; ++i) {

288:         if (order.hooks.length > 0) {

324:         for (uint256 i = 0; i < orders.length; ++i) {

333:             for (uint256 j = 0; j < orders[i].items.length; ++j) {

348:             if (orders[i].hooks.length > 0) {

```

</details>


<a name="GAS-14"></a> 
### [GAS-14] Optimize Gas by splitting `if() revert` statements
Using boolean operators in a single `if() revert` statement can consume more gas than necessary. Consider splitting these statements to save gas.

*There are <b>5</b> instances of this issue:*
```solidity
File: src/Kernel.sol

392:         if (address(oldModule) == address(0) || oldModule == newModule_) {

```

```solidity
File: src/modules/PaymentEscrow.sol

115:         if (!success || (data.length != 0 && !abi.decode(data, (bool)))) {

```

```solidity
File: src/policies/Create.sol

311:         if (totalRentals == 0 || totalPayments == 0) {

396:         if (totalRentals == 0 || totalPayments == 0) {

```

```solidity
File: src/policies/Factory.sol

143:         if (threshold == 0 || threshold > owners.length) {

```


<a name="GAS-15"></a> 
### [GAS-15] Optimize names to save gas
`public`/`external` function names and `public` member variable names can be optimized to save gas. See this [link](https://gist.github.com/IllIllI000/a5d8b486a8259f9f77891a919febd1a9) for an example of how it works. Below are the interfaces/abstract contracts that can be optimized so that the most frequently-called functions use the least amount of gas possible during method lookup. Method IDs that have two leading zero bytes can save 128 gas each during deployment, and renaming functions to have lower method IDs will save 22 gas per call, [per sorted position shifted](https://medium.com/joyso/solidity-how-does-function-name-affect-gas-consumption-in-smart-contract-47d270d8ac92)

*There are <b>9</b> instances of this issue:*
```solidity
File: src/Create2Deployer.sol

/// @audit `deploy`, `getCreate2Address`, `generateSaltWithSender`
14: contract Create2Deployer {

```

```solidity
File: src/Kernel.sol

/// @audit `executeAction`, `grantRole`, `revokeRole`
206: contract Kernel {

```

```solidity
File: src/modules/PaymentEscrow.sol

/// @audit `MODULE_PROXY_INSTANTIATION`, `VERSION`, `KEYCODE`, `settlePayment`, `settlePaymentBatch`, `increaseDeposit`, `setFee`, `skim`, `upgrade`, `freeze`
37: contract PaymentEscrow is Proxiable, Module, PaymentEscrowBase {

```

```solidity
File: src/modules/Storage.sol

/// @audit `MODULE_PROXY_INSTANTIATION`, `VERSION`, `KEYCODE`, `isRentedOut`, `contractToHook`, `hookOnTransaction`, `hookOnStart`, `hookOnStop`, `addRentals`, `removeRentals`, `removeRentalsBatch`, `addRentalSafe`, `updateHookPath`, `updateHookStatus`, `toggleWhitelistDelegate`, `toggleWhitelistExtension`, `upgrade`, `freeze`
66: contract Storage is Proxiable, Module, StorageBase {

```

```solidity
File: src/policies/Admin.sol

/// @audit `configureDependencies`, `requestPermissions`, `toggleWhitelistDelegate`, `toggleWhitelistExtension`, `upgradeStorage`, `freezeStorage`, `upgradePaymentEscrow`, `freezePaymentEscrow`, `skim`, `setFee`
15: contract Admin is Policy {

```

```solidity
File: src/policies/Create.sol

/// @audit `configureDependencies`, `requestPermissions`, `domainSeparator`, `getRentalOrderHash`, `getRentPayloadHash`, `getOrderMetadataHash`, `validateOrder`
41: contract Create is Policy, Signer, Zone, Accumulator {

```

```solidity
File: src/policies/Factory.sol

/// @audit `configureDependencies`, `requestPermissions`, `initializeRentalSafe`, `deployRentalSafe`
22: contract Factory is Policy {

```

```solidity
File: src/policies/Guard.sol

/// @audit `configureDependencies`, `requestPermissions`, `checkTransaction`, `checkAfterExecution`, `updateHookPath`, `updateHookStatus`
39: contract Guard is Policy, BaseGuard {

```

```solidity
File: src/policies/Stop.sol

/// @audit `configureDependencies`, `requestPermissions`, `stopRent`, `stopRentBatch`
34: contract Stop is Policy, Signer, Reclaimer, Accumulator {

```


<a name="GAS-16"></a> 
### [GAS-16] Redundant state variable getters
Getters for public state variables are automatically generated so there is no need to code them manually and waste gas.

*There is one instance of this issue:*
```solidity
File: src/policies/Create.sol

117:     function domainSeparator() external view returns (bytes32) {
             return _DOMAIN_SEPARATOR;

```


<a name="GAS-17"></a> 
### [GAS-17] Remove or replace unused state variables
Saves a storage slot. If the variable is assigned a non-zero value, saves Gsset (20000 gas). If it's assigned a zero value, saves Gsreset (2900 gas). If the variable remains unassigned, there is no gas savings unless the variable is `public`, in which case the compiler-generated non-payable getter deployment cost is saved. If the state variable is overriding an interface's public function, mark the variable as `constant` or `immutable` so that it does not use a storage slot.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/packages/Signer.sol

29:     bytes32 internal immutable _NAME_HASH;

30:     bytes32 internal immutable _VERSION_HASH;

```


<a name="GAS-18"></a> 
### [GAS-18] The result of a function call should be cached rather than re-calling the function
The function calls in solidity are expensive. If the same result of the same function calls are to be used several times, the result should be cached to reduce the gas consumption of repeated calls.

*There are <b>8</b> instances of this issue:*
```solidity
File: src/Kernel.sol

/// @audit `KEYCODE` is called 2 times
277:     function executeAction(Actions action_, address target_) external onlyExecutor {

```

```solidity
File: src/policies/Admin.sol

/// @audit `getModuleAddress` is called 2 times
29:     constructor(Kernel kernel_) Policy(kernel_) {}

/// @audit `getModuleAddress` is called 2 times
40:     function configureDependencies()
            external
            override
            onlyKernel
            returns (Keycode[] memory dependencies)
        {

```

```solidity
File: src/policies/Create.sol

/// @audit `getModuleAddress` is called 2 times
61:     constructor(Kernel kernel_) Policy(kernel_) Signer() Zone() {}

/// @audit `getModuleAddress` is called 2 times
72:     function configureDependencies()
            external
            override
            onlyKernel
            returns (Keycode[] memory dependencies)
        {

```

```solidity
File: src/policies/Guard.sol

/// @audit `_loadValueFromCalldata` is called 7 times
195:     function _checkTransaction(address from, address to, bytes memory data) private view {

```

```solidity
File: src/policies/Stop.sol

/// @audit `getModuleAddress` is called 2 times
52:     constructor(Kernel kernel_) Policy(kernel_) Signer() Reclaimer() {}

/// @audit `getModuleAddress` is called 2 times
63:     function configureDependencies()
            external
            override
            onlyKernel
            returns (Keycode[] memory dependencies)
        {

```


<a name="GAS-19"></a> 
### [GAS-19] State variables access within a loop
State variable reads and writes are more expensive than local variable reads and writes. Therefore, it is recommended to replace state variable reads and writes within loops with a local variable. Gas savings should be multiplied by the average loop length.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/policies/Create.sol

/// @audit `STORE`
480:             if (!STORE.hookOnStart(target)) {

/// @audit `ESCRW`
601:                     ESCRW.increaseDeposit(items[i].token, items[i].amount);

```

```solidity
File: src/policies/Stop.sol

/// @audit `STORE`
210:             if (!STORE.hookOnStop(target)) {

```


<a name="GAS-20"></a> 
### [GAS-20] Unlimited gas consumption risk due to external call recipients
When calling an external function without specifying a gas limit , the called contract may consume all the remaining gas, causing the tx to be reverted. To mitigate this, it is recommended to explicitly set a gas limit when making low level external calls.

*There is one instance of this issue:*
```solidity
File: src/modules/PaymentEscrow.sol

102:         (bool success, bytes memory data) = token.call(

```


<a name="GAS-21"></a> 
### [GAS-21] Unused named return variables without optimizer waste gas
Consider changing the variable to be an unnamed one, since the variable is never assigned, nor is it returned by name. If the optimizer is not turned on, leaving the code as it is will also waste gas for the stack variable.

*There are <b>6</b> instances of this issue:*
```solidity
File: src/Kernel.sol

/// @audit `major` not used
/// @audit `minor` not used
100:     function VERSION() external pure virtual returns (uint8 major, uint8 minor) {}

/// @audit `dependencies` not used
148:     function configureDependencies()
             external
             virtual
             onlyKernel
             returns (Keycode[] memory dependencies)
         {}

/// @audit `requests` not used
166:     function requestPermissions()
             external
             view
             virtual
             onlyKernel
             returns (Permissions[] memory requests)
         {}

```

```solidity
File: src/modules/PaymentEscrow.sol

/// @audit `major` not used
/// @audit `minor` not used
68:     function VERSION() external pure override returns (uint8 major, uint8 minor) {

```

```solidity
File: src/modules/Storage.sol

/// @audit `major` not used
/// @audit `minor` not used
96:     function VERSION() external pure override returns (uint8 major, uint8 minor) {

```

```solidity
File: src/policies/Create.sol

/// @audit `validOrderMagicValue` not used
733:     function validateOrder(
             ZoneParameters calldata zoneParams
         ) external override onlyRole("SEAPORT") returns (bytes4 validOrderMagicValue) {

```


<a name="GAS-22"></a> 
### [GAS-22] Optimize external calls with assembly for memory efficiency
Using interfaces to make external contract calls in Solidity is convenient but can be inefficient in terms of memory utilization. Each such call involves creating a new memory location to store the data being passed, thus incurring memory expansion costs.

Inline assembly allows for optimized memory usage by re-using already allocated memory spaces or using the scratch space for smaller datasets. This can result in notable gas savings, especially for contracts that make frequent external calls.

Additionally, using inline assembly enables important safety checks like verifying if the target address has code deployed to it using `extcodesize(addr)` before making the call, mitigating risks associated with contract interactions.

<details>
<summary>
There are <b>33</b> instances (click to show):
</summary>

```solidity
File: src/Kernel.sol

/// @audit `.INIT(...)`
375:         newModule_.INIT();

/// @audit `.INIT(...)`
406:         newModule_.INIT();

/// @audit `.setActiveStatus(...)`
449:         policy_.setActiveStatus(true);

/// @audit `.setActiveStatus(...)`
489:         policy_.setActiveStatus(false);

/// @audit `.changeKernel(...)`
516:             module.changeKernel(newKernel_);

/// @audit `.setActiveStatus(...)`
526:             policy.setActiveStatus(false);

/// @audit `.changeKernel(...)`
529:             policy.changeKernel(newKernel_);

```

```solidity
File: src/packages/Reclaimer.sol

/// @audit `.safeTransferFrom(...)`
33:         IERC721(item.token).safeTransferFrom(address(this), recipient, item.identifier);

/// @audit `.safeTransferFrom(...)`
43:         IERC1155(item.token).safeTransferFrom(

```

```solidity
File: src/policies/Admin.sol

/// @audit `.toggleWhitelistDelegate(...)`
103:         STORE.toggleWhitelistDelegate(delegate, isEnabled);

/// @audit `.toggleWhitelistExtension(...)`
117:         STORE.toggleWhitelistExtension(extension, isEnabled);

/// @audit `.upgrade(...)`
127:         STORE.upgrade(newImplementation);

/// @audit `.freeze(...)`
135:         STORE.freeze();

/// @audit `.upgrade(...)`
147:         ESCRW.upgrade(newImplementation);

/// @audit `.freeze(...)`
155:         ESCRW.freeze();

/// @audit `.skim(...)`
165:         ESCRW.skim(token, to);

/// @audit `.setFee(...)`
174:         ESCRW.setFee(feeNumerator);

```

```solidity
File: src/policies/Create.sol

/// @audit `.onStart(...)`
497:                 IHook(target).onStart(

/// @audit `.addRentals(...)`
595:             STORE.addRentals(orderHash, _convertToStatic(rentalAssetUpdates));

/// @audit `.increaseDeposit(...)`
601:                     ESCRW.increaseDeposit(items[i].token, items[i].amount);

```

```solidity
File: src/policies/Factory.sol

/// @audit `.enableModule(...)`
124:         ISafe(address(this)).enableModule(_stopPolicy);

/// @audit `.setGuard(...)`
127:         ISafe(address(this)).setGuard(_guardPolicy);

/// @audit `.createProxyWithNonce(...)`
181:             safeProxyFactory.createProxyWithNonce(

/// @audit `.totalSafes(...)`
184:                 uint256(keccak256(abi.encode(STORE.totalSafes() + 1, block.chainid)))

/// @audit `.addRentalSafe(...)`
189:         STORE.addRentalSafe(safe);

```

```solidity
File: src/policies/Guard.sol

/// @audit `.onTransaction(...)`
167:         try IHook(hook).onTransaction(safe, to, value, data) {} catch Error(

/// @audit `.updateHookPath(...)`
363:         STORE.updateHookPath(to, hook);

/// @audit `.updateHookStatus(...)`
377:         STORE.updateHookStatus(hook, bitmap);

```

```solidity
File: src/policies/Stop.sol

/// @audit `.onStop(...)`
227:                 IHook(target).onStop(

/// @audit `.settlePayment(...)`
296:         ESCRW.settlePayment(order);

/// @audit `.removeRentals(...)`
299:         STORE.removeRentals(

/// @audit `.settlePaymentBatch(...)`
360:         ESCRW.settlePaymentBatch(orders);

/// @audit `.removeRentalsBatch(...)`
363:         STORE.removeRentalsBatch(orderHashes, _convertToStatic(rentalAssetUpdates));

```

</details>


<a name="GAS-23"></a> 
### [GAS-23] Use assembly to compute hashes to save gas
If the arguments to the encode call can fit into the scratch space (two words or fewer), then it's more efficient to use assembly to generate the hash (80 gas):

`keccak256(abi.encodePacked(x, y)) -> assembly {mstore(0x00, a); mstore(0x20, b); let hash := keccak256(0x00, 0x40); }`

<details>
<summary>
There are <b>22</b> instances (click to show):
</summary>

```solidity
File: src/Create2Deployer.sol

89:         bytes32 addressHash = keccak256(

90:             abi.encodePacked(create2_ff, address(this), salt, keccak256(initCode))

```

```solidity
File: src/packages/Signer.sol

128:             keccak256(

150:             keccak256(

182:             keccak256(

186:                     keccak256(abi.encodePacked(itemHashes)),

187:                     keccak256(abi.encodePacked(hookHashes)),

208:         return keccak256(abi.encode(_ORDER_FULFILLMENT_TYPEHASH, fulfillment.recipient));

232:             keccak256(

236:                     keccak256(abi.encodePacked(hookHashes))

253:             keccak256(

279:             keccak256(

309:         nameHash = keccak256(bytes(_NAME));

312:         versionHash = keccak256(bytes(_VERSION));

315:         eip712DomainTypehash = keccak256(

367:         itemTypeHash = keccak256(itemTypeString);

370:         hookTypeHash = keccak256(hookTypeString);

373:         rentalOrderTypeHash = keccak256(

394:             rentPayloadTypeHash = keccak256(

403:             orderFulfillmentTypeHash = keccak256(orderFulfillmentTypeString);

406:             orderMetadataTypeHash = keccak256(orderMetadataTypeString);

```

```solidity
File: src/policies/Factory.sol

184:                 uint256(keccak256(abi.encode(STORE.totalSafes() + 1, block.chainid)))

```

</details>


<a name="GAS-24"></a> 
### [GAS-24] Use assembly to emit events
To efficiently emit events, it's possible to utilize assembly by making use of scratch space and the free memory pointer. This approach has the advantage of potentially avoiding the costs associated with memory expansion.

However, it's important to note that in order to safely optimize this process, it is preferable to cache and restore the free memory pointer.

A good example of such practice can be seen in [Solady's](https://github.com/Vectorized/solady/blob/main/src/tokens/ERC1155.sol#L167) codebase.

*There are <b>7</b> instances of this issue:*
```solidity
File: src/Kernel.sol

301:         emit Events.ActionExecuted(action_, target_);

324:         emit Events.RoleGranted(role_, addr_);

344:         emit Events.RoleRevoked(role_, addr_);

```

```solidity
File: src/modules/PaymentEscrow.sol

411:         emit Events.FeeTaken(token, skimmedBalance);

```

```solidity
File: src/policies/Create.sol

171:         emit Events.RentalOrderStarted(

```

```solidity
File: src/policies/Factory.sol

192:         emit Events.RentalSafeDeployment(safe, owners, threshold);

```

```solidity
File: src/policies/Stop.sol

113:         emit Events.RentalOrderStopped(seaportOrderHash, stopper);

```


<a name="GAS-25"></a> 
### [GAS-25] Use assembly to validate `msg.sender`

*There are <b>4</b> instances of this issue:*
```solidity
File: src/Create2Deployer.sol

37:         if (address(bytes20(salt)) != msg.sender) {

```

```solidity
File: src/Kernel.sol

41:         if (msg.sender != address(kernel))

255:         if (msg.sender != executor) revert Errors.Kernel_OnlyExecutor(msg.sender);

263:         if (msg.sender != admin) revert Errors.Kernel_OnlyAdmin(msg.sender);

```


<a name="GAS-26"></a> 
### [GAS-26] Use assembly to write address/contract type storage values
Using `assembly { sstore(state.slot, addr)` instead of `state = addr` can save gas.

<details>
<summary>
There are <b>22</b> instances (click to show):
</summary>

```solidity
File: src/Kernel.sol

34:         kernel = kernel_;

55:         kernel = newKernel_;

243:         executor = _executor;

244:         admin = _admin;

296:             executor = target_;

298:             admin = target_;

```

```solidity
File: src/modules/PaymentEscrow.sol

61:         kernel = kernel_;

```

```solidity
File: src/modules/Storage.sol

89:         kernel = kernel_;

```

```solidity
File: src/packages/Reclaimer.sol

23:         original = address(this);

```

```solidity
File: src/policies/Admin.sol

49:         STORE = Storage(getModuleAddress(toKeycode("STORE")));

52:         ESCRW = PaymentEscrow(getModuleAddress(toKeycode("ESCRW")));

```

```solidity
File: src/policies/Create.sol

81:         STORE = Storage(getModuleAddress(toKeycode("STORE")));

84:         ESCRW = PaymentEscrow(getModuleAddress(toKeycode("ESCRW")));

```

```solidity
File: src/policies/Factory.sol

57:         stopPolicy = stopPolicy_;

58:         guardPolicy = guardPolicy_;

59:         fallbackHandler = fallbackHandler_;

60:         safeProxyFactory = safeProxyFactory_;

61:         safeSingleton = safeSingleton_;

82:         STORE = Storage(getModuleAddress(toKeycode("STORE")));

```

```solidity
File: src/policies/Guard.sol

72:         STORE = Storage(getModuleAddress(toKeycode("STORE")));

```

```solidity
File: src/policies/Stop.sol

72:         STORE = Storage(getModuleAddress(toKeycode("STORE")));

75:         ESCRW = PaymentEscrow(getModuleAddress(toKeycode("ESCRW")));

```

</details>


<a name="GAS-27"></a> 
### [GAS-27] Using a double `if` statement instead of a logical AND (`&&`)
Using a double `if` statement instead of a logical AND (`&&`) can provide similar short-circuiting behavior whereas double if is slightly [more gas efficient](https://gist.github.com/DadeKuma/931ce6794a050201ec6544dbcc31316c).

*There are <b>6</b> instances of this issue:*
```solidity
File: src/modules/PaymentEscrow.sol

115:         if (!success || (data.length != 0 && !abi.decode(data, (bool)))) {

255:                 if (orderType.isPayOrder() && !isRentalOver) {

268:                     (orderType.isPayOrder() && isRentalOver) || orderType.isBaseOrder()

```

```solidity
File: src/policies/Guard.sol

324:         if (operation == Enum.Operation.DelegateCall && !STORE.whitelistedDelegates(to)) {

338:         if (hook != address(0) && isActive) {

```

```solidity
File: src/policies/Stop.sol

148:             if (!isLender && (!hasExpired)) {

```


<a name="GAS-28"></a> 
### [GAS-28] Use a more recent version of solidity
- Use a solidity version of at least 0.8.2 to get simple compiler automatic inlining.
- Use a solidity version of at least 0.8.3 to get better struct packing and cheaper multiple storage reads.
- Use a solidity version of at least 0.8.4 to get custom errors, which are cheaper at deployment than revert()/require() strings.
- Use a solidity version of at least 0.8.10 to have external calls skip contract existence checks if the external call has a return value.

<details>
<summary>
There are <b>12</b> instances (click to show):
</summary>

```solidity
File: src/Create2Deployer.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/Kernel.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/modules/PaymentEscrow.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/modules/Storage.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/packages/Accumulator.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/packages/Reclaimer.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/packages/Signer.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/policies/Admin.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/policies/Create.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/policies/Factory.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/policies/Guard.sol

2: pragma solidity ^0.8.20;

```

```solidity
File: src/policies/Stop.sol

2: pragma solidity ^0.8.20;

```

</details>


<a name="GAS-29"></a> 
### [GAS-29] Use `storage` instead of `memory` for structs/arrays
When fetching data from a storage location, assigning the data to a `memory` variable causes all fields of the struct/array to be read from storage, which incurs a Gcoldsload (**2100 gas**) for *each* field of the struct/array. If the fields are read from the new memory variable, they incur an additional `MLOAD` rather than a cheap stack read. Instead of declaring the variable with the `memory` keyword, declaring the variable with the `storage` keyword and caching any fields that need to be re-read in stack variables, will be much cheaper, only incurring the Gcoldsload for the fields actually read. The only time it makes sense to read the whole struct/array into a `memory` variable, is if the full struct/array is being returned by the function, is being passed to a function that requires `memory`, or if the array/struct is being read from another `memory` array/struct.

<details>
<summary>
There are <b>12</b> instances (click to show):
</summary>

```solidity
File: src/Kernel.sol

542:         Policy[] memory dependents = moduleDependents[keycode_];

568:             Permissions memory request = requests_[i];

```

```solidity
File: src/modules/PaymentEscrow.sol

233:             Item memory item = items[i];

```

```solidity
File: src/modules/Storage.sol

198:             RentalAssetUpdate memory asset = rentalAssetUpdates[i];

230:             RentalAssetUpdate memory asset = rentalAssetUpdates[i];

261:             RentalAssetUpdate memory asset = rentalAssetUpdates[i];

```

```solidity
File: src/packages/Reclaimer.sol

91:             Item memory item = rentalOrder.items[i];

```

```solidity
File: src/policies/Create.sol

211:             SpentItem memory offer = offers[i];

263:             SpentItem memory offer = offers[i];

339:             ReceivedItem memory consideration = considerations[i];

377:             ReceivedItem memory consideration = considerations[i];

696:             ReceivedItem memory execution = executions[i];

```

</details>


<a name="GAS-30"></a> 
### [GAS-30] Use `uint256(1)`/`uint256(2)` instead of `true`/`false` to save gas for changes
Avoids a Gsset (20000 gas) when changing from false to true, after having been true in the past. Since most of the bools aren't changed twice in one transaction, I've counted the amount of gas as half of the full amount, for each variable.

*There are <b>8</b> instances of this issue:*
```solidity
File: src/Create2Deployer.sol

16:     mapping(address => bool) public deployed;

```

```solidity
File: src/Kernel.sol

116:     bool public isActive;

221:     mapping(Keycode => mapping(Policy => mapping(bytes4 => bool)))

229:     mapping(address => mapping(Role => bool)) public hasRole;

230:     mapping(Role => bool) public isRole;

```

```solidity
File: src/modules/Storage.sol

20:     mapping(bytes32 orderHash => bool isActive) public orders;

55:     mapping(address delegate => bool isWhitelisted) public whitelistedDelegates;

58:     mapping(address extension => bool isWhitelisted) public whitelistedExtensions;

```


<a name="GAS-31"></a> 
### [GAS-31] Using bitmap to store bool states can save gas
Using a bitmap instead of a bool array or a bool mapping to store boolean states can save gas fees. This is because the bitmap can store 256 boolean values in a single slot instead of 256 slots, which can save gas when writing bool values or when reading multiple bool values from the same slot.

*There are <b>7</b> instances of this issue:*
```solidity
File: src/Create2Deployer.sol

16:     mapping(address => bool) public deployed;

```

```solidity
File: src/Kernel.sol

221:     mapping(Keycode => mapping(Policy => mapping(bytes4 => bool)))

229:     mapping(address => mapping(Role => bool)) public hasRole;

230:     mapping(Role => bool) public isRole;

```

```solidity
File: src/modules/Storage.sol

20:     mapping(bytes32 orderHash => bool isActive) public orders;

55:     mapping(address delegate => bool isWhitelisted) public whitelistedDelegates;

58:     mapping(address extension => bool isWhitelisted) public whitelistedExtensions;

```


<a name="GAS-32"></a> 
### [GAS-32] `abi.encodePacked` is more gas efficient than `abi.encode`
`abi.encode` pads all elementary types to 32 bytes, whereas `abi.encodePacked` will only use the minimal required memory to encode the data. See [here](https://docs.soliditylang.org/en/v0.8.11/abi-spec.html?highlight=encodepacked#non-standard-packed-mode) for more info.

*There are <b>9</b> instances of this issue:*
```solidity
File: src/packages/Signer.sol

129:                 abi.encode(

151:                 abi.encode(_HOOK_TYPEHASH, hook.target, hook.itemIndex, hook.extraData)

183:                 abi.encode(

208:         return keccak256(abi.encode(_ORDER_FULFILLMENT_TYPEHASH, fulfillment.recipient));

233:                 abi.encode(

254:                 abi.encode(

280:                 abi.encode(

374:             abi.encode(rentalOrderTypeString, hookTypeString, itemTypeString)

```

```solidity
File: src/policies/Factory.sol

184:                 uint256(keccak256(abi.encode(STORE.totalSafes() + 1, block.chainid)))

```


<a name="GAS-33"></a> 
### [GAS-33] Using bools for storage incurs overhead
Use uint256(1) and uint256(2) for true/false to avoid a Gwarmaccess (100 gas), and to avoid Gsset (20000 gas) when changing from ‘false’ to ‘true’, after having been ‘true’ in the past. See [source](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27).

*There are <b>8</b> instances of this issue:*
```solidity
File: src/Create2Deployer.sol

16:     mapping(address => bool) public deployed;

```

```solidity
File: src/Kernel.sol

116:     bool public isActive;

221:     mapping(Keycode => mapping(Policy => mapping(bytes4 => bool)))

229:     mapping(address => mapping(Role => bool)) public hasRole;

230:     mapping(Role => bool) public isRole;

```

```solidity
File: src/modules/Storage.sol

20:     mapping(bytes32 orderHash => bool isActive) public orders;

55:     mapping(address delegate => bool isWhitelisted) public whitelistedDelegates;

58:     mapping(address extension => bool isWhitelisted) public whitelistedExtensions;

```


<a name="GAS-34"></a> 
### [GAS-34] Cache array length outside of loop
If not cached, the solidity compiler will always read the length of the array during each iteration. That is, if it is a storage array, this is an extra sload operation (100 additional extra gas for each iteration except for the first) and if it is a memory array, this is an extra mload operation (3 additional gas for each iteration except for the first).

<details>
<summary>
There are <b>21</b> instances (click to show):
</summary>

```solidity
File: src/modules/PaymentEscrow.sol

231:         for (uint256 i = 0; i < items.length; ++i) {

341:         for (uint256 i = 0; i < orders.length; ++i) {

```

```solidity
File: src/modules/Storage.sol

197:         for (uint256 i = 0; i < rentalAssetUpdates.length; ++i) {

229:         for (uint256 i = 0; i < rentalAssetUpdates.length; ++i) {

249:         for (uint256 i = 0; i < orderHashes.length; ++i) {

260:         for (uint256 i = 0; i < rentalAssetUpdates.length; ++i) {

```

```solidity
File: src/packages/Signer.sol

170:         for (uint256 i = 0; i < order.items.length; ++i) {

176:         for (uint256 i = 0; i < order.hooks.length; ++i) {

225:         for (uint256 i = 0; i < metadata.hooks.length; ++i) {

```

```solidity
File: src/policies/Create.sol

209:         for (uint256 i; i < offers.length; ++i) {

261:         for (uint256 i; i < offers.length; ++i) {

337:         for (uint256 i; i < considerations.length; ++i) {

375:         for (uint256 i; i < considerations.length; ++i) {

475:         for (uint256 i = 0; i < hooks.length; ++i) {

567:             for (uint256 i; i < items.length; ++i) {

599:             for (uint256 i = 0; i < items.length; ++i) {

695:         for (uint256 i = 0; i < executions.length; ++i) {

```

```solidity
File: src/policies/Stop.sol

205:         for (uint256 i = 0; i < hooks.length; ++i) {

276:         for (uint256 i; i < order.items.length; ++i) {

324:         for (uint256 i = 0; i < orders.length; ++i) {

333:             for (uint256 j = 0; j < orders[i].items.length; ++j) {

```

</details>


<a name="GAS-35"></a> 
### [GAS-35] State variables should be cached in stack variables rather than re-reading them from storage
The instances below point to the second+ access of a state variable within a function. Caching of a state variable replaces each Gwarmaccess (100 gas) with a much cheaper stack read. Other less obvious fixes/optimizations include having local memory caches of state variable structs, or having local caches of state variable contracts/addresses.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/Kernel.sol

/// @audit more than 1 read for `activePolicies`, line 523 and 520
523:             Policy policy = activePolicies[j];

```

```solidity
File: src/modules/Storage.sol

/// @audit more than 1 read for `totalSafes`, line 282 and 276
282:         totalSafes = newSafeCount;

```

```solidity
File: src/policies/Guard.sol

/// @audit more than 1 read for `STORE`, line 335 and 334
335:         bool isActive = STORE.hookOnTransaction(hook);

```


<a name="GAS-36"></a> 
### [GAS-36] Use `calldata` instead of `memory` for function arguments that do not get mutated
Mark data types as `calldata` instead of `memory` where possible. This makes it so that the data is not automatically loaded into memory. If the data passed into the function does not need to be changed (like updating values in an array), it can be passed in as `calldata`. The one exception to this is if the argument must later be passed into another function that takes an argument that specifies `memory` storage.

*There are <b>8</b> instances of this issue:*
```solidity
File: src/Create2Deployer.sol

34:         bytes memory initCode

86:         bytes memory initCode

```

```solidity
File: src/modules/Storage.sol

191:         RentalAssetUpdate[] memory rentalAssetUpdates

```

```solidity
File: src/policies/Create.sol

127:         RentalOrder memory order

138:         RentPayload memory payload

149:         OrderMetadata memory metadata

```

```solidity
File: src/policies/Guard.sol

312:         bytes memory data,

319:         bytes memory,

```


<a name="GAS-37"></a> 
### [GAS-37] Don't initialize variables with default value

<details>
<summary>
There are <b>18</b> instances (click to show):
</summary>

```solidity
File: src/Kernel.sol

566:         for (uint256 i = 0; i < reqLength; ++i) {

```

```solidity
File: src/modules/PaymentEscrow.sol

231:         for (uint256 i = 0; i < items.length; ++i) {

341:         for (uint256 i = 0; i < orders.length; ++i) {

```

```solidity
File: src/modules/Storage.sol

197:         for (uint256 i = 0; i < rentalAssetUpdates.length; ++i) {

229:         for (uint256 i = 0; i < rentalAssetUpdates.length; ++i) {

249:         for (uint256 i = 0; i < orderHashes.length; ++i) {

260:         for (uint256 i = 0; i < rentalAssetUpdates.length; ++i) {

```

```solidity
File: src/packages/Accumulator.sol

120:         for (uint256 i = 0; i < rentalAssetUpdateLength; ++i) {

```

```solidity
File: src/packages/Reclaimer.sol

90:         for (uint256 i = 0; i < itemCount; ++i) {

```

```solidity
File: src/packages/Signer.sol

170:         for (uint256 i = 0; i < order.items.length; ++i) {

176:         for (uint256 i = 0; i < order.hooks.length; ++i) {

225:         for (uint256 i = 0; i < metadata.hooks.length; ++i) {

```

```solidity
File: src/policies/Create.sol

475:         for (uint256 i = 0; i < hooks.length; ++i) {

599:             for (uint256 i = 0; i < items.length; ++i) {

695:         for (uint256 i = 0; i < executions.length; ++i) {

```

```solidity
File: src/policies/Stop.sol

205:         for (uint256 i = 0; i < hooks.length; ++i) {

324:         for (uint256 i = 0; i < orders.length; ++i) {

333:             for (uint256 j = 0; j < orders[i].items.length; ++j) {

```

</details>


<a name="GAS-38"></a> 
### [GAS-38] Usage of `int`s/`uint`s smaller than 32 bytes incurs overhead
Using `int`s/`uint`s smaller than 32 bytes may cost more gas. This is because the EVM operates on 32 bytes at a time, so if an element is smaller than 32 bytes, the EVM must perform more operations to reduce the size of the element from 32 bytes to the desired size.

<details>
<summary>
There are <b>23</b> instances (click to show):
</summary>

```solidity
File: src/Create2Deployer.sol

94:         return address(uint160(uint256(addressHash)));

```

```solidity
File: src/Kernel.sol

100:     function VERSION() external pure virtual returns (uint8 major, uint8 minor) {}

100:     function VERSION() external pure virtual returns (uint8 major, uint8 minor) {}

```

```solidity
File: src/modules/PaymentEscrow.sol

68:     function VERSION() external pure override returns (uint8 major, uint8 minor) {

68:     function VERSION() external pure override returns (uint8 major, uint8 minor) {

279:                     revert Errors.Shared_OrderTypeNotSupported(uint8(orderType));

```

```solidity
File: src/modules/Storage.sol

47:     mapping(address hook => uint8 enabled) public hookStatus;

96:     function VERSION() external pure override returns (uint8 major, uint8 minor) {

96:     function VERSION() external pure override returns (uint8 major, uint8 minor) {

151:         return (uint8(1) & hookStatus[hook]) != 0;

161:         return uint8(2) & hookStatus[hook] != 0;

171:         return uint8(4) & hookStatus[hook] != 0;

315:         uint8 bitmap

321:         if (bitmap > uint8(7))

```

```solidity
File: src/packages/Signer.sol

353:             "Item(uint8 itemType,uint8 settleTo,address token,uint256 amount,uint256 identifier)"

353:             "Item(uint8 itemType,uint8 settleTo,address token,uint256 amount,uint256 identifier)"

363:             "RentalOrder(bytes32 seaportOrderHash,Item[] items,Hook[] hooks,uint8 orderType,address lender,address renter,address rentalWallet,uint256 startTimestamp,uint256 endTimestamp)"

385:                 "OrderMetadata(uint8 orderType,uint256 rentDuration,Hook[] hooks,bytes emittedExtraData)"

```

```solidity
File: src/policies/Create.sol

451:             revert Errors.Shared_OrderTypeNotSupported(uint8(orderType));

```

```solidity
File: src/policies/Guard.sol

246:                 uint160(

258:                 uint160(

375:         uint8 bitmap

```

```solidity
File: src/policies/Stop.sol

154:             revert Errors.Shared_OrderTypeNotSupported(uint8(orderType));

```

</details>


<a name="GAS-39"></a> 
### [GAS-39] Constructors can be marked as `payable` to save deployment gas
Payable functions cost less gas to execute, because the compiler does not have to add extra checks to ensure that no payment is provided. A constructor can be safely marked as payable, because only the deployer would be able to pass funds, and the project itself would not pass any funds.

<details>
<summary>
There are <b>12</b> instances (click to show):
</summary>

```solidity
File: src/Kernel.sol

33:     constructor(Kernel kernel_) {

71:     constructor(Kernel kernel_) KernelAdapter(kernel_) {}

124:     constructor(Kernel kernel_) KernelAdapter(kernel_) {}

242:     constructor(address _executor, address _admin) {

```

```solidity
File: src/modules/PaymentEscrow.sol

51:     constructor(Kernel kernel_) Module(kernel_) {}

```

```solidity
File: src/modules/Storage.sol

79:     constructor(Kernel kernel_) Module(kernel_) {}

```

```solidity
File: src/packages/Reclaimer.sol

22:     constructor() {

```

```solidity
File: src/packages/Signer.sol

44:     constructor() {

```

```solidity
File: src/policies/Admin.sol

29:     constructor(Kernel kernel_) Policy(kernel_) {}

```

```solidity
File: src/policies/Create.sol

61:     constructor(Kernel kernel_) Policy(kernel_) Signer() Zone() {}

```

```solidity
File: src/policies/Guard.sol

52:     constructor(Kernel kernel_) Policy(kernel_) {}

```

```solidity
File: src/policies/Stop.sol

52:     constructor(Kernel kernel_) Policy(kernel_) Signer() Reclaimer() {}

```

</details>


<a name="GAS-40"></a> 
### [GAS-40] Functions guaranteed to revert when called by normal users can be marked `payable`
If a function modifier such as `onlyOwner` is used, the function will revert if a normal user tries to pay the function. Marking the function as `payable` will lower the gas cost for legitimate callers because the compiler will not include checks for whether a payment was provided.

<details>
<summary>
There are <b>21</b> instances (click to show):
</summary>

```solidity
File: src/Kernel.sol

54:     function changeKernel(Kernel newKernel_) external onlyKernel {

106:     function INIT() external virtual onlyKernel {}

192:     function setActiveStatus(bool activate_) external onlyKernel {

277:     function executeAction(Actions action_, address target_) external onlyExecutor {

310:     function grantRole(Role role_, address addr_) public onlyAdmin {

333:     function revokeRole(Role role_, address addr_) public onlyAdmin {

```

```solidity
File: src/modules/PaymentEscrow.sol

320:     function settlePayment(RentalOrder calldata order) external onlyByProxy permissioned {

380:     function setFee(uint256 feeNumerator) external onlyByProxy permissioned {

397:     function skim(address token, address to) external onlyByProxy permissioned {

420:     function upgrade(address newImplementation) external onlyByProxy permissioned {

429:     function freeze() external onlyByProxy permissioned {

```

```solidity
File: src/modules/Storage.sol

274:     function addRentalSafe(address safe) external onlyByProxy permissioned {

294:     function updateHookPath(address to, address hook) external onlyByProxy permissioned {

360:     function upgrade(address newImplementation) external onlyByProxy permissioned {

369:     function freeze() external onlyByProxy permissioned {

```

```solidity
File: src/policies/Admin.sol

126:     function upgradeStorage(address newImplementation) external onlyRole("ADMIN_ADMIN") {

134:     function freezeStorage() external onlyRole("ADMIN_ADMIN") {

154:     function freezePaymentEscrow() external onlyRole("ADMIN_ADMIN") {

164:     function skim(address token, address to) external onlyRole("ADMIN_ADMIN") {

173:     function setFee(uint256 feeNumerator) external onlyRole("ADMIN_ADMIN") {

```

```solidity
File: src/policies/Guard.sol

362:     function updateHookPath(address to, address hook) external onlyRole("GUARD_ADMIN") {

```

</details>


<a name="GAS-41"></a> 
### [GAS-41] Using assembly to check for zero can save gas
Using assembly to check for zero can save gas by allowing more direct access to the evm and reducing some of the overhead associated with high-level operations in solidity.

<details>
<summary>
There are <b>24</b> instances (click to show):
</summary>

```solidity
File: src/Kernel.sol

182:         if (moduleForKeycode == address(0))

361:         if (address(getModuleForKeycode[keycode]) != address(0)) {

392:         if (address(oldModule) == address(0) || oldModule == newModule_) {

```

```solidity
File: src/modules/PaymentEscrow.sol

115:         if (!success || (data.length != 0 && !abi.decode(data, (bool)))) {

242:                 if (fee != 0) {

366:         if (amount == 0) {

```

```solidity
File: src/modules/Storage.sol

127:         return rentedAssets[rentalId] != 0;

141:         return hookStatus[hook] != 0 ? hook : address(0);

151:         return (uint8(1) & hookStatus[hook]) != 0;

161:         return uint8(2) & hookStatus[hook] != 0;

171:         return uint8(4) & hookStatus[hook] != 0;

296:         if (to.code.length == 0) revert Errors.StorageModule_NotContract(to);

299:         if (hook.code.length == 0) revert Errors.StorageModule_NotContract(hook);

318:         if (hook.code.length == 0) revert Errors.StorageModule_NotContract(hook);

```

```solidity
File: src/policies/Create.sol

201:         if (offers.length == 0) {

311:         if (totalRentals == 0 || totalPayments == 0) {

311:         if (totalRentals == 0 || totalPayments == 0) {

332:         if (considerations.length == 0) {

396:         if (totalRentals == 0 || totalPayments == 0) {

396:         if (totalRentals == 0 || totalPayments == 0) {

631:         if (metadata.rentDuration == 0) {

649:         if (STORE.deployedSafes(safe) == 0) {

```

```solidity
File: src/policies/Factory.sol

143:         if (threshold == 0 || threshold > owners.length) {

```

```solidity
File: src/policies/Guard.sol

338:         if (hook != address(0) && isActive) {

```

</details>


<a name="GAS-42"></a> 
### [GAS-42] `internal` functions not called by the contract should be removed
If the functions are required by an interface, the contract should inherit from that interface and use the `override` keyword

*There are <b>9</b> instances of this issue:*
```solidity
File: src/Kernel.sol

180:     function getModuleAddress(Keycode keycode_) internal view returns (address) {

```

```solidity
File: src/packages/Accumulator.sol

32:     function _insert(

96:     function _convertToStatic(

```

```solidity
File: src/packages/Signer.sol

76:     function _validateFulfiller(

94:     function _validateProtocolSignatureExpiration(uint256 expiration) internal view {

107:     function _recoverSignerFromPayload(

162:     function _deriveRentalOrderHash(

248:     function _deriveRentPayloadHash(

```

```solidity
File: src/policies/Create.sol

530:     function _rentFromZone(

```


