# Report

Audit report for **2024-02-spectra** generated by *ubl4nk_bot*.

## Low Issues


*Total <b>105</b> instances over <b>19</b> issues:*

|ID|Issue|Instances|
|-|:-|:-:|
| [L-1](#L-1) | Missing zero address check in functions with address parameters | 33 |
| [L-2](#L-2) | Consider implementing two-step procedure for updating protocol addresses | 1 |
| [L-3](#L-3) | Constructor / initialization function lacks parameter validation | 3 |
| [L-4](#L-4) | Code does not follow the best practice of check-effects-interaction | 11 |
| [L-5](#L-5) | Lack of `_disableInitializers` call to prevent uninitialized contracts | 2 |
| [L-6](#L-6) | Missing checks for state variable assignments | 6 |
| [L-7](#L-7) | Missing limits when setting min/max amounts | 1 |
| [L-8](#L-8) | Missing zero address check in constructor | 1 |
| [L-9](#L-9) | Consider some checks for `address(0)` when setting address state variables | 5 |
| [L-10](#L-10) | Check storage gap for upgradable contracts | 2 |
| [L-11](#L-11) | Solidity version 0.8.20 or above may not work on other chains due to PUSH0 | 6 |
| [L-12](#L-12) | Some functions do not work correctly with fee-on-transfer tokens | 9 |
| [L-13](#L-13) | Some tokens may revert when large transfers are made | 9 |
| [L-14](#L-14) | Some tokens may revert when zero value transfers are made | 9 |
| [L-15](#L-15) | Tokens may be minted to `address(0)` | 1 |
| [L-16](#L-16) | Using zero as a parameter | 1 |
| [L-17](#L-17) | Missing zero address check in initializer | 1 |
| [L-18](#L-18) | `decimals()` is not a part of the ERC-20 standard | 2 |
| [L-19](#L-19) | Initializers could be front-run | 2 |

## Non Critical Issues


*Total <b>751</b> instances over <b>75</b> issues:*

|ID|Issue|Instances|
|-|:-|:-:|
| [NC-1](#NC-1) | Assembly blocks should have extensive comments | 3 |
| [NC-2](#NC-2) | Add inline comments for unnamed variables | 2 |
| [NC-3](#NC-3) | Avoid mutating function parameters | 1 |
| [NC-4](#NC-4) | Consider adding a block/deny-list | 5 |
| [NC-5](#NC-5) | Consider adding emergency-stop functionality | 4 |
| [NC-6](#NC-6) | Consider adding formal verification proofs | 1 |
| [NC-7](#NC-7) | Constant decimal values | 2 |
| [NC-8](#NC-8) | Constants should be put on the left side of comparisons | 18 |
| [NC-9](#NC-9) | `Constructor` should emit an event | 5 |
| [NC-10](#NC-10) | Contract does not follow the Solidity Style Guide's suggested layout ordering | 4 |
| [NC-11](#NC-11) | Contract should expose an `interface` | 67 |
| [NC-12](#NC-12) | Contract uses both `require()`/`revert()` as well as custom errors | 1 |
| [NC-13](#NC-13) | Contracts should each be defined in separate files | 2 |
| [NC-14](#NC-14) | Contracts should have full test coverage | 1 |
| [NC-15](#NC-15) | Events that mark critical parameter changes should contain both the old and the new value | 11 |
| [NC-16](#NC-16) | Custom errors has no error details | 2 |
| [NC-17](#NC-17) | Solidity version is different in some files | 2 |
| [NC-18](#NC-18) | Do not use underscore at the end of variable name | 1 |
| [NC-19](#NC-19) | Polymorphic functions make security audits more time-consuming and error-prone | 7 |
| [NC-20](#NC-20) | Duplicated `require()`/`revert()` checks should be refactored | 12 |
| [NC-21](#NC-21) | `else` block not required | 2 |
| [NC-22](#NC-22) | Empty bytes check is missing | 5 |
| [NC-23](#NC-23) | Enable IR-based code generation | 1 |
| [NC-24](#NC-24) | Events are emitted without the sender information | 7 |
| [NC-25](#NC-25) | Events may be emitted out of order due to reentrancy | 5 |
| [NC-26](#NC-26) | Execution at deadlines should be allowed | 4 |
| [NC-27](#NC-27) |  Function ordering does not follow the Solidity Style Guide | 29 |
| [NC-28](#NC-28) | Variable names for `immutable`s should use CONSTANT_CASE | 2 |
| [NC-29](#NC-29) | Import declarations should import specific identifiers, rather than the whole file | 29 |
| [NC-30](#NC-30) | Imports could be organized more systematically | 9 |
| [NC-31](#NC-31) | It is best practice to use linear inheritance | 3 |
| [NC-32](#NC-32) | Lack of brace spacing | 1 |
| [NC-33](#NC-33) | Large or complicated code bases should implement invariant tests | 1 |
| [NC-34](#NC-34) | Long functions should be refactored into multiple, smaller, functions | 2 |
| [NC-35](#NC-35) | Magic numbers should be replaced with constants | 2 |
| [NC-36](#NC-36) | Missing events in initializers | 1 |
| [NC-37](#NC-37) | Named mappings are recommended | 3 |
| [NC-38](#NC-38) | Named imports of parent contracts are missing | 4 |
| [NC-39](#NC-39) | Missing NatSpec from contract/error/event/function/modifier declarations | 13 |
| [NC-40](#NC-40) | Missing NatSpec `@author` from contract declaration | 7 |
| [NC-41](#NC-41) | Missing NatSpec `@dev` from contract/event/function/modifier declarations | 18 |
| [NC-42](#NC-42) | Missing NatSpec `@notice` from contract/event/function/modifier declarations | 114 |
| [NC-43](#NC-43) | Missing NatSpec `@param` from event/function/modifier declarations | 59 |
| [NC-44](#NC-44) | Missing NatSpec `@return` from function declaration | 58 |
| [NC-45](#NC-45) | Missing NatSpec `@title` from contract declaration | 4 |
| [NC-46](#NC-46) | Potential Re-org Attack Vector | 1 |
| [NC-47](#NC-47) | Put all system-wide constants in one file | 7 |
| [NC-48](#NC-48) | Redundant `return` statement in a function with named return variables | 5 |
| [NC-49](#NC-49) | Setters should prevent re-setting the same value | 2 |
| [NC-50](#NC-50) | State variables should include comments | 6 |
| [NC-51](#NC-51) | The `nonReentrant` modifier should occur before all other modifiers | 2 |
| [NC-52](#NC-52) | Lines are too long | 1 |
| [NC-53](#NC-53) | Typos | 4 |
| [NC-54](#NC-54) | Unnecessary cast | 6 |
| [NC-55](#NC-55) | Unsafe solidity low-level call can cause gas grief attack | 1 |
| [NC-56](#NC-56) | Unused named return | 4 |
| [NC-57](#NC-57) | Unused contract variables | 1 |
| [NC-58](#NC-58) | Use `abi.encodeCall()` instead of `abi.encodeWithSignature()`/`abi.encodeWithSelector()` | 2 |
| [NC-59](#NC-59) | Consider using `delete` rather than assigning zero/false to clear values | 1 |
| [NC-60](#NC-60) | Expressions for constant values should use `immutable` rather than `constant` | 7 |
| [NC-61](#NC-61) | Use `@inheritdoc` for overridden functions | 40 |
| [NC-62](#NC-62) | Upgrade `openzeppelin` to the latest version (`5.0.1`) | 1 |
| [NC-63](#NC-63) | Use the latest solidity version for deployment (`0.8.24`) | 7 |
| [NC-64](#NC-64) | Use the Modern Upgradeable Contract Paradigm | 3 |
| [NC-65](#NC-65) | Consider using modifiers for address control | 7 |
| [NC-66](#NC-66) | Use of `override` is unnecessary | 56 |
| [NC-67](#NC-67) | Use a struct to encapsulate multiple function parameters | 1 |
| [NC-68](#NC-68) | Whitespace in Expressions | 2 |
| [NC-69](#NC-69) | Empty body - Consider commenting why | 1 |
| [NC-70](#NC-70) | Names of `private`/`internal` functions should be prefixed with an underscore | 3 |
| [NC-71](#NC-71) | Names of `private`/`internal` state variables should be prefixed with an underscore | 21 |
| [NC-72](#NC-72) |  `require()` / `revert()` statements should have descriptive reason strings | 2 |
| [NC-73](#NC-73) | Event is missing `indexed` fields | 2 |
| [NC-74](#NC-74) | Functions not used internally could be marked `external` | 12 |
| [NC-75](#NC-75) | Use `using` keyword when using specific imports rather than calling the specific import directly | 9 |

## Gas Optimizations


*Total <b>168</b> instances over <b>36</b> issues:*

|ID|Issue|Instances|Gas|
|-|:-|:-:|:-:|
| [GAS-1](#GAS-1) | Consider activating via-ir for deploying | 1 | - |
| [GAS-2](#GAS-2) | Don't transfer with zero amount to save gas | 1 | - |
| [GAS-3](#GAS-3) | Operator `+=` costs more gas than `<x> = <x> + <y>` for state variables | 2 | 226 |
| [GAS-4](#GAS-4) | Duplicated `require()`/`revert()` checks should be refactored to a modifier or function to save gas | 12 | - |
| [GAS-5](#GAS-5) | Initializers can be marked as payable to save deployment gas | 2 | 42 |
| [GAS-6](#GAS-6) | Inline `modifier`s that are only used once, to save gas | 1 | - |
| [GAS-7](#GAS-7) | `internal` functions only called once can be inlined to save gas | 4 | 120 |
| [GAS-8](#GAS-8) | `keccak256()` hash of literals should only be computed once | 1 | 42 |
| [GAS-9](#GAS-9) | Multiple accesses of the same mapping/array key/index should be cached | 3 | 126 |
| [GAS-10](#GAS-10) | Operator `>=`/`<=` costs less gas than operator `>`/`<` | 19 | 57 |
| [GAS-11](#GAS-11) | Optimize Gas by splitting `if() revert` statements | 1 | - |
| [GAS-12](#GAS-12) | Optimize names to save gas | 4 | 88 |
| [GAS-13](#GAS-13) | Redundant state variable getters | 10 | - |
| [GAS-14](#GAS-14) | Remove or replace unused state variables | 1 | - |
| [GAS-15](#GAS-15) | `require()`/`revert()` strings longer than 32 bytes cost extra gas | 1 | 3 |
| [GAS-16](#GAS-16) | The result of a function call should be cached rather than re-calling the function | 3 | 300 |
| [GAS-17](#GAS-17) | Unused named return variables without optimizer waste gas | 4 | 36 |
| [GAS-18](#GAS-18) | Optimize external calls with assembly for memory efficiency | 22 | 4840 |
| [GAS-19](#GAS-19) | Use assembly in place of `abi.decode` to extract `calldata` values more efficiently | 1 | - |
| [GAS-20](#GAS-20) | Use assembly to compute hashes to save gas | 1 | 80 |
| [GAS-21](#GAS-21) | Use assembly to emit events | 11 | 418 |
| [GAS-22](#GAS-22) | Use assembly to validate `msg.sender` | 7 | - |
| [GAS-23](#GAS-23) | Use assembly to write address/contract type storage values | 8 | 400 |
| [GAS-24](#GAS-24) | Use byte32 in place of string | 1 | - |
| [GAS-25](#GAS-25) | Using a double `if` statement instead of a logical AND (`&&`) | 4 | 120 |
| [GAS-26](#GAS-26) | Use local variables for emitting | 3 | 291 |
| [GAS-27](#GAS-27) | Use a more recent version of solidity | 7 | - |
| [GAS-28](#GAS-28) | Use `uint256(1)`/`uint256(2)` instead of `true`/`false` to save gas for changes | 1 | 8550 |
| [GAS-29](#GAS-29) | Use `unchecked` block for safe subtractions | 6 | 510 |
| [GAS-30](#GAS-30) | Using bools for storage incurs overhead | 1 | 100 |
| [GAS-31](#GAS-31) | State variables should be cached in stack variables rather than re-reading them from storage | 5 | 485 |
| [GAS-32](#GAS-32) | Use `calldata` instead of `memory` for function arguments that do not get mutated | 3 | - |
| [GAS-33](#GAS-33) | Usage of `int`s/`uint`s smaller than 32 bytes incurs overhead | 5 | 275 |
| [GAS-34](#GAS-34) | Constructors can be marked as `payable` to save deployment gas | 4 | 84 |
| [GAS-35](#GAS-35) | Using `private` rather than `public` for constants, saves gas | 2 | - |
| [GAS-36](#GAS-36) | `internal` functions not called by the contract should be removed | 6 | - |

## Low Issues

<a name="L-1"></a> 
### [L-1] Missing zero address check in functions with address parameters
Adding a zero address check for each address type parameter can prevent errors.

<details>
<summary>
There are <b>33</b> instances (click to show):
</summary>

```solidity
File: src/libraries/PrincipalTokenUtil.sol

/// @audit missing zero check for `_token`
137:     function _tryGetTokenDecimals(address _token) external view returns (uint8) {

/// @audit missing zero check for `_pt`
157:     function _computeTokenizationFee(
             uint256 _amount,
             address _pt,
             address _registry
         ) internal view returns (uint256) {

```
*Github:* [[137](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L137), [157](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L157)]


```solidity
File: src/proxy/AMProxyAdmin.sol

/// @audit missing zero check for `implementation`
40:     function upgradeAndCall(
            IAMTransparentUpgradeableProxy proxy,
            address implementation,
            bytes memory data
        ) public payable virtual restricted {

```
*Github:* [[40](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L40)]


```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

/// @audit missing zero check for ``
18:     function upgradeToAndCall(address, bytes calldata) external payable;

```
*Github:* [[18](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L18)]


```solidity
File: src/tokens/PrincipalToken.sol

/// @audit missing zero check for `receiver`
171:     function deposit(uint256 assets, address receiver) external override returns (uint256 shares) {

/// @audit missing zero check for `ptReceiver`
/// @audit missing zero check for `ytReceiver`
176:     function deposit(
             uint256 assets,
             address ptReceiver,
             address ytReceiver
         ) public override returns (uint256 shares) {

/// @audit missing zero check for `ptReceiver`
/// @audit missing zero check for `ytReceiver`
188:     function deposit(
             uint256 assets,
             address ptReceiver,
             address ytReceiver,
             uint256 minShares
         ) external override returns (uint256 shares) {

/// @audit missing zero check for `receiver`
201:     function depositIBT(uint256 ibts, address receiver) external override returns (uint256 shares) {

/// @audit missing zero check for `ptReceiver`
/// @audit missing zero check for `ytReceiver`
206:     function depositIBT(
             uint256 ibts,
             address ptReceiver,
             address ytReceiver
         ) public override returns (uint256 shares) {

/// @audit missing zero check for `ptReceiver`
/// @audit missing zero check for `ytReceiver`
216:     function depositIBT(
             uint256 ibts,
             address ptReceiver,
             address ytReceiver,
             uint256 minShares
         ) external override returns (uint256 shares) {

/// @audit missing zero check for `receiver`
/// @audit missing zero check for `owner`
229:     function redeem(
             uint256 shares,
             address receiver,
             address owner
         ) public override returns (uint256 assets) {

/// @audit missing zero check for `receiver`
/// @audit missing zero check for `owner`
240:     function redeem(
             uint256 shares,
             address receiver,
             address owner,
             uint256 minAssets
         ) external override returns (uint256 assets) {

/// @audit missing zero check for `receiver`
/// @audit missing zero check for `owner`
253:     function redeemForIBT(
             uint256 shares,
             address receiver,
             address owner
         ) public override returns (uint256 ibts) {

/// @audit missing zero check for `receiver`
/// @audit missing zero check for `owner`
265:     function redeemForIBT(
             uint256 shares,
             address receiver,
             address owner,
             uint256 minIbts
         ) external override returns (uint256 ibts) {

/// @audit missing zero check for `receiver`
/// @audit missing zero check for `owner`
278:     function withdraw(
             uint256 assets,
             address receiver,
             address owner
         ) public override returns (uint256 shares) {

/// @audit missing zero check for `receiver`
/// @audit missing zero check for `owner`
290:     function withdraw(
             uint256 assets,
             address receiver,
             address owner,
             uint256 maxShares
         ) external override returns (uint256 shares) {

/// @audit missing zero check for `receiver`
/// @audit missing zero check for `owner`
303:     function withdrawIBT(
             uint256 ibts,
             address receiver,
             address owner
         ) public override returns (uint256 shares) {

/// @audit missing zero check for `receiver`
/// @audit missing zero check for `owner`
316:     function withdrawIBT(
             uint256 ibts,
             address receiver,
             address owner,
             uint256 maxShares
         ) external override returns (uint256 shares) {

/// @audit missing zero check for `_user`
340:     function updateYield(address _user) public override returns (uint256 updatedUserYieldInIBT) {

/// @audit missing zero check for `_receiver`
369:     function claimYield(address _receiver) public override returns (uint256 yieldInAsset) {

/// @audit missing zero check for `_receiver`
377:     function claimYieldInIBT(address _receiver) public override returns (uint256 yieldInIBT) {

/// @audit missing zero check for `_rewardsProxy`
420:     function setRewardsProxy(address _rewardsProxy) external restricted {

/// @audit missing zero check for ``
441:     function maxDeposit(address) external pure override returns (uint256) {

/// @audit missing zero check for `_user`
560:     function getCurrentYieldOfUserInIBT(
             address _user
         ) external view override returns (uint256 _yieldOfUserInIBT) {

/// @audit missing zero check for `_token`
583:     function maxFlashLoan(address _token) public view override returns (uint256) {

/// @audit missing zero check for `_token`
594:     function flashFee(address _token, uint256 _amount) public view override returns (uint256) {

/// @audit missing zero check for `_ptReceiver`
750:     function _depositIBT(
             uint256 _ibts,
             address _ptReceiver,
             address _ytReceiver
         ) internal notExpired nonReentrant whenNotPaused returns (uint256 shares) {

/// @audit missing zero check for `_receiver`
/// @audit missing zero check for `_owner`
780:     function _withdrawShares(
             uint256 _ibts,
             address _receiver,
             address _owner,
             uint256 _ptRate,
             uint256 _ibtRate
         ) internal returns (uint256 shares) {

```
*Github:* [[171](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L171), [176](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L176), [188](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L188), [201](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L201), [206](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L206), [216](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L216), [229](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L229), [240](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L240), [253](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L253), [265](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L265), [278](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L278), [290](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L290), [303](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L303), [316](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L316), [340](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L340), [369](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L369), [377](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L377), [420](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L420), [441](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L441), [560](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L560), [583](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L583), [594](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L594), [750](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L750), [780](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L780)]


```solidity
File: src/tokens/YieldToken.sol

/// @audit missing zero check for `_pt`
31:     function initialize(
            string calldata _name,
            string calldata _symbol,
            address _pt
        ) external initializer {

/// @audit missing zero check for `from`
42:     function burnWithoutUpdate(address from, uint256 amount) external override {

/// @audit missing zero check for `to`
50:     function mint(address to, uint256 amount) external override {

/// @audit missing zero check for `to`
71:     function transfer(
            address to,
            uint256 amount
        ) public virtual override(IYieldToken, ERC20Upgradeable) returns (bool success) {

/// @audit missing zero check for `from`
/// @audit missing zero check for `to`
95:     function transferFrom(
            address from,
            address to,
            uint256 amount
        ) public virtual override(IYieldToken, ERC20Upgradeable) returns (bool success) {

```
*Github:* [[31](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L31), [42](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L42), [50](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L50), [71](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L71), [95](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L95)]


</details>


<a name="L-2"></a> 
### [L-2] Consider implementing two-step procedure for updating protocol addresses
A copy-paste error or a typo may end up bricking protocol functionality, or sending tokens to an address with no known private key. Consider implementing a two-step procedure for updating protocol addresses, where the recipient is set as pending, and must "accept" the assignment by making an affirmative call. A straight forward way of doing this would be to have the target contracts implement [EIP-165](https://eips.ethereum.org/EIPS/eip-165), and to have the "set" functions ensure that the recipient is of the right interface type.

*There is one instance of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

/// @audit `rewardsProxy`
420:     function setRewardsProxy(address _rewardsProxy) external restricted {

```
*Github:* [[420](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L420)]



<a name="L-3"></a> 
### [L-3] Constructor / initialization function lacks parameter validation
Constructors and initialization functions play a critical role in contracts by setting important initial states when the contract is first deployed before the system starts. The parameters passed to the constructor and initialization functions directly affect the behavior of the contract / protocol. If incorrect parameters are provided, the system may fail to run, behave abnormally, be unstable, or lack security. Therefore, it's crucial to carefully check each parameter in the constructor and initialization functions. If an exception is found, the transaction should be rolled back.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

/// @audit `_logic` not validated
/// @audit `_data` not validated
77:     constructor(

```
*Github:* [[77](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L77)]


```solidity
File: src/tokens/PrincipalToken.sol

/// @audit `_duration` not validated
120:     function initialize(

```
*Github:* [[120](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L120)]


```solidity
File: src/tokens/YieldToken.sol

/// @audit `_symbol` not validated
/// @audit `_pt` not validated
31:     function initialize(

```
*Github:* [[31](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L31)]



<a name="L-4"></a> 
### [L-4] Code does not follow the best practice of check-effects-interaction
Code should follow the best-practice of [check-effects-interaction](https://blockchain-academy.hs-mittweida.de/courses/solidity-coding-beginners-to-intermediate/lessons/solidity-11-coding-patterns/topic/checks-effects-interactions/), where state variables are updated before any external calls are made. Doing so prevents a large class of reentrancy bugs.

<details>
<summary>
There are <b>11</b> instances (click to show):
</summary>

```solidity
File: src/tokens/PrincipalToken.sol

/// @audit `.totalAssets(...)` is called on line 128
131:         _asset = IERC4626(_ibt).asset();

/// @audit `.totalAssets(...)` is called on line 128
/// @audit `.asset(...)` is called on line 131
132:         duration = _duration;

/// @audit `.totalAssets(...)` is called on line 128
/// @audit `.asset(...)` is called on line 131
133:         expiry = _duration + block.timestamp;

/// @audit `.totalAssets(...)` is called on line 128
/// @audit `.asset(...)` is called on line 131
/// @audit `.symbol(...)` is called on line 134
141:         _ibtDecimals = IERC4626(_ibt).decimals();

/// @audit `.totalAssets(...)` is called on line 128
/// @audit `.asset(...)` is called on line 131
/// @audit `.symbol(...)` is called on line 134
/// @audit `.decimals(...)` is called on line 141
142:         _assetDecimals = PrincipalTokenUtil._tryGetTokenDecimals(_asset);

/// @audit `.totalAssets(...)` is called on line 128
/// @audit `.asset(...)` is called on line 131
/// @audit `.symbol(...)` is called on line 134
/// @audit `.decimals(...)` is called on line 141
150:         ibt = _ibt;

/// @audit `.totalAssets(...)` is called on line 128
/// @audit `.asset(...)` is called on line 131
/// @audit `.symbol(...)` is called on line 134
/// @audit `.decimals(...)` is called on line 141
151:         ibtUnit = 10 ** _ibtDecimals;

/// @audit `.totalAssets(...)` is called on line 128
/// @audit `.asset(...)` is called on line 131
/// @audit `.symbol(...)` is called on line 134
/// @audit `.decimals(...)` is called on line 141
152:         ibtRate = IERC4626(ibt).previewRedeem(ibtUnit).toRay(_assetDecimals);

/// @audit `.totalAssets(...)` is called on line 128
/// @audit `.asset(...)` is called on line 131
/// @audit `.symbol(...)` is called on line 134
/// @audit `.decimals(...)` is called on line 141
/// @audit `.toRay(...)` is called on line 152
/// @audit `.previewRedeem(...)` is called on line 152
153:         ptRate = RayMath.RAY_UNIT;

/// @audit `.totalAssets(...)` is called on line 128
/// @audit `.asset(...)` is called on line 131
/// @audit `.symbol(...)` is called on line 134
/// @audit `.decimals(...)` is called on line 141
/// @audit `.toRay(...)` is called on line 152
/// @audit `.previewRedeem(...)` is called on line 152
154:         yt = _deployYT(

/// @audit `.getFeeCollector(...)` is called on line 330
334:         unclaimedFeesInIBT = 0;

```
*Github:* [[131](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L131), [132](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L132), [133](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L133), [141](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L141), [142](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L142), [150](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L150), [151](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L151), [152](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L152), [153](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L153), [154](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L154), [334](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L334)]


</details>


<a name="L-5"></a> 
### [L-5] Lack of `_disableInitializers` call to prevent uninitialized contracts
Multiple contracts are using the Initializable module from OpenZeppelin. For this reason and in order to prevent leaving that contract uninitialized OpenZeppelin's documentation recommends adding the `_disableInitializers` function in the constructor to automatically lock the contracts when they are deployed. this will protect the contract that holds the logic business from beeing initialized by an attack.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

120:     function initialize(

```
*Github:* [[120](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L120)]


```solidity
File: src/tokens/YieldToken.sol

31:     function initialize(

```
*Github:* [[31](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L31)]



<a name="L-6"></a> 
### [L-6] Missing checks for state variable assignments
There are some missing checks in these functions, and this could lead to unexpected scenarios. Consider always adding a sanity check for state variables.

*There are <b>6</b> instances of this issue:*
```solidity
File: src/proxy/AMBeacon.sol

/// @audit `newImplementation`
79:         _implementation = newImplementation;

```
*Github:* [[79](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L79)]


```solidity
File: src/tokens/PrincipalToken.sol

/// @audit `_registry`
106:         registry = _registry;

/// @audit `_duration`
132:         duration = _duration;

/// @audit `_ibt`
150:         ibt = _ibt;

/// @audit `_rewardsProxy`
423:         rewardsProxy = _rewardsProxy;

```
*Github:* [[106](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L106), [132](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L132), [150](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L150), [423](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L423)]


```solidity
File: src/tokens/YieldToken.sol

/// @audit `_pt`
38:         pt = _pt;

```
*Github:* [[38](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L38)]



<a name="L-7"></a> 
### [L-7] Missing limits when setting min/max amounts
There are some missing limits in these functions, and this could lead to unexpected scenarios. Consider adding a min/max limit for the following values, when appropriate.

*There is one instance of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

/// @audit `_duration`
120:     function initialize(
             address _ibt,
             uint256 _duration,
             address _initialAuthority
         ) external initializer {

```
*Github:* [[120](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L120)]



<a name="L-8"></a> 
### [L-8] Missing zero address check in constructor
Constructors often take address parameters to initialize important components of a contract, such as owner or linked contracts. However, without a checking, there's a risk that an address parameter could be mistakenly set to the zero address (0x0). This could be due to an error or oversight during contract deployment. A zero address in a crucial role can cause serious issues, as it cannot perform actions like a normal address, and any funds sent to it will be irretrievable. It's therefore crucial to include a zero address check in constructors to prevent such potential problems. If a zero address is detected, the constructor should revert the transaction.

*There is one instance of this issue:*
```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

/// @audit missing zero check for `_logic`
77:     constructor(
            address _logic,
            address initialAuthority,
            bytes memory _data
        ) payable ERC1967Proxy(_logic, _data) {

```
*Github:* [[77](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L77)]



<a name="L-9"></a> 
### [L-9] Consider some checks for `address(0)` when setting address state variables
Check for zero-address to avoid the risk of setting `address(0)` for state variables after an update.

*There are <b>5</b> instances of this issue:*
```solidity
File: src/proxy/AMBeacon.sol

/// @audit `newImplementation`
79:         _implementation = newImplementation;

```
*Github:* [[79](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L79)]


```solidity
File: src/tokens/PrincipalToken.sol

/// @audit `_registry`
106:         registry = _registry;

/// @audit `_ibt`
150:         ibt = _ibt;

/// @audit `_rewardsProxy`
423:         rewardsProxy = _rewardsProxy;

```
*Github:* [[106](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L106), [150](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L150), [423](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L423)]


```solidity
File: src/tokens/YieldToken.sol

/// @audit `_pt`
38:         pt = _pt;

```
*Github:* [[38](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L38)]



<a name="L-10"></a> 
### [L-10] Check storage gap for upgradable contracts
Each upgradable contract should include a state variable (usually named `__gap`) to provide reserved space in storage. This allows the team to freely add new state variables in the future upgrades without compromising the storage compatibility with existing deployments.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

29: contract PrincipalToken is
        ERC20PermitUpgradeable,

```
*Github:* [[29](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L29)]


```solidity
File: src/tokens/YieldToken.sol

15: contract YieldToken is IYieldToken, ERC20PermitUpgradeable {

```
*Github:* [[15](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L15)]



<a name="L-11"></a> 
### [L-11] Solidity version 0.8.20 or above may not work on other chains due to PUSH0
Solidity version 0.8.20 or above uses the new [Shanghai EVM](https://blog.soliditylang.org/2023/05/10/solidity-0.8.20-release-announcement/#important-note) which introduces the PUSH0 opcode. This op code may not yet be implemented on all evm-chains or Layer2s, so deployment on these chains will fail. Consider using an earlier solidity version.

*There are <b>6</b> instances of this issue:*
```solidity
File: src/libraries/PrincipalTokenUtil.sol

3: pragma solidity 0.8.20;

```
*Github:* [[3](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L3)]


```solidity
File: src/proxy/AMBeacon.sol

5: pragma solidity 0.8.20;

```
*Github:* [[5](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L5)]


```solidity
File: src/proxy/AMProxyAdmin.sol

5: pragma solidity 0.8.20;

```
*Github:* [[5](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L5)]


```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

4: pragma solidity 0.8.20;

```
*Github:* [[4](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L4)]


```solidity
File: src/tokens/PrincipalToken.sol

3: pragma solidity 0.8.20;

```
*Github:* [[3](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L3)]


```solidity
File: src/tokens/YieldToken.sol

3: pragma solidity 0.8.20;

```
*Github:* [[3](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L3)]



<a name="L-12"></a> 
### [L-12] Some functions do not work correctly with fee-on-transfer tokens
Some tokens take a transfer fee (e.g. `STA`, `PAXG`), some do not currently charge a fee but may do so in the future (e.g. `USDT`, `USDC`).

Should a fee-on-transfer token be added as an asset and deposited, it could be abused, as the accounting is wrong. In the current implementation the following function calls do not work well with fee-on-transfer tokens as the amount variable is the pre-fee amount, including the fee, whereas the final balance do not include the fee anymore.

*There are <b>9</b> instances of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

181:         IERC20(_asset).safeTransferFrom(msg.sender, address(this), assets);

211:         IERC20(ibt).safeTransferFrom(msg.sender, address(this), ibts);

260:         IERC20(ibt).safeTransfer(receiver, ibts);

312:         IERC20(ibt).safeTransfer(receiver, ibts);

380:             IERC20(ibt).safeTransfer(_receiver, yieldInIBT);

621:         IERC20(ibt).safeTransfer(address(_receiver), _amount);

628:         IERC20(ibt).safeTransferFrom(address(_receiver), address(this), _amount + fee);

```
*Github:* [[181](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L181), [211](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L211), [260](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L260), [312](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L312), [380](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L380), [621](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L621), [628](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L628)]


```solidity
File: src/tokens/YieldToken.sol

76:         return super.transfer(to, amount);

101:         return super.transferFrom(from, to, amount);

```
*Github:* [[76](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L76), [101](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L101)]



<a name="L-13"></a> 
### [L-13] Some tokens may revert when large transfers are made
Tokens such as COMP or UNI will revert when an address' balance reaches `type(uint96).max`. Ensure that the calls below can be broken up into smaller batches if necessary.

*There are <b>9</b> instances of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

181:         IERC20(_asset).safeTransferFrom(msg.sender, address(this), assets);

211:         IERC20(ibt).safeTransferFrom(msg.sender, address(this), ibts);

260:         IERC20(ibt).safeTransfer(receiver, ibts);

312:         IERC20(ibt).safeTransfer(receiver, ibts);

380:             IERC20(ibt).safeTransfer(_receiver, yieldInIBT);

621:         IERC20(ibt).safeTransfer(address(_receiver), _amount);

628:         IERC20(ibt).safeTransferFrom(address(_receiver), address(this), _amount + fee);

```
*Github:* [[181](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L181), [211](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L211), [260](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L260), [312](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L312), [380](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L380), [621](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L621), [628](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L628)]


```solidity
File: src/tokens/YieldToken.sol

76:         return super.transfer(to, amount);

101:         return super.transferFrom(from, to, amount);

```
*Github:* [[76](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L76), [101](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L101)]



<a name="L-14"></a> 
### [L-14] Some tokens may revert when zero value transfers are made
Despite the fact that [EIP-20 states](https://github.com/ethereum/EIPs/blob/7500ac4fc1bbdfaf684e7ef851f798f6b667b2fe/EIPS/eip-20.md?plain=1#L116) that zero-value transfers must be accepted, some tokens, such as LEND, will revert if this is attempted, which may cause transactions that involve other tokens (such as batch operations) to fully revert. Consider skipping the transfer if the amount is zero, which will also save gas.

*There are <b>9</b> instances of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

181:         IERC20(_asset).safeTransferFrom(msg.sender, address(this), assets);

211:         IERC20(ibt).safeTransferFrom(msg.sender, address(this), ibts);

260:         IERC20(ibt).safeTransfer(receiver, ibts);

312:         IERC20(ibt).safeTransfer(receiver, ibts);

380:             IERC20(ibt).safeTransfer(_receiver, yieldInIBT);

621:         IERC20(ibt).safeTransfer(address(_receiver), _amount);

628:         IERC20(ibt).safeTransferFrom(address(_receiver), address(this), _amount + fee);

```
*Github:* [[181](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L181), [211](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L211), [260](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L260), [312](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L312), [380](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L380), [621](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L621), [628](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L628)]


```solidity
File: src/tokens/YieldToken.sol

76:         return super.transfer(to, amount);

101:         return super.transferFrom(from, to, amount);

```
*Github:* [[76](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L76), [101](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L101)]



<a name="L-15"></a> 
### [L-15] Tokens may be minted to `address(0)`

*There is one instance of this issue:*
```solidity
File: src/tokens/YieldToken.sol

50:     function mint(address to, uint256 amount) external override {
            if (msg.sender != pt) {
                revert CallerIsNotPtContract();
            }
            _mint(to, amount);
        }

```
*Github:* [[50](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L50)]



<a name="L-16"></a> 
### [L-16] Using zero as a parameter
Taking `0` as a valid argument in Solidity without checks can lead to severe security issues. A historical example is the infamous `0x0` address bug where numerous tokens were lost. This happens because 0 can be interpreted as an uninitialized `address`, leading to transfers to the 0x0 address, effectively burning tokens. Moreover, `0` as a denominator in division operations would cause a runtime exception. It's also often indicative of a logical error in the caller's code. It's important to always validate input and handle edge cases like `0` appropriately. Use `require()` statements to enforce conditions and provide clear error messages to facilitate debugging and safer code.

*There is one instance of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

733:                     IYieldToken(address(0)).initialize.selector,

```
*Github:* [[733](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L733)]



<a name="L-17"></a> 
### [L-17] Missing zero address check in initializer

*There is one instance of this issue:*
```solidity
File: src/tokens/YieldToken.sol

/// @audit missing zero check for `_pt`
31:     function initialize(
            string calldata _name,
            string calldata _symbol,
            address _pt
        ) external initializer {

```
*Github:* [[31](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L31)]



<a name="L-18"></a> 
### [L-18] `decimals()` is not a part of the ERC-20 standard
The `decimals()` function is not a part of the ERC-20 standard, and was added later as an optional extension. As such, some valid ERC20 tokens do not support this interface, so it is unsafe to blindly cast all tokens to this interface, and then call this function.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/libraries/PrincipalTokenUtil.sol

129:         return _userYieldIBT + newYieldInIBTRay.fromRay(IERC20Metadata(_yt).decimals());

```
*Github:* [[129](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L129)]


```solidity
File: src/tokens/YieldToken.sol

112:         return IERC20Metadata(pt).decimals();

```
*Github:* [[112](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L112)]



<a name="L-19"></a> 
### [L-19] Initializers could be front-run
Initializers could be front-run, allowing an attacker to either set their own values, take ownership of the contract, and in the best case forcing a re-deployment

*There are <b>2</b> instances of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

120:     function initialize(

```
*Github:* [[120](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L120)]


```solidity
File: src/tokens/YieldToken.sol

31:     function initialize(

```
*Github:* [[31](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L31)]




## Non Critical Issues

<a name="NC-1"></a> 
### [NC-1] Assembly blocks should have extensive comments
Assembly blocks take a lot more time to audit than normal Solidity code, and often have gotchas and side-effects that the Solidity versions of the same code do not. Consider adding more comments explaining what is being done in every step of the assembly code, and describe why assembly is being used instead of Solidity.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/libraries/RayMath.sol

22:         assembly {

41:         assembly {

60:         assembly {

```
*Github:* [[22](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/RayMath.sol#L22), [41](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/RayMath.sol#L41), [60](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/RayMath.sol#L60)]



<a name="NC-2"></a> 
### [NC-2] Add inline comments for unnamed variables
`function foo(address x, address)` -> `function foo(address x, address /* y */)`

*There are <b>2</b> instances of this issue:*
```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

18:     function upgradeToAndCall(address, bytes calldata) external payable;

```
*Github:* [[18](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L18)]


```solidity
File: src/tokens/PrincipalToken.sol

441:     function maxDeposit(address) external pure override returns (uint256) {

```
*Github:* [[441](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L441)]



<a name="NC-3"></a> 
### [NC-3] Avoid mutating function parameters
Function parameters in Solidity are passed by value, meaning they are essentially local copies. Mutating them can lead to confusion and errors because the changes don't persist outside the function. By keeping function parameters immutable, you ensure clarity in code behavior, preventing unintended side-effects. If you need to modify a value based on a parameter, use a local variable inside the function, leaving the original parameter unaltered. By adhering to this practice, you maintain a clear distinction between input data and the internal processing logic, improving code readability and reducing the potential for bugs.

*There is one instance of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

/// @audit `_data`
394:     function claimRewards(bytes memory _data) external restricted {
             if (rewardsProxy == address(0)) {
                 revert NoRewardsProxySet();
             }
             _data = abi.encodeWithSelector(IRewardsProxy(rewardsProxy).claimRewards.selector, _data);

```
*Github:* [[394](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L394)]



<a name="NC-4"></a> 
### [NC-4] Consider adding a block/deny-list
Doing so will significantly increase centralization, but will help to prevent hackers from using stolen tokens.

*There are <b>5</b> instances of this issue:*
```solidity
File: src/proxy/AMBeacon.sol

20: contract AMBeacon is IBeacon, AccessManaged {

```
*Github:* [[20](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L20)]


```solidity
File: src/proxy/AMProxyAdmin.sol

14: contract AMProxyAdmin is AccessManaged {

```
*Github:* [[14](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L14)]


```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

60: contract AMTransparentUpgradeableProxy is ERC1967Proxy {

```
*Github:* [[60](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L60)]


```solidity
File: src/tokens/PrincipalToken.sol

29: contract PrincipalToken is
        ERC20PermitUpgradeable,
        AccessManagedUpgradeable,
        ReentrancyGuardUpgradeable,
        PausableUpgradeable,
        IPrincipalToken
    {

```
*Github:* [[29](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L29)]


```solidity
File: src/tokens/YieldToken.sol

15: contract YieldToken is IYieldToken, ERC20PermitUpgradeable {

```
*Github:* [[15](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L15)]



<a name="NC-5"></a> 
### [NC-5] Consider adding emergency-stop functionality
Consider adding `Pausable` to the following contracts so it's possible to stop them in case of an emergency.

*There are <b>4</b> instances of this issue:*
```solidity
File: src/proxy/AMBeacon.sol

20: contract AMBeacon is IBeacon, AccessManaged {

```
*Github:* [[20](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L20)]


```solidity
File: src/proxy/AMProxyAdmin.sol

14: contract AMProxyAdmin is AccessManaged {

```
*Github:* [[14](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L14)]


```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

60: contract AMTransparentUpgradeableProxy is ERC1967Proxy {

```
*Github:* [[60](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L60)]


```solidity
File: src/tokens/YieldToken.sol

15: contract YieldToken is IYieldToken, ERC20PermitUpgradeable {

```
*Github:* [[15](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L15)]



<a name="NC-6"></a> 
### [NC-6] Consider adding formal verification proofs
Formal verification is the act of proving or disproving the correctness of intended algorithms underlying a system with respect to a certain formal specification/property/invariant, using formal methods of mathematics.

Some tools that are currently available to perform these tests on smart contracts are [SMTChecker](https://docs.soliditylang.org/en/latest/smtchecker.html) and [Certora Prover](https://www.certora.com/).

*There is one instance of this issue:*
```solidity

Global finding

```
*Github:* [[Global](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/)]



<a name="NC-7"></a> 
### [NC-7] Constant decimal values
The use of fixed decimal values such as 1e18 or 1e8 in Solidity contracts can lead to inaccuracies, bugs, and vulnerabilities, particularly when interacting with tokens having different decimal configurations. Not all ERC20 tokens follow the standard 18 decimal places, and assumptions about decimal places can lead to miscalculations.

Resolution: Always retrieve and use the decimals() function from the token contract itself when performing calculations involving token amounts. This ensures that your contract correctly handles tokens with any number of decimal places, mitigating the risk of numerical errors or under/overflows that could jeopardize contract integrity and user funds.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/libraries/PrincipalTokenUtil.sol

19:     uint256 private constant FEE_DIVISOR = 1e18; // equivalent to 100% fees

```
*Github:* [[19](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L19)]


```solidity
File: src/libraries/RayMath.sol

12:     uint256 public constant RAY_UNIT = 1e27;

```
*Github:* [[12](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/RayMath.sol#L12)]



<a name="NC-8"></a> 
### [NC-8] Constants should be put on the left side of comparisons
Putting constants on the left side of comparison statements is a best practice known as [Yoda conditions](https://en.wikipedia.org/wiki/Yoda_conditions). Although solidity's static typing system prevents accidental assignments within conditionals, adopting this practice can improve code readability and consistency, especially when working across multiple languages.

<details>
<summary>
There are <b>18</b> instances (click to show):
</summary>

```solidity
File: src/libraries/PrincipalTokenUtil.sol

28:         if (_rate == 0) {

```
*Github:* [[28](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L28)]


```solidity
File: src/proxy/AMBeacon.sol

76:         if (newImplementation.code.length == 0) {

```
*Github:* [[76](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L76)]


```solidity
File: src/tokens/PrincipalToken.sol

103:         if (_registry == address(0)) {

125:         if (_ibt == address(0) || _initialAuthority == address(0)) {

128:         if (IERC4626(_ibt).totalAssets() == 0) {

353:         if (_oldIBTRateUser != 0) {

371:         if (yieldInIBT != 0) {

379:         if (yieldInIBT != 0) {

395:         if (rewardsProxy == address(0)) {

566:         if (_oldIBTRate != 0) {

664:         if (_ibtRate == 0) {

685:         if (_ptRate == 0) {

703:         if (_ptRate == 0) {

726:         if (ytBeacon == address(0)) {

763:         if (shares == 0) {

787:         if (_ptRate == 0) {

850:         if (yieldInIBT == 0) {

903:         if (IERC4626(ibt).totalAssets() == 0 && IERC4626(ibt).totalSupply() != 0) {

```
*Github:* [[103](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L103), [125](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L125), [128](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L128), [353](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L353), [371](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L371), [379](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L379), [395](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L395), [566](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L566), [664](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L664), [685](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L685), [703](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L703), [726](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L726), [763](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L763), [787](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L787), [850](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L850), [903](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L903)]


</details>


<a name="NC-9"></a> 
### [NC-9] `Constructor` should emit an event
Use events to signal significant changes to off-chain monitoring tools.

*There are <b>5</b> instances of this issue:*
```solidity
File: src/proxy/AMBeacon.sol

39:     constructor(address implementation_, address initialAuthority) AccessManaged(initialAuthority) {

```
*Github:* [[39](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L39)]


```solidity
File: src/proxy/AMProxyAdmin.sol

28:     constructor(address initialAuthority) AccessManaged(initialAuthority) {}

```
*Github:* [[28](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L28)]


```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

77:     constructor(

```
*Github:* [[77](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L77)]


```solidity
File: src/tokens/PrincipalToken.sol

102:     constructor(address _registry) {

```
*Github:* [[102](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L102)]


```solidity
File: src/tokens/YieldToken.sol

21:     constructor() {

```
*Github:* [[21](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L21)]



<a name="NC-10"></a> 
### [NC-10] Contract does not follow the Solidity Style Guide's suggested layout ordering
The [style guide](https://docs.soliditylang.org/en/v0.8.16/style-guide.html#order-of-layout) says that, within a contract, the ordering should be `1) Type declarations`, `2) State variables`, `3) Events`, `4) Modifiers`, and `5) Functions`, but the contract(s) below do not follow this ordering

*There are <b>4</b> instances of this issue:*
```solidity
File: src/libraries/PrincipalTokenUtil.sol

/// @audit event/error `AssetDoesNotImplementMetadata` came earlier
18:     uint256 private constant SAFETY_BOUND = 100; // used to favour the protocol in case of approximations

/// @audit event/error `AssetDoesNotImplementMetadata` came earlier
19:     uint256 private constant FEE_DIVISOR = 1e18; // equivalent to 100% fees

```
*Github:* [[18](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L18), [19](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L19)]


```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

/// @audit function `upgradeToAndCall` came earlier
65:     address private immutable _admin;

/// @audit function `upgradeToAndCall` came earlier
70:     error ProxyDeniedAdminAccess();

```
*Github:* [[65](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L65), [70](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L70)]



<a name="NC-11"></a> 
### [NC-11] Contract should expose an `interface`
All `external`/`public` functions should extend an `interface`. This is useful to make sure that the whole API is extracted.

*Note:* It is possible that the interface is out-of-scope and has not been seen by the bot.

<details>
<summary>
There are <b>67</b> instances (click to show):
</summary>

```solidity
File: src/proxy/AMBeacon.sol

46:     function implementation() public view virtual returns (address) {

63:     function upgradeTo(address newImplementation) public virtual restricted {

```
*Github:* [[46](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L46), [63](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L63)]


```solidity
File: src/proxy/AMProxyAdmin.sol

40:     function upgradeAndCall(

```
*Github:* [[40](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L40)]


```solidity
File: src/tokens/PrincipalToken.sol

120:     function initialize(

161:     function pause() external override restricted {

166:     function unPause() external override restricted {

171:     function deposit(uint256 assets, address receiver) external override returns (uint256 shares) {

176:     function deposit(

188:     function deposit(

201:     function depositIBT(uint256 ibts, address receiver) external override returns (uint256 shares) {

206:     function depositIBT(

216:     function depositIBT(

229:     function redeem(

240:     function redeem(

253:     function redeemForIBT(

265:     function redeemForIBT(

278:     function withdraw(

290:     function withdraw(

303:     function withdrawIBT(

316:     function withdrawIBT(

329:     function claimFees() external override returns (uint256 assets) {

340:     function updateYield(address _user) public override returns (uint256 updatedUserYieldInIBT) {

369:     function claimYield(address _receiver) public override returns (uint256 yieldInAsset) {

377:     function claimYieldInIBT(address _receiver) public override returns (uint256 yieldInIBT) {

385:     function beforeYtTransfer(address _from, address _to) external override {

394:     function claimRewards(bytes memory _data) external restricted {

409:     function storeRatesAtExpiry() public override afterExpiry {

420:     function setRewardsProxy(address _rewardsProxy) external restricted {

430:     function previewDeposit(uint256 assets) public view override returns (uint256) {

436:     function previewDepositIBT(uint256 ibts) external view override returns (uint256) {

441:     function maxDeposit(address) external pure override returns (uint256) {

446:     function previewWithdraw(

454:     function previewWithdrawIBT(uint256 ibts) public view override whenNotPaused returns (uint256) {

460:     function maxWithdraw(address owner) public view override whenNotPaused returns (uint256) {

466:     function maxWithdrawIBT(address owner) public view override whenNotPaused returns (uint256) {

471:     function previewRedeem(uint256 shares) public view override returns (uint256) {

476:     function previewRedeemForIBT(

483:     function maxRedeem(address owner) public view override returns (uint256) {

488:     function convertToPrincipal(uint256 underlyingAmount) external view override returns (uint256) {

493:     function convertToUnderlying(uint256 principalAmount) public view override returns (uint256) {

498:     function totalAssets() public view override returns (uint256) {

503:     function decimals() public view override(IERC20Metadata, ERC20Upgradeable) returns (uint8) {

508:     function underlying() external view override returns (address) {

513:     function maturity() external view override returns (uint256) {

518:     function getDuration() external view override returns (uint256) {

523:     function getIBT() external view override returns (address) {

528:     function getYT() external view override returns (address) {

533:     function getIBTRate() external view override returns (uint256) {

539:     function getPTRate() external view override returns (uint256) {

545:     function getIBTUnit() external view override returns (uint256) {

550:     function getUnclaimedFeesInIBT() external view override returns (uint256) {

555:     function getTotalFeesInIBT() external view override returns (uint256) {

560:     function getCurrentYieldOfUserInIBT(

583:     function maxFlashLoan(address _token) public view override returns (uint256) {

594:     function flashFee(address _token, uint256 _amount) public view override returns (uint256) {

602:     function getTokenizationFee() public view override returns (uint256) {

609:     function flashLoan(

```
*Github:* [[120](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L120), [161](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L161), [166](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L166), [171](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L171), [176](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L176), [188](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L188), [201](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L201), [206](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L206), [216](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L216), [229](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L229), [240](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L240), [253](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L253), [265](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L265), [278](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L278), [290](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L290), [303](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L303), [316](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L316), [329](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L329), [340](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L340), [369](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L369), [377](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L377), [385](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L385), [394](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L394), [409](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L409), [420](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L420), [430](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L430), [436](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L436), [441](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L441), [446](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L446), [454](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L454), [460](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L460), [466](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L466), [471](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L471), [476](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L476), [483](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L483), [488](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L488), [493](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L493), [498](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L498), [503](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L503), [508](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L508), [513](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L513), [518](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L518), [523](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L523), [528](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L528), [533](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L533), [539](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L539), [545](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L545), [550](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L550), [555](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L555), [560](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L560), [583](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L583), [594](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L594), [602](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L602), [609](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L609)]


```solidity
File: src/tokens/YieldToken.sol

31:     function initialize(

42:     function burnWithoutUpdate(address from, uint256 amount) external override {

50:     function mint(address to, uint256 amount) external override {

58:     function burn(uint256 amount) public override {

71:     function transfer(

95:     function transferFrom(

105:     function decimals()

116:     function getPT() public view virtual override returns (address) {

121:     function balanceOf(

128:     function actualBalanceOf(address account) public view override returns (uint256) {

```
*Github:* [[31](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L31), [42](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L42), [50](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L50), [58](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L58), [71](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L71), [95](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L95), [105](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L105), [116](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L116), [121](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L121), [128](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L128)]


</details>


<a name="NC-12"></a> 
### [NC-12] Contract uses both `require()`/`revert()` as well as custom errors
Consider using just one method in a single file.

*There is one instance of this issue:*
```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

22:  * @dev This contract implements a proxy that is upgradeable through an associated {ProxyAdmin} instance.

```
*Github:* [[22](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L22)]



<a name="NC-13"></a> 
### [NC-13] Contracts should each be defined in separate files
Keeping each contract in a separate file makes it easier to work with multiple people, makes the code easier to maintain, and is a common practice on most projects. The following files each contains more than one contract/library/interface.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

/// @audit another contract/library/interface is defined in this file
17: interface IAMTransparentUpgradeableProxy is IERC1967 {

/// @audit another contract/library/interface is defined in this file
60: contract AMTransparentUpgradeableProxy is ERC1967Proxy {

```
*Github:* [[17](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L17), [60](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L60)]



<a name="NC-14"></a> 
### [NC-14] Contracts should have full test coverage
While 100% code coverage does not guarantee that there are no bugs, it often will catch easy-to-find bugs, and will ensure that there are fewer regressions when the code invariably has to be modified. Furthermore, in order to get full coverage, code authors will often have to re-organize their code so that it is more modular, so that each component can be tested separately, which reduces interdependencies between modules and layers, and makes for code that is easier to reason about and audit.

*There is one instance of this issue:*
```solidity

Global finding

```
*Github:* [[Global](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/)]



<a name="NC-15"></a> 
### [NC-15] Events that mark critical parameter changes should contain both the old and the new value
This should especially be done if the new value is not required to be different from the old value.

<details>
<summary>
There are <b>11</b> instances (click to show):
</summary>

```solidity
File: src/proxy/AMBeacon.sol

80:         emit Upgraded(newImplementation);

```
*Github:* [[80](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L80)]


```solidity
File: src/tokens/PrincipalToken.sol

236:         emit Redeem(owner, receiver, shares);

261:         emit Redeem(owner, receiver, shares);

336:         emit FeeClaimed(msg.sender, ibts, assets);

364:             emit YieldUpdated(_user, updatedUserYieldInIBT);

416:         emit RatesStoredAtExpiry(ibtRate, ptRate);

422:         emit RewardsProxyChange(rewardsProxy, _rewardsProxy);

740:         emit YTDeployed(_yt);

767:         emit Mint(msg.sender, _ptReceiver, shares);

797:         emit Redeem(_owner, _receiver, shares);

857:             emit YieldClaimed(msg.sender, msg.sender, yieldInIBT);

```
*Github:* [[236](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L236), [261](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L261), [336](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L336), [364](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L364), [416](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L416), [422](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L422), [740](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L740), [767](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L767), [797](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L797), [857](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L857)]


</details>


<a name="NC-16"></a> 
### [NC-16] Custom errors has no error details
Consider adding parameters to the error to indicate which user or values caused the failure.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/libraries/PrincipalTokenUtil.sol

16:     error AssetDoesNotImplementMetadata();

```
*Github:* [[16](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L16)]


```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

70:     error ProxyDeniedAdminAccess();

```
*Github:* [[70](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L70)]



<a name="NC-17"></a> 
### [NC-17] Solidity version is different in some files

*There are <b>2</b> instances of this issue:*
```solidity
File: src/libraries/RayMath.sol

2: pragma solidity =0.8.20;

```
*Github:* [[2](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/RayMath.sol#L2)]


```solidity
File: src/proxy/AMBeacon.sol

5: pragma solidity 0.8.20;

```
*Github:* [[5](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L5)]



<a name="NC-18"></a> 
### [NC-18] Do not use underscore at the end of variable name
Adopting a consistent and clear naming convention enhances code readability and maintainability. In Solidity, appending an underscore at the end of a variable name is unconventional and can lead to confusion. It is generally advisable to stick to accepted naming practices to promote ease of understanding and use.

*There is one instance of this issue:*
```solidity
File: src/proxy/AMBeacon.sol

39:     constructor(address implementation_, address initialAuthority) AccessManaged(initialAuthority) {

```
*Github:* [[39](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L39)]



<a name="NC-19"></a> 
### [NC-19] Polymorphic functions make security audits more time-consuming and error-prone
The instances below point to one of two functions with the same name. Consider naming each function differently, in order to make code navigation and analysis easier.

*There are <b>7</b> instances of this issue:*
```solidity
File: src/libraries/RayMath.sol

/// @audit also found on line 35
20:     function fromRay(uint256 _a, uint256 _decimals) internal pure returns (uint256 b) {

```
*Github:* [[20](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/RayMath.sol#L20)]


```solidity
File: src/tokens/PrincipalToken.sol

/// @audit also found on line 176
171:     function deposit(uint256 assets, address receiver) external override returns (uint256 shares) {

/// @audit also found on line 206
201:     function depositIBT(uint256 ibts, address receiver) external override returns (uint256 shares) {

/// @audit also found on line 240
229:     function redeem(

/// @audit also found on line 265
253:     function redeemForIBT(

/// @audit also found on line 290
278:     function withdraw(

/// @audit also found on line 316
303:     function withdrawIBT(

```
*Github:* [[171](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L171), [201](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L201), [229](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L229), [253](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L253), [278](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L278), [303](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L303)]



<a name="NC-20"></a> 
### [NC-20] Duplicated `require()`/`revert()` checks should be refactored
Refactoring duplicate `require()`/`revert()` checks into a modifier or function can make the code more concise, readable and maintainable, and less likely to make errors or omissions when modifying the `require()` or `revert()`.

<details>
<summary>
There are <b>12</b> instances (click to show):
</summary>

```solidity
File: src/libraries/PrincipalTokenUtil.sol

/// @audit duplicated on line 126
29:             revert IPrincipalToken.RateError();

```
*Github:* [[29](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L29)]


```solidity
File: src/tokens/PrincipalToken.sol

/// @audit duplicated on line 126
104:             revert AddressError();

/// @audit duplicated on line 665
129:             revert RateError();

/// @audit duplicated on line 224
196:             revert ERC5143SlippageProtectionFailed();

/// @audit duplicated on line 273
248:             revert ERC5143SlippageProtectionFailed();

/// @audit duplicated on line 324
298:             revert ERC5143SlippageProtectionFailed();

/// @audit duplicated on line 387
331:             revert UnauthorizedCaller();

/// @audit duplicated on line 704
686:             revert RateError();

/// @audit duplicated on line 788
764:             revert RateError();

/// @audit duplicated on line 830
807:             revert UnauthorizedCaller();

/// @audit duplicated on line 840
810:             revert UnsufficientBalance();

```
*Github:* [[104](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L104), [129](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L129), [196](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L196), [248](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L248), [298](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L298), [331](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L331), [686](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L686), [764](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L764), [807](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L807), [810](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L810)]


```solidity
File: src/tokens/YieldToken.sol

/// @audit duplicated on line 52
44:             revert CallerIsNotPtContract();

```
*Github:* [[44](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L44)]


</details>


<a name="NC-21"></a> 
### [NC-21] `else` block not required
One level of nesting can be removed by not having an `else` block when the `if`-block always jumps at the end. For example:
```solidity
if (condition) {
	body1...
	return x;
} else {
	body2...
}
```
can be changed to:
```solidity
if (condition) {
	body1...
	return x;
}
body2...
```

*There are <b>2</b> instances of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

850:         if (yieldInIBT == 0) {
                 return 0;
             } else {

922:         if (ratesAtExpiryStored) {
                 return (ptRate, ibtRate);
             } else {

```
*Github:* [[850](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L850), [922](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L922)]



<a name="NC-22"></a> 
### [NC-22] Empty bytes check is missing
Passing empty bytes to a function can cause unexpected behavior, such as certain operations failing, producing incorrect results, or wasting gas. It is recommended to check that all byte parameters are not empty.

*There are <b>5</b> instances of this issue:*
```solidity
File: src/proxy/AMProxyAdmin.sol

/// @audit missing empty check for `data`
40:     function upgradeAndCall(
            IAMTransparentUpgradeableProxy proxy,
            address implementation,
            bytes memory data
        ) public payable virtual restricted {

```
*Github:* [[40](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L40)]


```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

/// @audit missing empty check for ``
18:     function upgradeToAndCall(address, bytes calldata) external payable;

/// @audit missing empty check for `_data`
77:     constructor(
            address _logic,
            address initialAuthority,
            bytes memory _data
        ) payable ERC1967Proxy(_logic, _data) {

```
*Github:* [[18](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L18), [77](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L77)]


```solidity
File: src/tokens/PrincipalToken.sol

/// @audit missing empty check for `_data`
394:     function claimRewards(bytes memory _data) external restricted {

/// @audit missing empty check for `_data`
609:     function flashLoan(
             IERC3156FlashBorrower _receiver,
             address _token,
             uint256 _amount,
             bytes calldata _data
         ) external override returns (bool) {

```
*Github:* [[394](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L394), [609](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L609)]



<a name="NC-23"></a> 
### [NC-23] Enable IR-based code generation
The IR-based code generator was introduced with an aim to not only allow code generation to be more transparent and auditable but also to enable more powerful optimization passes that span across functions. You can enable it on the command line using `--via-ir` or with the option `{"viaIR": true}`. This will take longer to compile, but you can just simple test it before deploying and if you got a better benchmark then you can add --via-ir to your deploy command More on: https://docs.soliditylang.org/en/v0.8.17/ir-breaking-changes.html

*There is one instance of this issue:*
```solidity

Global finding

```
*Github:* [[Global](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/)]



<a name="NC-24"></a> 
### [NC-24] Events are emitted without the sender information
When an action is triggered based on a user's action, not being able to filter based on who triggered the action makes event processing a lot more cumbersome. Including the `msg.sender` the events of these types of action will make events much more useful to end users, especially when `msg.sender` is not `tx.origin`.

*There are <b>7</b> instances of this issue:*
```solidity
File: src/proxy/AMBeacon.sol

80:         emit Upgraded(newImplementation);

```
*Github:* [[80](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L80)]


```solidity
File: src/tokens/PrincipalToken.sol

236:         emit Redeem(owner, receiver, shares);

261:         emit Redeem(owner, receiver, shares);

416:         emit RatesStoredAtExpiry(ibtRate, ptRate);

422:         emit RewardsProxyChange(rewardsProxy, _rewardsProxy);

740:         emit YTDeployed(_yt);

797:         emit Redeem(_owner, _receiver, shares);

```
*Github:* [[236](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L236), [261](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L261), [416](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L416), [422](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L422), [740](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L740), [797](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L797)]



<a name="NC-25"></a> 
### [NC-25] Events may be emitted out of order due to reentrancy
Ensure that events follow the best practice of check-effects-interaction, and are emitted before external calls.

*There are <b>5</b> instances of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

/// @audit `.redeem(...)` is called on line 235
236:         emit Redeem(owner, receiver, shares);

/// @audit `.safeTransfer(...)` is called on line 260
261:         emit Redeem(owner, receiver, shares);

/// @audit `.getFeeCollector(...)` is called on line 330
/// @audit `.redeem(...)` is called on line 335
336:         emit FeeClaimed(msg.sender, ibts, assets);

/// @audit `.getYTBeacon(...)` is called on line 725
740:         emit YTDeployed(_yt);

/// @audit `.burnWithoutUpdate(...)` is called on line 794
797:         emit Redeem(_owner, _receiver, shares);

```
*Github:* [[236](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L236), [261](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L261), [336](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L336), [740](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L740), [797](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L797)]



<a name="NC-26"></a> 
### [NC-26] Execution at deadlines should be allowed
The condition may be wrong in these cases, as when `block.timestamp` is equal to the compared `>` or `<` variable these blocks will not be executed.

*There are <b>4</b> instances of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

94:         if (block.timestamp < expiry) {

793:         if (block.timestamp < expiry) {

886:         if (block.timestamp < expiry) {

```
*Github:* [[94](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L94), [793](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L793), [886](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L886)]


```solidity
File: src/tokens/YieldToken.sol

124:         return (block.timestamp < IPrincipalToken(pt).maturity()) ? super.balanceOf(account) : 0;

```
*Github:* [[124](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L124)]



<a name="NC-27"></a> 
### [NC-27]  Function ordering does not follow the Solidity Style Guide
According to the [solidity style guide](https://docs.soliditylang.org/en/v0.8.17/style-guide.html#order-of-functions), functions should be laid out in the following order: `constructor()`, `receive()`, `fallback()`, `external`, `public`, `internal`, `private`, but the cases below do not follow this pattern

<details>
<summary>
There are <b>29</b> instances (click to show):
</summary>

```solidity
File: src/libraries/PrincipalTokenUtil.sol

/// @audit internal function `_convertToSharesWithRate` came earlier from this external function
/// @audit internal function `_convertToAssetsWithRate` came earlier from this external function
55:     function _computeYield(

/// @audit internal function `_convertToSharesWithRate` came earlier from this external function
/// @audit internal function `_convertToAssetsWithRate` came earlier from this external function
137:     function _tryGetTokenDecimals(address _token) external view returns (uint8) {

```
*Github:* [[55](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L55), [137](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L137)]


```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

/// @audit a function was seen before constructor
77:     constructor(

```
*Github:* [[77](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L77)]


```solidity
File: src/tokens/PrincipalToken.sol

/// @audit public function `deposit` came earlier from this external function
201:     function depositIBT(uint256 ibts, address receiver) external override returns (uint256 shares) {

/// @audit public function `deposit` came earlier from this external function
216:     function depositIBT(

/// @audit public function `deposit` came earlier from this external function
/// @audit public function `depositIBT` came earlier from this external function
240:     function redeem(

/// @audit public function `deposit` came earlier from this external function
/// @audit public function `depositIBT` came earlier from this external function
/// @audit public function `redeem` came earlier from this external function
265:     function redeemForIBT(

/// @audit public function `deposit` came earlier from this external function
/// @audit public function `depositIBT` came earlier from this external function
/// @audit public function `redeem` came earlier from this external function
/// @audit public function `redeemForIBT` came earlier from this external function
290:     function withdraw(

/// @audit public function `deposit` came earlier from this external function
/// @audit public function `depositIBT` came earlier from this external function
/// @audit public function `redeem` came earlier from this external function
/// @audit public function `redeemForIBT` came earlier from this external function
/// @audit public function `withdraw` came earlier from this external function
316:     function withdrawIBT(

/// @audit public function `deposit` came earlier from this external function
/// @audit public function `depositIBT` came earlier from this external function
/// @audit public function `redeem` came earlier from this external function
/// @audit public function `redeemForIBT` came earlier from this external function
/// @audit public function `withdraw` came earlier from this external function
/// @audit public function `withdrawIBT` came earlier from this external function
329:     function claimFees() external override returns (uint256 assets) {

/// @audit public function `deposit` came earlier from this external function
/// @audit public function `depositIBT` came earlier from this external function
/// @audit public function `redeem` came earlier from this external function
/// @audit public function `redeemForIBT` came earlier from this external function
/// @audit public function `withdraw` came earlier from this external function
/// @audit public function `withdrawIBT` came earlier from this external function
/// @audit public function `updateYield` came earlier from this external function
/// @audit public function `claimYield` came earlier from this external function
/// @audit public function `claimYieldInIBT` came earlier from this external function
385:     function beforeYtTransfer(address _from, address _to) external override {

/// @audit public function `deposit` came earlier from this external function
/// @audit public function `depositIBT` came earlier from this external function
/// @audit public function `redeem` came earlier from this external function
/// @audit public function `redeemForIBT` came earlier from this external function
/// @audit public function `withdraw` came earlier from this external function
/// @audit public function `withdrawIBT` came earlier from this external function
/// @audit public function `updateYield` came earlier from this external function
/// @audit public function `claimYield` came earlier from this external function
/// @audit public function `claimYieldInIBT` came earlier from this external function
394:     function claimRewards(bytes memory _data) external restricted {

/// @audit public function `deposit` came earlier from this external function
/// @audit public function `depositIBT` came earlier from this external function
/// @audit public function `redeem` came earlier from this external function
/// @audit public function `redeemForIBT` came earlier from this external function
/// @audit public function `withdraw` came earlier from this external function
/// @audit public function `withdrawIBT` came earlier from this external function
/// @audit public function `updateYield` came earlier from this external function
/// @audit public function `claimYield` came earlier from this external function
/// @audit public function `claimYieldInIBT` came earlier from this external function
/// @audit public function `storeRatesAtExpiry` came earlier from this external function
420:     function setRewardsProxy(address _rewardsProxy) external restricted {

/// @audit public function `deposit` came earlier from this external function
/// @audit public function `depositIBT` came earlier from this external function
/// @audit public function `redeem` came earlier from this external function
/// @audit public function `redeemForIBT` came earlier from this external function
/// @audit public function `withdraw` came earlier from this external function
/// @audit public function `withdrawIBT` came earlier from this external function
/// @audit public function `updateYield` came earlier from this external function
/// @audit public function `claimYield` came earlier from this external function
/// @audit public function `claimYieldInIBT` came earlier from this external function
/// @audit public function `storeRatesAtExpiry` came earlier from this external function
/// @audit public function `previewDeposit` came earlier from this external function
436:     function previewDepositIBT(uint256 ibts) external view override returns (uint256) {

/// @audit public function `deposit` came earlier from this external function
/// @audit public function `depositIBT` came earlier from this external function
/// @audit public function `redeem` came earlier from this external function
/// @audit public function `redeemForIBT` came earlier from this external function
/// @audit public function `withdraw` came earlier from this external function
/// @audit public function `withdrawIBT` came earlier from this external function
/// @audit public function `updateYield` came earlier from this external function
/// @audit public function `claimYield` came earlier from this external function
/// @audit public function `claimYieldInIBT` came earlier from this external function
/// @audit public function `storeRatesAtExpiry` came earlier from this external function
/// @audit public function `previewDeposit` came earlier from this external function
441:     function maxDeposit(address) external pure override returns (uint256) {

/// @audit public function `deposit` came earlier from this external function
/// @audit public function `depositIBT` came earlier from this external function
/// @audit public function `redeem` came earlier from this external function
/// @audit public function `redeemForIBT` came earlier from this external function
/// @audit public function `withdraw` came earlier from this external function
/// @audit public function `withdrawIBT` came earlier from this external function
/// @audit public function `updateYield` came earlier from this external function
/// @audit public function `claimYield` came earlier from this external function
/// @audit public function `claimYieldInIBT` came earlier from this external function
/// @audit public function `storeRatesAtExpiry` came earlier from this external function
/// @audit public function `previewDeposit` came earlier from this external function
446:     function previewWithdraw(

/// @audit public function `deposit` came earlier from this external function
/// @audit public function `depositIBT` came earlier from this external function
/// @audit public function `redeem` came earlier from this external function
/// @audit public function `redeemForIBT` came earlier from this external function
/// @audit public function `withdraw` came earlier from this external function
/// @audit public function `withdrawIBT` came earlier from this external function
/// @audit public function `updateYield` came earlier from this external function
/// @audit public function `claimYield` came earlier from this external function
/// @audit public function `claimYieldInIBT` came earlier from this external function
/// @audit public function `storeRatesAtExpiry` came earlier from this external function
/// @audit public function `previewDeposit` came earlier from this external function
/// @audit public function `previewWithdrawIBT` came earlier from this external function
/// @audit public function `maxWithdraw` came earlier from this external function
/// @audit public function `maxWithdrawIBT` came earlier from this external function
/// @audit public function `previewRedeem` came earlier from this external function
/// @audit public function `previewRedeemForIBT` came earlier from this external function
/// @audit public function `maxRedeem` came earlier from this external function
488:     function convertToPrincipal(uint256 underlyingAmount) external view override returns (uint256) {

/// @audit public function `deposit` came earlier from this external function
/// @audit public function `depositIBT` came earlier from this external function
/// @audit public function `redeem` came earlier from this external function
/// @audit public function `redeemForIBT` came earlier from this external function
/// @audit public function `withdraw` came earlier from this external function
/// @audit public function `withdrawIBT` came earlier from this external function
/// @audit public function `updateYield` came earlier from this external function
/// @audit public function `claimYield` came earlier from this external function
/// @audit public function `claimYieldInIBT` came earlier from this external function
/// @audit public function `storeRatesAtExpiry` came earlier from this external function
/// @audit public function `previewDeposit` came earlier from this external function
/// @audit public function `previewWithdrawIBT` came earlier from this external function
/// @audit public function `maxWithdraw` came earlier from this external function
/// @audit public function `maxWithdrawIBT` came earlier from this external function
/// @audit public function `previewRedeem` came earlier from this external function
/// @audit public function `previewRedeemForIBT` came earlier from this external function
/// @audit public function `maxRedeem` came earlier from this external function
/// @audit public function `convertToUnderlying` came earlier from this external function
/// @audit public function `totalAssets` came earlier from this external function
/// @audit public function `decimals` came earlier from this external function
508:     function underlying() external view override returns (address) {

/// @audit public function `deposit` came earlier from this external function
/// @audit public function `depositIBT` came earlier from this external function
/// @audit public function `redeem` came earlier from this external function
/// @audit public function `redeemForIBT` came earlier from this external function
/// @audit public function `withdraw` came earlier from this external function
/// @audit public function `withdrawIBT` came earlier from this external function
/// @audit public function `updateYield` came earlier from this external function
/// @audit public function `claimYield` came earlier from this external function
/// @audit public function `claimYieldInIBT` came earlier from this external function
/// @audit public function `storeRatesAtExpiry` came earlier from this external function
/// @audit public function `previewDeposit` came earlier from this external function
/// @audit public function `previewWithdrawIBT` came earlier from this external function
/// @audit public function `maxWithdraw` came earlier from this external function
/// @audit public function `maxWithdrawIBT` came earlier from this external function
/// @audit public function `previewRedeem` came earlier from this external function
/// @audit public function `previewRedeemForIBT` came earlier from this external function
/// @audit public function `maxRedeem` came earlier from this external function
/// @audit public function `convertToUnderlying` came earlier from this external function
/// @audit public function `totalAssets` came earlier from this external function
/// @audit public function `decimals` came earlier from this external function
513:     function maturity() external view override returns (uint256) {

/// @audit public function `deposit` came earlier from this external function
/// @audit public function `depositIBT` came earlier from this external function
/// @audit public function `redeem` came earlier from this external function
/// @audit public function `redeemForIBT` came earlier from this external function
/// @audit public function `withdraw` came earlier from this external function
/// @audit public function `withdrawIBT` came earlier from this external function
/// @audit public function `updateYield` came earlier from this external function
/// @audit public function `claimYield` came earlier from this external function
/// @audit public function `claimYieldInIBT` came earlier from this external function
/// @audit public function `storeRatesAtExpiry` came earlier from this external function
/// @audit public function `previewDeposit` came earlier from this external function
/// @audit public function `previewWithdrawIBT` came earlier from this external function
/// @audit public function `maxWithdraw` came earlier from this external function
/// @audit public function `maxWithdrawIBT` came earlier from this external function
/// @audit public function `previewRedeem` came earlier from this external function
/// @audit public function `previewRedeemForIBT` came earlier from this external function
/// @audit public function `maxRedeem` came earlier from this external function
/// @audit public function `convertToUnderlying` came earlier from this external function
/// @audit public function `totalAssets` came earlier from this external function
/// @audit public function `decimals` came earlier from this external function
518:     function getDuration() external view override returns (uint256) {

/// @audit public function `deposit` came earlier from this external function
/// @audit public function `depositIBT` came earlier from this external function
/// @audit public function `redeem` came earlier from this external function
/// @audit public function `redeemForIBT` came earlier from this external function
/// @audit public function `withdraw` came earlier from this external function
/// @audit public function `withdrawIBT` came earlier from this external function
/// @audit public function `updateYield` came earlier from this external function
/// @audit public function `claimYield` came earlier from this external function
/// @audit public function `claimYieldInIBT` came earlier from this external function
/// @audit public function `storeRatesAtExpiry` came earlier from this external function
/// @audit public function `previewDeposit` came earlier from this external function
/// @audit public function `previewWithdrawIBT` came earlier from this external function
/// @audit public function `maxWithdraw` came earlier from this external function
/// @audit public function `maxWithdrawIBT` came earlier from this external function
/// @audit public function `previewRedeem` came earlier from this external function
/// @audit public function `previewRedeemForIBT` came earlier from this external function
/// @audit public function `maxRedeem` came earlier from this external function
/// @audit public function `convertToUnderlying` came earlier from this external function
/// @audit public function `totalAssets` came earlier from this external function
/// @audit public function `decimals` came earlier from this external function
523:     function getIBT() external view override returns (address) {

/// @audit public function `deposit` came earlier from this external function
/// @audit public function `depositIBT` came earlier from this external function
/// @audit public function `redeem` came earlier from this external function
/// @audit public function `redeemForIBT` came earlier from this external function
/// @audit public function `withdraw` came earlier from this external function
/// @audit public function `withdrawIBT` came earlier from this external function
/// @audit public function `updateYield` came earlier from this external function
/// @audit public function `claimYield` came earlier from this external function
/// @audit public function `claimYieldInIBT` came earlier from this external function
/// @audit public function `storeRatesAtExpiry` came earlier from this external function
/// @audit public function `previewDeposit` came earlier from this external function
/// @audit public function `previewWithdrawIBT` came earlier from this external function
/// @audit public function `maxWithdraw` came earlier from this external function
/// @audit public function `maxWithdrawIBT` came earlier from this external function
/// @audit public function `previewRedeem` came earlier from this external function
/// @audit public function `previewRedeemForIBT` came earlier from this external function
/// @audit public function `maxRedeem` came earlier from this external function
/// @audit public function `convertToUnderlying` came earlier from this external function
/// @audit public function `totalAssets` came earlier from this external function
/// @audit public function `decimals` came earlier from this external function
528:     function getYT() external view override returns (address) {

/// @audit public function `deposit` came earlier from this external function
/// @audit public function `depositIBT` came earlier from this external function
/// @audit public function `redeem` came earlier from this external function
/// @audit public function `redeemForIBT` came earlier from this external function
/// @audit public function `withdraw` came earlier from this external function
/// @audit public function `withdrawIBT` came earlier from this external function
/// @audit public function `updateYield` came earlier from this external function
/// @audit public function `claimYield` came earlier from this external function
/// @audit public function `claimYieldInIBT` came earlier from this external function
/// @audit public function `storeRatesAtExpiry` came earlier from this external function
/// @audit public function `previewDeposit` came earlier from this external function
/// @audit public function `previewWithdrawIBT` came earlier from this external function
/// @audit public function `maxWithdraw` came earlier from this external function
/// @audit public function `maxWithdrawIBT` came earlier from this external function
/// @audit public function `previewRedeem` came earlier from this external function
/// @audit public function `previewRedeemForIBT` came earlier from this external function
/// @audit public function `maxRedeem` came earlier from this external function
/// @audit public function `convertToUnderlying` came earlier from this external function
/// @audit public function `totalAssets` came earlier from this external function
/// @audit public function `decimals` came earlier from this external function
533:     function getIBTRate() external view override returns (uint256) {

/// @audit public function `deposit` came earlier from this external function
/// @audit public function `depositIBT` came earlier from this external function
/// @audit public function `redeem` came earlier from this external function
/// @audit public function `redeemForIBT` came earlier from this external function
/// @audit public function `withdraw` came earlier from this external function
/// @audit public function `withdrawIBT` came earlier from this external function
/// @audit public function `updateYield` came earlier from this external function
/// @audit public function `claimYield` came earlier from this external function
/// @audit public function `claimYieldInIBT` came earlier from this external function
/// @audit public function `storeRatesAtExpiry` came earlier from this external function
/// @audit public function `previewDeposit` came earlier from this external function
/// @audit public function `previewWithdrawIBT` came earlier from this external function
/// @audit public function `maxWithdraw` came earlier from this external function
/// @audit public function `maxWithdrawIBT` came earlier from this external function
/// @audit public function `previewRedeem` came earlier from this external function
/// @audit public function `previewRedeemForIBT` came earlier from this external function
/// @audit public function `maxRedeem` came earlier from this external function
/// @audit public function `convertToUnderlying` came earlier from this external function
/// @audit public function `totalAssets` came earlier from this external function
/// @audit public function `decimals` came earlier from this external function
539:     function getPTRate() external view override returns (uint256) {

/// @audit public function `deposit` came earlier from this external function
/// @audit public function `depositIBT` came earlier from this external function
/// @audit public function `redeem` came earlier from this external function
/// @audit public function `redeemForIBT` came earlier from this external function
/// @audit public function `withdraw` came earlier from this external function
/// @audit public function `withdrawIBT` came earlier from this external function
/// @audit public function `updateYield` came earlier from this external function
/// @audit public function `claimYield` came earlier from this external function
/// @audit public function `claimYieldInIBT` came earlier from this external function
/// @audit public function `storeRatesAtExpiry` came earlier from this external function
/// @audit public function `previewDeposit` came earlier from this external function
/// @audit public function `previewWithdrawIBT` came earlier from this external function
/// @audit public function `maxWithdraw` came earlier from this external function
/// @audit public function `maxWithdrawIBT` came earlier from this external function
/// @audit public function `previewRedeem` came earlier from this external function
/// @audit public function `previewRedeemForIBT` came earlier from this external function
/// @audit public function `maxRedeem` came earlier from this external function
/// @audit public function `convertToUnderlying` came earlier from this external function
/// @audit public function `totalAssets` came earlier from this external function
/// @audit public function `decimals` came earlier from this external function
545:     function getIBTUnit() external view override returns (uint256) {

/// @audit public function `deposit` came earlier from this external function
/// @audit public function `depositIBT` came earlier from this external function
/// @audit public function `redeem` came earlier from this external function
/// @audit public function `redeemForIBT` came earlier from this external function
/// @audit public function `withdraw` came earlier from this external function
/// @audit public function `withdrawIBT` came earlier from this external function
/// @audit public function `updateYield` came earlier from this external function
/// @audit public function `claimYield` came earlier from this external function
/// @audit public function `claimYieldInIBT` came earlier from this external function
/// @audit public function `storeRatesAtExpiry` came earlier from this external function
/// @audit public function `previewDeposit` came earlier from this external function
/// @audit public function `previewWithdrawIBT` came earlier from this external function
/// @audit public function `maxWithdraw` came earlier from this external function
/// @audit public function `maxWithdrawIBT` came earlier from this external function
/// @audit public function `previewRedeem` came earlier from this external function
/// @audit public function `previewRedeemForIBT` came earlier from this external function
/// @audit public function `maxRedeem` came earlier from this external function
/// @audit public function `convertToUnderlying` came earlier from this external function
/// @audit public function `totalAssets` came earlier from this external function
/// @audit public function `decimals` came earlier from this external function
550:     function getUnclaimedFeesInIBT() external view override returns (uint256) {

/// @audit public function `deposit` came earlier from this external function
/// @audit public function `depositIBT` came earlier from this external function
/// @audit public function `redeem` came earlier from this external function
/// @audit public function `redeemForIBT` came earlier from this external function
/// @audit public function `withdraw` came earlier from this external function
/// @audit public function `withdrawIBT` came earlier from this external function
/// @audit public function `updateYield` came earlier from this external function
/// @audit public function `claimYield` came earlier from this external function
/// @audit public function `claimYieldInIBT` came earlier from this external function
/// @audit public function `storeRatesAtExpiry` came earlier from this external function
/// @audit public function `previewDeposit` came earlier from this external function
/// @audit public function `previewWithdrawIBT` came earlier from this external function
/// @audit public function `maxWithdraw` came earlier from this external function
/// @audit public function `maxWithdrawIBT` came earlier from this external function
/// @audit public function `previewRedeem` came earlier from this external function
/// @audit public function `previewRedeemForIBT` came earlier from this external function
/// @audit public function `maxRedeem` came earlier from this external function
/// @audit public function `convertToUnderlying` came earlier from this external function
/// @audit public function `totalAssets` came earlier from this external function
/// @audit public function `decimals` came earlier from this external function
555:     function getTotalFeesInIBT() external view override returns (uint256) {

/// @audit public function `deposit` came earlier from this external function
/// @audit public function `depositIBT` came earlier from this external function
/// @audit public function `redeem` came earlier from this external function
/// @audit public function `redeemForIBT` came earlier from this external function
/// @audit public function `withdraw` came earlier from this external function
/// @audit public function `withdrawIBT` came earlier from this external function
/// @audit public function `updateYield` came earlier from this external function
/// @audit public function `claimYield` came earlier from this external function
/// @audit public function `claimYieldInIBT` came earlier from this external function
/// @audit public function `storeRatesAtExpiry` came earlier from this external function
/// @audit public function `previewDeposit` came earlier from this external function
/// @audit public function `previewWithdrawIBT` came earlier from this external function
/// @audit public function `maxWithdraw` came earlier from this external function
/// @audit public function `maxWithdrawIBT` came earlier from this external function
/// @audit public function `previewRedeem` came earlier from this external function
/// @audit public function `previewRedeemForIBT` came earlier from this external function
/// @audit public function `maxRedeem` came earlier from this external function
/// @audit public function `convertToUnderlying` came earlier from this external function
/// @audit public function `totalAssets` came earlier from this external function
/// @audit public function `decimals` came earlier from this external function
560:     function getCurrentYieldOfUserInIBT(

/// @audit public function `deposit` came earlier from this external function
/// @audit public function `depositIBT` came earlier from this external function
/// @audit public function `redeem` came earlier from this external function
/// @audit public function `redeemForIBT` came earlier from this external function
/// @audit public function `withdraw` came earlier from this external function
/// @audit public function `withdrawIBT` came earlier from this external function
/// @audit public function `updateYield` came earlier from this external function
/// @audit public function `claimYield` came earlier from this external function
/// @audit public function `claimYieldInIBT` came earlier from this external function
/// @audit public function `storeRatesAtExpiry` came earlier from this external function
/// @audit public function `previewDeposit` came earlier from this external function
/// @audit public function `previewWithdrawIBT` came earlier from this external function
/// @audit public function `maxWithdraw` came earlier from this external function
/// @audit public function `maxWithdrawIBT` came earlier from this external function
/// @audit public function `previewRedeem` came earlier from this external function
/// @audit public function `previewRedeemForIBT` came earlier from this external function
/// @audit public function `maxRedeem` came earlier from this external function
/// @audit public function `convertToUnderlying` came earlier from this external function
/// @audit public function `totalAssets` came earlier from this external function
/// @audit public function `decimals` came earlier from this external function
/// @audit public function `maxFlashLoan` came earlier from this external function
/// @audit public function `flashFee` came earlier from this external function
/// @audit public function `getTokenizationFee` came earlier from this external function
609:     function flashLoan(

```
*Github:* [[201](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L201), [216](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L216), [240](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L240), [265](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L265), [290](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L290), [316](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L316), [329](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L329), [385](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L385), [394](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L394), [420](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L420), [436](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L436), [441](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L441), [446](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L446), [488](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L488), [508](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L508), [513](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L513), [518](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L518), [523](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L523), [528](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L528), [533](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L533), [539](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L539), [545](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L545), [550](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L550), [555](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L555), [560](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L560), [609](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L609)]


</details>


<a name="NC-28"></a> 
### [NC-28] Variable names for `immutable`s should use CONSTANT_CASE
For `immutable` variable names, each word should use all capital letters, with underscores separating each word (CONSTANT_CASE)

*There are <b>2</b> instances of this issue:*
```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

65:     address private immutable _admin;

```
*Github:* [[65](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L65)]


```solidity
File: src/tokens/PrincipalToken.sol

44:     address private immutable registry;

```
*Github:* [[44](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L44)]



<a name="NC-29"></a> 
### [NC-29] Import declarations should import specific identifiers, rather than the whole file
Using import declarations of the form `import {<identifier_name>} from "some/file.sol"` avoids polluting the symbol namespace making flattened files smaller, and speeds up compilation (but does not save any gas).

<details>
<summary>
There are <b>29</b> instances (click to show):
</summary>

```solidity
File: src/libraries/PrincipalTokenUtil.sol

5: import "../interfaces/IYieldToken.sol";

6: import "../interfaces/IPrincipalToken.sol";

7: import "../interfaces/IRegistry.sol";

8: import "openzeppelin-contracts/interfaces/IERC4626.sol";

9: import "openzeppelin-math/Math.sol";

10: import "../libraries/RayMath.sol";

```
*Github:* [[5](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L5), [6](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L6), [7](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L7), [8](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L8), [9](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L9), [10](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L10)]


```solidity
File: src/proxy/AMBeacon.sol

8: import "openzeppelin-contracts/access/manager/AccessManaged.sol";

```
*Github:* [[8](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L8)]


```solidity
File: src/proxy/AMProxyAdmin.sol

8: import "openzeppelin-contracts/access/manager/AccessManaged.sol";

```
*Github:* [[8](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L8)]


```solidity
File: src/tokens/PrincipalToken.sol

5: import "openzeppelin-contracts/token/ERC20/utils/SafeERC20.sol";

6: import "openzeppelin-contracts-upgradeable/access/manager/AccessManagedUpgradeable.sol";

7: import "openzeppelin-contracts-upgradeable/utils/PausableUpgradeable.sol";

8: import "openzeppelin-contracts-upgradeable/utils/ReentrancyGuardUpgradeable.sol";

9: import "openzeppelin-math/Math.sol";

10: import "openzeppelin-erc20-extensions/ERC20PermitUpgradeable.sol";

11: import "openzeppelin-contracts/proxy/beacon/BeaconProxy.sol";

12: import "openzeppelin-contracts/interfaces/IERC3156FlashBorrower.sol";

13: import "openzeppelin-contracts/interfaces/IERC4626.sol";

15: import "../libraries/PrincipalTokenUtil.sol";

16: import "../libraries/NamingUtil.sol";

17: import "../libraries/RayMath.sol";

18: import "../interfaces/IRegistry.sol";

19: import "../interfaces/IPrincipalToken.sol";

20: import "../interfaces/IYieldToken.sol";

21: import "../interfaces/IRewardsProxy.sol";

```
*Github:* [[5](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L5), [6](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L6), [7](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L7), [8](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L8), [9](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L9), [10](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L10), [11](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L11), [12](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L12), [13](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L13), [15](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L15), [16](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L16), [17](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L17), [18](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L18), [19](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L19), [20](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L20), [21](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L21)]


```solidity
File: src/tokens/YieldToken.sol

5: import "openzeppelin-math/Math.sol";

6: import "openzeppelin-erc20-extensions/ERC20PermitUpgradeable.sol";

7: import "openzeppelin-erc20-basic/extensions/IERC20Metadata.sol";

8: import "../interfaces/IPrincipalToken.sol";

9: import "../interfaces/IYieldToken.sol";

```
*Github:* [[5](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L5), [6](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L6), [7](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L7), [8](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L8), [9](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L9)]


</details>


<a name="NC-30"></a> 
### [NC-30] Imports could be organized more systematically
The contract's interface should be imported first, followed by each of the interfaces it uses, followed by all other files. The examples below do not follow this layout.

*There are <b>9</b> instances of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

12: import "openzeppelin-contracts/interfaces/IERC3156FlashBorrower.sol";

13: import "openzeppelin-contracts/interfaces/IERC4626.sol";

18: import "../interfaces/IRegistry.sol";

19: import "../interfaces/IPrincipalToken.sol";

20: import "../interfaces/IYieldToken.sol";

21: import "../interfaces/IRewardsProxy.sol";

```
*Github:* [[12](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L12), [13](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L13), [18](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L18), [19](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L19), [20](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L20), [21](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L21)]


```solidity
File: src/tokens/YieldToken.sol

7: import "openzeppelin-erc20-basic/extensions/IERC20Metadata.sol";

8: import "../interfaces/IPrincipalToken.sol";

9: import "../interfaces/IYieldToken.sol";

```
*Github:* [[7](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L7), [8](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L8), [9](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L9)]



<a name="NC-31"></a> 
### [NC-31] It is best practice to use linear inheritance
In Solidity, complex inheritance structures can obfuscate code understanding, introducing potential security risks. Multiple inheritance, especially with overlapping function names or state variables, can cause unintentional overrides or ambiguous behavior. 

Resolution: Strive for linear and simple inheritance chains. Avoid diamond or circular inheritance patterns. Clearly document the purpose and relationships of base contracts, ensuring that overrides are intentional. Tools like Remix or Hardhat can visualize inheritance chains, assisting in verification. Keeping inheritance streamlined aids in better code readability, reduces potential errors, and ensures smoother audits and upgrades.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/proxy/AMBeacon.sol

20: contract AMBeacon is IBeacon, AccessManaged {

```
*Github:* [[20](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L20)]


```solidity
File: src/tokens/PrincipalToken.sol

29: contract PrincipalToken is
        ERC20PermitUpgradeable,
        AccessManagedUpgradeable,
        ReentrancyGuardUpgradeable,
        PausableUpgradeable,
        IPrincipalToken

```
*Github:* [[29](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L29)]


```solidity
File: src/tokens/YieldToken.sol

15: contract YieldToken is IYieldToken, ERC20PermitUpgradeable {

```
*Github:* [[15](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L15)]



<a name="NC-32"></a> 
### [NC-32] Lack of brace spacing
Lack of brace spacing in coding refers to the absence of spaces around braces, which can hinder code readability. In Solidity, as in many programming languages, spacing can enhance the visual distinction between different parts of the code, making it easier to follow. A lack of spacing can lead to a dense, confusing appearance. The resolution to this issue is to follow a consistent style guide that defines rules for brace spacing. By including spaces around braces, such as `{ statement }` instead of `{statement}`, developers can ensure that the code is more legible and maintainable, especially in larger codebases.

*There is one instance of this issue:*
```solidity
File: src/proxy/AMProxyAdmin.sol

45:         proxy.upgradeToAndCall{value: msg.value}(implementation, data);

```
*Github:* [[45](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L45)]



<a name="NC-33"></a> 
### [NC-33] Large or complicated code bases should implement invariant tests
This includes: large code bases, or code with lots of inline-assembly, complicated math, or complicated interactions between multiple contracts. Invariant fuzzers such as Echidna require the test writer to come up with invariants which should not be violated under any circumstances, and the fuzzer tests various inputs and function calls to ensure that the invariants always hold. Even code with 100% code coverage can still have bugs due to the order of the operations a user performs, and invariant fuzzers may help significantly.

*There is one instance of this issue:*
```solidity

Global finding

```
*Github:* [[Global](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/)]



<a name="NC-34"></a> 
### [NC-34] Long functions should be refactored into multiple, smaller, functions

*There are <b>2</b> instances of this issue:*
```solidity
File: src/libraries/PrincipalTokenUtil.sol

/// @audit 75 lines
55:     function _computeYield(
            address _user,
            uint256 _userYieldIBT,
            uint256 _oldIBTRate,
            uint256 _ibtRate,
            uint256 _oldPTRate,
            uint256 _ptRate,
            address _yt
        ) external view returns (uint256) {

```
*Github:* [[55](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L55)]


```solidity
File: src/proxy/AMBeacon.sol

/// @audit 69 lines
39:     constructor(address implementation_, address initialAuthority) AccessManaged(initialAuthority) {

```
*Github:* [[39](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L39)]



<a name="NC-35"></a> 
### [NC-35] Magic numbers should be replaced with constants
Magic numbers are hard-coded values in code that can make it difficult for developers and maintainers to understand the code, and can also cause confusion or errors. To improve the readability and maintainability of code, it is recommended to replace magic numbers with constants that have good readability.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

// @audit `4`
121:         (address newImplementation, bytes memory data) = abi.decode(msg.data[4:], (address, bytes));

```
*Github:* [[121](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L121)]


```solidity
File: src/tokens/PrincipalToken.sol

// @audit `10`
151:         ibtUnit = 10 ** _ibtDecimals;

```
*Github:* [[151](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L151)]



<a name="NC-36"></a> 
### [NC-36] Missing events in initializers
As a best practice, consider emitting an event when the contract is initialized. In this way, it's easy for the user to track the exact point in time when the contract was initialized, by filtering the emitted events.

*There is one instance of this issue:*
```solidity
File: src/tokens/YieldToken.sol

31:     function initialize(

```
*Github:* [[31](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L31)]



<a name="NC-37"></a> 
### [NC-37] Named mappings are recommended
[Named mappings](https://docs.soliditylang.org/en/v0.8.18/types.html#mapping-types) (with syntax `mapping(KeyType KeyName? => ValueType ValueName?)`) are recommended.It can make the mapping variables clearer, more readable and easier to maintain.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

62:     mapping(address => uint256) private ibtRateOfUser; // stores each user's IBT rate (in Ray)

63:     mapping(address => uint256) private ptRateOfUser; // stores each user's PT rate (in Ray)

64:     mapping(address => uint256) private yieldOfUserInIBT; // stores each user's yield generated from YTs

```
*Github:* [[62](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L62), [63](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L63), [64](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L64)]



<a name="NC-38"></a> 
### [NC-38] Named imports of parent contracts are missing

*There are <b>4</b> instances of this issue:*
```solidity
File: src/proxy/AMBeacon.sol

/// @audit `AccessManaged`
20: contract AMBeacon is IBeacon, AccessManaged {

```
*Github:* [[20](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L20)]


```solidity
File: src/proxy/AMProxyAdmin.sol

/// @audit `AccessManaged`
14: contract AMProxyAdmin is AccessManaged {

```
*Github:* [[14](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L14)]


```solidity
File: src/tokens/PrincipalToken.sol

/// @audit `ERC20PermitUpgradeable`
/// @audit `AccessManagedUpgradeable`
/// @audit `ReentrancyGuardUpgradeable`
/// @audit `PausableUpgradeable`
/// @audit `IPrincipalToken`
29: contract PrincipalToken is

```
*Github:* [[29](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L29)]


```solidity
File: src/tokens/YieldToken.sol

/// @audit `IYieldToken`
/// @audit `ERC20PermitUpgradeable`
15: contract YieldToken is IYieldToken, ERC20PermitUpgradeable {

```
*Github:* [[15](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L15)]



<a name="NC-39"></a> 
### [NC-39] Missing NatSpec from contract/error/event/function/modifier declarations
e.g. `@dev` or `@notice`, and it must appear above the contract definition braces in order to be identified by the compiler as NatSpec.

<details>
<summary>
There are <b>13</b> instances (click to show):
</summary>

```solidity
File: src/libraries/PrincipalTokenUtil.sol

12: library PrincipalTokenUtil {

16:     error AssetDoesNotImplementMetadata();

```
*Github:* [[12](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L12), [16](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L16)]


```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

18:     function upgradeToAndCall(address, bytes calldata) external payable;

```
*Github:* [[18](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L18)]


```solidity
File: src/tokens/PrincipalToken.sol

68:     event Redeem(address indexed from, address indexed to, uint256 amount);

69:     event Mint(address indexed from, address indexed to, uint256 amount);

70:     event YTDeployed(address indexed yt);

71:     event YieldUpdated(address indexed user, uint256 indexed yieldInIBT);

72:     event YieldClaimed(address indexed owner, address indexed receiver, uint256 indexed yieldInIBT);

73:     event FeeClaimed(

78:     event RatesStoredAtExpiry(uint256 indexed ibtRate, uint256 indexed ptRate);

79:     event RewardsProxyChange(address indexed oldRewardsProxy, address indexed newRewardsProxy);

102:     constructor(address _registry) {

```
*Github:* [[68](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L68), [69](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L69), [70](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L70), [71](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L71), [72](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L72), [73](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L73), [78](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L78), [79](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L79), [102](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L102)]


```solidity
File: src/tokens/YieldToken.sol

21:     constructor() {

```
*Github:* [[21](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L21)]


</details>


<a name="NC-40"></a> 
### [NC-40] Missing NatSpec `@author` from contract declaration
Some contract definitions have an incomplete NatSpec: add a `@author` notation to improve the code documentation.

*There are <b>7</b> instances of this issue:*
```solidity
File: src/libraries/PrincipalTokenUtil.sol

12: library PrincipalTokenUtil {

```
*Github:* [[12](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L12)]


```solidity
File: src/proxy/AMBeacon.sol

20: contract AMBeacon is IBeacon, AccessManaged {

```
*Github:* [[20](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L20)]


```solidity
File: src/proxy/AMProxyAdmin.sol

14: contract AMProxyAdmin is AccessManaged {

```
*Github:* [[14](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L14)]


```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

17: interface IAMTransparentUpgradeableProxy is IERC1967 {

60: contract AMTransparentUpgradeableProxy is ERC1967Proxy {

```
*Github:* [[17](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L17), [60](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L60)]


```solidity
File: src/tokens/PrincipalToken.sol

29: contract PrincipalToken is

```
*Github:* [[29](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L29)]


```solidity
File: src/tokens/YieldToken.sol

15: contract YieldToken is IYieldToken, ERC20PermitUpgradeable {

```
*Github:* [[15](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L15)]



<a name="NC-41"></a> 
### [NC-41] Missing NatSpec `@dev` from contract/event/function/modifier declarations
Some contract definitions have an incomplete NatSpec: add a `@dev` notation to improve the code documentation.

<details>
<summary>
There are <b>18</b> instances (click to show):
</summary>

```solidity
File: src/libraries/PrincipalTokenUtil.sol

12: library PrincipalTokenUtil {

```
*Github:* [[12](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L12)]


```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

18:     function upgradeToAndCall(address, bytes calldata) external payable;

```
*Github:* [[18](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L18)]


```solidity
File: src/tokens/PrincipalToken.sol

29: contract PrincipalToken is

68:     event Redeem(address indexed from, address indexed to, uint256 amount);

69:     event Mint(address indexed from, address indexed to, uint256 amount);

70:     event YTDeployed(address indexed yt);

71:     event YieldUpdated(address indexed user, uint256 indexed yieldInIBT);

72:     event YieldClaimed(address indexed owner, address indexed receiver, uint256 indexed yieldInIBT);

73:     event FeeClaimed(

78:     event RatesStoredAtExpiry(uint256 indexed ibtRate, uint256 indexed ptRate);

79:     event RewardsProxyChange(address indexed oldRewardsProxy, address indexed newRewardsProxy);

85:     modifier notExpired() virtual {

93:     modifier afterExpiry() virtual {

102:     constructor(address _registry) {

866:     function _maxBurnable(address _user) internal view returns (uint256 maxBurnable) {

```
*Github:* [[29](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L29), [68](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L68), [69](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L69), [70](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L70), [71](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L71), [72](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L72), [73](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L73), [78](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L78), [79](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L79), [85](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L85), [93](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L93), [102](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L102), [866](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L866)]


```solidity
File: src/tokens/YieldToken.sol

15: contract YieldToken is IYieldToken, ERC20PermitUpgradeable {

21:     constructor() {

31:     function initialize(

```
*Github:* [[15](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L15), [21](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L21), [31](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L31)]


</details>


<a name="NC-42"></a> 
### [NC-42] Missing NatSpec `@notice` from contract/event/function/modifier declarations
Some contract definitions have an incomplete NatSpec: add a `@notice` notation to improve the code documentation.

<details>
<summary>
There are <b>114</b> instances (click to show):
</summary>

```solidity
File: src/libraries/PrincipalTokenUtil.sol

12: library PrincipalTokenUtil {

22:     function _convertToSharesWithRate(

35:     function _convertToAssetsWithRate(

55:     function _computeYield(

137:     function _tryGetTokenDecimals(address _token) external view returns (uint8) {

157:     function _computeTokenizationFee(

178:     function _computeYieldFee(uint256 _amount, address _registry) internal view returns (uint256) {

188:     function _computeFlashloanFee(

```
*Github:* [[12](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L12), [22](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L22), [35](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L35), [55](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L55), [137](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L137), [157](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L157), [178](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L178), [188](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L188)]


```solidity
File: src/libraries/RayMath.sol

20:     function fromRay(uint256 _a, uint256 _decimals) internal pure returns (uint256 b) {

35:     function fromRay(

57:     function toRay(uint256 _a, uint256 _decimals) internal pure returns (uint256 b) {

```
*Github:* [[20](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/RayMath.sol#L20), [35](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/RayMath.sol#L35), [57](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/RayMath.sol#L57)]


```solidity
File: src/proxy/AMBeacon.sol

20: contract AMBeacon is IBeacon, AccessManaged {

31:     event Upgraded(address indexed implementation);

39:     constructor(address implementation_, address initialAuthority) AccessManaged(initialAuthority) {

46:     function implementation() public view virtual returns (address) {

63:     function upgradeTo(address newImplementation) public virtual restricted {

75:     function _setImplementation(address newImplementation) private {

```
*Github:* [[20](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L20), [31](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L31), [39](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L39), [46](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L46), [63](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L63), [75](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L75)]


```solidity
File: src/proxy/AMProxyAdmin.sol

14: contract AMProxyAdmin is AccessManaged {

28:     constructor(address initialAuthority) AccessManaged(initialAuthority) {}

40:     function upgradeAndCall(

```
*Github:* [[14](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L14), [28](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L28), [40](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L40)]


```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

17: interface IAMTransparentUpgradeableProxy is IERC1967 {

18:     function upgradeToAndCall(address, bytes calldata) external payable;

60: contract AMTransparentUpgradeableProxy is ERC1967Proxy {

77:     constructor(

94:     function _proxyAdmin() internal virtual returns (address) {

101:     function _fallback() internal virtual override {

120:     function _dispatchUpgradeToAndCall() private {

```
*Github:* [[17](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L17), [18](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L18), [60](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L60), [77](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L77), [94](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L94), [101](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L101), [120](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L120)]


```solidity
File: src/tokens/PrincipalToken.sol

68:     event Redeem(address indexed from, address indexed to, uint256 amount);

69:     event Mint(address indexed from, address indexed to, uint256 amount);

70:     event YTDeployed(address indexed yt);

71:     event YieldUpdated(address indexed user, uint256 indexed yieldInIBT);

72:     event YieldClaimed(address indexed owner, address indexed receiver, uint256 indexed yieldInIBT);

73:     event FeeClaimed(

78:     event RatesStoredAtExpiry(uint256 indexed ibtRate, uint256 indexed ptRate);

79:     event RewardsProxyChange(address indexed oldRewardsProxy, address indexed newRewardsProxy);

102:     constructor(address _registry) {

120:     function initialize(

161:     function pause() external override restricted {

166:     function unPause() external override restricted {

171:     function deposit(uint256 assets, address receiver) external override returns (uint256 shares) {

176:     function deposit(

188:     function deposit(

201:     function depositIBT(uint256 ibts, address receiver) external override returns (uint256 shares) {

206:     function depositIBT(

216:     function depositIBT(

229:     function redeem(

240:     function redeem(

253:     function redeemForIBT(

265:     function redeemForIBT(

278:     function withdraw(

290:     function withdraw(

303:     function withdrawIBT(

316:     function withdrawIBT(

329:     function claimFees() external override returns (uint256 assets) {

340:     function updateYield(address _user) public override returns (uint256 updatedUserYieldInIBT) {

369:     function claimYield(address _receiver) public override returns (uint256 yieldInAsset) {

377:     function claimYieldInIBT(address _receiver) public override returns (uint256 yieldInIBT) {

385:     function beforeYtTransfer(address _from, address _to) external override {

394:     function claimRewards(bytes memory _data) external restricted {

409:     function storeRatesAtExpiry() public override afterExpiry {

420:     function setRewardsProxy(address _rewardsProxy) external restricted {

430:     function previewDeposit(uint256 assets) public view override returns (uint256) {

436:     function previewDepositIBT(uint256 ibts) external view override returns (uint256) {

441:     function maxDeposit(address) external pure override returns (uint256) {

446:     function previewWithdraw(

454:     function previewWithdrawIBT(uint256 ibts) public view override whenNotPaused returns (uint256) {

460:     function maxWithdraw(address owner) public view override whenNotPaused returns (uint256) {

466:     function maxWithdrawIBT(address owner) public view override whenNotPaused returns (uint256) {

471:     function previewRedeem(uint256 shares) public view override returns (uint256) {

476:     function previewRedeemForIBT(

483:     function maxRedeem(address owner) public view override returns (uint256) {

488:     function convertToPrincipal(uint256 underlyingAmount) external view override returns (uint256) {

493:     function convertToUnderlying(uint256 principalAmount) public view override returns (uint256) {

498:     function totalAssets() public view override returns (uint256) {

503:     function decimals() public view override(IERC20Metadata, ERC20Upgradeable) returns (uint8) {

508:     function underlying() external view override returns (address) {

513:     function maturity() external view override returns (uint256) {

518:     function getDuration() external view override returns (uint256) {

523:     function getIBT() external view override returns (address) {

528:     function getYT() external view override returns (address) {

533:     function getIBTRate() external view override returns (uint256) {

539:     function getPTRate() external view override returns (uint256) {

545:     function getIBTUnit() external view override returns (uint256) {

550:     function getUnclaimedFeesInIBT() external view override returns (uint256) {

555:     function getTotalFeesInIBT() external view override returns (uint256) {

560:     function getCurrentYieldOfUserInIBT(

583:     function maxFlashLoan(address _token) public view override returns (uint256) {

594:     function flashFee(address _token, uint256 _amount) public view override returns (uint256) {

602:     function getTokenizationFee() public view override returns (uint256) {

609:     function flashLoan(

641:     function _previewDepositIBT(

659:     function _convertSharesToIBTs(

680:     function _convertIBTsToShares(

701:     function _convertIBTsToSharesPreview(uint256 ibts) internal view returns (uint256 shares) {

713:     function _updateFees(uint256 _feesInIBT) internal {

724:     function _deployYT(string memory _name, string memory _symbol) internal returns (address _yt) {

750:     function _depositIBT(

780:     function _withdrawShares(

805:     function _beforeRedeem(uint256 _shares, address _owner) internal nonReentrant whenNotPaused {

828:     function _beforeWithdraw(uint256 _assets, address _owner) internal whenNotPaused nonReentrant {

848:     function _claimYield() internal returns (uint256 yieldInIBT) {

879:     function _updatePTandIBTRates() internal returns (uint256 _ptRate, uint256 _ibtRate) {

901:     function _getCurrentPTandIBTRates(bool roundUpPTRate) internal view returns (uint256, uint256) {

921:     function _getPTandIBTRates(bool roundUpPTRate) internal view returns (uint256, uint256) {

```
*Github:* [[68](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L68), [69](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L69), [70](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L70), [71](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L71), [72](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L72), [73](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L73), [78](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L78), [79](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L79), [102](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L102), [120](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L120), [161](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L161), [166](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L166), [171](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L171), [176](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L176), [188](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L188), [201](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L201), [206](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L206), [216](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L216), [229](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L229), [240](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L240), [253](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L253), [265](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L265), [278](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L278), [290](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L290), [303](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L303), [316](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L316), [329](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L329), [340](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L340), [369](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L369), [377](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L377), [385](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L385), [394](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L394), [409](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L409), [420](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L420), [430](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L430), [436](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L436), [441](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L441), [446](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L446), [454](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L454), [460](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L460), [466](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L466), [471](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L471), [476](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L476), [483](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L483), [488](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L488), [493](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L493), [498](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L498), [503](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L503), [508](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L508), [513](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L513), [518](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L518), [523](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L523), [528](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L528), [533](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L533), [539](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L539), [545](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L545), [550](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L550), [555](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L555), [560](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L560), [583](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L583), [594](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L594), [602](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L602), [609](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L609), [641](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L641), [659](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L659), [680](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L680), [701](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L701), [713](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L713), [724](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L724), [750](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L750), [780](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L780), [805](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L805), [828](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L828), [848](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L848), [879](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L879), [901](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L901), [921](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L921)]


```solidity
File: src/tokens/YieldToken.sol

21:     constructor() {

42:     function burnWithoutUpdate(address from, uint256 amount) external override {

50:     function mint(address to, uint256 amount) external override {

58:     function burn(uint256 amount) public override {

71:     function transfer(

95:     function transferFrom(

105:     function decimals()

116:     function getPT() public view virtual override returns (address) {

121:     function balanceOf(

128:     function actualBalanceOf(address account) public view override returns (uint256) {

```
*Github:* [[21](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L21), [42](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L42), [50](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L50), [58](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L58), [71](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L71), [95](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L95), [105](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L105), [116](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L116), [121](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L121), [128](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L128)]


</details>


<a name="NC-43"></a> 
### [NC-43] Missing NatSpec `@param` from event/function/modifier declarations
Some event definitions have an incomplete NatSpec: add a `@param` notation to improve the code documentation.

<details>
<summary>
There are <b>59</b> instances (click to show):
</summary>

```solidity
File: src/libraries/PrincipalTokenUtil.sol

/// @audit missing @param for `_assets`
/// @audit missing @param for `_rate`
/// @audit missing @param for `_ibtUnit`
/// @audit missing @param for `_rounding`
22:     function _convertToSharesWithRate(
            uint256 _assets,
            uint256 _rate,
            uint256 _ibtUnit,
            Math.Rounding _rounding
        ) internal pure returns (uint256 shares) {

/// @audit missing @param for `_shares`
/// @audit missing @param for `_rate`
/// @audit missing @param for `_ibtUnit`
/// @audit missing @param for `_rounding`
35:     function _convertToAssetsWithRate(
            uint256 _shares,
            uint256 _rate,
            uint256 _ibtUnit,
            Math.Rounding _rounding
        ) internal pure returns (uint256 assets) {

```
*Github:* [[22](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L22), [35](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L35)]


```solidity
File: src/proxy/AMBeacon.sol

31:     event Upgraded(address indexed implementation);

/// @audit missing @param for `newImplementation`
63:     function upgradeTo(address newImplementation) public virtual restricted {

/// @audit missing @param for `newImplementation`
75:     function _setImplementation(address newImplementation) private {

```
*Github:* [[31](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L31), [63](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L63), [75](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L75)]


```solidity
File: src/proxy/AMProxyAdmin.sol

/// @audit missing @param for `initialAuthority`
28:     constructor(address initialAuthority) AccessManaged(initialAuthority) {}

/// @audit missing @param for `proxy`
/// @audit missing @param for `implementation`
/// @audit missing @param for `data`
40:     function upgradeAndCall(
            IAMTransparentUpgradeableProxy proxy,
            address implementation,
            bytes memory data
        ) public payable virtual restricted {

```
*Github:* [[28](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L28), [40](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L40)]


```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

/// @audit missing @param for `_logic`
/// @audit missing @param for `initialAuthority`
/// @audit missing @param for `_data`
77:     constructor(
            address _logic,
            address initialAuthority,
            bytes memory _data
        ) payable ERC1967Proxy(_logic, _data) {

```
*Github:* [[77](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L77)]


```solidity
File: src/tokens/PrincipalToken.sol

68:     event Redeem(address indexed from, address indexed to, uint256 amount);

69:     event Mint(address indexed from, address indexed to, uint256 amount);

70:     event YTDeployed(address indexed yt);

71:     event YieldUpdated(address indexed user, uint256 indexed yieldInIBT);

72:     event YieldClaimed(address indexed owner, address indexed receiver, uint256 indexed yieldInIBT);

73:     event FeeClaimed(

78:     event RatesStoredAtExpiry(uint256 indexed ibtRate, uint256 indexed ptRate);

79:     event RewardsProxyChange(address indexed oldRewardsProxy, address indexed newRewardsProxy);

/// @audit missing @param for `_registry`
102:     constructor(address _registry) {

/// @audit missing @param for `assets`
/// @audit missing @param for `receiver`
171:     function deposit(uint256 assets, address receiver) external override returns (uint256 shares) {

/// @audit missing @param for `assets`
/// @audit missing @param for `ptReceiver`
/// @audit missing @param for `ytReceiver`
176:     function deposit(
             uint256 assets,
             address ptReceiver,
             address ytReceiver
         ) public override returns (uint256 shares) {

/// @audit missing @param for `assets`
/// @audit missing @param for `ptReceiver`
/// @audit missing @param for `ytReceiver`
/// @audit missing @param for `minShares`
188:     function deposit(
             uint256 assets,
             address ptReceiver,
             address ytReceiver,
             uint256 minShares
         ) external override returns (uint256 shares) {

/// @audit missing @param for `ibts`
/// @audit missing @param for `receiver`
201:     function depositIBT(uint256 ibts, address receiver) external override returns (uint256 shares) {

/// @audit missing @param for `ibts`
/// @audit missing @param for `ptReceiver`
/// @audit missing @param for `ytReceiver`
206:     function depositIBT(
             uint256 ibts,
             address ptReceiver,
             address ytReceiver
         ) public override returns (uint256 shares) {

/// @audit missing @param for `ibts`
/// @audit missing @param for `ptReceiver`
/// @audit missing @param for `ytReceiver`
/// @audit missing @param for `minShares`
216:     function depositIBT(
             uint256 ibts,
             address ptReceiver,
             address ytReceiver,
             uint256 minShares
         ) external override returns (uint256 shares) {

/// @audit missing @param for `shares`
/// @audit missing @param for `receiver`
/// @audit missing @param for `owner`
229:     function redeem(
             uint256 shares,
             address receiver,
             address owner
         ) public override returns (uint256 assets) {

/// @audit missing @param for `shares`
/// @audit missing @param for `receiver`
/// @audit missing @param for `owner`
/// @audit missing @param for `minAssets`
240:     function redeem(
             uint256 shares,
             address receiver,
             address owner,
             uint256 minAssets
         ) external override returns (uint256 assets) {

/// @audit missing @param for `shares`
/// @audit missing @param for `receiver`
/// @audit missing @param for `owner`
253:     function redeemForIBT(
             uint256 shares,
             address receiver,
             address owner
         ) public override returns (uint256 ibts) {

/// @audit missing @param for `shares`
/// @audit missing @param for `receiver`
/// @audit missing @param for `owner`
/// @audit missing @param for `minIbts`
265:     function redeemForIBT(
             uint256 shares,
             address receiver,
             address owner,
             uint256 minIbts
         ) external override returns (uint256 ibts) {

/// @audit missing @param for `assets`
/// @audit missing @param for `receiver`
/// @audit missing @param for `owner`
278:     function withdraw(
             uint256 assets,
             address receiver,
             address owner
         ) public override returns (uint256 shares) {

/// @audit missing @param for `assets`
/// @audit missing @param for `receiver`
/// @audit missing @param for `owner`
/// @audit missing @param for `maxShares`
290:     function withdraw(
             uint256 assets,
             address receiver,
             address owner,
             uint256 maxShares
         ) external override returns (uint256 shares) {

/// @audit missing @param for `ibts`
/// @audit missing @param for `receiver`
/// @audit missing @param for `owner`
303:     function withdrawIBT(
             uint256 ibts,
             address receiver,
             address owner
         ) public override returns (uint256 shares) {

/// @audit missing @param for `ibts`
/// @audit missing @param for `receiver`
/// @audit missing @param for `owner`
/// @audit missing @param for `maxShares`
316:     function withdrawIBT(
             uint256 ibts,
             address receiver,
             address owner,
             uint256 maxShares
         ) external override returns (uint256 shares) {

/// @audit missing @param for `_user`
340:     function updateYield(address _user) public override returns (uint256 updatedUserYieldInIBT) {

/// @audit missing @param for `_receiver`
369:     function claimYield(address _receiver) public override returns (uint256 yieldInAsset) {

/// @audit missing @param for `_receiver`
377:     function claimYieldInIBT(address _receiver) public override returns (uint256 yieldInIBT) {

/// @audit missing @param for `_from`
/// @audit missing @param for `_to`
385:     function beforeYtTransfer(address _from, address _to) external override {

/// @audit missing @param for `_data`
394:     function claimRewards(bytes memory _data) external restricted {

/// @audit missing @param for `_rewardsProxy`
420:     function setRewardsProxy(address _rewardsProxy) external restricted {

/// @audit missing @param for `assets`
430:     function previewDeposit(uint256 assets) public view override returns (uint256) {

/// @audit missing @param for `ibts`
436:     function previewDepositIBT(uint256 ibts) external view override returns (uint256) {

/// @audit missing @param for `assets`
446:     function previewWithdraw(
             uint256 assets
         ) external view override whenNotPaused returns (uint256) {

/// @audit missing @param for `ibts`
454:     function previewWithdrawIBT(uint256 ibts) public view override whenNotPaused returns (uint256) {

/// @audit missing @param for `owner`
460:     function maxWithdraw(address owner) public view override whenNotPaused returns (uint256) {

/// @audit missing @param for `owner`
466:     function maxWithdrawIBT(address owner) public view override whenNotPaused returns (uint256) {

/// @audit missing @param for `shares`
471:     function previewRedeem(uint256 shares) public view override returns (uint256) {

/// @audit missing @param for `shares`
476:     function previewRedeemForIBT(
             uint256 shares
         ) public view override whenNotPaused returns (uint256) {

/// @audit missing @param for `owner`
483:     function maxRedeem(address owner) public view override returns (uint256) {

/// @audit missing @param for `underlyingAmount`
488:     function convertToPrincipal(uint256 underlyingAmount) external view override returns (uint256) {

/// @audit missing @param for `principalAmount`
493:     function convertToUnderlying(uint256 principalAmount) public view override returns (uint256) {

/// @audit missing @param for `_user`
560:     function getCurrentYieldOfUserInIBT(
             address _user
         ) external view override returns (uint256 _yieldOfUserInIBT) {

/// @audit missing @param for `_token`
583:     function maxFlashLoan(address _token) public view override returns (uint256) {

/// @audit missing @param for `_token`
/// @audit missing @param for `_amount`
594:     function flashFee(address _token, uint256 _amount) public view override returns (uint256) {

/// @audit missing @param for `_receiver`
/// @audit missing @param for `_token`
/// @audit missing @param for `_amount`
/// @audit missing @param for `_data`
609:     function flashLoan(
             IERC3156FlashBorrower _receiver,
             address _token,
             uint256 _amount,
             bytes calldata _data
         ) external override returns (bool) {

```
*Github:* [[68](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L68), [69](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L69), [70](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L70), [71](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L71), [72](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L72), [73](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L73), [78](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L78), [79](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L79), [102](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L102), [171](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L171), [176](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L176), [188](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L188), [201](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L201), [206](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L206), [216](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L216), [229](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L229), [240](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L240), [253](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L253), [265](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L265), [278](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L278), [290](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L290), [303](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L303), [316](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L316), [340](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L340), [369](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L369), [377](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L377), [385](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L385), [394](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L394), [420](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L420), [430](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L430), [436](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L436), [446](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L446), [454](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L454), [460](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L460), [466](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L466), [471](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L471), [476](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L476), [483](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L483), [488](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L488), [493](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L493), [560](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L560), [583](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L583), [594](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L594), [609](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L609)]


```solidity
File: src/tokens/YieldToken.sol

/// @audit missing @param for `from`
/// @audit missing @param for `amount`
42:     function burnWithoutUpdate(address from, uint256 amount) external override {

/// @audit missing @param for `to`
/// @audit missing @param for `amount`
50:     function mint(address to, uint256 amount) external override {

/// @audit missing @param for `amount`
58:     function burn(uint256 amount) public override {

/// @audit missing @param for `to`
/// @audit missing @param for `amount`
71:     function transfer(
            address to,
            uint256 amount
        ) public virtual override(IYieldToken, ERC20Upgradeable) returns (bool success) {

/// @audit missing @param for `from`
/// @audit missing @param for `to`
/// @audit missing @param for `amount`
95:     function transferFrom(
            address from,
            address to,
            uint256 amount
        ) public virtual override(IYieldToken, ERC20Upgradeable) returns (bool success) {

/// @audit missing @param for `account`
121:     function balanceOf(
             address account
         ) public view override(IYieldToken, ERC20Upgradeable) returns (uint256) {

/// @audit missing @param for `account`
128:     function actualBalanceOf(address account) public view override returns (uint256) {

```
*Github:* [[42](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L42), [50](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L50), [58](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L58), [71](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L71), [95](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L95), [121](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L121), [128](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L128)]


</details>


<a name="NC-44"></a> 
### [NC-44] Missing NatSpec `@return` from function declaration
Some function definitions have an incomplete NatSpec: add a `@return` notation to improve the code documentation.

<details>
<summary>
There are <b>58</b> instances (click to show):
</summary>

```solidity
File: src/libraries/PrincipalTokenUtil.sol

22:     function _convertToSharesWithRate(
            uint256 _assets,
            uint256 _rate,
            uint256 _ibtUnit,
            Math.Rounding _rounding
        ) internal pure returns (uint256 shares) {

35:     function _convertToAssetsWithRate(
            uint256 _shares,
            uint256 _rate,
            uint256 _ibtUnit,
            Math.Rounding _rounding
        ) internal pure returns (uint256 assets) {

```
*Github:* [[22](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L22), [35](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L35)]


```solidity
File: src/proxy/AMBeacon.sol

46:     function implementation() public view virtual returns (address) {

```
*Github:* [[46](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L46)]


```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

94:     function _proxyAdmin() internal virtual returns (address) {

```
*Github:* [[94](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L94)]


```solidity
File: src/tokens/PrincipalToken.sol

171:     function deposit(uint256 assets, address receiver) external override returns (uint256 shares) {

176:     function deposit(
             uint256 assets,
             address ptReceiver,
             address ytReceiver
         ) public override returns (uint256 shares) {

188:     function deposit(
             uint256 assets,
             address ptReceiver,
             address ytReceiver,
             uint256 minShares
         ) external override returns (uint256 shares) {

201:     function depositIBT(uint256 ibts, address receiver) external override returns (uint256 shares) {

206:     function depositIBT(
             uint256 ibts,
             address ptReceiver,
             address ytReceiver
         ) public override returns (uint256 shares) {

216:     function depositIBT(
             uint256 ibts,
             address ptReceiver,
             address ytReceiver,
             uint256 minShares
         ) external override returns (uint256 shares) {

229:     function redeem(
             uint256 shares,
             address receiver,
             address owner
         ) public override returns (uint256 assets) {

240:     function redeem(
             uint256 shares,
             address receiver,
             address owner,
             uint256 minAssets
         ) external override returns (uint256 assets) {

253:     function redeemForIBT(
             uint256 shares,
             address receiver,
             address owner
         ) public override returns (uint256 ibts) {

265:     function redeemForIBT(
             uint256 shares,
             address receiver,
             address owner,
             uint256 minIbts
         ) external override returns (uint256 ibts) {

278:     function withdraw(
             uint256 assets,
             address receiver,
             address owner
         ) public override returns (uint256 shares) {

290:     function withdraw(
             uint256 assets,
             address receiver,
             address owner,
             uint256 maxShares
         ) external override returns (uint256 shares) {

303:     function withdrawIBT(
             uint256 ibts,
             address receiver,
             address owner
         ) public override returns (uint256 shares) {

316:     function withdrawIBT(
             uint256 ibts,
             address receiver,
             address owner,
             uint256 maxShares
         ) external override returns (uint256 shares) {

329:     function claimFees() external override returns (uint256 assets) {

340:     function updateYield(address _user) public override returns (uint256 updatedUserYieldInIBT) {

369:     function claimYield(address _receiver) public override returns (uint256 yieldInAsset) {

377:     function claimYieldInIBT(address _receiver) public override returns (uint256 yieldInIBT) {

430:     function previewDeposit(uint256 assets) public view override returns (uint256) {

436:     function previewDepositIBT(uint256 ibts) external view override returns (uint256) {

441:     function maxDeposit(address) external pure override returns (uint256) {

446:     function previewWithdraw(
             uint256 assets
         ) external view override whenNotPaused returns (uint256) {

454:     function previewWithdrawIBT(uint256 ibts) public view override whenNotPaused returns (uint256) {

460:     function maxWithdraw(address owner) public view override whenNotPaused returns (uint256) {

466:     function maxWithdrawIBT(address owner) public view override whenNotPaused returns (uint256) {

471:     function previewRedeem(uint256 shares) public view override returns (uint256) {

476:     function previewRedeemForIBT(
             uint256 shares
         ) public view override whenNotPaused returns (uint256) {

483:     function maxRedeem(address owner) public view override returns (uint256) {

488:     function convertToPrincipal(uint256 underlyingAmount) external view override returns (uint256) {

493:     function convertToUnderlying(uint256 principalAmount) public view override returns (uint256) {

498:     function totalAssets() public view override returns (uint256) {

503:     function decimals() public view override(IERC20Metadata, ERC20Upgradeable) returns (uint8) {

508:     function underlying() external view override returns (address) {

513:     function maturity() external view override returns (uint256) {

518:     function getDuration() external view override returns (uint256) {

523:     function getIBT() external view override returns (address) {

528:     function getYT() external view override returns (address) {

533:     function getIBTRate() external view override returns (uint256) {

539:     function getPTRate() external view override returns (uint256) {

545:     function getIBTUnit() external view override returns (uint256) {

550:     function getUnclaimedFeesInIBT() external view override returns (uint256) {

555:     function getTotalFeesInIBT() external view override returns (uint256) {

560:     function getCurrentYieldOfUserInIBT(
             address _user
         ) external view override returns (uint256 _yieldOfUserInIBT) {

583:     function maxFlashLoan(address _token) public view override returns (uint256) {

594:     function flashFee(address _token, uint256 _amount) public view override returns (uint256) {

602:     function getTokenizationFee() public view override returns (uint256) {

609:     function flashLoan(
             IERC3156FlashBorrower _receiver,
             address _token,
             uint256 _amount,
             bytes calldata _data
         ) external override returns (bool) {

879:     function _updatePTandIBTRates() internal returns (uint256 _ptRate, uint256 _ibtRate) {

```
*Github:* [[171](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L171), [176](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L176), [188](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L188), [201](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L201), [206](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L206), [216](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L216), [229](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L229), [240](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L240), [253](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L253), [265](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L265), [278](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L278), [290](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L290), [303](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L303), [316](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L316), [329](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L329), [340](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L340), [369](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L369), [377](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L377), [430](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L430), [436](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L436), [441](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L441), [446](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L446), [454](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L454), [460](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L460), [466](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L466), [471](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L471), [476](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L476), [483](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L483), [488](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L488), [493](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L493), [498](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L498), [503](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L503), [508](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L508), [513](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L513), [518](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L518), [523](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L523), [528](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L528), [533](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L533), [539](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L539), [545](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L545), [550](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L550), [555](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L555), [560](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L560), [583](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L583), [594](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L594), [602](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L602), [609](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L609), [879](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L879)]


```solidity
File: src/tokens/YieldToken.sol

71:     function transfer(
            address to,
            uint256 amount
        ) public virtual override(IYieldToken, ERC20Upgradeable) returns (bool success) {

95:     function transferFrom(
            address from,
            address to,
            uint256 amount
        ) public virtual override(IYieldToken, ERC20Upgradeable) returns (bool success) {

105:     function decimals()
             public
             view
             virtual
             override(IYieldToken, ERC20Upgradeable)
             returns (uint8)
         {

116:     function getPT() public view virtual override returns (address) {

121:     function balanceOf(
             address account
         ) public view override(IYieldToken, ERC20Upgradeable) returns (uint256) {

128:     function actualBalanceOf(address account) public view override returns (uint256) {

```
*Github:* [[71](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L71), [95](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L95), [105](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L105), [116](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L116), [121](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L121), [128](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L128)]


</details>


<a name="NC-45"></a> 
### [NC-45] Missing NatSpec `@title` from contract declaration
Some contract definitions have an incomplete NatSpec: add a `@title` notation to improve the code documentation.

*There are <b>4</b> instances of this issue:*
```solidity
File: src/libraries/PrincipalTokenUtil.sol

12: library PrincipalTokenUtil {

```
*Github:* [[12](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L12)]


```solidity
File: src/proxy/AMProxyAdmin.sol

14: contract AMProxyAdmin is AccessManaged {

```
*Github:* [[14](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L14)]


```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

17: interface IAMTransparentUpgradeableProxy is IERC1967 {

60: contract AMTransparentUpgradeableProxy is ERC1967Proxy {

```
*Github:* [[17](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L17), [60](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L60)]



<a name="NC-46"></a> 
### [NC-46] Potential Re-org Attack Vector
The contract appears to deploy new contracts using the `new` keyword. In a re-org attack scenario, such deployments can be exploited by a malicious actor who might rewrite the blockchain's history and deploy the contract at an expected address.

Consider deploying the contract via `CREATE2` opcode with a specific salt that includes `msg.sender` and the existing contract address. This will ensure a predictable contract address, reducing the chances of such an attack.

*There is one instance of this issue:*
```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

86:         _admin = address(new AMProxyAdmin(initialAuthority));

```
*Github:* [[86](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L86)]



<a name="NC-47"></a> 
### [NC-47] Put all system-wide constants in one file
Putting all the system-wide constants in a single file improves code readability, makes it easier to understand the basic configuration and limitations of the system, and makes maintenance easier.

*There are <b>7</b> instances of this issue:*
```solidity
File: src/libraries/PrincipalTokenUtil.sol

18:     uint256 private constant SAFETY_BOUND = 100; // used to favour the protocol in case of approximations

19:     uint256 private constant FEE_DIVISOR = 1e18; // equivalent to 100% fees

```
*Github:* [[18](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L18), [19](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L19)]


```solidity
File: src/libraries/RayMath.sol

12:     uint256 public constant RAY_UNIT = 1e27;

```
*Github:* [[12](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/RayMath.sol#L12)]


```solidity
File: src/proxy/AMProxyAdmin.sol

23:     string public constant UPGRADE_INTERFACE_VERSION = "5.0.0";

```
*Github:* [[23](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L23)]


```solidity
File: src/tokens/PrincipalToken.sol

40:     uint256 private constant MIN_DECIMALS = 6;

41:     uint256 private constant MAX_DECIMALS = 18;

42:     bytes32 private constant ON_FLASH_LOAN = keccak256("ERC3156FlashBorrower.onFlashLoan");

```
*Github:* [[40](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L40), [41](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L41), [42](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L42)]



<a name="NC-48"></a> 
### [NC-48] Redundant `return` statement in a function with named return variables
Because the return variable (or its default value) has been assigned, explicit return at the end of the function is unnecessary, as it is returned automatically.

*There are <b>5</b> instances of this issue:*
```solidity
File: src/libraries/PrincipalTokenUtil.sol

22:     function _convertToSharesWithRate(

35:     function _convertToAssetsWithRate(

```
*Github:* [[22](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L22), [35](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L35)]


```solidity
File: src/tokens/PrincipalToken.sol

848:     function _claimYield() internal returns (uint256 yieldInIBT) {

```
*Github:* [[848](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L848)]


```solidity
File: src/tokens/YieldToken.sol

71:     function transfer(

95:     function transferFrom(

```
*Github:* [[71](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L71), [95](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L95)]



<a name="NC-49"></a> 
### [NC-49] Setters should prevent re-setting the same value
Not only is wasteful in terms of gas, but this is especially problematic when an event is emitted and the old and new values set are the same, as listeners might not expect this kind of scenario.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/proxy/AMBeacon.sol

79:         _implementation = newImplementation;

```
*Github:* [[79](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L79)]


```solidity
File: src/tokens/PrincipalToken.sol

423:         rewardsProxy = _rewardsProxy;

```
*Github:* [[423](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L423)]



<a name="NC-50"></a> 
### [NC-50] State variables should include comments
Consider adding some comments on critical state variables to explain what they are supposed to do: this will help for future code reviews.

*There are <b>6</b> instances of this issue:*
```solidity
File: src/proxy/AMBeacon.sol

21:     address private _implementation;

```
*Github:* [[21](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L21)]


```solidity
File: src/proxy/AMProxyAdmin.sol

23:     string public constant UPGRADE_INTERFACE_VERSION = "5.0.0";

```
*Github:* [[23](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L23)]


```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

65:     address private immutable _admin;

```
*Github:* [[65](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L65)]


```solidity
File: src/tokens/PrincipalToken.sol

40:     uint256 private constant MIN_DECIMALS = 6;

41:     uint256 private constant MAX_DECIMALS = 18;

```
*Github:* [[40](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L40), [41](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L41)]


```solidity
File: src/tokens/YieldToken.sol

18:     address private pt;

```
*Github:* [[18](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L18)]



<a name="NC-51"></a> 
### [NC-51] The `nonReentrant` modifier should occur before all other modifiers
This is a best-practice to protect against reentrancy in other modifiers.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

750:     function _depositIBT(
             uint256 _ibts,
             address _ptReceiver,
             address _ytReceiver
         ) internal notExpired nonReentrant whenNotPaused returns (uint256 shares) {

828:     function _beforeWithdraw(uint256 _assets, address _owner) internal whenNotPaused nonReentrant {

```
*Github:* [[750](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L750), [828](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L828)]



<a name="NC-52"></a> 
### [NC-52] Lines are too long
The [solidity style guide](https://docs.soliditylang.org/en/v0.8.17/style-guide.html#maximum-line-length) recommends a maximum line length of 120 characters. Lines of code that are longer than 120 should be wrapped.

*There is one instance of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

702:         (uint256 _ptRate, uint256 _ibtRate) = _getPTandIBTRates(true); // to round up the shares, the PT rate must round down

```
*Github:* [[702](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L702)]



<a name="NC-53"></a> 
### [NC-53] Typos

*There are <b>4</b> instances of this issue:*
```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

/// @audit `upgradeability`
13:  * does not implement this interface directly, and its upgradeability mechanism is implemented by an internal dispatch

/// @audit `upgradeability`
58:  * could render the `upgradeToAndCall` function inaccessible, preventing upgradeability and compromising transparency.

```
*Github:* [[13](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L13), [58](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L58)]


```solidity
File: src/tokens/PrincipalToken.sol

/// @audit `intializes`
115:      * it deploys yt and intializes values of required variables

/// @audit `addresss`
774:      * @param _receiver The addresss of the receiver of the assets

```
*Github:* [[115](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L115), [774](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L774)]



<a name="NC-54"></a> 
### [NC-54] Unnecessary cast
The variable is being cast to its own type.

*There are <b>6</b> instances of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

/// @audit no need to cast `_receiver` into address
621:         IERC20(ibt).safeTransfer(address(_receiver), _amount);

/// @audit no need to cast `_receiver` into address
621:         IERC20(ibt).safeTransfer(address(_receiver), _amount);

/// @audit no need to cast `_receiver` into address
621:         IERC20(ibt).safeTransfer(address(_receiver), _amount);

/// @audit no need to cast `_receiver` into address
628:         IERC20(ibt).safeTransferFrom(address(_receiver), address(this), _amount + fee);

/// @audit no need to cast `_receiver` into address
628:         IERC20(ibt).safeTransferFrom(address(_receiver), address(this), _amount + fee);

/// @audit no need to cast `_receiver` into address
628:         IERC20(ibt).safeTransferFrom(address(_receiver), address(this), _amount + fee);

```
*Github:* [[621](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L621), [621](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L621), [621](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L621), [628](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L628), [628](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L628), [628](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L628)]



<a name="NC-55"></a> 
### [NC-55] Unsafe solidity low-level call can cause gas grief attack
Using the low-level calls of a solidity address can leave the contract open to gas grief attacks. These attacks occur when the called contract returns a large amount of data. So when calling an external contract, it is necessary to check the length of the return data before reading/copying it (using `returndatasize()`).

*There is one instance of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

399:         (bool success, ) = rewardsProxy.delegatecall(_data);

```
*Github:* [[399](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L399)]



<a name="NC-56"></a> 
### [NC-56] Unused named return
Declaring named returns, but not using them, is confusing to the reader. Consider either completely removing them (by declaring just the type without a name), or remove the return statement and do a variable assignment. This would improve the readability of the code, and it may also help reduce regressions during future code refactors.

*There are <b>4</b> instances of this issue:*
```solidity
File: src/libraries/PrincipalTokenUtil.sol

/// @audit `shares` not used
22:     function _convertToSharesWithRate(
            uint256 _assets,
            uint256 _rate,
            uint256 _ibtUnit,
            Math.Rounding _rounding
        ) internal pure returns (uint256 shares) {

/// @audit `assets` not used
35:     function _convertToAssetsWithRate(
            uint256 _shares,
            uint256 _rate,
            uint256 _ibtUnit,
            Math.Rounding _rounding
        ) internal pure returns (uint256 assets) {

```
*Github:* [[22](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L22), [35](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L35)]


```solidity
File: src/tokens/YieldToken.sol

/// @audit `success` not used
71:     function transfer(
            address to,
            uint256 amount
        ) public virtual override(IYieldToken, ERC20Upgradeable) returns (bool success) {

/// @audit `success` not used
95:     function transferFrom(
            address from,
            address to,
            uint256 amount
        ) public virtual override(IYieldToken, ERC20Upgradeable) returns (bool success) {

```
*Github:* [[71](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L71), [95](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L95)]



<a name="NC-57"></a> 
### [NC-57] Unused contract variables
The following state variables are defined but not used. It is recommended to check the code for logical omissions that cause them not to be used. If it's determined that they are not needed anywhere, it's best to remove them from the codebase to improve code clarity and minimize confusion.

*There is one instance of this issue:*
```solidity
File: src/proxy/AMProxyAdmin.sol

23:     string public constant UPGRADE_INTERFACE_VERSION = "5.0.0";

```
*Github:* [[23](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L23)]



<a name="NC-58"></a> 
### [NC-58] Use `abi.encodeCall()` instead of `abi.encodeWithSignature()`/`abi.encodeWithSelector()`
`abi.encodeCall()` has compiler type safety, whereas the other two functions do not

*There are <b>2</b> instances of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

398:         _data = abi.encodeWithSelector(IRewardsProxy(rewardsProxy).claimRewards.selector, _data);

732:                 abi.encodeWithSelector(

```
*Github:* [[398](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L398), [732](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L732)]



<a name="NC-59"></a> 
### [NC-59] Consider using `delete` rather than assigning zero/false to clear values
The `delete` keyword more closely matches the semantics of what is being done, and draws more attention to the changing of state, which may lead to a more thorough audit of its associated logic.

*There is one instance of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

853:             yieldOfUserInIBT[msg.sender] = 0;

```
*Github:* [[853](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L853)]



<a name="NC-60"></a> 
### [NC-60] Expressions for constant values should use `immutable` rather than `constant`
While it doesn't save any gas because the compiler knows that developers often make this mistake, it's still best to use the right tool for the task at hand. There is a difference between `constant` variables and `immutable` variables, and they should each be used in their appropriate contexts. `constants` should be used for literal values written into the code, and `immutable` variables should be used for expressions, or values calculated in, or passed into the constructor.

*There are <b>7</b> instances of this issue:*
```solidity
File: src/libraries/PrincipalTokenUtil.sol

18:     uint256 private constant SAFETY_BOUND = 100; // used to favour the protocol in case of approximations

19:     uint256 private constant FEE_DIVISOR = 1e18; // equivalent to 100% fees

```
*Github:* [[18](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L18), [19](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L19)]


```solidity
File: src/libraries/RayMath.sol

12:     uint256 public constant RAY_UNIT = 1e27;

```
*Github:* [[12](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/RayMath.sol#L12)]


```solidity
File: src/proxy/AMProxyAdmin.sol

23:     string public constant UPGRADE_INTERFACE_VERSION = "5.0.0";

```
*Github:* [[23](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L23)]


```solidity
File: src/tokens/PrincipalToken.sol

40:     uint256 private constant MIN_DECIMALS = 6;

41:     uint256 private constant MAX_DECIMALS = 18;

42:     bytes32 private constant ON_FLASH_LOAN = keccak256("ERC3156FlashBorrower.onFlashLoan");

```
*Github:* [[40](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L40), [41](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L41), [42](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L42)]



<a name="NC-61"></a> 
### [NC-61] Use `@inheritdoc` for overridden functions

<details>
<summary>
There are <b>40</b> instances (click to show):
</summary>

```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

101:     function _fallback() internal virtual override {

```
*Github:* [[101](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L101)]


```solidity
File: src/tokens/PrincipalToken.sol

161:     function pause() external override restricted {

166:     function unPause() external override restricted {

171:     function deposit(uint256 assets, address receiver) external override returns (uint256 shares) {

201:     function depositIBT(uint256 ibts, address receiver) external override returns (uint256 shares) {

329:     function claimFees() external override returns (uint256 assets) {

340:     function updateYield(address _user) public override returns (uint256 updatedUserYieldInIBT) {

369:     function claimYield(address _receiver) public override returns (uint256 yieldInAsset) {

377:     function claimYieldInIBT(address _receiver) public override returns (uint256 yieldInIBT) {

385:     function beforeYtTransfer(address _from, address _to) external override {

409:     function storeRatesAtExpiry() public override afterExpiry {

430:     function previewDeposit(uint256 assets) public view override returns (uint256) {

436:     function previewDepositIBT(uint256 ibts) external view override returns (uint256) {

441:     function maxDeposit(address) external pure override returns (uint256) {

454:     function previewWithdrawIBT(uint256 ibts) public view override whenNotPaused returns (uint256) {

460:     function maxWithdraw(address owner) public view override whenNotPaused returns (uint256) {

466:     function maxWithdrawIBT(address owner) public view override whenNotPaused returns (uint256) {

471:     function previewRedeem(uint256 shares) public view override returns (uint256) {

483:     function maxRedeem(address owner) public view override returns (uint256) {

488:     function convertToPrincipal(uint256 underlyingAmount) external view override returns (uint256) {

493:     function convertToUnderlying(uint256 principalAmount) public view override returns (uint256) {

498:     function totalAssets() public view override returns (uint256) {

508:     function underlying() external view override returns (address) {

513:     function maturity() external view override returns (uint256) {

518:     function getDuration() external view override returns (uint256) {

523:     function getIBT() external view override returns (address) {

528:     function getYT() external view override returns (address) {

533:     function getIBTRate() external view override returns (uint256) {

539:     function getPTRate() external view override returns (uint256) {

545:     function getIBTUnit() external view override returns (uint256) {

550:     function getUnclaimedFeesInIBT() external view override returns (uint256) {

555:     function getTotalFeesInIBT() external view override returns (uint256) {

583:     function maxFlashLoan(address _token) public view override returns (uint256) {

594:     function flashFee(address _token, uint256 _amount) public view override returns (uint256) {

602:     function getTokenizationFee() public view override returns (uint256) {

```
*Github:* [[161](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L161), [166](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L166), [171](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L171), [201](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L201), [329](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L329), [340](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L340), [369](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L369), [377](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L377), [385](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L385), [409](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L409), [430](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L430), [436](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L436), [441](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L441), [454](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L454), [460](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L460), [466](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L466), [471](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L471), [483](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L483), [488](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L488), [493](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L493), [498](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L498), [508](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L508), [513](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L513), [518](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L518), [523](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L523), [528](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L528), [533](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L533), [539](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L539), [545](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L545), [550](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L550), [555](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L555), [583](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L583), [594](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L594), [602](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L602)]


```solidity
File: src/tokens/YieldToken.sol

42:     function burnWithoutUpdate(address from, uint256 amount) external override {

50:     function mint(address to, uint256 amount) external override {

58:     function burn(uint256 amount) public override {

116:     function getPT() public view virtual override returns (address) {

128:     function actualBalanceOf(address account) public view override returns (uint256) {

```
*Github:* [[42](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L42), [50](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L50), [58](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L58), [116](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L116), [128](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L128)]


</details>


<a name="NC-62"></a> 
### [NC-62] Upgrade `openzeppelin` to the latest version (`5.0.1`)
These contracts import contracts from openzeppelin contracts but they are not using the latest version. For more information, please visit: [OpenZeppelin GitHub Releases](https://github.com/OpenZeppelin/openzeppelin-contracts/releases) It is recommended to always use the latest version to take advantage of updates and security fixes.

*There is one instance of this issue:*
```solidity

Global finding

```
*Github:* [[Global](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/)]



<a name="NC-63"></a> 
### [NC-63] Use the latest solidity version for deployment (`0.8.24`)
Upgrading to a newer Solidity release can optimize gas usage, take advantage of new features and improve overall contract efficiency. Where possible, based on compatibility requirements, it is recommended to use newer/latest solidity version to take advantage of the latest optimizations and features.

*There are <b>7</b> instances of this issue:*
```solidity
File: src/libraries/PrincipalTokenUtil.sol

3: pragma solidity 0.8.20;

```
*Github:* [[3](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L3)]


```solidity
File: src/libraries/RayMath.sol

2: pragma solidity =0.8.20;

```
*Github:* [[2](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/RayMath.sol#L2)]


```solidity
File: src/proxy/AMBeacon.sol

5: pragma solidity 0.8.20;

```
*Github:* [[5](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L5)]


```solidity
File: src/proxy/AMProxyAdmin.sol

5: pragma solidity 0.8.20;

```
*Github:* [[5](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L5)]


```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

4: pragma solidity 0.8.20;

```
*Github:* [[4](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L4)]


```solidity
File: src/tokens/PrincipalToken.sol

3: pragma solidity 0.8.20;

```
*Github:* [[3](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L3)]


```solidity
File: src/tokens/YieldToken.sol

3: pragma solidity 0.8.20;

```
*Github:* [[3](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L3)]



<a name="NC-64"></a> 
### [NC-64] Use the Modern Upgradeable Contract Paradigm
Modern smart contract development often employs upgradeable contract structures, utilizing proxy patterns like OpenZeppelin’s Upgradeable Contracts. This paradigm separates logic and state, allowing developers to amend and enhance the contract's functionality without altering its state or the deployed contract address. Transitioning to this approach enhances long-term maintainability.

Resolution: Adopt a well-established proxy pattern for upgradeability, ensuring proper initialization and employing transparent proxies to mitigate potential risks. Embrace comprehensive testing and audit practices, particularly when updating contract logic, to ensure state consistency and security are preserved across upgrades. This ensures your contract remains robust and adaptable to future requirements.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/proxy/AMBeacon.sol

20: contract AMBeacon is IBeacon, AccessManaged {

```
*Github:* [[20](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L20)]


```solidity
File: src/proxy/AMProxyAdmin.sol

14: contract AMProxyAdmin is AccessManaged {

```
*Github:* [[14](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L14)]


```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

60: contract AMTransparentUpgradeableProxy is ERC1967Proxy {

```
*Github:* [[60](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L60)]



<a name="NC-65"></a> 
### [NC-65] Consider using modifiers for address control
Modifiers in Solidity can improve code readability and modularity by encapsulating repetitive checks, such as address validity checks, into a reusable construct. For example, an `onlyOwner` modifier can be used to replace repetitive `require(msg.sender == owner)` checks across several functions, reducing code redundancy and enhancing maintainability. To implement, define a modifier with the check, then apply the modifier to relevant functions.

*There are <b>7</b> instances of this issue:*
```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

102:         if (msg.sender == _proxyAdmin()) {

```
*Github:* [[102](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L102)]


```solidity
File: src/tokens/PrincipalToken.sol

330:         if (msg.sender != IRegistry(registry).getFeeCollector()) {

386:         if (msg.sender != yt) {

806:         if (_owner != msg.sender) {

829:         if (_owner != msg.sender) {

```
*Github:* [[330](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L330), [386](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L386), [806](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L806), [829](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L829)]


```solidity
File: src/tokens/YieldToken.sol

43:         if (msg.sender != pt) {

51:         if (msg.sender != pt) {

```
*Github:* [[43](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L43), [51](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L51)]



<a name="NC-66"></a> 
### [NC-66] Use of `override` is unnecessary
Starting with Solidity version [0.8.8](https://docs.soliditylang.org/en/v0.8.20/contracts.html#function-overriding), using the `override` keyword when the function solely overrides an interface function, and the function doesn't exist in multiple base contracts, is unnecessary.

<details>
<summary>
There are <b>56</b> instances (click to show):
</summary>

```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

101:     function _fallback() internal virtual override {

```
*Github:* [[101](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L101)]


```solidity
File: src/tokens/PrincipalToken.sol

161:     function pause() external override restricted {

166:     function unPause() external override restricted {

171:     function deposit(uint256 assets, address receiver) external override returns (uint256 shares) {

180:     ) public override returns (uint256 shares) {

193:     ) external override returns (uint256 shares) {

201:     function depositIBT(uint256 ibts, address receiver) external override returns (uint256 shares) {

210:     ) public override returns (uint256 shares) {

221:     ) external override returns (uint256 shares) {

233:     ) public override returns (uint256 assets) {

245:     ) external override returns (uint256 assets) {

257:     ) public override returns (uint256 ibts) {

270:     ) external override returns (uint256 ibts) {

282:     ) public override returns (uint256 shares) {

295:     ) external override returns (uint256 shares) {

307:     ) public override returns (uint256 shares) {

321:     ) external override returns (uint256 shares) {

329:     function claimFees() external override returns (uint256 assets) {

340:     function updateYield(address _user) public override returns (uint256 updatedUserYieldInIBT) {

369:     function claimYield(address _receiver) public override returns (uint256 yieldInAsset) {

377:     function claimYieldInIBT(address _receiver) public override returns (uint256 yieldInIBT) {

385:     function beforeYtTransfer(address _from, address _to) external override {

409:     function storeRatesAtExpiry() public override afterExpiry {

430:     function previewDeposit(uint256 assets) public view override returns (uint256) {

436:     function previewDepositIBT(uint256 ibts) external view override returns (uint256) {

441:     function maxDeposit(address) external pure override returns (uint256) {

448:     ) external view override whenNotPaused returns (uint256) {

454:     function previewWithdrawIBT(uint256 ibts) public view override whenNotPaused returns (uint256) {

460:     function maxWithdraw(address owner) public view override whenNotPaused returns (uint256) {

466:     function maxWithdrawIBT(address owner) public view override whenNotPaused returns (uint256) {

471:     function previewRedeem(uint256 shares) public view override returns (uint256) {

478:     ) public view override whenNotPaused returns (uint256) {

483:     function maxRedeem(address owner) public view override returns (uint256) {

488:     function convertToPrincipal(uint256 underlyingAmount) external view override returns (uint256) {

493:     function convertToUnderlying(uint256 principalAmount) public view override returns (uint256) {

498:     function totalAssets() public view override returns (uint256) {

508:     function underlying() external view override returns (address) {

513:     function maturity() external view override returns (uint256) {

518:     function getDuration() external view override returns (uint256) {

523:     function getIBT() external view override returns (address) {

528:     function getYT() external view override returns (address) {

533:     function getIBTRate() external view override returns (uint256) {

539:     function getPTRate() external view override returns (uint256) {

545:     function getIBTUnit() external view override returns (uint256) {

550:     function getUnclaimedFeesInIBT() external view override returns (uint256) {

555:     function getTotalFeesInIBT() external view override returns (uint256) {

562:     ) external view override returns (uint256 _yieldOfUserInIBT) {

583:     function maxFlashLoan(address _token) public view override returns (uint256) {

594:     function flashFee(address _token, uint256 _amount) public view override returns (uint256) {

602:     function getTokenizationFee() public view override returns (uint256) {

614:     ) external override returns (bool) {

```
*Github:* [[161](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L161), [166](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L166), [171](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L171), [180](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L180), [193](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L193), [201](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L201), [210](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L210), [221](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L221), [233](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L233), [245](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L245), [257](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L257), [270](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L270), [282](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L282), [295](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L295), [307](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L307), [321](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L321), [329](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L329), [340](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L340), [369](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L369), [377](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L377), [385](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L385), [409](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L409), [430](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L430), [436](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L436), [441](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L441), [448](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L448), [454](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L454), [460](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L460), [466](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L466), [471](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L471), [478](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L478), [483](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L483), [488](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L488), [493](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L493), [498](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L498), [508](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L508), [513](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L513), [518](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L518), [523](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L523), [528](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L528), [533](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L533), [539](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L539), [545](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L545), [550](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L550), [555](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L555), [562](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L562), [583](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L583), [594](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L594), [602](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L602), [614](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L614)]


```solidity
File: src/tokens/YieldToken.sol

42:     function burnWithoutUpdate(address from, uint256 amount) external override {

50:     function mint(address to, uint256 amount) external override {

58:     function burn(uint256 amount) public override {

116:     function getPT() public view virtual override returns (address) {

128:     function actualBalanceOf(address account) public view override returns (uint256) {

```
*Github:* [[42](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L42), [50](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L50), [58](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L58), [116](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L116), [128](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L128)]


</details>


<a name="NC-67"></a> 
### [NC-67] Use a struct to encapsulate multiple function parameters
If a function has too many parameters, replacing them with a struct can improve code readability and maintainability, increase reusability, and reduce the likelihood of errors when passing the parameters.

*There is one instance of this issue:*
```solidity
File: src/libraries/PrincipalTokenUtil.sol

/// @audit 7 parameters
55:     function _computeYield(
            address _user,
            uint256 _userYieldIBT,
            uint256 _oldIBTRate,
            uint256 _ibtRate,
            uint256 _oldPTRate,
            uint256 _ptRate,
            address _yt
        ) external view returns (uint256) {

```
*Github:* [[55](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L55)]



<a name="NC-68"></a> 
### [NC-68] Whitespace in Expressions
See the [Whitespace in Expressions](https://docs.soliditylang.org/en/latest/style-guide.html#whitespace-in-expressions) section of the Solidity Style Guide.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

399:         (bool success, ) = rewardsProxy.delegatecall(_data);

540:         (uint256 _ptRate, ) = _getPTandIBTRates(false);

```
*Github:* [[399](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L399), [540](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L540)]



<a name="NC-69"></a> 
### [NC-69] Empty body - Consider commenting why

*There is one instance of this issue:*
```solidity
File: src/proxy/AMProxyAdmin.sol

28:     constructor(address initialAuthority) AccessManaged(initialAuthority) {}

```
*Github:* [[28](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L28)]



<a name="NC-70"></a> 
### [NC-70] Names of `private`/`internal` functions should be prefixed with an underscore
It is recommended by the [Solidity Style Guide](https://docs.soliditylang.org/en/v0.8.20/style-guide.html#underscore-prefix-for-non-external-functions-and-variables)

*There are <b>3</b> instances of this issue:*
```solidity
File: src/libraries/RayMath.sol

20:     function fromRay(uint256 _a, uint256 _decimals) internal pure returns (uint256 b) {

35:     function fromRay(
            uint256 _a,
            uint256 _decimals,
            bool _roundUp
        ) internal pure returns (uint256 b) {

57:     function toRay(uint256 _a, uint256 _decimals) internal pure returns (uint256 b) {

```
*Github:* [[20](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/RayMath.sol#L20), [35](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/RayMath.sol#L35), [57](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/RayMath.sol#L57)]



<a name="NC-71"></a> 
### [NC-71] Names of `private`/`internal` state variables should be prefixed with an underscore
It is recommended by the [Solidity Style Guide](https://docs.soliditylang.org/en/v0.8.20/style-guide.html#underscore-prefix-for-non-external-functions-and-variables)

<details>
<summary>
There are <b>21</b> instances (click to show):
</summary>

```solidity
File: src/libraries/PrincipalTokenUtil.sol

18:     uint256 private constant SAFETY_BOUND = 100; // used to favour the protocol in case of approximations

19:     uint256 private constant FEE_DIVISOR = 1e18; // equivalent to 100% fees

```
*Github:* [[18](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L18), [19](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L19)]


```solidity
File: src/tokens/PrincipalToken.sol

40:     uint256 private constant MIN_DECIMALS = 6;

41:     uint256 private constant MAX_DECIMALS = 18;

42:     bytes32 private constant ON_FLASH_LOAN = keccak256("ERC3156FlashBorrower.onFlashLoan");

44:     address private immutable registry;

46:     address private rewardsProxy;

47:     bool private ratesAtExpiryStored;

48:     address private ibt; // address of the Interest Bearing Token 4626 held by this PT vault

50:     address private yt; // YT corresponding to this PT, deployed at initialization

51:     uint256 private ibtUnit; // equal to one unit of the IBT held by this PT vault (10^decimals)

55:     uint256 private ptRate; // or PT price in asset (in Ray)

56:     uint256 private ibtRate; // or IBT price in asset (in Ray)

57:     uint256 private unclaimedFeesInIBT; // unclaimed fees

58:     uint256 private totalFeesInIBT; // total fees

59:     uint256 private expiry; // date of maturity (set at initialization)

60:     uint256 private duration; // duration to maturity

62:     mapping(address => uint256) private ibtRateOfUser; // stores each user's IBT rate (in Ray)

63:     mapping(address => uint256) private ptRateOfUser; // stores each user's PT rate (in Ray)

64:     mapping(address => uint256) private yieldOfUserInIBT; // stores each user's yield generated from YTs

```
*Github:* [[40](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L40), [41](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L41), [42](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L42), [44](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L44), [46](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L46), [47](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L47), [48](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L48), [50](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L50), [51](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L51), [55](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L55), [56](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L56), [57](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L57), [58](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L58), [59](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L59), [60](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L60), [62](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L62), [63](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L63), [64](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L64)]


```solidity
File: src/tokens/YieldToken.sol

18:     address private pt;

```
*Github:* [[18](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L18)]


</details>


<a name="NC-72"></a> 
### [NC-72]  `require()` / `revert()` statements should have descriptive reason strings

*There are <b>2</b> instances of this issue:*
```solidity
File: src/libraries/PrincipalTokenUtil.sol

29:             revert IPrincipalToken.RateError();

126:                 revert IPrincipalToken.RateError();

```
*Github:* [[29](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L29), [126](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L126)]



<a name="NC-73"></a> 
### [NC-73] Event is missing `indexed` fields
Index event fields make the field more quickly accessible to off-chain tools that parse events. However, note that each index field costs extra gas during emission, so it's not necessarily best to index the maximum allowed per event (three fields). Each event should use three indexed fields if there are three or more fields, and gas usage is not particularly of concern for the events in question. If there are fewer than three fields, all of the fields should be indexed.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

68:     event Redeem(address indexed from, address indexed to, uint256 amount);

69:     event Mint(address indexed from, address indexed to, uint256 amount);

```
*Github:* [[68](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L68), [69](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L69)]



<a name="NC-74"></a> 
### [NC-74] Functions not used internally could be marked `external`

<details>
<summary>
There are <b>12</b> instances (click to show):
</summary>

```solidity
File: src/tokens/PrincipalToken.sol

369:     function claimYield(address _receiver) public override returns (uint256 yieldInAsset) {

377:     function claimYieldInIBT(address _receiver) public override returns (uint256 yieldInIBT) {

430:     function previewDeposit(uint256 assets) public view override returns (uint256) {

466:     function maxWithdrawIBT(address owner) public view override whenNotPaused returns (uint256) {

471:     function previewRedeem(uint256 shares) public view override returns (uint256) {

483:     function maxRedeem(address owner) public view override returns (uint256) {

498:     function totalAssets() public view override returns (uint256) {

503:     function decimals() public view override(IERC20Metadata, ERC20Upgradeable) returns (uint8) {

602:     function getTokenizationFee() public view override returns (uint256) {

```
*Github:* [[369](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L369), [377](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L377), [430](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L430), [466](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L466), [471](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L471), [483](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L483), [498](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L498), [503](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L503), [602](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L602)]


```solidity
File: src/tokens/YieldToken.sol

58:     function burn(uint256 amount) public override {

121:     function balanceOf(

128:     function actualBalanceOf(address account) public view override returns (uint256) {

```
*Github:* [[58](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L58), [121](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L121), [128](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L128)]


</details>


<a name="NC-75"></a> 
### [NC-75] Use `using` keyword when using specific imports rather than calling the specific import directly
In Solidity, the `using` keyword can streamline the use of library functions for specific types. Instead of calling library functions directly with their full import paths, you can declare a library once with `using` for a specific type. This approach makes your code more readable and concise. For example, instead of `LibraryName.functionName(variable)`, you would first declare `using LibraryName for TypeName;` at the contract level. After this, you can call library functions directly on variables of `TypeName` like `variable.functionName()`. This method not only enhances code clarity but also promotes cleaner and more organized code, especially when multiple functions from the same library are used frequently.

*There are <b>9</b> instances of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

/// @audit `PrincipalTokenUtil`
142:         _assetDecimals = PrincipalTokenUtil._tryGetTokenDecimals(_asset);

/// @audit `RayMath`
153:         ptRate = RayMath.RAY_UNIT;

/// @audit `PrincipalTokenUtil`
354:             updatedUserYieldInIBT = PrincipalTokenUtil._computeYield(

/// @audit `PrincipalTokenUtil`
567:             _yieldOfUserInIBT = PrincipalTokenUtil._computeYield(

/// @audit `PrincipalTokenUtil`
576:             _yieldOfUserInIBT -= PrincipalTokenUtil._computeYieldFee(_yieldOfUserInIBT, registry);

/// @audit `PrincipalTokenUtil`
596:         return PrincipalTokenUtil._computeFlashloanFee(_amount, registry);

/// @audit `PrincipalTokenUtil`
644:         uint256 tokenizationFee = PrincipalTokenUtil._computeTokenizationFee(

/// @audit `PrincipalTokenUtil`
756:         uint256 tokenizationFee = PrincipalTokenUtil._computeTokenizationFee(

/// @audit `PrincipalTokenUtil`
854:             uint256 yieldFeeInIBT = PrincipalTokenUtil._computeYieldFee(yieldInIBT, registry);

```
*Github:* [[142](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L142), [153](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L153), [354](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L354), [567](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L567), [576](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L576), [596](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L596), [644](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L644), [756](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L756), [854](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L854)]




## Gas Optimizations

<a name="GAS-1"></a> 
### [GAS-1] Consider activating via-ir for deploying
By using `--via-ir` or `{"viaIR": true}`, the compiler is able to use more advanced [multi-function optimizations](https://docs.soliditylang.org/en/v0.8.17/ir-breaking-changes.html#solidity-ir-based-codegen-changes), for extra gas savings.

*There is one instance of this issue:*
```solidity

Global finding

```
*Github:* [[Global](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/)]



<a name="GAS-2"></a> 
### [GAS-2] Don't transfer with zero amount to save gas
In Solidity, unnecessary operations can waste gas. For example, a transfer function without a zero amount check uses gas even if called with a zero amount, since the contract state remains unchanged. Implementing a zero amount check avoids these unnecessary function calls, saving gas and improving efficiency.

*There is one instance of this issue:*
```solidity
File: src/tokens/YieldToken.sol

76:         return super.transfer(to, amount);

```
*Github:* [[76](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L76)]



<a name="GAS-3"></a> 
### [GAS-3] Operator `+=` costs more gas than `<x> = <x> + <y>` for state variables

*There are <b>2</b> instances of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

/// @audit `unclaimedFeesInIBT +=`
714:         unclaimedFeesInIBT += _feesInIBT;

/// @audit `totalFeesInIBT +=`
715:         totalFeesInIBT += _feesInIBT;

```
*Github:* [[714](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L714), [715](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L715)]



<a name="GAS-4"></a> 
### [GAS-4] Duplicated `require()`/`revert()` checks should be refactored to a modifier or function to save gas
Saves deployment costs.

<details>
<summary>
There are <b>12</b> instances (click to show):
</summary>

```solidity
File: src/libraries/PrincipalTokenUtil.sol

/// @audit duplicated on line 126
29:             revert IPrincipalToken.RateError();

```
*Github:* [[29](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L29)]


```solidity
File: src/tokens/PrincipalToken.sol

/// @audit duplicated on line 126
104:             revert AddressError();

/// @audit duplicated on line 665
129:             revert RateError();

/// @audit duplicated on line 224
196:             revert ERC5143SlippageProtectionFailed();

/// @audit duplicated on line 273
248:             revert ERC5143SlippageProtectionFailed();

/// @audit duplicated on line 324
298:             revert ERC5143SlippageProtectionFailed();

/// @audit duplicated on line 387
331:             revert UnauthorizedCaller();

/// @audit duplicated on line 704
686:             revert RateError();

/// @audit duplicated on line 788
764:             revert RateError();

/// @audit duplicated on line 830
807:             revert UnauthorizedCaller();

/// @audit duplicated on line 840
810:             revert UnsufficientBalance();

```
*Github:* [[104](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L104), [129](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L129), [196](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L196), [248](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L248), [298](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L298), [331](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L331), [686](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L686), [764](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L764), [807](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L807), [810](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L810)]


```solidity
File: src/tokens/YieldToken.sol

/// @audit duplicated on line 52
44:             revert CallerIsNotPtContract();

```
*Github:* [[44](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L44)]


</details>


<a name="GAS-5"></a> 
### [GAS-5] Initializers can be marked as payable to save deployment gas
Payable functions cost less gas to execute, because the compiler does not have to add extra checks to ensure that no payment is provided. Initializers can be safely marked as payable, because only the deployer or the factory contract would call the function without carrying any funds.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

120:     function initialize(

```
*Github:* [[120](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L120)]


```solidity
File: src/tokens/YieldToken.sol

31:     function initialize(

```
*Github:* [[31](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L31)]



<a name="GAS-6"></a> 
### [GAS-6] Inline `modifier`s that are only used once, to save gas

*There is one instance of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

93:     modifier afterExpiry() virtual {

```
*Github:* [[93](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L93)]



<a name="GAS-7"></a> 
### [GAS-7] `internal` functions only called once can be inlined to save gas
If an `internal` function is only used once, there is no need to modularize it, unless the function calling it would otherwise be too long and complex. Not inlining costs 20 to 40 gas because of two extra JUMP instructions and additional stack operations needed for function calls.

*There are <b>4</b> instances of this issue:*
```solidity
File: src/libraries/PrincipalTokenUtil.sol

/// @audit `_convertToSharesWithRate` is used only once
22:     function _convertToSharesWithRate(

```
*Github:* [[22](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L22)]


```solidity
File: src/tokens/PrincipalToken.sol

/// @audit `_convertIBTsToSharesPreview` is used only once
701:     function _convertIBTsToSharesPreview(uint256 ibts) internal view returns (uint256 shares) {

/// @audit `_deployYT` is used only once
724:     function _deployYT(string memory _name, string memory _symbol) internal returns (address _yt) {

/// @audit `_updatePTandIBTRates` is used only once
879:     function _updatePTandIBTRates() internal returns (uint256 _ptRate, uint256 _ibtRate) {

```
*Github:* [[701](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L701), [724](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L724), [879](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L879)]



<a name="GAS-8"></a> 
### [GAS-8] `keccak256()` hash of literals should only be computed once
The result of the hash should be stored in an immutable variable, and the variable should be used instead. If the hash is being used as a part of a function selector, the cast to `bytes4` should also only be done once.

*There is one instance of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

42:     bytes32 private constant ON_FLASH_LOAN = keccak256("ERC3156FlashBorrower.onFlashLoan");

```
*Github:* [[42](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L42)]



<a name="GAS-9"></a> 
### [GAS-9] Multiple accesses of the same mapping/array key/index should be cached
The instances below point to the second+ access of a value inside a mapping/array, within a function. Caching a mapping's value in a local `storage` or `calldata` variable when the value is accessed [multiple times](https://gist.github.com/IllIllI000/ec23a57daa30a8f8ca8b9681c8ccefb0), saves ~42 gas per access due to not having to recalculate the key's keccak256 hash (Gkeccak256 - 30 gas) and that calculation's associated stack operations. Caching an array's struct avoids recalculating the array offsets into memory/calldata

*There are <b>3</b> instances of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

/// @audit `ibtRateOfUser[_user]` is also accessed on line 343
345:             ibtRateOfUser[_user] = _ibtRate;

/// @audit `ptRateOfUser[_user]` is also accessed on line 347
349:             ptRateOfUser[_user] = _ptRate;

/// @audit `yieldOfUserInIBT[_user]` is also accessed on line 356
363:             yieldOfUserInIBT[_user] = updatedUserYieldInIBT;

```
*Github:* [[345](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L345), [349](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L349), [363](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L363)]



<a name="GAS-10"></a> 
### [GAS-10] Operator `>=`/`<=` costs less gas than operator `>`/`<`
The compiler uses opcodes `GT` and `ISZERO` for code that uses `>`, but only requires `LT` for `>=`. A similar behavior applies for `>`, which uses opcodes `LT` and `ISZERO`, but only requires `GT` for `<=`. It can save 3 gas for each. It should be converted to the `<=`/`>=` equivalent when comparing against integer literals.

<details>
<summary>
There are <b>19</b> instances (click to show):
</summary>

```solidity
File: src/libraries/PrincipalTokenUtil.sol

73:         if (_oldPTRate == _ptRate && _ibtRate > _oldIBTRate) {

77:             if (_oldPTRate > _ptRate) {

```
*Github:* [[73](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L73), [77](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L77)]


```solidity
File: src/tokens/PrincipalToken.sol

94:         if (block.timestamp < expiry) {

144:             _assetDecimals < MIN_DECIMALS ||

145:             _assetDecimals > _ibtDecimals ||

146:             _ibtDecimals > MAX_DECIMALS

195:         if (shares < minShares) {

223:         if (shares < minShares) {

247:         if (assets < minAssets) {

272:         if (ibts < minIbts) {

297:         if (shares > maxShares) {

323:         if (shares > maxShares) {

615:         if (_amount > maxFlashLoan(_token)) revert FlashLoanExceedsMaxAmount();

793:         if (block.timestamp < expiry) {

809:         if (_shares > _maxBurnable(_owner)) {

872:             maxBurnable = (ptBalance > ytBalance) ? ytBalance : ptBalance;

886:         if (block.timestamp < expiry) {

906:         uint256 currentPTRate = currentIBTRate < ibtRate

```
*Github:* [[94](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L94), [144](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L144), [145](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L145), [146](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L146), [195](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L195), [223](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L223), [247](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L247), [272](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L272), [297](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L297), [323](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L323), [615](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L615), [793](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L793), [809](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L809), [872](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L872), [886](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L886), [906](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L906)]


```solidity
File: src/tokens/YieldToken.sol

124:         return (block.timestamp < IPrincipalToken(pt).maturity()) ? super.balanceOf(account) : 0;

```
*Github:* [[124](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L124)]


</details>


<a name="GAS-11"></a> 
### [GAS-11] Optimize Gas by splitting `if() revert` statements
Using boolean operators in a single `if() revert` statement can consume more gas than necessary. Consider splitting these statements to save gas.

*There is one instance of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

125:         if (_ibt == address(0) || _initialAuthority == address(0)) {

```
*Github:* [[125](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L125)]



<a name="GAS-12"></a> 
### [GAS-12] Optimize names to save gas
`public`/`external` function names and `public` member variable names can be optimized to save gas. See this [link](https://gist.github.com/IllIllI000/a5d8b486a8259f9f77891a919febd1a9) for an example of how it works. Below are the interfaces/abstract contracts that can be optimized so that the most frequently-called functions use the least amount of gas possible during method lookup. Method IDs that have two leading zero bytes can save 128 gas each during deployment, and renaming functions to have lower method IDs will save 22 gas per call, [per sorted position shifted](https://medium.com/joyso/solidity-how-does-function-name-affect-gas-consumption-in-smart-contract-47d270d8ac92)

*There are <b>4</b> instances of this issue:*
```solidity
File: src/proxy/AMBeacon.sol

/// @audit `implementation`, `upgradeTo`
20: contract AMBeacon is IBeacon, AccessManaged {

```
*Github:* [[20](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L20)]


```solidity
File: src/proxy/AMProxyAdmin.sol

/// @audit `upgradeAndCall`
14: contract AMProxyAdmin is AccessManaged {

```
*Github:* [[14](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L14)]


```solidity
File: src/tokens/PrincipalToken.sol

/// @audit `initialize`, `pause`, `unPause`, `deposit`, `deposit`, `deposit`, `depositIBT`, `depositIBT`, `depositIBT`, `redeem`, `redeem`, `redeemForIBT`, `redeemForIBT`, `withdraw`, `withdraw`, `withdrawIBT`, `withdrawIBT`, `claimFees`, `updateYield`, `claimYield`, `claimYieldInIBT`, `beforeYtTransfer`, `claimRewards`, `storeRatesAtExpiry`, `setRewardsProxy`, `previewDeposit`, `previewDepositIBT`, `maxDeposit`, `previewWithdraw`, `previewWithdrawIBT`, `maxWithdraw`, `maxWithdrawIBT`, `previewRedeem`, `previewRedeemForIBT`, `maxRedeem`, `convertToPrincipal`, `convertToUnderlying`, `totalAssets`, `decimals`, `underlying`, `maturity`, `getDuration`, `getIBT`, `getYT`, `getIBTRate`, `getPTRate`, `getIBTUnit`, `getUnclaimedFeesInIBT`, `getTotalFeesInIBT`, `getCurrentYieldOfUserInIBT`, `maxFlashLoan`, `flashFee`, `getTokenizationFee`, `flashLoan`
29: contract PrincipalToken is

```
*Github:* [[29](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L29)]


```solidity
File: src/tokens/YieldToken.sol

/// @audit `initialize`, `burnWithoutUpdate`, `mint`, `burn`, `transfer`, `transferFrom`, `decimals`, `getPT`, `balanceOf`, `actualBalanceOf`
15: contract YieldToken is IYieldToken, ERC20PermitUpgradeable {

```
*Github:* [[15](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L15)]



<a name="GAS-13"></a> 
### [GAS-13] Redundant state variable getters
Getters for public state variables are automatically generated so there is no need to code them manually and waste gas.

*There are <b>10</b> instances of this issue:*
```solidity
File: src/proxy/AMBeacon.sol

46:     function implementation() public view virtual returns (address) {
            return _implementation;

```
*Github:* [[46](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L46)]


```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

94:     function _proxyAdmin() internal virtual returns (address) {
            return _admin;

```
*Github:* [[94](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L94)]


```solidity
File: src/tokens/PrincipalToken.sol

508:     function underlying() external view override returns (address) {
             return _asset;

513:     function maturity() external view override returns (uint256) {
             return expiry;

518:     function getDuration() external view override returns (uint256) {
             return duration;

523:     function getIBT() external view override returns (address) {
             return ibt;

545:     function getIBTUnit() external view override returns (uint256) {
             return ibtUnit;

550:     function getUnclaimedFeesInIBT() external view override returns (uint256) {
             return unclaimedFeesInIBT;

555:     function getTotalFeesInIBT() external view override returns (uint256) {
             return totalFeesInIBT;

```
*Github:* [[508](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L508), [513](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L513), [518](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L518), [523](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L523), [545](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L545), [550](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L550), [555](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L555)]


```solidity
File: src/tokens/YieldToken.sol

116:     function getPT() public view virtual override returns (address) {
             return pt;

```
*Github:* [[116](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L116)]



<a name="GAS-14"></a> 
### [GAS-14] Remove or replace unused state variables
Saves a storage slot. If the variable is assigned a non-zero value, saves Gsset (20000 gas). If it's assigned a zero value, saves Gsreset (2900 gas). If the variable remains unassigned, there is no gas savings unless the variable is `public`, in which case the compiler-generated non-payable getter deployment cost is saved. If the state variable is overriding an interface's public function, mark the variable as `constant` or `immutable` so that it does not use a storage slot.

*There is one instance of this issue:*
```solidity
File: src/proxy/AMProxyAdmin.sol

23:     string public constant UPGRADE_INTERFACE_VERSION = "5.0.0";

```
*Github:* [[23](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L23)]



<a name="GAS-15"></a> 
### [GAS-15] `require()`/`revert()` strings longer than 32 bytes cost extra gas
Each extra memory word of bytes past the original 32 [incurs an MSTORE](https://gist.github.com/hrkrshnn/ee8fabd532058307229d65dcd5836ddc#consider-having-short-revert-strings) which costs 3 gas

*There is one instance of this issue:*
```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

82:         require(
                initialAuthority != address(0),
                "AMTransparentUpgradeableProxy: initialAuthority is zero address"

```
*Github:* [[82](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L82)]



<a name="GAS-16"></a> 
### [GAS-16] The result of a function call should be cached rather than re-calling the function
The function calls in solidity are expensive. If the same result of the same function calls are to be used several times, the result should be cached to reduce the gas consumption of repeated calls.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/libraries/PrincipalTokenUtil.sol

/// @audit `decimals` is called 3 times
/// @audit `_convertToAssetsWithRate` is called 3 times
/// @audit `fromRay` is called 2 times
55:     function _computeYield(
            address _user,
            uint256 _userYieldIBT,
            uint256 _oldIBTRate,
            uint256 _ibtRate,
            uint256 _oldPTRate,
            uint256 _ptRate,
            address _yt
        ) external view returns (uint256) {

```
*Github:* [[55](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L55)]


```solidity
File: src/tokens/PrincipalToken.sol

/// @audit `updateYield` is called 2 times
385:     function beforeYtTransfer(address _from, address _to) external override {

/// @audit `balanceOf` is called 3 times
866:     function _maxBurnable(address _user) internal view returns (uint256 maxBurnable) {

```
*Github:* [[385](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L385), [866](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L866)]



<a name="GAS-17"></a> 
### [GAS-17] Unused named return variables without optimizer waste gas
Consider changing the variable to be an unnamed one, since the variable is never assigned, nor is it returned by name. If the optimizer is not turned on, leaving the code as it is will also waste gas for the stack variable.

*There are <b>4</b> instances of this issue:*
```solidity
File: src/libraries/PrincipalTokenUtil.sol

/// @audit `shares` not used
22:     function _convertToSharesWithRate(
            uint256 _assets,
            uint256 _rate,
            uint256 _ibtUnit,
            Math.Rounding _rounding
        ) internal pure returns (uint256 shares) {

/// @audit `assets` not used
35:     function _convertToAssetsWithRate(
            uint256 _shares,
            uint256 _rate,
            uint256 _ibtUnit,
            Math.Rounding _rounding
        ) internal pure returns (uint256 assets) {

```
*Github:* [[22](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L22), [35](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L35)]


```solidity
File: src/tokens/YieldToken.sol

/// @audit `success` not used
71:     function transfer(
            address to,
            uint256 amount
        ) public virtual override(IYieldToken, ERC20Upgradeable) returns (bool success) {

/// @audit `success` not used
95:     function transferFrom(
            address from,
            address to,
            uint256 amount
        ) public virtual override(IYieldToken, ERC20Upgradeable) returns (bool success) {

```
*Github:* [[71](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L71), [95](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L95)]



<a name="GAS-18"></a> 
### [GAS-18] Optimize external calls with assembly for memory efficiency
Using interfaces to make external contract calls in Solidity is convenient but can be inefficient in terms of memory utilization. Each such call involves creating a new memory location to store the data being passed, thus incurring memory expansion costs.

Inline assembly allows for optimized memory usage by re-using already allocated memory spaces or using the scratch space for smaller datasets. This can result in notable gas savings, especially for contracts that make frequent external calls.

Additionally, using inline assembly enables important safety checks like verifying if the target address has code deployed to it using `extcodesize(addr)` before making the call, mitigating risks associated with contract interactions.

<details>
<summary>
There are <b>22</b> instances (click to show):
</summary>

```solidity
File: src/libraries/PrincipalTokenUtil.sol

/// @audit `.decimals(...)`
69:             IYieldToken(_yt).decimals()

/// @audit `.decimals(...)`
113:                         IERC4626(IPrincipalToken(IYieldToken(_yt).getPT()).underlying()).decimals()

/// @audit `.underlying(...)`
113:                         IERC4626(IPrincipalToken(IYieldToken(_yt).getPT()).underlying()).decimals()

/// @audit `.getPT(...)`
113:                         IERC4626(IPrincipalToken(IYieldToken(_yt).getPT()).underlying()).decimals()

/// @audit `.getTokenizationFee(...)`
164:                 .mulDiv(IRegistry(_registry).getTokenizationFee(), FEE_DIVISOR, Math.Rounding.Ceil)

/// @audit `.getFeeReduction(...)`
166:                     FEE_DIVISOR - IRegistry(_registry).getFeeReduction(_pt, msg.sender),

/// @audit `.getPTFlashLoanFee(...)`
194:                 IRegistry(_registry).getPTFlashLoanFee(),

```
*Github:* [[69](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L69), [113](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L113), [113](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L113), [113](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L113), [164](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L164), [166](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L166), [194](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L194)]


```solidity
File: src/tokens/PrincipalToken.sol

/// @audit `.safeTransferFrom(...)`
181:         IERC20(_asset).safeTransferFrom(msg.sender, address(this), assets);

/// @audit `.safeIncreaseAllowance(...)`
182:         IERC20(_asset).safeIncreaseAllowance(ibt, assets);

/// @audit `.safeTransferFrom(...)`
211:         IERC20(ibt).safeTransferFrom(msg.sender, address(this), ibts);

/// @audit `.safeTransfer(...)`
260:         IERC20(ibt).safeTransfer(receiver, ibts);

/// @audit `.previewRedeem(...)`
308:         _beforeWithdraw(IERC4626(ibt).previewRedeem(ibts), owner);

/// @audit `.safeTransfer(...)`
312:         IERC20(ibt).safeTransfer(receiver, ibts);

/// @audit `.safeTransfer(...)`
380:             IERC20(ibt).safeTransfer(_receiver, yieldInIBT);

/// @audit `.safeTransfer(...)`
621:         IERC20(ibt).safeTransfer(address(_receiver), _amount);

/// @audit `.safeTransferFrom(...)`
628:         IERC20(ibt).safeTransferFrom(address(_receiver), address(this), _amount + fee);

/// @audit `.mint(...)`
768:         IYieldToken(yt).mint(_ytReceiver, shares);

/// @audit `.burnWithoutUpdate(...)`
794:             IYieldToken(yt).burnWithoutUpdate(_owner, shares);

/// @audit `.burnWithoutUpdate(...)`
818:             IYieldToken(yt).burnWithoutUpdate(_owner, _shares);

```
*Github:* [[181](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L181), [182](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L182), [211](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L211), [260](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L260), [308](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L308), [312](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L312), [380](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L380), [621](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L621), [628](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L628), [768](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L768), [794](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L794), [818](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L818)]


```solidity
File: src/tokens/YieldToken.sol

/// @audit `.updateYield(...)`
59:         IPrincipalToken(pt).updateYield(msg.sender);

/// @audit `.beforeYtTransfer(...)`
75:         IPrincipalToken(pt).beforeYtTransfer(msg.sender, to);

/// @audit `.beforeYtTransfer(...)`
100:         IPrincipalToken(pt).beforeYtTransfer(from, to);

```
*Github:* [[59](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L59), [75](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L75), [100](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L100)]


</details>


<a name="GAS-19"></a> 
### [GAS-19] Use assembly in place of `abi.decode` to extract `calldata` values more efficiently
Instead of using `abi.decode`, we can use assembly to decode our desired calldata values directly. This will allow us to avoid decoding calldata values that we will not use. For more details on how to implement this, check the following [report](https://code4rena.com/reports/2023-05-juicebox#g-04-use-assembly-in-place-of-abidecode-to-extract-calldata-values-more-efficiently).

*There is one instance of this issue:*
```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

121:         (address newImplementation, bytes memory data) = abi.decode(msg.data[4:], (address, bytes));

```
*Github:* [[121](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L121)]



<a name="GAS-20"></a> 
### [GAS-20] Use assembly to compute hashes to save gas
If the arguments to the encode call can fit into the scratch space (two words or fewer), then it's more efficient to use assembly to generate the hash (80 gas):

`keccak256(abi.encodePacked(x, y)) -> assembly {mstore(0x00, a); mstore(0x20, b); let hash := keccak256(0x00, 0x40); }`

*There is one instance of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

42:     bytes32 private constant ON_FLASH_LOAN = keccak256("ERC3156FlashBorrower.onFlashLoan");

```
*Github:* [[42](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L42)]



<a name="GAS-21"></a> 
### [GAS-21] Use assembly to emit events
To efficiently emit events, it's possible to utilize assembly by making use of scratch space and the free memory pointer. This approach has the advantage of potentially avoiding the costs associated with memory expansion.

However, it's important to note that in order to safely optimize this process, it is preferable to cache and restore the free memory pointer.

A good example of such practice can be seen in [Solady's](https://github.com/Vectorized/solady/blob/main/src/tokens/ERC1155.sol#L167) codebase.

<details>
<summary>
There are <b>11</b> instances (click to show):
</summary>

```solidity
File: src/proxy/AMBeacon.sol

80:         emit Upgraded(newImplementation);

```
*Github:* [[80](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L80)]


```solidity
File: src/tokens/PrincipalToken.sol

236:         emit Redeem(owner, receiver, shares);

261:         emit Redeem(owner, receiver, shares);

336:         emit FeeClaimed(msg.sender, ibts, assets);

364:             emit YieldUpdated(_user, updatedUserYieldInIBT);

416:         emit RatesStoredAtExpiry(ibtRate, ptRate);

422:         emit RewardsProxyChange(rewardsProxy, _rewardsProxy);

740:         emit YTDeployed(_yt);

767:         emit Mint(msg.sender, _ptReceiver, shares);

797:         emit Redeem(_owner, _receiver, shares);

857:             emit YieldClaimed(msg.sender, msg.sender, yieldInIBT);

```
*Github:* [[236](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L236), [261](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L261), [336](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L336), [364](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L364), [416](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L416), [422](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L422), [740](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L740), [767](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L767), [797](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L797), [857](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L857)]


</details>


<a name="GAS-22"></a> 
### [GAS-22] Use assembly to validate `msg.sender`

*There are <b>7</b> instances of this issue:*
```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

102:         if (msg.sender == _proxyAdmin()) {

```
*Github:* [[102](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L102)]


```solidity
File: src/tokens/PrincipalToken.sol

330:         if (msg.sender != IRegistry(registry).getFeeCollector()) {

386:         if (msg.sender != yt) {

806:         if (_owner != msg.sender) {

829:         if (_owner != msg.sender) {

```
*Github:* [[330](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L330), [386](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L386), [806](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L806), [829](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L829)]


```solidity
File: src/tokens/YieldToken.sol

43:         if (msg.sender != pt) {

51:         if (msg.sender != pt) {

```
*Github:* [[43](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L43), [51](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L51)]



<a name="GAS-23"></a> 
### [GAS-23] Use assembly to write address/contract type storage values
Using `assembly { sstore(state.slot, addr)` instead of `state = addr` can save gas.

*There are <b>8</b> instances of this issue:*
```solidity
File: src/proxy/AMBeacon.sol

79:         _implementation = newImplementation;

```
*Github:* [[79](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L79)]


```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

86:         _admin = address(new AMProxyAdmin(initialAuthority));

```
*Github:* [[86](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L86)]


```solidity
File: src/tokens/PrincipalToken.sol

106:         registry = _registry;

131:         _asset = IERC4626(_ibt).asset();

150:         ibt = _ibt;

154:         yt = _deployYT(

423:         rewardsProxy = _rewardsProxy;

```
*Github:* [[106](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L106), [131](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L131), [150](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L150), [154](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L154), [423](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L423)]


```solidity
File: src/tokens/YieldToken.sol

38:         pt = _pt;

```
*Github:* [[38](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L38)]



<a name="GAS-24"></a> 
### [GAS-24] Use byte32 in place of string
For strings of 32 char strings and below you can use bytes32 instead as it's more gas efficient

*There is one instance of this issue:*
```solidity
File: src/proxy/AMProxyAdmin.sol

23:     string public constant UPGRADE_INTERFACE_VERSION = "5.0.0";

```
*Github:* [[23](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L23)]



<a name="GAS-25"></a> 
### [GAS-25] Using a double `if` statement instead of a logical AND (`&&`)
Using a double `if` statement instead of a logical AND (`&&`) can provide similar short-circuiting behavior whereas double if is slightly [more gas efficient](https://gist.github.com/DadeKuma/931ce6794a050201ec6544dbcc31316c).

*There are <b>4</b> instances of this issue:*
```solidity
File: src/libraries/PrincipalTokenUtil.sol

64:         if (_oldPTRate == _ptRate && _ibtRate == _oldIBTRate) {

73:         if (_oldPTRate == _ptRate && _ibtRate > _oldIBTRate) {

141:         if (success && encodedDecimals.length >= 32) {

```
*Github:* [[64](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L64), [73](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L73), [141](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L141)]


```solidity
File: src/tokens/PrincipalToken.sol

903:         if (IERC4626(ibt).totalAssets() == 0 && IERC4626(ibt).totalSupply() != 0) {

```
*Github:* [[903](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L903)]



<a name="GAS-26"></a> 
### [GAS-26] Use local variables for emitting
Use the function/modifier's local copy of the state variable, rather than incurring an extra Gwarmaccess (100 gas). In the unlikely event that the state variable hasn't already been used by the function/modifier, consider whether it is really necessary to include it in the event, given the fact that it incurs a Gcoldsload (2100 gas), or whether it can be passed in to or back out of the functions that do use it

*There are <b>3</b> instances of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

/// @audit `ptRate`
416:         emit RatesStoredAtExpiry(ibtRate, ptRate);

/// @audit `ibtRate`
416:         emit RatesStoredAtExpiry(ibtRate, ptRate);

/// @audit `rewardsProxy`
422:         emit RewardsProxyChange(rewardsProxy, _rewardsProxy);

```
*Github:* [[416](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L416), [416](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L416), [422](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L422)]



<a name="GAS-27"></a> 
### [GAS-27] Use a more recent version of solidity
- Use a solidity version of at least 0.8.2 to get simple compiler automatic inlining.
- Use a solidity version of at least 0.8.3 to get better struct packing and cheaper multiple storage reads.
- Use a solidity version of at least 0.8.4 to get custom errors, which are cheaper at deployment than revert()/require() strings.
- Use a solidity version of at least 0.8.10 to have external calls skip contract existence checks if the external call has a return value.

*There are <b>7</b> instances of this issue:*
```solidity
File: src/libraries/PrincipalTokenUtil.sol

3: pragma solidity 0.8.20;

```
*Github:* [[3](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L3)]


```solidity
File: src/libraries/RayMath.sol

2: pragma solidity =0.8.20;

```
*Github:* [[2](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/RayMath.sol#L2)]


```solidity
File: src/proxy/AMBeacon.sol

5: pragma solidity 0.8.20;

```
*Github:* [[5](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L5)]


```solidity
File: src/proxy/AMProxyAdmin.sol

5: pragma solidity 0.8.20;

```
*Github:* [[5](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L5)]


```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

4: pragma solidity 0.8.20;

```
*Github:* [[4](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L4)]


```solidity
File: src/tokens/PrincipalToken.sol

3: pragma solidity 0.8.20;

```
*Github:* [[3](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L3)]


```solidity
File: src/tokens/YieldToken.sol

3: pragma solidity 0.8.20;

```
*Github:* [[3](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L3)]



<a name="GAS-28"></a> 
### [GAS-28] Use `uint256(1)`/`uint256(2)` instead of `true`/`false` to save gas for changes
Avoids a Gsset (20000 gas) when changing from false to true, after having been true in the past. Since most of the bools aren't changed twice in one transaction, I've counted the amount of gas as half of the full amount, for each variable.

*There is one instance of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

47:     bool private ratesAtExpiryStored;

```
*Github:* [[47](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L47)]



<a name="GAS-29"></a> 
### [GAS-29] Use `unchecked` block for safe subtractions
If it can be confirmed that the subtraction operation will not overflow, using an unchecked block can save gas. For example, `require(x <= y); z = y - x;` can be optimized to `require(x <= y); unchecked { z = y - x; }`

*There are <b>6</b> instances of this issue:*
```solidity
File: src/libraries/PrincipalTokenUtil.sol

/// @audit this subtraction is checked on line 64
75:             newYieldInIBTRay = ibtOfPTInRay.mulDiv(_ibtRate - _oldIBTRate, _ibtRate);

/// @audit this subtraction is checked on line 64
85:                             _oldPTRate - _ptRate,

/// @audit this subtraction is checked on line 64
91:                             _ibtRate - _oldIBTRate,

/// @audit this subtraction is checked on line 64
100:                         _oldPTRate - _ptRate,

/// @audit this subtraction is checked on line 64
105:                         ibtOfPTInRay * (_oldIBTRate - _ibtRate),

/// @audit this subtraction is checked on line 108
111:                         : actualNegativeYieldInAssetRay - expectedNegativeYieldInAssetRay;

```
*Github:* [[75](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L75), [85](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L85), [91](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L91), [100](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L100), [105](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L105), [111](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L111)]



<a name="GAS-30"></a> 
### [GAS-30] Using bools for storage incurs overhead
Use uint256(1) and uint256(2) for true/false to avoid a Gwarmaccess (100 gas), and to avoid Gsset (20000 gas) when changing from ‘false’ to ‘true’, after having been ‘true’ in the past. See [source](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27).

*There is one instance of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

47:     bool private ratesAtExpiryStored;

```
*Github:* [[47](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L47)]



<a name="GAS-31"></a> 
### [GAS-31] State variables should be cached in stack variables rather than re-reading them from storage
The instances below point to the second+ access of a state variable within a function. Caching of a state variable replaces each Gwarmaccess (100 gas) with a much cheaper stack read. Other less obvious fixes/optimizations include having local memory caches of state variable structs, or having local caches of state variable contracts/addresses.

*There are <b>5</b> instances of this issue:*
```solidity
File: src/tokens/PrincipalToken.sol

/// @audit more than 1 read for `ibt`, line 150 and 125
150:         ibt = _ibt;

/// @audit more than 1 read for `ibt`, line 150 and 125
150:         ibt = _ibt;

/// @audit more than 1 read for `unclaimedFeesInIBT`, line 334 and 333
334:         unclaimedFeesInIBT = 0;

/// @audit more than 1 read for `rewardsProxy`, line 399 and 395
399:         (bool success, ) = rewardsProxy.delegatecall(_data);

/// @audit more than 1 read for `yieldOfUserInIBT`, line 576 and 567
576:             _yieldOfUserInIBT -= PrincipalTokenUtil._computeYieldFee(_yieldOfUserInIBT, registry);

```
*Github:* [[150](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L150), [150](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L150), [334](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L334), [399](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L399), [576](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L576)]



<a name="GAS-32"></a> 
### [GAS-32] Use `calldata` instead of `memory` for function arguments that do not get mutated
Mark data types as `calldata` instead of `memory` where possible. This makes it so that the data is not automatically loaded into memory. If the data passed into the function does not need to be changed (like updating values in an array), it can be passed in as `calldata`. The one exception to this is if the argument must later be passed into another function that takes an argument that specifies `memory` storage.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/proxy/AMProxyAdmin.sol

/// @audit make `data` as a calldata
43:         bytes memory data

```
*Github:* [[43](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L43)]


```solidity
File: src/proxy/AMTransparentUpgradeableProxy.sol

/// @audit make `_data` as a calldata
80:         bytes memory _data

```
*Github:* [[80](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMTransparentUpgradeableProxy.sol#L80)]


```solidity
File: src/tokens/PrincipalToken.sol

/// @audit make `_data` as a calldata
394:     function claimRewards(bytes memory _data) external restricted {

```
*Github:* [[394](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L394)]



<a name="GAS-33"></a> 
### [GAS-33] Usage of `int`s/`uint`s smaller than 32 bytes incurs overhead
Using `int`s/`uint`s smaller than 32 bytes may cost more gas. This is because the EVM operates on 32 bytes at a time, so if an element is smaller than 32 bytes, the EVM must perform more operations to reduce the size of the element from 32 bytes to the desired size.

*There are <b>5</b> instances of this issue:*
```solidity
File: src/libraries/PrincipalTokenUtil.sol

137:     function _tryGetTokenDecimals(address _token) external view returns (uint8) {

143:             if (returnedDecimals <= type(uint8).max) {

144:                 return uint8(returnedDecimals);

```
*Github:* [[137](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L137), [143](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L143), [144](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L144)]


```solidity
File: src/tokens/PrincipalToken.sol

503:     function decimals() public view override(IERC20Metadata, ERC20Upgradeable) returns (uint8) {

```
*Github:* [[503](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L503)]


```solidity
File: src/tokens/YieldToken.sol

110:         returns (uint8)

```
*Github:* [[110](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L110)]



<a name="GAS-34"></a> 
### [GAS-34] Constructors can be marked as `payable` to save deployment gas
Payable functions cost less gas to execute, because the compiler does not have to add extra checks to ensure that no payment is provided. A constructor can be safely marked as payable, because only the deployer would be able to pass funds, and the project itself would not pass any funds.

*There are <b>4</b> instances of this issue:*
```solidity
File: src/proxy/AMBeacon.sol

39:     constructor(address implementation_, address initialAuthority) AccessManaged(initialAuthority) {

```
*Github:* [[39](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMBeacon.sol#L39)]


```solidity
File: src/proxy/AMProxyAdmin.sol

28:     constructor(address initialAuthority) AccessManaged(initialAuthority) {}

```
*Github:* [[28](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L28)]


```solidity
File: src/tokens/PrincipalToken.sol

102:     constructor(address _registry) {

```
*Github:* [[102](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/PrincipalToken.sol#L102)]


```solidity
File: src/tokens/YieldToken.sol

21:     constructor() {

```
*Github:* [[21](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/tokens/YieldToken.sol#L21)]



<a name="GAS-35"></a> 
### [GAS-35] Using `private` rather than `public` for constants, saves gas
If needed, the values can be read from the verified contract source code, or if there are multiple values there can be a single getter function that [returns a tuple](https://github.com/code-423n4/2022-08-frax/blob/90f55a9ce4e25bceed3a74290b854341d8de6afa/src/contracts/FraxlendPair.sol#L156-L178) of the values of all currently-public constants. Saves **3406-3606 gas** in deployment gas due to the compiler not having to create non-payable getter functions for deployment calldata, not having to store the bytes of the value outside of where it's used, and not adding another entry to the method ID table

*There are <b>2</b> instances of this issue:*
```solidity
File: src/libraries/RayMath.sol

12:     uint256 public constant RAY_UNIT = 1e27;

```
*Github:* [[12](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/RayMath.sol#L12)]


```solidity
File: src/proxy/AMProxyAdmin.sol

23:     string public constant UPGRADE_INTERFACE_VERSION = "5.0.0";

```
*Github:* [[23](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/proxy/AMProxyAdmin.sol#L23)]



<a name="GAS-36"></a> 
### [GAS-36] `internal` functions not called by the contract should be removed
If the functions are required by an interface, the contract should inherit from that interface and use the `override` keyword

*There are <b>6</b> instances of this issue:*
```solidity
File: src/libraries/PrincipalTokenUtil.sol

157:     function _computeTokenizationFee(

178:     function _computeYieldFee(uint256 _amount, address _registry) internal view returns (uint256) {

188:     function _computeFlashloanFee(

```
*Github:* [[157](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L157), [178](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L178), [188](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/PrincipalTokenUtil.sol#L188)]


```solidity
File: src/libraries/RayMath.sol

20:     function fromRay(uint256 _a, uint256 _decimals) internal pure returns (uint256 b) {

35:     function fromRay(

57:     function toRay(uint256 _a, uint256 _decimals) internal pure returns (uint256 b) {

```
*Github:* [[20](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/RayMath.sol#L20), [35](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/RayMath.sol#L35), [57](https://github.com/code-423n4/2024-02-spectra/blob/b35bbf78ad9d0e74e9c8450a0c5c6d35b68f7228/src/libraries/RayMath.sol#L57)]



