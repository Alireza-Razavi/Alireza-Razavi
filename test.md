# Report

Audit report for **2024-03-coinbase** generated by *ubl4nk_bot*.

## Medium Issues


*Total <b>3</b> instances over <b>2</b> issues:*

|ID|Issue|Instances|
|-|:-|:-:|
| [M-1](#M-1) | No way to retrieve ETH from the contract | 2 |
| [M-2](#M-2) | Malformed equate statement | 1 |

## Low Issues


*Total <b>57</b> instances over <b>22</b> issues:*

|ID|Issue|Instances|
|-|:-|:-:|
| [L-1](#L-1) | Missing zero address check in functions with address parameters | 10 |
| [L-2](#L-2) | `assert()` should be replaced with `require()` or `revert()` | 1 |
| [L-3](#L-3) | Constructor / initialization function lacks parameter validation | 1 |
| [L-4](#L-4) | Empty `receive()`/`fallback()` function | 1 |
| [L-5](#L-5) | Function may return unassigned variable | 1 |
| [L-6](#L-6) | Functions calling contracts/addresses with transfer hooks are missing reentrancy guards | 2 |
| [L-7](#L-7) | Missing checks for state variable assignments | 1 |
| [L-8](#L-8) | Missing zero address check in constructor | 1 |
| [L-9](#L-9) | Consider some checks for `address(0)` when setting address state variables | 1 |
| [L-10](#L-10) | Check storage gap for upgradable contracts | 1 |
| [L-11](#L-11) | Multiplication on the result of a division | 4 |
| [L-12](#L-12) | Owner can renounce ownership | 1 |
| [L-13](#L-13) | `receive()`/`fallback()` function does not authorize requests | 1 |
| [L-14](#L-14) | Solady's SafeTransferLib does not check for token contract's existence | 1 |
| [L-15](#L-15) | Solidity version 0.8.20 or above may not work on other chains due to PUSH0 | 7 |
| [L-16](#L-16) | Use Ownable2Step instead of Ownable | 1 |
| [L-17](#L-17) | Using zero as a parameter | 2 |
| [L-18](#L-18) | `abi.encodePacked()` should not be used with dynamic types when passing the result to a hash function such as `keccak256()` | 1 |
| [L-19](#L-19) | Centralization Risk for trusted owners | 16 |
| [L-20](#L-20) | Initializers could be front-run | 1 |
| [L-21](#L-21) | Low level calls in solidity versions preceding 0.8.14 can result in an optimiser bug | 1 |
| [L-22](#L-22) | For loops in public or external functions should be avoided due to high gas costs and possible DOS | 1 |

## Non Critical Issues


*Total <b>502</b> instances over <b>82</b> issues:*

|ID|Issue|Instances|
|-|:-|:-:|
| [NC-1](#NC-1) | Assembly blocks should have extensive comments | 10 |
| [NC-2](#NC-2) | `abi.encodePacked()` should be replaced with `bytes.concat()` | 2 |
| [NC-3](#NC-3) | Add inline comments for unnamed variables | 3 |
| [NC-4](#NC-4) | Avoid mutating function parameters | 1 |
| [NC-5](#NC-5) | Avoid the use of sensitive terms | 3 |
| [NC-6](#NC-6) | Multiple `address`/ID mappings can be combined into a single `mapping` of an `address`/ID to a `struct`, for readability | 1 |
| [NC-7](#NC-7) | Complex casting | 2 |
| [NC-8](#NC-8) | Consider adding a block/deny-list | 5 |
| [NC-9](#NC-9) | Consider adding emergency-stop functionality | 4 |
| [NC-10](#NC-10) | Consider adding formal verification proofs | 1 |
| [NC-11](#NC-11) | Consider bounding input array length | 2 |
| [NC-12](#NC-12) | Consider using descriptive `constant`s when passing zero as a function argument | 1 |
| [NC-13](#NC-13) | Consider using SafeTransferLib.safeTransferETH() or Address.sendValue() for clearer semantic meaning | 1 |
| [NC-14](#NC-14) | Constants should be put on the left side of comparisons | 12 |
| [NC-15](#NC-15) | Variable names for `constant`s should use CONSTANT_CASE | 9 |
| [NC-16](#NC-16) | `Constructor` should emit an event | 3 |
| [NC-17](#NC-17) | Contract should expose an `interface` | 38 |
| [NC-18](#NC-18) | Contracts should have full test coverage | 1 |
| [NC-19](#NC-19) | Events that mark critical parameter changes should contain both the old and the new value | 3 |
| [NC-20](#NC-20) | Custom errors has no error details | 7 |
| [NC-21](#NC-21) | Solidity version is different in some files | 2 |
| [NC-22](#NC-22) | Duplicated `require()`/`revert()` checks should be refactored | 1 |
| [NC-23](#NC-23) | Empty bytes check is missing | 11 |
| [NC-24](#NC-24) | Enable IR-based code generation | 1 |
| [NC-25](#NC-25) | Enum values should be used instead of constant array indexes | 3 |
| [NC-26](#NC-26) | Events are emitted without the sender information | 3 |
| [NC-27](#NC-27) | Execution at deadlines should be allowed | 1 |
| [NC-28](#NC-28) | External call recipient can consume all remaining gas | 1 |
| [NC-29](#NC-29) |  Function ordering does not follow the Solidity Style Guide | 2 |
| [NC-30](#NC-30) | Functions and modifiers should be named in mixedCase style | 2 |
| [NC-31](#NC-31) | Functions with array parameters should have length checks in place | 5 |
| [NC-32](#NC-32) | High cyclomatic complexity | 1 |
| [NC-33](#NC-33) | Variable names for `immutable`s should use CONSTANT_CASE | 1 |
| [NC-34](#NC-34) | Inconsistent spacing in comments | 36 |
| [NC-35](#NC-35) | Incorrect withdraw declaration | 3 |
| [NC-36](#NC-36) | It is best practice to use linear inheritance | 2 |
| [NC-37](#NC-37) | Lack of brace spacing | 4 |
| [NC-38](#NC-38) | Large or complicated code bases should implement invariant tests | 1 |
| [NC-39](#NC-39) | Large numeric literals should use underscores for readability | 1 |
| [NC-40](#NC-40) | Long functions should be refactored into multiple, smaller, functions | 2 |
| [NC-41](#NC-41) | Magic numbers should be replaced with constants | 16 |
| [NC-42](#NC-42) | Missing contract existence checks before low-level calls | 1 |
| [NC-43](#NC-43) | Missing events in initializers | 2 |
| [NC-44](#NC-44) | Missing NatSpec from contract/error/event/function/modifier declarations | 5 |
| [NC-45](#NC-45) | Missing NatSpec `@author` from contract declaration | 1 |
| [NC-46](#NC-46) | Missing NatSpec `@dev` from contract/event/function/modifier declarations | 39 |
| [NC-47](#NC-47) | Missing NatSpec `@notice` from contract/event/function/modifier declarations | 20 |
| [NC-48](#NC-48) | Missing NatSpec `@param` from event/function/modifier declarations | 15 |
| [NC-49](#NC-49) | Missing NatSpec `@return` from function declaration | 15 |
| [NC-50](#NC-50) | Missing NatSpec `@title` from contract declaration | 1 |
| [NC-51](#NC-51) | Non-assembly method available | 36 |
| [NC-52](#NC-52) | Put all system-wide constants in one file | 18 |
| [NC-53](#NC-53) | Redundant `return` statement in a function with named return variables | 5 |
| [NC-54](#NC-54) | The remaining ETH may be locked in the contract after call | 1 |
| [NC-55](#NC-55) | SPDX identifier should be the in the first line of a solidity file | 1 |
| [NC-56](#NC-56) | State variables should include comments | 3 |
| [NC-57](#NC-57) | Lines are too long | 1 |
| [NC-58](#NC-58) | Typos | 10 |
| [NC-59](#NC-59) | Unsafe solidity low-level call can cause gas grief attack | 1 |
| [NC-60](#NC-60) | Unused `error` definition | 1 |
| [NC-61](#NC-61) | Unused arguments should be removed or implemented | 2 |
| [NC-62](#NC-62) | Unused named return | 5 |
| [NC-63](#NC-63) | Unused contract variables | 2 |
| [NC-64](#NC-64) | Solidity compiler version is not fixed | 6 |
| [NC-65](#NC-65) | Expressions for constant values should use `immutable` rather than `constant` | 18 |
| [NC-66](#NC-66) | Upgrade `openzeppelin` to the latest version (`5.0.2`) | 1 |
| [NC-67](#NC-67) | Use the latest solidity version for deployment (`0.8.25`) | 7 |
| [NC-68](#NC-68) | Use the Modern Upgradeable Contract Paradigm | 4 |
| [NC-69](#NC-69) | Consider using modifiers for address control | 4 |
| [NC-70](#NC-70) | Returning a struct instead of a bunch of variables is better | 3 |
| [NC-71](#NC-71) | Common functions should be refactored to a common base contract | 2 |
| [NC-72](#NC-72) | Empty body - Consider commenting why | 4 |
| [NC-73](#NC-73) | Names of `private`/`internal` functions should be prefixed with an underscore | 11 |
| [NC-74](#NC-74) | Names of `private`/`internal` state variables should be prefixed with an underscore | 16 |
| [NC-75](#NC-75) | Internal function calls within for loops | 2 |
| [NC-76](#NC-76) | Variables should be named in mixedCase style | 12 |
| [NC-77](#NC-77) | Event is missing `indexed` fields | 3 |
| [NC-78](#NC-78) | Unspecific compiler version pragma | 1 |
| [NC-79](#NC-79) | Functions not used internally could be marked `external` | 1 |
| [NC-80](#NC-80) | Default address(0) can be returned | 5 |
| [NC-81](#NC-81) | Payable functions which do not interact with the native token should not be payable | 7 |
| [NC-82](#NC-82) | Use `using` keyword when using specific imports rather than calling the specific import directly | 2 |

## Gas Optimizations


*Total <b>169</b> instances over <b>55</b> issues:*

|ID|Issue|Instances|Gas|
|-|:-|:-:|:-:|
| [GAS-1](#GAS-1) | Optimize gas by using do-while loops | 2 | 510 |
| [GAS-2](#GAS-2) | Multiple `address`/ID mappings can be combined into a single `mapping` of an `address`/ID to a `struct`, where appropriate | 1 | - |
| [GAS-3](#GAS-3) | Consider activating via-ir for deploying | 1 | - |
| [GAS-4](#GAS-4) | Counting down in for statements is more gas efficient | 1 | - |
| [GAS-5](#GAS-5) | Divisions can be `unchecked` to save gas | 1 | 20 |
| [GAS-6](#GAS-6) | Do not calculate constants | 1 | - |
| [GAS-7](#GAS-7) | Duplicated `require()`/`revert()` checks should be refactored to a modifier or function to save gas | 1 | - |
| [GAS-8](#GAS-8) | Increments can be `unchecked` to save gas | 1 | 60 |
| [GAS-9](#GAS-9) | Initializers can be marked as payable to save deployment gas | 1 | 21 |
| [GAS-10](#GAS-10) | Inline `modifier`s that are only used once, to save gas | 1 | - |
| [GAS-11](#GAS-11) | `internal` functions only called once can be inlined to save gas | 10 | 300 |
| [GAS-12](#GAS-12) | `keccak256()` hash of literals should only be computed once | 2 | 84 |
| [GAS-13](#GAS-13) | Low level `call` can be optimized with assembly | 1 | 248 |
| [GAS-14](#GAS-14) | Multiple accesses of the same mapping/array key/index should be cached | 3 | 126 |
| [GAS-15](#GAS-15) | Operator `>=`/`<=` costs less gas than operator `>`/`<` | 8 | 24 |
| [GAS-16](#GAS-16) | Optimize names to save gas | 4 | 88 |
| [GAS-17](#GAS-17) | Reduce gas usage by moving to Solidity 0.8.19 or later | 4 | 4000 |
| [GAS-18](#GAS-18) | Remove or replace unused state variables | 2 | - |
| [GAS-19](#GAS-19) | The result of a function call should be cached rather than re-calling the function | 3 | 300 |
| [GAS-20](#GAS-20) | There are comparisons to boolean literals (true and false), these can be simplified to save gas | 1 | 18 |
| [GAS-21](#GAS-21) | Use smaller sizes for struct variables if possible | 3 | 7500 |
| [GAS-22](#GAS-22) | Unlimited gas consumption risk due to external call recipients | 1 | - |
| [GAS-23](#GAS-23) | Unused named return variables without optimizer waste gas | 5 | 45 |
| [GAS-24](#GAS-24) | Optimize external calls with assembly for memory efficiency | 4 | 880 |
| [GAS-25](#GAS-25) | Use assembly in place of `abi.decode` to extract `calldata` values more efficiently | 3 | - |
| [GAS-26](#GAS-26) | Use assembly to compute hashes to save gas | 13 | 1040 |
| [GAS-27](#GAS-27) | Use assembly to emit events | 3 | 114 |
| [GAS-28](#GAS-28) | Use assembly to validate `msg.sender` | 4 | - |
| [GAS-29](#GAS-29) | Use assembly to write address/contract type storage values | 1 | 50 |
| [GAS-30](#GAS-30) | Using a double `if` statement instead of a logical AND (`&&`) | 9 | 270 |
| [GAS-31](#GAS-31) | Consider using OZ EnumerateSet in place of nested mappings | 1 | 1000 |
| [GAS-32](#GAS-32) | Use a more recent version of solidity | 7 | - |
| [GAS-33](#GAS-33) | Use != 0 instead of > 0 | 1 | 3 |
| [GAS-34](#GAS-34) | Use `require` instead of `assert` | 1 | - |
| [GAS-35](#GAS-35) | Use `selfbalance()` instead of `address(this).balance` | 2 | - |
| [GAS-36](#GAS-36) | Consider Using Solady's Gas Optimized Lib for Math | 1 | - |
| [GAS-37](#GAS-37) | Use `uint256(1)`/`uint256(2)` instead of `true`/`false` to save gas for changes | 2 | 17100 |
| [GAS-38](#GAS-38) | Use `unchecked` block for safe subtractions | 2 | 170 |
| [GAS-39](#GAS-39) | Using bitmap to store bool states can save gas | 2 | - |
| [GAS-40](#GAS-40) | Using `this` to access functions results in an external call, wasting gas | 2 | 200 |
| [GAS-41](#GAS-41) | `abi.encodePacked` is more gas efficient than `abi.encode` | 13 | - |
| [GAS-42](#GAS-42) | Using bools for storage incurs overhead | 2 | 200 |
| [GAS-43](#GAS-43) | Cache array length outside of loop | 2 | - |
| [GAS-44](#GAS-44) | Use `calldata` instead of `memory` for function arguments that do not get mutated | 4 | - |
| [GAS-45](#GAS-45) | Usage of `int`s/`uint`s smaller than 32 bytes incurs overhead | 4 | 220 |
| [GAS-46](#GAS-46) | Constructors can be marked as `payable` to save deployment gas | 2 | 42 |
| [GAS-47](#GAS-47) | Functions guaranteed to revert when called by normal users can be marked `payable` | 13 | 273 |
| [GAS-48](#GAS-48) | `++i` costs less gas than `i++`, especially when it's used in `for`-loops (`--i`/`i--` too) | 1 | 5 |
| [GAS-49](#GAS-49) | Using `private` rather than `public` for constants, saves gas | 1 | - |
| [GAS-50](#GAS-50) | Use assembly to check for `address(0)` | 2 | 12 |
| [GAS-51](#GAS-51) | `internal` functions not called by the contract should be removed | 2 | - |
| [GAS-52](#GAS-52) | Avoid updating storage when the value hasn't changed | 3 | - |
| [GAS-53](#GAS-53) | Cache address(this) when used more than once | 1 | - |
| [GAS-54](#GAS-54) | Where a value is casted more than once, consider caching the result to save gas | 1 | - |
| [GAS-55](#GAS-55) | Consider not using libraries when implementing simple functionality. | 2 | - |

## Medium Issues

<a name="M-1"></a> 
### [M-1] No way to retrieve ETH from the contract
The following contracts contain at least one `payable` function, yet the function does not utilise forwarded ETH, and the contract is missing functionality to withdraw ETH from the contract. This means that funds may become trapped in the contract indefinitely. Consider adding a withdraw/sweep function to contracts that are capable of receiving ether.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

/// @audit Contract can receive Ether but there is lack of functionality to claim the Ethers from the contract
18: contract MagicSpend is Ownable, IPaymaster {

```
*Github:* [[18](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L18)]


```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

/// @audit Contract can receive Ether but there is lack of functionality to claim the Ethers from the contract
13: contract CoinbaseSmartWalletFactory {

```
*Github:* [[13](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L13)]



<a name="M-2"></a> 
### [M-2] Malformed equate statement
Using the provided modifier `onlyOwner` for function access control without a proper enforcement mechanism like `require` or `revert` is a dire mistake because it fails to restrict access as intended. The modifier merely evaluates a condition (`msg.sender == owner`) without any action taken based on the result. This means any user, regardless of whether they are the owner, can execute functions that are supposed to be restricted to the owner, potentially leading to unauthorized actions, such as withdrawing funds or altering critical contract settings.

**Solution:**
To fix this, the modifier should enforce the ownership check using a `require` statement:

```solidity
modifier onlyOwner() {
	require(msg.sender == owner, "Caller is not the owner");
	_;
}
```

With this correction, the modifier effectively ensures that only the account designated as `owner` can access the function. If a non-owner attempts to call the function, the transaction is reverted, maintaining the intended access control and contract integrity.

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/MultiOwnable.sol

77:     modifier onlyOwner() virtual {
            _checkOwner();

```
*Github:* [[77](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L77)]




## Low Issues

<a name="L-1"></a> 
### [L-1] Missing zero address check in functions with address parameters
Adding a zero address check for each address type parameter can prevent errors.

*There are <b>10</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

/// @audit missing zero check for `asset`
/// @audit missing zero check for `to`
203:     function ownerWithdraw(address asset, address to, uint256 amount) external onlyOwner {

/// @audit missing zero check for `to`
222:     function entryPointWithdraw(address payable to, uint256 amount) external onlyOwner {

/// @audit missing zero check for `account`
260:     function isValidWithdrawSignature(address account, WithdrawRequest memory withdrawRequest)
             public
             view
             returns (bool)
         {

/// @audit missing zero check for `account`
279:     function getHash(address account, WithdrawRequest memory withdrawRequest) public view returns (bytes32) {

/// @audit missing zero check for `account`
299:     function nonceUsed(address account, uint256 nonce) external view returns (bool) {

/// @audit missing zero check for `account`
315:     function _validateRequest(address account, WithdrawRequest memory withdrawRequest) internal {

/// @audit missing zero check for `to`
334:     function _withdraw(address asset, address to, uint256 amount) internal {

```
*Github:* [[203](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L203), [222](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L222), [260](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L260), [279](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L279), [299](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L299), [315](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L315), [334](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L334)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

/// @audit missing zero check for `target`
196:     function execute(address target, uint256 value, bytes calldata data) public payable virtual onlyEntryPointOrOwner {

/// @audit missing zero check for `target`
272:     function _call(address target, uint256 value, bytes memory data) internal {

/// @audit missing zero check for ``
330:     function _authorizeUpgrade(address) internal view virtual override(UUPSUpgradeable) onlyOwner {}

```
*Github:* [[196](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L196), [272](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L272), [330](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L330)]



<a name="L-2"></a> 
### [L-2] `assert()` should be replaced with `require()` or `revert()`
In versions of Solidity prior to 0.8.0, when encountering an assert all the remaining gas will be consumed. Even after solidity 0.8.0, the assert function is still not recommended, as described in the [documentation](https://docs.soliditylang.org/en/v0.8.20/control-structures.html#panic-via-assert-and-error-via-require):
> Assert should only be used to test for internal errors, and to check invariants. Properly functioning code should never create a Panic, not even on invalid external input. If this happens, then there is a bug in your contract which you should fix.

*There is one instance of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

150:         assert(mode != PostOpMode.postOpReverted);

```
*Github:* [[150](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L150)]



<a name="L-3"></a> 
### [L-3] Constructor / initialization function lacks parameter validation
Constructors and initialization functions play a critical role in contracts by setting important initial states when the contract is first deployed before the system starts. The parameters passed to the constructor and initialization functions directly affect the behavior of the contract / protocol. If incorrect parameters are provided, the system may fail to run, behave abnormally, be unstable, or lack security. Therefore, it's crucial to carefully check each parameter in the constructor and initialization functions. If an exception is found, the transaction should be rolled back.

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

/// @audit `erc4337` not validated
24:     constructor(address erc4337) payable {

```
*Github:* [[24](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L24)]



<a name="L-4"></a> 
### [L-4] Empty `receive()`/`fallback()` function
If the intention is for Ether sent by a caller to be used for an actual purpose (i.e. the function is not just a WETH `withdraw()` handler), the function should call another function (e.g. call `weth.deposit()` and use the token on the caller's behalf) or at least emit an event to track that funds were sent directly to it.

*There is one instance of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

106:     receive() external payable {}

```
*Github:* [[106](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L106)]



<a name="L-5"></a> 
### [L-5] Function may return unassigned variable
Make sure that functions with a return value always return a valid and assigned value. Even if the default value is as expected, it should be assigned with the default value for code clarity and to reduce confusion.

*There is one instance of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

/// @audit `X` is unassigned
117:     function ecZZ_mulmuladd_S_asm(
             uint256 Q0,
             uint256 Q1, //affine rep for input point Q
             uint256 scalar_u,
             uint256 scalar_v
         ) internal view returns (uint256 X) {

```
*Github:* [[117](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L117)]



<a name="L-6"></a> 
### [L-6] Functions calling contracts/addresses with transfer hooks are missing reentrancy guards
While adherence to the check-effects-interaction pattern is commendable, the absence of a reentrancy guard in functions, especially where transfer hooks might be present, can expose the protocol users to risks of read-only reentrancies. Such reentrancy vulnerabilities can be exploited to execute malicious actions even without altering the contract state. Without a reentrancy guard, the only potential mitigation would be to blocklist the entire protocol - an extreme and disruptive measure. Therefore, incorporating a reentrancy guard into these functions is vital to bolster security, as it helps protect against both traditional reentrancy attacks and read-only reentrancies, ensuring robust and safe protocol operations.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

169:     function withdrawGasExcess() external {
             uint256 amount = _withdrawableETH[msg.sender];
             // we could allow 0 value transfers, but prefer to be explicit
             if (amount == 0) revert NoExcess();
     
             delete _withdrawableETH[msg.sender];
             _withdraw(address(0), msg.sender, amount);

181:     function withdraw(WithdrawRequest memory withdrawRequest) external {
             _validateRequest(msg.sender, withdrawRequest);
     
             if (!isValidWithdrawSignature(msg.sender, withdrawRequest)) {
                 revert InvalidSignature();
             }
     
             if (block.timestamp > withdrawRequest.expiry) {
                 revert Expired();
             }
     
             // reserve funds for gas, will credit user with difference in post op
             _withdraw(withdrawRequest.asset, msg.sender, withdrawRequest.amount);

```
*Github:* [[169](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L169), [181](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L181)]



<a name="L-7"></a> 
### [L-7] Missing checks for state variable assignments
There are some missing checks in these functions, and this could lead to unexpected scenarios. Consider always adding a sanity check for state variables.

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

/// @audit `erc4337`
25:         implementation = erc4337;

```
*Github:* [[25](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L25)]



<a name="L-8"></a> 
### [L-8] Missing zero address check in constructor
Constructors often take address parameters to initialize important components of a contract, such as owner or linked contracts. However, without a checking, there's a risk that an address parameter could be mistakenly set to the zero address (0x0). This could be due to an error or oversight during contract deployment. A zero address in a crucial role can cause serious issues, as it cannot perform actions like a normal address, and any funds sent to it will be irretrievable. It's therefore crucial to include a zero address check in constructors to prevent such potential problems. If a zero address is detected, the constructor should revert the transaction.

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

/// @audit missing zero check for `erc4337`
24:     constructor(address erc4337) payable {

```
*Github:* [[24](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L24)]



<a name="L-9"></a> 
### [L-9] Consider some checks for `address(0)` when setting address state variables
Check for zero-address to avoid the risk of setting `address(0)` for state variables after an update.

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

/// @audit `erc4337`
25:         implementation = erc4337;

```
*Github:* [[25](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L25)]



<a name="L-10"></a> 
### [L-10] Check storage gap for upgradable contracts
Each upgradable contract should include a state variable (usually named `__gap`) to provide reserved space in storage. This allows the team to freely add new state variables in the future upgrades without compromising the storage compatibility with existing deployments.

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

20: contract CoinbaseSmartWallet is MultiOwnable, UUPSUpgradeable, Receiver, ERC1271 {

```
*Github:* [[20](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L20)]



<a name="L-11"></a> 
### [L-11] Multiplication on the result of a division
Dividing an integer by another integer will often result in loss of precision. When the result is multiplied by another number, the loss of precision is magnified, often to material magnitudes. `(X / Z) * Y` should be re-written as `(X * Y) / Z`

*There are <b>4</b> instances of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

170:                     let T4 := mulmod(3, mulmod(addmod(X, sub(p, zz), p), addmod(X, zz, p), p), p) //M=3*(X1-ZZ1)*(X1+ZZ1)

231:                                 Y := addmod(T2, mulmod(T1, Y, p), p) //Y3= M(S-X3)-W*Y1

330:                 zz := mulmod(3, mulmod(addmod(x, sub(p, zz), p), addmod(x, zz, p), p), p) //M=3*(X1-ZZ1)*(X1+ZZ1)

334:                 P1 := addmod(x, sub(p, mulmod(P1, y, p)), p) //Y3= M(S-X3)-W*Y1

```
*Github:* [[170](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L170), [231](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L231), [330](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L330), [334](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L334)]



<a name="L-12"></a> 
### [L-12] Owner can renounce ownership
Each of the following contracts implements or inherits the `renounceOwnership()` function. This can represent a certain risk if the ownership is renounced for any other reason than by design. Renouncing ownership will leave the contract without an owner, thereby removing any functionality that is only available to the owner.

*There is one instance of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

18: contract MagicSpend is Ownable, IPaymaster {

```
*Github:* [[18](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L18)]



<a name="L-13"></a> 
### [L-13] `receive()`/`fallback()` function does not authorize requests
Having no access control on the function (e.g. `require(msg.sender == address(weth))`) means that someone may send Ether to the contract, and have no way to get anything back out, which is a loss of funds. If the concern is having to spend a small amount of gas to check the sender against an immutable address, the code should at least have a function to rescue mistakenly-sent Ether.

*There is one instance of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

106:     receive() external payable {}

```
*Github:* [[106](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L106)]



<a name="L-14"></a> 
### [L-14] Solady's SafeTransferLib does not check for token contract's existence
There is a subtle difference between the implementation of solady’s SafeTransferLib and OZ’s SafeERC20: OZ’s SafeERC20 checks if the token is a contract or not, solady’s SafeTransferLib does not.
https://github.com/Vectorized/solady/blob/main/src/utils/SafeTransferLib.sol#L10 
`@dev Note that none of the functions in this library check that a token has code at all! That responsibility is delegated to the caller` 


*There is one instance of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

338:             SafeTransferLib.safeTransfer(asset, to, amount);

```
*Github:* [[338](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L338)]



<a name="L-15"></a> 
### [L-15] Solidity version 0.8.20 or above may not work on other chains due to PUSH0
Solidity version 0.8.20 or above uses the new [Shanghai EVM](https://blog.soliditylang.org/2023/05/10/solidity-0.8.20-release-announcement/#important-note) which introduces the PUSH0 opcode. This op code may not yet be implemented on all evm-chains or Layer2s, so deployment on these chains will fail. Consider using an earlier solidity version.

*There are <b>7</b> instances of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

24: pragma solidity >=0.8.19 <0.9.0;

```
*Github:* [[24](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L24)]


```solidity
File: src/MagicSpend/MagicSpend.sol

2: pragma solidity 0.8.23;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L2)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

2: pragma solidity ^0.8.23;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L2)]


```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

2: pragma solidity ^0.8.4;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L2)]


```solidity
File: src/SmartWallet/ERC1271.sol

2: pragma solidity ^0.8.4;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L2)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

2: pragma solidity ^0.8.4;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L2)]


```solidity
File: src/WebAuthnSol/WebAuthn.sol

2: pragma solidity ^0.8.0;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L2)]



<a name="L-16"></a> 
### [L-16] Use Ownable2Step instead of Ownable
`Ownable2Step` and `Ownable2StepUpgradeable` prevent the contract ownership from mistakenly being transferred to an address that cannot handle it (e.g. due to a typo in the address), by requiring that the recipient of the owner permissions actively accept via a contract call of its own.

*There is one instance of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

18: contract MagicSpend is Ownable, IPaymaster {

```
*Github:* [[18](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L18)]



<a name="L-17"></a> 
### [L-17] Using zero as a parameter
Taking `0` as a valid argument in Solidity without checks can lead to severe security issues. A historical example is the infamous `0x0` address bug where numerous tokens were lost. This happens because 0 can be interpreted as an uninitialized `address`, leading to transfers to the 0x0 address, effectively burning tokens. Moreover, `0` as a denominator in division operations would cause a runtime exception. It's also often indicative of a logical error in the caller's code. It's important to always validate input and handle edge cases like `0` appropriately. Use `require()` statements to enforce conditions and provide clear error messages to facilitate debugging and safer code.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

175:         _withdraw(address(0), msg.sender, amount);

```
*Github:* [[175](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L175)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

186:         _call(address(this), 0, data);

```
*Github:* [[186](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L186)]



<a name="L-18"></a> 
### [L-18] `abi.encodePacked()` should not be used with dynamic types when passing the result to a hash function such as `keccak256()`
Use `abi.encode()` instead which will pad items to 32 bytes, which will [prevent hash collisions](https://docs.soliditylang.org/en/v0.8.13/abi-spec.html#non-standard-packed-mode) (e.g. `abi.encodePacked(0x123,0x456)` => `0x123456` => `abi.encodePacked(0x1,0x23456)`, but `abi.encode(0x123,0x456)` => `0x0...1230...456`). "Unless there is a compelling reason, `abi.encode` should be preferred". If there is only one argument to `abi.encodePacked()` it can often be cast to `bytes()` or `bytes32()` [instead](https://ethereum.stackexchange.com/questions/30912/how-to-compare-strings-in-solidity#answer-82739).
If all arguments are strings and or bytes, `bytes.concat()` should be used instead

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/ERC1271.sol

122:         return keccak256(abi.encodePacked("\x19\x01", domainSeparator(), _hashStruct(hash)));

```
*Github:* [[122](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L122)]



<a name="L-19"></a> 
### [L-19] Centralization Risk for trusted owners
Contracts have owners with privileged rights to perform admin tasks and need to be trusted to not perform malicious updates or drain funds.

<details>
<summary>
There are <b>16</b> instances (click to show):
</summary>

```solidity
File: src/MagicSpend/MagicSpend.sol

109:     function validatePaymasterUserOp(UserOperation calldata userOp, bytes32, uint256 maxCost)
             external
             onlyEntryPoint

143:     function postOp(IPaymaster.PostOpMode mode, bytes calldata context, uint256 actualGasCost)
             external
             onlyEntryPoint

203:     function ownerWithdraw(address asset, address to, uint256 amount) external onlyOwner {

212:     function entryPointDeposit(uint256 amount) external payable onlyOwner {

222:     function entryPointWithdraw(address payable to, uint256 amount) external onlyOwner {

232:     function entryPointAddStake(uint256 amount, uint32 unstakeDelaySeconds) external payable onlyOwner {

239:     function entryPointUnlockStake() external onlyOwner {

248:     function entryPointWithdrawStake(address payable to) external onlyOwner {

```
*Github:* [[109](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L109), [143](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L143), [203](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L203), [212](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L212), [222](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L222), [232](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L232), [239](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L239), [248](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L248)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

137:     function validateUserOp(UserOperation calldata userOp, bytes32 userOpHash, uint256 missingAccountFunds)
             public
             payable
             virtual
             onlyEntryPoint

180:     function executeWithoutChainIdValidation(bytes calldata data) public payable virtual onlyEntryPoint {

196:     function execute(address target, uint256 value, bytes calldata data) public payable virtual onlyEntryPointOrOwner {

205:     function executeBatch(Call[] calldata calls) public payable virtual onlyEntryPointOrOwner {

330:     function _authorizeUpgrade(address) internal view virtual override(UUPSUpgradeable) onlyOwner {}

```
*Github:* [[137](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L137), [180](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L180), [196](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L196), [205](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L205), [330](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L330)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

85:     function addOwnerAddress(address owner) public virtual onlyOwner {

93:     function addOwnerPublicKey(bytes32 x, bytes32 y) public virtual onlyOwner {

102:     function removeOwnerAtIndex(uint256 index) public virtual onlyOwner {

```
*Github:* [[85](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L85), [93](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L93), [102](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L102)]


</details>


<a name="L-20"></a> 
### [L-20] Initializers could be front-run
Initializers could be front-run, allowing an attacker to either set their own values, take ownership of the contract, and in the best case forcing a re-deployment

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

114:     function initialize(bytes[] calldata owners) public payable virtual {

```
*Github:* [[114](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L114)]



<a name="L-21"></a> 
### [L-21] Low level calls in solidity versions preceding 0.8.14 can result in an optimiser bug
In Solidity versions 0.8.13 and 0.8.14, a known optimizer bug presents potential risks when a variable is used in a separate assembly block from the one in which it was stored. Specifically, the 'mstore' operation could be optimized out due to this bug, leading to the use of uninitialized memory. Although the current code does not exhibit this risky pattern of execution, it does utilize 'mstore' within assembly blocks, which introduces a vulnerability risk for future code modifications. As a preventative measure, it is advisable to avoid the usage of the afflicted Solidity versions, 0.8.13 and 0.8.14. Instead, consider utilizing a version that is not impacted by this optimizer bug to prevent potential memory initialization issues in your smart contract.

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/MultiOwnable.sol

213:         assembly ("memory-safe") {

```
*Github:* [[213](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L213)]



<a name="L-22"></a> 
### [L-22] For loops in public or external functions should be avoided due to high gas costs and possible DOS
In Solidity, for loops can potentially cause Denial of Service (DoS) attacks if not handled carefully. DoS attacks can occur when an attacker intentionally exploits the gas cost of a function, causing it to run out of gas or making it too expensive for other users to call. Below are some scenarios where for loops can lead to DoS attacks: Nested for loops can become exceptionally gas expensive and should be used sparingly.

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

205:     function executeBatch(Call[] calldata calls) public payable virtual onlyEntryPointOrOwner {
             for (uint256 i; i < calls.length;) {

```
*Github:* [[205](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L205)]




## Non Critical Issues

<a name="NC-1"></a> 
### [NC-1] Assembly blocks should have extensive comments
Assembly blocks take a lot more time to audit than normal Solidity code, and often have gotchas and side-effects that the Solidity versions of the same code do not. Consider adding more comments explaining what is being done in every step of the assembly code, and describe why assembly is being used instead of Solidity.

*There are <b>10</b> instances of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

95:         assembly {

140:             assembly {

324:             assembly {

354:             assembly {

375:         assembly {

```
*Github:* [[95](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L95), [140](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L140), [324](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L324), [354](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L354), [375](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L375)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

94:         assembly ("memory-safe") {

242:         assembly {

275:             assembly ("memory-safe") {

309:             assembly ("memory-safe") {

```
*Github:* [[94](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L94), [242](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L242), [275](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L275), [309](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L309)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

213:         assembly ("memory-safe") {

```
*Github:* [[213](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L213)]



<a name="NC-2"></a> 
### [NC-2] `abi.encodePacked()` should be replaced with `bytes.concat()`
Solidity version 0.8.4 introduces `bytes.concat()`, which can be used to replace `abi.encodePacked()` on bytes/strings. It can make the intended operation clearer, leading to less reviewer confusion.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/SmartWallet/ERC1271.sol

122:         return keccak256(abi.encodePacked("\x19\x01", domainSeparator(), _hashStruct(hash)));

```
*Github:* [[122](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L122)]


```solidity
File: src/WebAuthnSol/WebAuthn.sol

148:         bytes32 messageHash = sha256(abi.encodePacked(webAuthnAuth.authenticatorData, clientDataJSONHash));

```
*Github:* [[148](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L148)]



<a name="NC-3"></a> 
### [NC-3] Add inline comments for unnamed variables
`function foo(address x, address)` -> `function foo(address x, address /* y */)`

*There are <b>3</b> instances of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

293:     function ecAff_IsZero(uint256, uint256 y) internal pure returns (bool flag) {

```
*Github:* [[293](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L293)]


```solidity
File: src/MagicSpend/MagicSpend.sol

109:     function validatePaymasterUserOp(UserOperation calldata userOp, bytes32, uint256 maxCost)
             external
             onlyEntryPoint
             returns (bytes memory context, uint256 validationData)
         {

```
*Github:* [[109](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L109)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

330:     function _authorizeUpgrade(address) internal view virtual override(UUPSUpgradeable) onlyOwner {}

```
*Github:* [[330](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L330)]



<a name="NC-4"></a> 
### [NC-4] Avoid mutating function parameters
Function parameters in Solidity are passed by value, meaning they are essentially local copies. Mutating them can lead to confusion and errors because the changes don't persist outside the function. By keeping function parameters immutable, you ensure clarity in code behavior, preventing unintended side-effects. If you need to modify a value based on a parameter, use a local variable inside the function, leaving the original parameter unaltered. By adhering to this practice, you maintain a clear distinction between input data and the internal processing logic, improving code readability and reducing the potential for bugs.

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

/// @audit `userOpHash`
137:     function validateUserOp(UserOperation calldata userOp, bytes32 userOpHash, uint256 missingAccountFunds)
             public
             payable
             virtual
             onlyEntryPoint
             payPrefund(missingAccountFunds)
             returns (uint256 validationData)
         {
             uint256 key = userOp.nonce >> 64;
     
             // 0xbf6ba1fc = bytes4(keccak256("executeWithoutChainIdValidation(bytes)"))
             if (userOp.callData.length >= 4 && bytes4(userOp.callData[0:4]) == 0xbf6ba1fc) {
                 userOpHash = getUserOpHashWithoutChainId(userOp);

```
*Github:* [[137](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L137)]



<a name="NC-5"></a> 
### [NC-5] Avoid the use of sensitive terms
Use [alternative variants](https://www.zdnet.com/article/mysql-drops-master-slave-and-blacklist-whitelist-terminology/), e.g. allowlist/denylist instead of whitelist/blacklist

*There are <b>3</b> instances of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

51:     /// @dev Whitelisting of `UserOperation`s that are allowed to skip the chain ID validation is

247:     /// @notice Check if the given function selector is whitelisted to skip the chain ID validation.

251:     /// @return `true` is the function selector is whitelisted to skip the chain ID validation, else `false`.

```
*Github:* [[51](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L51), [247](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L247), [251](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L251)]



<a name="NC-6"></a> 
### [NC-6] Multiple `address`/ID mappings can be combined into a single `mapping` of an `address`/ID to a `struct`, for readability
Well-organized data structures make code reviews easier, which may lead to fewer bugs. Consider combining related mappings into mappings to structs, so it's clear what data is related

*There is one instance of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

37:     mapping(uint256 nonce => mapping(address user => bool used)) internal _nonceUsed;

```
*Github:* [[37](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L37)]



<a name="NC-7"></a> 
### [NC-7] Complex casting
Consider whether the number of casts is really necessary, or whether using a different type would be more appropriate. Alternatively, add comments to explain in detail why the casts are necessary, and any implicit reasons why the cast does not introduce an overflow.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

302:             if (uint256(bytes32(ownerBytes)) > type(uint160).max) {

```
*Github:* [[302](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L302)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

168:             if (owners[i].length == 32 && uint256(bytes32(owners[i])) > type(uint160).max) {

```
*Github:* [[168](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L168)]



<a name="NC-8"></a> 
### [NC-8] Consider adding a block/deny-list
Doing so will significantly increase centralization, but will help to prevent hackers from using stolen tokens.

*There are <b>5</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

18: contract MagicSpend is Ownable, IPaymaster {

```
*Github:* [[18](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L18)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

20: contract CoinbaseSmartWallet is MultiOwnable, UUPSUpgradeable, Receiver, ERC1271 {

```
*Github:* [[20](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L20)]


```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

13: contract CoinbaseSmartWalletFactory {

```
*Github:* [[13](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L13)]


```solidity
File: src/SmartWallet/ERC1271.sol

16: abstract contract ERC1271 {

```
*Github:* [[16](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L16)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

32: contract MultiOwnable {

```
*Github:* [[32](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L32)]



<a name="NC-9"></a> 
### [NC-9] Consider adding emergency-stop functionality
Consider adding `Pausable` to the following contracts so it's possible to stop them in case of an emergency.

*There are <b>4</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

18: contract MagicSpend is Ownable, IPaymaster {

```
*Github:* [[18](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L18)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

20: contract CoinbaseSmartWallet is MultiOwnable, UUPSUpgradeable, Receiver, ERC1271 {

```
*Github:* [[20](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L20)]


```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

13: contract CoinbaseSmartWalletFactory {

```
*Github:* [[13](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L13)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

32: contract MultiOwnable {

```
*Github:* [[32](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L32)]



<a name="NC-10"></a> 
### [NC-10] Consider adding formal verification proofs
Formal verification is the act of proving or disproving the correctness of intended algorithms underlying a system with respect to a certain formal specification/property/invariant, using formal methods of mathematics.

Some tools that are currently available to perform these tests on smart contracts are [SMTChecker](https://docs.soliditylang.org/en/latest/smtchecker.html) and [Certora Prover](https://www.certora.com/).

*There is one instance of this issue:*
```solidity

Global finding

```
*Github:* [[Global](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/)]



<a name="NC-11"></a> 
### [NC-11] Consider bounding input array length
The functions below take in an unbounded array, and make function calls for entries in the array. While the function will revert if it eventually runs out of gas, it may be a nicer user experience to require() that the length of the array is below some reasonable maximum, so that the user doesn't have to use up a full transaction's gas only to see that the transaction reverts.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

/// @audit consider length check for `calls`
206:         for (uint256 i; i < calls.length;) {

```
*Github:* [[206](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L206)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

/// @audit consider length check for `owners`
163:         for (uint256 i; i < owners.length; i++) {

```
*Github:* [[163](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L163)]



<a name="NC-12"></a> 
### [NC-12] Consider using descriptive `constant`s when passing zero as a function argument
Passing zero as a function argument can sometimes result in a security issue (e.g. passing zero as the slippage parameter). Consider using a `constant` variable with a descriptive name, so it's clear that the argument is intentionally being used, and for the right reasons.

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

186:         _call(address(this), 0, data);

```
*Github:* [[186](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L186)]



<a name="NC-13"></a> 
### [NC-13] Consider using SafeTransferLib.safeTransferETH() or Address.sendValue() for clearer semantic meaning
For improved code readability and better semantic understanding, it's recommended to use OpenZeppelin's SafeTransferLib.safeTransferETH() or Address.sendValue(). These functions explicitly describe their operation with their naming convention, increasing the comprehensibility of the code. Their usage over lower-level calls enhances the maintainability of your smart contract code by clearly indicating the purpose of the function.

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

273:         (bool success, bytes memory result) = target.call{value: value}(data);

```
*Github:* [[273](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L273)]



<a name="NC-14"></a> 
### [NC-14] Constants should be put on the left side of comparisons
Putting constants on the left side of comparison statements is a best practice known as [Yoda conditions](https://en.wikipedia.org/wiki/Yoda_conditions). Although solidity's static typing system prevents accidental assignments within conditionals, adopting this practice can improve code readability and consistency, especially when working across multiple languages.

<details>
<summary>
There are <b>12</b> instances (click to show):
</summary>

```solidity
File: src/FreshCryptoLib/FCL.sol

51:         if (r == 0 || r >= n || s == 0 || s >= n) {

131:             if (scalar_u == 0 && scalar_v == 0) return 0;

135:                 (H0 == 0) && (H1 == 0) //handling Q=-G

294:         return (y == 0);

350:             if (y1 == 0) {

```
*Github:* [[51](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L51), [131](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L131), [135](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L135), [294](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L294), [350](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L350)]


```solidity
File: src/MagicSpend/MagicSpend.sol

121:         if (withdrawRequest.asset != address(0)) {

172:         if (amount == 0) revert NoExcess();

335:         if (asset == address(0)) {

```
*Github:* [[121](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L121), [172](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L172), [335](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L335)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

115:         if (nextOwnerIndex() != 0) {

148:         if (userOp.callData.length >= 4 && bytes4(userOp.callData[0:4]) == 0xbf6ba1fc) {

```
*Github:* [[115](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L115), [148](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L148)]


```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

44:         if (owners.length == 0) {

```
*Github:* [[44](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L44)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

104:         if (owner.length == 0) revert NoOwnerAtIndex(index);

```
*Github:* [[104](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L104)]


</details>


<a name="NC-15"></a> 
### [NC-15] Variable names for `constant`s should use CONSTANT_CASE
For `constant` variable names, each word should use all capital letters, with underscores separating each word (CONSTANT_CASE)

*There are <b>9</b> instances of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

31:     uint256 constant p = 0xFFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF;

33:     uint256 constant a = 0xFFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFC;

35:     uint256 constant b = 0x5AC635D8AA3A93E7B3EBBD55769886BC651D06B0CC53B0F63BCE3C3E27D2604B;

37:     uint256 constant gx = 0x6B17D1F2E12C4247F8BCE6E563A440F277037D812DEB33A0F4A13945D898C296;

38:     uint256 constant gy = 0x4FE342E2FE1A7F9B8EE7EB4A7C0F9E162BCE33576B315ECECBB6406837BF51F5;

40:     uint256 constant n = 0xFFFFFFFF00000000FFFFFFFFFFFFFFFFBCE6FAADA7179E84F3B9CAC2FC632551;

42:     uint256 constant minus_2 = 0xFFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFD;

44:     uint256 constant minus_2modn = 0xFFFFFFFF00000000FFFFFFFFFFFFFFFFBCE6FAADA7179E84F3B9CAC2FC63254F;

46:     uint256 constant minus_1 = 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF;

```
*Github:* [[31](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L31), [33](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L33), [35](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L35), [37](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L37), [38](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L38), [40](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L40), [42](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L42), [44](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L44), [46](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L46)]



<a name="NC-16"></a> 
### [NC-16] `Constructor` should emit an event
Use events to signal significant changes to off-chain monitoring tools.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

101:     constructor(address _owner) {

```
*Github:* [[101](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L101)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

102:     constructor() {

```
*Github:* [[102](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L102)]


```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

24:     constructor(address erc4337) payable {

```
*Github:* [[24](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L24)]



<a name="NC-17"></a> 
### [NC-17] Contract should expose an `interface`
All `external`/`public` functions should extend an `interface`. This is useful to make sure that the whole API is extracted.

*Note:* It is possible that the interface is out-of-scope and has not been seen by the bot.

<details>
<summary>
There are <b>38</b> instances (click to show):
</summary>

```solidity
File: src/MagicSpend/MagicSpend.sol

109:     function validatePaymasterUserOp(UserOperation calldata userOp, bytes32, uint256 maxCost)

143:     function postOp(IPaymaster.PostOpMode mode, bytes calldata context, uint256 actualGasCost)

169:     function withdrawGasExcess() external {

181:     function withdraw(WithdrawRequest memory withdrawRequest) external {

203:     function ownerWithdraw(address asset, address to, uint256 amount) external onlyOwner {

212:     function entryPointDeposit(uint256 amount) external payable onlyOwner {

222:     function entryPointWithdraw(address payable to, uint256 amount) external onlyOwner {

232:     function entryPointAddStake(uint256 amount, uint32 unstakeDelaySeconds) external payable onlyOwner {

239:     function entryPointUnlockStake() external onlyOwner {

248:     function entryPointWithdrawStake(address payable to) external onlyOwner {

260:     function isValidWithdrawSignature(address account, WithdrawRequest memory withdrawRequest)

279:     function getHash(address account, WithdrawRequest memory withdrawRequest) public view returns (bytes32) {

299:     function nonceUsed(address account, uint256 nonce) external view returns (bool) {

304:     function entryPoint() public pure returns (address) {

```
*Github:* [[109](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L109), [143](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L143), [169](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L169), [181](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L181), [203](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L203), [212](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L212), [222](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L222), [232](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L232), [239](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L239), [248](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L248), [260](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L260), [279](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L279), [299](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L299), [304](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L304)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

114:     function initialize(bytes[] calldata owners) public payable virtual {

137:     function validateUserOp(UserOperation calldata userOp, bytes32 userOpHash, uint256 missingAccountFunds)

180:     function executeWithoutChainIdValidation(bytes calldata data) public payable virtual onlyEntryPoint {

196:     function execute(address target, uint256 value, bytes calldata data) public payable virtual onlyEntryPointOrOwner {

205:     function executeBatch(Call[] calldata calls) public payable virtual onlyEntryPointOrOwner {

217:     function entryPoint() public view virtual returns (address) {

229:     function getUserOpHashWithoutChainId(UserOperation calldata userOp)

241:     function implementation() public view returns (address $) {

252:     function canSkipChainIdValidation(bytes4 functionSelector) public pure returns (bool) {

```
*Github:* [[114](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L114), [137](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L137), [180](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L180), [196](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L196), [205](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L205), [217](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L217), [229](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L229), [241](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L241), [252](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L252)]


```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

38:     function createAccount(bytes[] calldata owners, uint256 nonce)

64:     function getAddress(bytes[] calldata owners, uint256 nonce) external view returns (address predicted) {

71:     function initCodeHash() public view virtual returns (bytes32 result) {

```
*Github:* [[38](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L38), [64](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L64), [71](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L71)]


```solidity
File: src/SmartWallet/ERC1271.sol

36:     function eip712Domain()

69:     function isValidSignature(bytes32 hash, bytes calldata signature) public view virtual returns (bytes4 result) {

90:     function replaySafeHash(bytes32 hash) public view virtual returns (bytes32) {

100:     function domainSeparator() public view returns (bytes32) {

```
*Github:* [[36](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L36), [69](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L69), [90](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L90), [100](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L100)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

85:     function addOwnerAddress(address owner) public virtual onlyOwner {

93:     function addOwnerPublicKey(bytes32 x, bytes32 y) public virtual onlyOwner {

102:     function removeOwnerAtIndex(uint256 index) public virtual onlyOwner {

117:     function isOwnerAddress(address account) public view virtual returns (bool) {

127:     function isOwnerPublicKey(bytes32 x, bytes32 y) public view virtual returns (bool) {

136:     function isOwnerBytes(bytes memory account) public view virtual returns (bool) {

145:     function ownerAtIndex(uint256 index) public view virtual returns (bytes memory) {

152:     function nextOwnerIndex() public view virtual returns (uint256) {

```
*Github:* [[85](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L85), [93](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L93), [102](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L102), [117](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L117), [127](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L127), [136](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L136), [145](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L145), [152](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L152)]


</details>


<a name="NC-18"></a> 
### [NC-18] Contracts should have full test coverage
While 100% code coverage does not guarantee that there are no bugs, it often will catch easy-to-find bugs, and will ensure that there are fewer regressions when the code invariably has to be modified. Furthermore, in order to get full coverage, code authors will often have to re-organize their code so that it is more modular, so that each component can be tested separately, which reduces interdependencies between modules and layers, and makes for code that is easier to reason about and audit.

*There is one instance of this issue:*
```solidity

Global finding

```
*Github:* [[Global](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/)]



<a name="NC-19"></a> 
### [NC-19] Events that mark critical parameter changes should contain both the old and the new value
This should especially be done if the new value is not required to be different from the old value.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

323:         emit MagicSpendWithdrawal(account, withdrawRequest.asset, withdrawRequest.amount, withdrawRequest.nonce);

```
*Github:* [[323](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L323)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

109:         emit RemoveOwner(index, owner);

195:         emit AddOwner(index, owner);

```
*Github:* [[109](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L109), [195](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L195)]



<a name="NC-20"></a> 
### [NC-20] Custom errors has no error details
Consider adding parameters to the error to indicate which user or values caused the failure.

*There are <b>7</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

53:     error InvalidSignature();

56:     error Expired();

83:     error NoExcess();

90:     error UnexpectedPostOpRevertedMode();

```
*Github:* [[53](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L53), [56](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L56), [83](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L83), [90](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L90)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

46:     error Initialized();

```
*Github:* [[46](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L46)]


```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

18:     error OwnerRequired();

```
*Github:* [[18](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L18)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

40:     error Unauthorized();

```
*Github:* [[40](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L40)]



<a name="NC-21"></a> 
### [NC-21] Solidity version is different in some files

*There are <b>2</b> instances of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

2: pragma solidity ^0.8.23;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L2)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

2: pragma solidity ^0.8.4;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L2)]



<a name="NC-22"></a> 
### [NC-22] Duplicated `require()`/`revert()` checks should be refactored
Refactoring duplicate `require()`/`revert()` checks into a modifier or function can make the code more concise, readable and maintainable, and less likely to make errors or omissions when modifying the `require()` or `revert()`.

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

/// @audit duplicated on line 155
151:                 revert InvalidNonceKey(key);

```
*Github:* [[151](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L151)]



<a name="NC-23"></a> 
### [NC-23] Empty bytes check is missing
Passing empty bytes to a function can cause unexpected behavior, such as certain operations failing, producing incorrect results, or wasting gas. It is recommended to check that all byte parameters are not empty.

<details>
<summary>
There are <b>11</b> instances (click to show):
</summary>

```solidity
File: src/MagicSpend/MagicSpend.sol

/// @audit missing empty check for `context`
143:     function postOp(IPaymaster.PostOpMode mode, bytes calldata context, uint256 actualGasCost)
             external
             onlyEntryPoint
         {

```
*Github:* [[143](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L143)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

/// @audit missing empty check for `data`
180:     function executeWithoutChainIdValidation(bytes calldata data) public payable virtual onlyEntryPoint {

/// @audit missing empty check for `data`
196:     function execute(address target, uint256 value, bytes calldata data) public payable virtual onlyEntryPointOrOwner {

/// @audit missing empty check for `data`
272:     function _call(address target, uint256 value, bytes memory data) internal {

/// @audit missing empty check for `signature`
291:     function _validateSignature(bytes32 message, bytes calldata signature)
             internal
             view
             virtual
             override
             returns (bool)
         {

```
*Github:* [[180](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L180), [196](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L196), [272](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L272), [291](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L291)]


```solidity
File: src/SmartWallet/ERC1271.sol

/// @audit missing empty check for `signature`
69:     function isValidSignature(bytes32 hash, bytes calldata signature) public view virtual returns (bytes4 result) {

/// @audit missing empty check for `signature`
155:     function _validateSignature(bytes32 message, bytes calldata signature) internal view virtual returns (bool);

```
*Github:* [[69](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L69), [155](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L155)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

/// @audit missing empty check for `account`
136:     function isOwnerBytes(bytes memory account) public view virtual returns (bool) {
             return _getMultiOwnableStorage().isOwner[account];

/// @audit missing empty check for `owner`
179:     function _addOwner(bytes memory owner) internal virtual {
             _addOwnerAtIndex(owner, _getMultiOwnableStorage().nextOwnerIndex++);

/// @audit missing empty check for `owner`
189:     function _addOwnerAtIndex(bytes memory owner, uint256 index) internal virtual {
             if (isOwnerBytes(owner)) revert AlreadyOwner(owner);

```
*Github:* [[136](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L136), [179](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L179), [189](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L189)]


```solidity
File: src/WebAuthnSol/WebAuthn.sol

/// @audit missing empty check for `challenge`
104:     function verify(bytes memory challenge, bool requireUV, WebAuthnAuth memory webAuthnAuth, uint256 x, uint256 y)
             internal
             view
             returns (bool)
         {
             if (webAuthnAuth.s > P256_N_DIV_2) {

```
*Github:* [[104](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L104)]


</details>


<a name="NC-24"></a> 
### [NC-24] Enable IR-based code generation
The IR-based code generator was introduced with an aim to not only allow code generation to be more transparent and auditable but also to enable more powerful optimization passes that span across functions. You can enable it on the command line using `--via-ir` or with the option `{"viaIR": true}`. This will take longer to compile, but you can just simple test it before deploying and if you got a better benchmark then you can add --via-ir to your deploy command More on: https://docs.soliditylang.org/en/v0.8.17/ir-breaking-changes.html

*There is one instance of this issue:*
```solidity

Global finding

```
*Github:* [[Global](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/)]



<a name="NC-25"></a> 
### [NC-25] Enum values should be used instead of constant array indexes
Create a commented enum value to use instead of constant array indexes, this makes the code far easier to understand.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

105:         owners[0] = abi.encode(address(0));

```
*Github:* [[105](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L105)]


```solidity
File: src/WebAuthnSol/WebAuthn.sol

133:         if (webAuthnAuth.authenticatorData[32] & AUTH_DATA_FLAGS_UP != AUTH_DATA_FLAGS_UP) {

138:         if (requireUV && (webAuthnAuth.authenticatorData[32] & AUTH_DATA_FLAGS_UV) != AUTH_DATA_FLAGS_UV) {

```
*Github:* [[133](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L133), [138](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L138)]



<a name="NC-26"></a> 
### [NC-26] Events are emitted without the sender information
When an action is triggered based on a user's action, not being able to filter based on who triggered the action makes event processing a lot more cumbersome. Including the `msg.sender` the events of these types of action will make events much more useful to end users, especially when `msg.sender` is not `tx.origin`.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

323:         emit MagicSpendWithdrawal(account, withdrawRequest.asset, withdrawRequest.amount, withdrawRequest.nonce);

```
*Github:* [[323](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L323)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

109:         emit RemoveOwner(index, owner);

195:         emit AddOwner(index, owner);

```
*Github:* [[109](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L109), [195](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L195)]



<a name="NC-27"></a> 
### [NC-27] Execution at deadlines should be allowed
The condition may be wrong in these cases, as when `block.timestamp` is equal to the compared `>` or `<` variable these blocks will not be executed.

*There is one instance of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

188:         if (block.timestamp > withdrawRequest.expiry) {

```
*Github:* [[188](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L188)]



<a name="NC-28"></a> 
### [NC-28] External call recipient can consume all remaining gas
There is no limit specified on the amount of gas used, so the recipient can use up all of the remaining gas (`gasleft()`), causing it to revert. Therefore, when calling an external contract, it is necessary to specify a limited amount of gas to forward.

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

273:         (bool success, bytes memory result) = target.call{value: value}(data);

```
*Github:* [[273](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L273)]



<a name="NC-29"></a> 
### [NC-29]  Function ordering does not follow the Solidity Style Guide
According to the [solidity style guide](https://docs.soliditylang.org/en/v0.8.17/style-guide.html#order-of-functions), functions should be laid out in the following order: `constructor()`, `receive()`, `fallback()`, `external`, `public`, `internal`, `private`, but the cases below do not follow this pattern

*There are <b>2</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

/// @audit public function `isValidWithdrawSignature` came earlier from this external function
/// @audit public function `getHash` came earlier from this external function
299:     function nonceUsed(address account, uint256 nonce) external view returns (bool) {

```
*Github:* [[299](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L299)]


```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

/// @audit public function `createAccount` came earlier from this external function
64:     function getAddress(bytes[] calldata owners, uint256 nonce) external view returns (address predicted) {

```
*Github:* [[64](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L64)]



<a name="NC-30"></a> 
### [NC-30] Functions and modifiers should be named in mixedCase style
As the [Solidity Style Guide](https://docs.soliditylang.org/en/v0.8.21/style-guide.html#function-names) suggests: functions and modifiers should be named in mixedCase style.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

94:     function FCL_nModInv(uint256 u) internal view returns (uint256 result) {

374:     function FCL_pModInv(uint256 u) internal view returns (uint256 result) {

```
*Github:* [[94](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L94), [374](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L374)]



<a name="NC-31"></a> 
### [NC-31] Functions with array parameters should have length checks in place

*There are <b>5</b> instances of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

/// @audit `owners`
114:     function initialize(bytes[] calldata owners) public payable virtual {

/// @audit `calls`
205:     function executeBatch(Call[] calldata calls) public payable virtual onlyEntryPointOrOwner {

```
*Github:* [[114](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L114), [205](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L205)]


```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

/// @audit `owners`
64:     function getAddress(bytes[] calldata owners, uint256 nonce) external view returns (address predicted) {

/// @audit `owners`
81:     function _getSalt(bytes[] calldata owners, uint256 nonce) internal pure returns (bytes32 salt) {

```
*Github:* [[64](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L64), [81](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L81)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

/// @audit `owners`
162:     function _initializeOwners(bytes[] memory owners) internal virtual {

```
*Github:* [[162](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L162)]



<a name="NC-32"></a> 
### [NC-32] High cyclomatic complexity
Consider breaking down these blocks into more manageable units, by splitting things into utility functions, by reducing nesting, and by using early returns

*There is one instance of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

/// @audit Number of blocks: 22
117:     function ecZZ_mulmuladd_S_asm(

```
*Github:* [[117](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L117)]



<a name="NC-33"></a> 
### [NC-33] Variable names for `immutable`s should use CONSTANT_CASE
For `immutable` variable names, each word should use all capital letters, with underscores separating each word (CONSTANT_CASE)

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

15:     address public immutable implementation;

```
*Github:* [[15](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L15)]



<a name="NC-34"></a> 
### [NC-34] Inconsistent spacing in comments
Some lines use `// x` and some use `//x`. The instances below point out the usages that don't follow the majority, within each file

<details>
<summary>
There are <b>36</b> instances (click to show):
</summary>

```solidity
File: src/FreshCryptoLib/FCL.sol

1: //curve order (number of points)

2: //********************************************************************************************/

8: ///* Copyright (C) 2022 - Renaud Dubois - This file is part of FCL (Fresh CryptoLib) project

9: ///* License: This software is licensed under MIT License

10: ///* This Code may be reused including license and copyright notice.

11: ///* See LICENSE file at the root folder of the project.

12: ///* FILE: FCL_ecdsa.sol

13: ///*

14: ///*

15: ///* DESCRIPTION: ecdsa verification implementation

16: ///*

17: //**************************************************************************************/

18: //* WARNING: this code SHALL not be used for non prime order curves for security reasons.

27:     //*******************************Constants*******************************************************/

30:     //curve prime field modulus

32:     //short weierstrass first coefficient

34:     //short weierstrass second coefficient

36:     //generating point affine coordinates

39:     //curve order (number of points)

48:     //******************Core Function ecdsa_verify********************************************************************/

72:     //**************************************************************************************/

74:     //***************************Supporting Functions***********************************************************/

179:                         //value of dibit

208:                         //T3:=sub(p, Y)

209:                         //T3:=Y

213:                         //special extremely rare case accumulator where EcAdd is replaced by EcDbl, no need to optimize this

214:                         //todo : construct edge vector case

250:                 //(X,Y)=ecZZ_SetAff(X,Y,zz, zzz);

251:                 //T[0] = inverseModp_Hard(T[0], p); //1/zzz, inline modular inversion using precompile:

257:                 //mstore(add(pointer, 0x60), u)

264:                 //Y:=mulmod(Y,zzz,p)//Y/zzz

265:                 //zz :=mulmod(zz, mload(T),p) //1/z

266:                 //zz:= mulmod(zz,zz,p) //1/zz

366:             //end assembly

```
*Github:* [[1](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L1), [2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L2), [8](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L8), [9](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L9), [10](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L10), [11](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L11), [12](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L12), [13](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L13), [14](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L14), [15](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L15), [16](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L16), [17](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L17), [18](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L18), [27](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L27), [30](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L30), [32](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L32), [34](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L34), [36](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L36), [39](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L39), [48](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L48), [72](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L72), [74](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L74), [179](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L179), [208](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L208), [209](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L209), [213](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L213), [214](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L214), [250](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L250), [251](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L251), [257](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L257), [264](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L264), [265](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L265), [266](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L266), [366](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L366)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

250:     ////

```
*Github:* [[250](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L250)]


```solidity
File: src/SmartWallet/ERC1271.sol

119:     ////

```
*Github:* [[119](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L119)]


</details>


<a name="NC-35"></a> 
### [NC-35] Incorrect withdraw declaration
In Solidity, it's essential for clarity and interoperability to correctly specify return types in function declarations. If the `withdraw` function is expected to return a `bool` to indicate success or failure, its omission could lead to ambiguity or unexpected behavior when interacting with or calling this function from other contracts or off-chain systems. Missing return values can mislead developers and potentially lead to contract integrations built on incorrect assumptions. To resolve this, the function declaration for withdraw should be modified to explicitly include the `bool` return type, ensuring clarity and correctness in contract interactions.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

169:     function withdrawGasExcess() external {

181:     function withdraw(WithdrawRequest memory withdrawRequest) external {

334:     function _withdraw(address asset, address to, uint256 amount) internal {

```
*Github:* [[169](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L169), [181](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L181), [334](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L334)]



<a name="NC-36"></a> 
### [NC-36] It is best practice to use linear inheritance
In Solidity, complex inheritance structures can obfuscate code understanding, introducing potential security risks. Multiple inheritance, especially with overlapping function names or state variables, can cause unintentional overrides or ambiguous behavior. 

Resolution: Strive for linear and simple inheritance chains. Avoid diamond or circular inheritance patterns. Clearly document the purpose and relationships of base contracts, ensuring that overrides are intentional. Tools like Remix or Hardhat can visualize inheritance chains, assisting in verification. Keeping inheritance streamlined aids in better code readability, reduces potential errors, and ensures smoother audits and upgrades.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

18: contract MagicSpend is Ownable, IPaymaster {

```
*Github:* [[18](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L18)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

20: contract CoinbaseSmartWallet is MultiOwnable, UUPSUpgradeable, Receiver, ERC1271 {

```
*Github:* [[20](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L20)]



<a name="NC-37"></a> 
### [NC-37] Lack of brace spacing
Lack of brace spacing in coding refers to the absence of spaces around braces, which can hinder code readability. In Solidity, as in many programming languages, spacing can enhance the visual distinction between different parts of the code, making it easier to follow. A lack of spacing can lead to a dense, confusing appearance. The resolution to this issue is to follow a consistent style guide that defines rules for brace spacing. By including spaces around braces, such as `{ statement }` instead of `{statement}`, developers can ensure that the code is more legible and maintainable, especially in larger codebases.

*There are <b>4</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

233:         IEntryPoint(entryPoint()).addStake{value: amount}(unstakeDelaySeconds);

```
*Github:* [[233](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L233)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

273:         (bool success, bytes memory result) = target.call{value: value}(data);

321:             return WebAuthn.verify({challenge: abi.encode(message), requireUV: false, webAuthnAuth: auth, x: x, y: y});

```
*Github:* [[273](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L273), [321](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L321)]


```solidity
File: src/SmartWallet/ERC1271.sol

70:         if (_validateSignature({message: replaySafeHash(hash), signature: signature})) {

```
*Github:* [[70](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L70)]



<a name="NC-38"></a> 
### [NC-38] Large or complicated code bases should implement invariant tests
This includes: large code bases, or code with lots of inline-assembly, complicated math, or complicated interactions between multiple contracts. Invariant fuzzers such as Echidna require the test writer to come up with invariants which should not be violated under any circumstances, and the fuzzer tests various inputs and function calls to ensure that the invariants always hold. Even code with 100% code coverage can still have bugs due to the order of the operations a user performs, and invariant fuzzers may help significantly.

*There is one instance of this issue:*
```solidity

Global finding

```
*Github:* [[Global](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/)]



<a name="NC-39"></a> 
### [NC-39] Large numeric literals should use underscores for readability
Large hardcoded numbers in code can be difficult to read. Consider using underscores for number literals to improve readability (e.g `1234567` -> `1_234_567`). Consider using an underscore for every third digit from the right.

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

43:     uint256 public constant REPLAYABLE_NONCE_KEY = 8453;

```
*Github:* [[43](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L43)]



<a name="NC-40"></a> 
### [NC-40] Long functions should be refactored into multiple, smaller, functions

*There are <b>2</b> instances of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

/// @audit 155 lines
117:     function ecZZ_mulmuladd_S_asm(
             uint256 Q0,
             uint256 Q1, //affine rep for input point Q
             uint256 scalar_u,
             uint256 scalar_v
         ) internal view returns (uint256 X) {

```
*Github:* [[117](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L117)]


```solidity
File: src/WebAuthnSol/WebAuthn.sol

/// @audit 57 lines
104:     function verify(bytes memory challenge, bool requireUV, WebAuthnAuth memory webAuthnAuth, uint256 x, uint256 y)
             internal
             view
             returns (bool)
         {
             if (webAuthnAuth.s > P256_N_DIV_2) {

```
*Github:* [[104](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L104)]



<a name="NC-41"></a> 
### [NC-41] Magic numbers should be replaced with constants
Magic numbers are hard-coded values in code that can make it difficult for developers and maintainers to understand the code, and can also cause confusion or errors. To improve the readability and maintainability of code, it is recommended to replace magic numbers with constants that have good readability.

<details>
<summary>
There are <b>16</b> instances (click to show):
</summary>

```solidity
File: src/MagicSpend/MagicSpend.sol

// @audit `20`
114:         WithdrawRequest memory withdrawRequest = abi.decode(userOp.paymasterAndData[20:], (WithdrawRequest));

// @audit `160`
128:         validationData = (sigFailed ? 1 : 0) | (uint256(withdrawRequest.expiry) << 160);

// @audit `0x5FF137D4b0FDCD49DcA30c7CF57E578a026d2789`
305:         return 0x5FF137D4b0FDCD49DcA30c7CF57E578a026d2789;

```
*Github:* [[114](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L114), [128](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L128), [305](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L305)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

// @audit `64`
145:         uint256 key = userOp.nonce >> 64;

// @audit `4`
148:         if (userOp.callData.length >= 4 && bytes4(userOp.callData[0:4]) == 0xbf6ba1fc) {

// @audit `4`
148:         if (userOp.callData.length >= 4 && bytes4(userOp.callData[0:4]) == 0xbf6ba1fc) {

// @audit `0xbf6ba1fc`
148:         if (userOp.callData.length >= 4 && bytes4(userOp.callData[0:4]) == 0xbf6ba1fc) {

// @audit `4`
181:         bytes4 selector = bytes4(data[0:4]);

// @audit `0x5FF137D4b0FDCD49DcA30c7CF57E578a026d2789`
218:         return 0x5FF137D4b0FDCD49DcA30c7CF57E578a026d2789;

// @audit `32`
301:         if (ownerBytes.length == 32) {

// @audit `64`
316:         if (ownerBytes.length == 64) {

```
*Github:* [[145](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L145), [148](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L148), [148](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L148), [148](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L148), [181](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L181), [218](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L218), [301](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L301), [316](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L316)]


```solidity
File: src/SmartWallet/ERC1271.sol

// @audit `0x1626ba7e`
72:             return 0x1626ba7e;

// @audit `0xffffffff`
75:         return 0xffffffff;

```
*Github:* [[72](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L72), [75](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L75)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

// @audit `32`
164:             if (owners[i].length != 32 && owners[i].length != 64) {

// @audit `64`
164:             if (owners[i].length != 32 && owners[i].length != 64) {

// @audit `32`
168:             if (owners[i].length == 32 && uint256(bytes32(owners[i])) > type(uint160).max) {

```
*Github:* [[164](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L164), [164](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L164), [168](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L168)]


</details>


<a name="NC-42"></a> 
### [NC-42] Missing contract existence checks before low-level calls
Low-level calls return success if there is no code present at the specified address. In addition to the zero-address checks, add a check to verify that `<address>.code.length > 0`

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

273:         (bool success, bytes memory result) = target.call{value: value}(data);

```
*Github:* [[273](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L273)]



<a name="NC-43"></a> 
### [NC-43] Missing events in initializers
As a best practice, consider emitting an event when the contract is initialized. In this way, it's easy for the user to track the exact point in time when the contract was initialized, by filtering the emitted events.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

114:     function initialize(bytes[] calldata owners) public payable virtual {

```
*Github:* [[114](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L114)]


```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

71:     function initCodeHash() public view virtual returns (bytes32 result) {

```
*Github:* [[71](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L71)]



<a name="NC-44"></a> 
### [NC-44] Missing NatSpec from contract/error/event/function/modifier declarations
e.g. `@dev` or `@notice`, and it must appear above the contract definition braces in order to be identified by the compiler as NatSpec.

*There are <b>5</b> instances of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

26: library FCL {

50:     function ecdsa_verify(bytes32 message, uint256 r, uint256 s, uint256 Qx, uint256 Qy) internal view returns (bool) {

94:     function FCL_nModInv(uint256 u) internal view returns (uint256 result) {

274:     function ecAff_add(uint256 x0, uint256 y0, uint256 x1, uint256 y1) internal view returns (uint256, uint256) {

```
*Github:* [[26](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L26), [50](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L50), [94](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L94), [274](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L274)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

102:     constructor() {

```
*Github:* [[102](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L102)]



<a name="NC-45"></a> 
### [NC-45] Missing NatSpec `@author` from contract declaration
Some contract definitions have an incomplete NatSpec: add a `@author` notation to improve the code documentation.

*There is one instance of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

26: library FCL {

```
*Github:* [[26](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L26)]



<a name="NC-46"></a> 
### [NC-46] Missing NatSpec `@dev` from contract/event/function/modifier declarations
Some contract definitions have an incomplete NatSpec: add a `@dev` notation to improve the code documentation.

<details>
<summary>
There are <b>39</b> instances (click to show):
</summary>

```solidity
File: src/FreshCryptoLib/FCL.sol

26: library FCL {

50:     function ecdsa_verify(bytes32 message, uint256 r, uint256 s, uint256 Qx, uint256 Qy) internal view returns (bool) {

94:     function FCL_nModInv(uint256 u) internal view returns (uint256 result) {

274:     function ecAff_add(uint256 x0, uint256 y0, uint256 x1, uint256 y1) internal view returns (uint256, uint256) {

```
*Github:* [[26](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L26), [50](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L50), [94](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L94), [274](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L274)]


```solidity
File: src/MagicSpend/MagicSpend.sol

45:     event MagicSpendWithdrawal(address indexed account, address indexed asset, uint256 amount, uint256 nonce);

101:     constructor(address _owner) {

106:     receive() external payable {}

109:     function validatePaymasterUserOp(UserOperation calldata userOp, bytes32, uint256 maxCost)

143:     function postOp(IPaymaster.PostOpMode mode, bytes calldata context, uint256 actualGasCost)

181:     function withdraw(WithdrawRequest memory withdrawRequest) external {

299:     function nonceUsed(address account, uint256 nonce) external view returns (bool) {

304:     function entryPoint() public pure returns (address) {

```
*Github:* [[45](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L45), [101](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L101), [106](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L106), [109](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L109), [143](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L143), [181](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L181), [299](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L299), [304](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L304)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

20: contract CoinbaseSmartWallet is MultiOwnable, UUPSUpgradeable, Receiver, ERC1271 {

65:     modifier onlyEntryPoint() virtual {

74:     modifier onlyEntryPointOrOwner() virtual {

102:     constructor() {

217:     function entryPoint() public view virtual returns (address) {

241:     function implementation() public view returns (address $) {

252:     function canSkipChainIdValidation(bytes4 functionSelector) public pure returns (bool) {

333:     function _domainNameAndVersion() internal pure override(ERC1271) returns (string memory, string memory) {

```
*Github:* [[20](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L20), [65](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L65), [74](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L74), [102](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L102), [217](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L217), [241](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L241), [252](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L252), [333](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L333)]


```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

13: contract CoinbaseSmartWalletFactory {

24:     constructor(address erc4337) payable {

64:     function getAddress(bytes[] calldata owners, uint256 nonce) external view returns (address predicted) {

71:     function initCodeHash() public view virtual returns (bytes32 result) {

81:     function _getSalt(bytes[] calldata owners, uint256 nonce) internal pure returns (bytes32 salt) {

```
*Github:* [[13](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L13), [24](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L24), [64](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L64), [71](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L71), [81](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L81)]


```solidity
File: src/SmartWallet/ERC1271.sol

121:     function _eip712Hash(bytes32 hash) internal view virtual returns (bytes32) {

```
*Github:* [[121](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L121)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

32: contract MultiOwnable {

68:     event AddOwner(uint256 indexed index, bytes owner);

74:     event RemoveOwner(uint256 indexed index, bytes owner);

77:     modifier onlyOwner() virtual {

85:     function addOwnerAddress(address owner) public virtual onlyOwner {

93:     function addOwnerPublicKey(bytes32 x, bytes32 y) public virtual onlyOwner {

117:     function isOwnerAddress(address account) public view virtual returns (bool) {

127:     function isOwnerPublicKey(bytes32 x, bytes32 y) public view virtual returns (bool) {

136:     function isOwnerBytes(bytes memory account) public view virtual returns (bool) {

145:     function ownerAtIndex(uint256 index) public view virtual returns (bytes memory) {

152:     function nextOwnerIndex() public view virtual returns (uint256) {

179:     function _addOwner(bytes memory owner) internal virtual {

212:     function _getMultiOwnableStorage() internal pure returns (MultiOwnableStorage storage $) {

```
*Github:* [[32](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L32), [68](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L68), [74](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L74), [77](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L77), [85](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L85), [93](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L93), [117](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L117), [127](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L127), [136](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L136), [145](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L145), [152](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L152), [179](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L179), [212](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L212)]


</details>


<a name="NC-47"></a> 
### [NC-47] Missing NatSpec `@notice` from contract/event/function/modifier declarations
Some contract definitions have an incomplete NatSpec: add a `@notice` notation to improve the code documentation.

<details>
<summary>
There are <b>20</b> instances (click to show):
</summary>

```solidity
File: src/FreshCryptoLib/FCL.sol

26: library FCL {

50:     function ecdsa_verify(bytes32 message, uint256 r, uint256 s, uint256 Qx, uint256 Qy) internal view returns (bool) {

78:     function ecAff_isOnCurve(uint256 x, uint256 y) internal pure returns (bool) {

94:     function FCL_nModInv(uint256 u) internal view returns (uint256 result) {

117:     function ecZZ_mulmuladd_S_asm(

274:     function ecAff_add(uint256 x0, uint256 y0, uint256 x1, uint256 y1) internal view returns (uint256, uint256) {

293:     function ecAff_IsZero(uint256, uint256 y) internal pure returns (bool flag) {

301:     function ecZZ_SetAff(uint256 x, uint256 y, uint256 zz, uint256 zzz)

318:     function ecZZ_Dbl(uint256 x, uint256 y, uint256 zz, uint256 zzz)

344:     function ecZZ_AddN(uint256 x1, uint256 y1, uint256 zz1, uint256 zzz1, uint256 x2, uint256 y2)

374:     function FCL_pModInv(uint256 u) internal view returns (uint256 result) {

```
*Github:* [[26](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L26), [50](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L50), [78](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L78), [94](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L94), [117](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L117), [274](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L274), [293](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L293), [301](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L301), [318](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L318), [344](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L344), [374](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L374)]


```solidity
File: src/MagicSpend/MagicSpend.sol

93:     modifier onlyEntryPoint() virtual {

109:     function validatePaymasterUserOp(UserOperation calldata userOp, bytes32, uint256 maxCost)

143:     function postOp(IPaymaster.PostOpMode mode, bytes calldata context, uint256 actualGasCost)

```
*Github:* [[93](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L93), [109](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L109), [143](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L143)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

102:     constructor() {

252:     function canSkipChainIdValidation(bytes4 functionSelector) public pure returns (bool) {

291:     function _validateSignature(bytes32 message, bytes calldata signature)

330:     function _authorizeUpgrade(address) internal view virtual override(UUPSUpgradeable) onlyOwner {}

333:     function _domainNameAndVersion() internal pure override(ERC1271) returns (string memory, string memory) {

```
*Github:* [[102](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L102), [252](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L252), [291](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L291), [330](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L330), [333](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L333)]


```solidity
File: src/SmartWallet/ERC1271.sol

121:     function _eip712Hash(bytes32 hash) internal view virtual returns (bytes32) {

```
*Github:* [[121](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L121)]


</details>


<a name="NC-48"></a> 
### [NC-48] Missing NatSpec `@param` from event/function/modifier declarations
Some event definitions have an incomplete NatSpec: add a `@param` notation to improve the code documentation.

<details>
<summary>
There are <b>15</b> instances (click to show):
</summary>

```solidity
File: src/FreshCryptoLib/FCL.sol

/// @audit missing @param for `message`
/// @audit missing @param for `r`
/// @audit missing @param for `s`
/// @audit missing @param for `Qx`
/// @audit missing @param for `Qy`
50:     function ecdsa_verify(bytes32 message, uint256 r, uint256 s, uint256 Qx, uint256 Qy) internal view returns (bool) {

/// @audit missing @param for `x`
/// @audit missing @param for `y`
78:     function ecAff_isOnCurve(uint256 x, uint256 y) internal pure returns (bool) {

/// @audit missing @param for `u`
94:     function FCL_nModInv(uint256 u) internal view returns (uint256 result) {

/// @audit missing @param for `Q0`
/// @audit missing @param for `Q1`
/// @audit missing @param for `scalar_u`
/// @audit missing @param for `scalar_v`
117:     function ecZZ_mulmuladd_S_asm(
             uint256 Q0,
             uint256 Q1, //affine rep for input point Q
             uint256 scalar_u,
             uint256 scalar_v
         ) internal view returns (uint256 X) {

/// @audit missing @param for `x0`
/// @audit missing @param for `y0`
/// @audit missing @param for `x1`
/// @audit missing @param for `y1`
274:     function ecAff_add(uint256 x0, uint256 y0, uint256 x1, uint256 y1) internal view returns (uint256, uint256) {

/// @audit missing @param for `y`
293:     function ecAff_IsZero(uint256, uint256 y) internal pure returns (bool flag) {

/// @audit missing @param for `x`
/// @audit missing @param for `y`
/// @audit missing @param for `zz`
/// @audit missing @param for `zzz`
301:     function ecZZ_SetAff(uint256 x, uint256 y, uint256 zz, uint256 zzz)
             internal
             view
             returns (uint256 x1, uint256 y1)
         {

/// @audit missing @param for `x`
/// @audit missing @param for `y`
/// @audit missing @param for `zz`
/// @audit missing @param for `zzz`
318:     function ecZZ_Dbl(uint256 x, uint256 y, uint256 zz, uint256 zzz)
             internal
             pure
             returns (uint256 P0, uint256 P1, uint256 P2, uint256 P3)
         {

/// @audit missing @param for `x1`
/// @audit missing @param for `y1`
/// @audit missing @param for `zz1`
/// @audit missing @param for `zzz1`
/// @audit missing @param for `x2`
/// @audit missing @param for `y2`
344:     function ecZZ_AddN(uint256 x1, uint256 y1, uint256 zz1, uint256 zzz1, uint256 x2, uint256 y2)
             internal
             pure
             returns (uint256 P0, uint256 P1, uint256 P2, uint256 P3)
         {

/// @audit missing @param for `u`
374:     function FCL_pModInv(uint256 u) internal view returns (uint256 result) {

```
*Github:* [[50](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L50), [78](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L78), [94](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L94), [117](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L117), [274](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L274), [293](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L293), [301](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L301), [318](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L318), [344](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L344), [374](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L374)]


```solidity
File: src/MagicSpend/MagicSpend.sol

/// @audit missing @param for `userOp`
/// @audit missing @param for `maxCost`
109:     function validatePaymasterUserOp(UserOperation calldata userOp, bytes32, uint256 maxCost)
             external
             onlyEntryPoint
             returns (bytes memory context, uint256 validationData)
         {

/// @audit missing @param for `mode`
/// @audit missing @param for `context`
/// @audit missing @param for `actualGasCost`
143:     function postOp(IPaymaster.PostOpMode mode, bytes calldata context, uint256 actualGasCost)
             external
             onlyEntryPoint
         {

```
*Github:* [[109](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L109), [143](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L143)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

/// @audit missing @param for `functionSelector`
252:     function canSkipChainIdValidation(bytes4 functionSelector) public pure returns (bool) {

/// @audit missing @param for `message`
291:     function _validateSignature(bytes32 message, bytes calldata signature)
             internal
             view
             virtual
             override
             returns (bool)
         {

```
*Github:* [[252](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L252), [291](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L291)]


```solidity
File: src/SmartWallet/ERC1271.sol

/// @audit missing @param for `hash`
121:     function _eip712Hash(bytes32 hash) internal view virtual returns (bytes32) {
             return keccak256(abi.encodePacked("\x19\x01", domainSeparator(), _hashStruct(hash)));

```
*Github:* [[121](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L121)]


</details>


<a name="NC-49"></a> 
### [NC-49] Missing NatSpec `@return` from function declaration
Some function definitions have an incomplete NatSpec: add a `@return` notation to improve the code documentation.

<details>
<summary>
There are <b>15</b> instances (click to show):
</summary>

```solidity
File: src/FreshCryptoLib/FCL.sol

50:     function ecdsa_verify(bytes32 message, uint256 r, uint256 s, uint256 Qx, uint256 Qy) internal view returns (bool) {

78:     function ecAff_isOnCurve(uint256 x, uint256 y) internal pure returns (bool) {

94:     function FCL_nModInv(uint256 u) internal view returns (uint256 result) {

117:     function ecZZ_mulmuladd_S_asm(
             uint256 Q0,
             uint256 Q1, //affine rep for input point Q
             uint256 scalar_u,
             uint256 scalar_v
         ) internal view returns (uint256 X) {

274:     function ecAff_add(uint256 x0, uint256 y0, uint256 x1, uint256 y1) internal view returns (uint256, uint256) {

293:     function ecAff_IsZero(uint256, uint256 y) internal pure returns (bool flag) {

301:     function ecZZ_SetAff(uint256 x, uint256 y, uint256 zz, uint256 zzz)
             internal
             view
             returns (uint256 x1, uint256 y1)
         {

318:     function ecZZ_Dbl(uint256 x, uint256 y, uint256 zz, uint256 zzz)
             internal
             pure
             returns (uint256 P0, uint256 P1, uint256 P2, uint256 P3)
         {

344:     function ecZZ_AddN(uint256 x1, uint256 y1, uint256 zz1, uint256 zzz1, uint256 x2, uint256 y2)
             internal
             pure
             returns (uint256 P0, uint256 P1, uint256 P2, uint256 P3)
         {

374:     function FCL_pModInv(uint256 u) internal view returns (uint256 result) {

```
*Github:* [[50](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L50), [78](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L78), [94](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L94), [117](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L117), [274](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L274), [293](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L293), [301](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L301), [318](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L318), [344](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L344), [374](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L374)]


```solidity
File: src/MagicSpend/MagicSpend.sol

109:     function validatePaymasterUserOp(UserOperation calldata userOp, bytes32, uint256 maxCost)
             external
             onlyEntryPoint
             returns (bytes memory context, uint256 validationData)
         {

304:     function entryPoint() public pure returns (address) {

```
*Github:* [[109](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L109), [304](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L304)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

291:     function _validateSignature(bytes32 message, bytes calldata signature)
             internal
             view
             virtual
             override
             returns (bool)
         {

333:     function _domainNameAndVersion() internal pure override(ERC1271) returns (string memory, string memory) {

```
*Github:* [[291](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L291), [333](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L333)]


```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

38:     function createAccount(bytes[] calldata owners, uint256 nonce)
            public
            payable
            virtual
            returns (CoinbaseSmartWallet account)
        {

```
*Github:* [[38](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L38)]


</details>


<a name="NC-50"></a> 
### [NC-50] Missing NatSpec `@title` from contract declaration
Some contract definitions have an incomplete NatSpec: add a `@title` notation to improve the code documentation.

*There is one instance of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

26: library FCL {

```
*Github:* [[26](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L26)]



<a name="NC-51"></a> 
### [NC-51] Non-assembly method available
There are some automated tools that will flag a project as having higher complexity if there is inline-assembly, so it's best to avoid using it where it's not necessary. In addition, most assembly methods can be replaced by non-assembly methods, for example:
- `assembly{ g := gas() }` => `uint256 g = gasleft()`
- `assembly{ id := chainid() }` => `uint256 id = block.chainid`
- `assembly { r := mulmod(a, b, d) }` => `uint256 m = mulmod(x, y, k)`
- `assembly { size := extcodesize() }` => `uint256 size = address(a).code.length`
- etc.

<details>
<summary>
There are <b>36</b> instances (click to show):
</summary>

```solidity
File: src/FreshCryptoLib/FCL.sol

166:                     let T1 := mulmod(2, Y, p) //U = 2*Y1, y free

167:                     let T2 := mulmod(T1, T1, p) // V=U^2

168:                     let T3 := mulmod(X, T2, p) // S = X1*V

169:                     T1 := mulmod(T1, T2, p) // W=UV

170:                     let T4 := mulmod(3, mulmod(addmod(X, sub(p, zz), p), addmod(X, zz, p), p), p) //M=3*(X1-ZZ1)*(X1+ZZ1)

171:                     zzz := mulmod(T1, zzz, p) //zzz3=W*zzz1

172:                     zz := mulmod(T2, zz, p) //zz3=V*ZZ1, V free

175:                     T2 := mulmod(T4, addmod(X, sub(p, T3), p), p) //-M(S-X3)=M(X3-S)

217:                                 T1 := mulmod(minus_2, Y, p) //U = 2*Y1, y free

218:                                 T2 := mulmod(T1, T1, p) // V=U^2

219:                                 T3 := mulmod(X, T2, p) // S = X1*V

221:                                 T1 := mulmod(T1, T2, p) // W=UV

222:                                 y2 := mulmod(addmod(X, zz, p), addmod(X, sub(p, zz), p), p) //(X-ZZ)(X+ZZ)

223:                                 T4 := mulmod(3, y2, p) //M=3*(X-ZZ)(X+ZZ)

225:                                 zzz := mulmod(T1, zzz, p) //zzz3=W*zzz1

226:                                 zz := mulmod(T2, zz, p) //zz3=V*ZZ1, V free

229:                                 T2 := mulmod(T4, addmod(T3, sub(p, X), p), p) //M(S-X3)

237:                         T4 := mulmod(T2, T2, p) //PP

238:                         let TT1 := mulmod(T4, T2, p) //PPP, this one could be spared, but adding this register spare gas

239:                         zz := mulmod(zz, T4, p)

240:                         zzz := mulmod(zzz, TT1, p) //zz3=V*ZZ1

241:                         let TT2 := mulmod(X, T4, p)

267:                 X := mulmod(X, mload(T), p) //X/zz

325:                 P0 := mulmod(2, y, p) //U = 2*Y1

326:                 P2 := mulmod(P0, P0, p) // V=U^2

327:                 P3 := mulmod(x, P2, p) // S = X1*V

328:                 P1 := mulmod(P0, P2, p) // W=UV

329:                 P2 := mulmod(P2, zz, p) //zz3=V*ZZ1

330:                 zz := mulmod(3, mulmod(addmod(x, sub(p, zz), p), addmod(x, zz, p), p), p) //M=3*(X1-ZZ1)*(X1+ZZ1)

332:                 x := mulmod(zz, addmod(P3, sub(p, P0), p), p) //M(S-X3)

333:                 P3 := mulmod(P1, zzz, p) //zzz3=W*zzz1

358:                 P0 := mulmod(x2, x2, p) //PP = P^2

359:                 P1 := mulmod(P0, x2, p) //PPP = P*PP

360:                 P2 := mulmod(zz1, P0, p) ////ZZ3 = ZZ1*PP

361:                 P3 := mulmod(zzz1, P1, p) ////ZZZ3 = ZZZ1*PPP

362:                 zz1 := mulmod(x1, P0, p) //Q = X1*PP

```
*Github:* [[166](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L166), [167](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L167), [168](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L168), [169](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L169), [170](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L170), [171](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L171), [172](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L172), [175](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L175), [217](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L217), [218](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L218), [219](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L219), [221](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L221), [222](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L222), [223](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L223), [225](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L225), [226](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L226), [229](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L229), [237](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L237), [238](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L238), [239](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L239), [240](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L240), [241](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L241), [267](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L267), [325](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L325), [326](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L326), [327](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L327), [328](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L328), [329](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L329), [330](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L330), [332](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L332), [333](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L333), [358](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L358), [359](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L359), [360](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L360), [361](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L361), [362](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L362)]


</details>


<a name="NC-52"></a> 
### [NC-52] Put all system-wide constants in one file
Putting all the system-wide constants in a single file improves code readability, makes it easier to understand the basic configuration and limitations of the system, and makes maintenance easier.

<details>
<summary>
There are <b>18</b> instances (click to show):
</summary>

```solidity
File: src/FreshCryptoLib/FCL.sol

29:     address constant MODEXP_PRECOMPILE = 0x0000000000000000000000000000000000000005;

31:     uint256 constant p = 0xFFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF;

33:     uint256 constant a = 0xFFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFC;

35:     uint256 constant b = 0x5AC635D8AA3A93E7B3EBBD55769886BC651D06B0CC53B0F63BCE3C3E27D2604B;

37:     uint256 constant gx = 0x6B17D1F2E12C4247F8BCE6E563A440F277037D812DEB33A0F4A13945D898C296;

38:     uint256 constant gy = 0x4FE342E2FE1A7F9B8EE7EB4A7C0F9E162BCE33576B315ECECBB6406837BF51F5;

40:     uint256 constant n = 0xFFFFFFFF00000000FFFFFFFFFFFFFFFFBCE6FAADA7179E84F3B9CAC2FC632551;

42:     uint256 constant minus_2 = 0xFFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFD;

44:     uint256 constant minus_2modn = 0xFFFFFFFF00000000FFFFFFFFFFFFFFFFBCE6FAADA7179E84F3B9CAC2FC63254F;

46:     uint256 constant minus_1 = 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF;

```
*Github:* [[29](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L29), [31](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L31), [33](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L33), [35](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L35), [37](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L37), [38](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L38), [40](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L40), [42](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L42), [44](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L44), [46](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L46)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

43:     uint256 public constant REPLAYABLE_NONCE_KEY = 8453;

```
*Github:* [[43](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L43)]


```solidity
File: src/SmartWallet/ERC1271.sol

23:     bytes32 private constant _MESSAGE_TYPEHASH = keccak256("CoinbaseSmartWalletMessage(bytes32 hash)");

```
*Github:* [[23](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L23)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

36:     bytes32 private constant MUTLI_OWNABLE_STORAGE_LOCATION =

```
*Github:* [[36](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L36)]


```solidity
File: src/WebAuthnSol/WebAuthn.sol

40:     bytes1 private constant AUTH_DATA_FLAGS_UP = 0x01;

44:     bytes1 private constant AUTH_DATA_FLAGS_UV = 0x04;

47:     uint256 private constant P256_N_DIV_2 = FCL.n / 2;

51:     address private constant VERIFIER = address(0x100);

55:     bytes32 private constant EXPECTED_TYPE_HASH = keccak256('"type":"webauthn.get"');

```
*Github:* [[40](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L40), [44](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L44), [47](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L47), [51](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L51), [55](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L55)]


</details>


<a name="NC-53"></a> 
### [NC-53] Redundant `return` statement in a function with named return variables
Because the return variable (or its default value) has been assigned, explicit return at the end of the function is unnecessary, as it is returned automatically.

*There are <b>5</b> instances of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

117:     function ecZZ_mulmuladd_S_asm(

293:     function ecAff_IsZero(uint256, uint256 y) internal pure returns (bool flag) {

```
*Github:* [[117](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L117), [293](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L293)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

137:     function validateUserOp(UserOperation calldata userOp, bytes32 userOpHash, uint256 missingAccountFunds)

229:     function getUserOpHashWithoutChainId(UserOperation calldata userOp)

```
*Github:* [[137](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L137), [229](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L229)]


```solidity
File: src/SmartWallet/ERC1271.sol

69:     function isValidSignature(bytes32 hash, bytes calldata signature) public view virtual returns (bytes4 result) {

```
*Github:* [[69](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L69)]



<a name="NC-54"></a> 
### [NC-54] The remaining ETH may be locked in the contract after call
After calling an external contract and forwards some ETH value, the contract balance should be checked. If there is excess eth left over due to a failed call, or more eth being delivered than needed, or any other reason, this eth must be refunded to the user or handled appropriately, otherwise the eth may be frozen in the contract forever.

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

273:         (bool success, bytes memory result) = target.call{value: value}(data);

```
*Github:* [[273](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L273)]



<a name="NC-55"></a> 
### [NC-55] SPDX identifier should be the in the first line of a solidity file

*There is one instance of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

/// @audit SPDX-License-Identifier
1: //curve order (number of points)

```
*Github:* [[1](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L1)]



<a name="NC-56"></a> 
### [NC-56] State variables should include comments
Consider adding some comments on critical state variables to explain what they are supposed to do: this will help for future code reviews.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

43:     uint256 public constant REPLAYABLE_NONCE_KEY = 8453;

```
*Github:* [[43](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L43)]


```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

15:     address public immutable implementation;

```
*Github:* [[15](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L15)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

36:     bytes32 private constant MUTLI_OWNABLE_STORAGE_LOCATION =

```
*Github:* [[36](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L36)]



<a name="NC-57"></a> 
### [NC-57] Lines are too long
The [solidity style guide](https://docs.soliditylang.org/en/v0.8.17/style-guide.html#maximum-line-length) recommends a maximum line length of 120 characters. Lines of code that are longer than 120 should be wrapped.

*There is one instance of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

170:                     let T4 := mulmod(3, mulmod(addmod(X, sub(p, zz), p), addmod(X, zz, p), p), p) //M=3*(X1-ZZ1)*(X1+ZZ1)

```
*Github:* [[170](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L170)]



<a name="NC-58"></a> 
### [NC-58] Typos

*There are <b>10</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

/// @audit `withraw`
63:     /// @notice Thrown during validation in the context of ERC4337, when the withraw reques amount is insufficient

/// @audit `withdrwable`
87:     /// @dev This should only really occur if for unknown reasons the transfer of the withdrwable

```
*Github:* [[63](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L63), [87](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L87)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

/// @audit `indentifying`
23:         /// @dev The index indentifying owner (see MultiOwnable) who signed.

/// @audit `implemenentation`
122:     /// @notice Custom implemenentation of the ERC-4337 `validateUserOp` method. The EntryPoint will

/// @audit `befor`
174:     /// @dev `validateUserOp()` will recompute the `userOpHash` without the chain ID befor validatin

/// @audit `validatin`
174:     /// @dev `validateUserOp()` will recompute the `userOpHash` without the chain ID befor validatin

```
*Github:* [[23](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L23), [122](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L122), [174](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L174), [174](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L174)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

/// @audit `idenfitied`
10:     /// @dev Mapping of indices to raw owner bytes, used to idenfitied owners by their

/// @audit `intialize`
52:     /// @notice Thrown when trying to intialize the contracts owners if a provided owner is neither

/// @audit `intialize`
58:     /// @notice Thrown when trying to intialize the contracts owners if a provided owner is 32 bytes

/// @audit `intiial`
161:     /// @param owners The intiial list of owners to register.

```
*Github:* [[10](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L10), [52](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L52), [58](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L58), [161](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L161)]



<a name="NC-59"></a> 
### [NC-59] Unsafe solidity low-level call can cause gas grief attack
Using the low-level calls of a solidity address can leave the contract open to gas grief attacks. These attacks occur when the called contract returns a large amount of data. So when calling an external contract, it is necessary to check the length of the return data before reading/copying it (using `returndatasize()`).

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

273:         (bool success, bytes memory result) = target.call{value: value}(data);

```
*Github:* [[273](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L273)]



<a name="NC-60"></a> 
### [NC-60] Unused `error` definition
The following `error`s are defined but not used. It is recommended to check the code for logical omissions that cause them not to be used. If it's determined that they are not needed anywhere, it's best to remove them from the codebase to improve code clarity and minimize confusion. Note that there may be cases where an error appears to be used because it has multiple definitions in different files. In such cases, the definitions should be moved to a separate file.

*There is one instance of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

90:     error UnexpectedPostOpRevertedMode();

```
*Github:* [[90](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L90)]



<a name="NC-61"></a> 
### [NC-61] Unused arguments should be removed or implemented
Some arguments are never used: if this is intentional, consider removing these arguments from the function. Otherwise, implement the missing logic accordingly.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

/// @audit `missingAccountFunds`
137:     function validateUserOp(UserOperation calldata userOp, bytes32 userOpHash, uint256 missingAccountFunds)

```
*Github:* [[137](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L137)]


```solidity
File: src/SmartWallet/ERC1271.sol

/// @audit `message`
/// @audit `signature`
155:     function _validateSignature(bytes32 message, bytes calldata signature) internal view virtual returns (bool);

```
*Github:* [[155](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L155)]



<a name="NC-62"></a> 
### [NC-62] Unused named return
Declaring named returns, but not using them, is confusing to the reader. Consider either completely removing them (by declaring just the type without a name), or remove the return statement and do a variable assignment. This would improve the readability of the code, and it may also help reduce regressions during future code refactors.

*There are <b>5</b> instances of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

/// @audit `flag` not used
293:     function ecAff_IsZero(uint256, uint256 y) internal pure returns (bool flag) {

```
*Github:* [[293](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L293)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

/// @audit `validationData` not used
137:     function validateUserOp(UserOperation calldata userOp, bytes32 userOpHash, uint256 missingAccountFunds)
             public
             payable
             virtual
             onlyEntryPoint
             payPrefund(missingAccountFunds)
             returns (uint256 validationData)
         {

/// @audit `userOpHash` not used
229:     function getUserOpHashWithoutChainId(UserOperation calldata userOp)
             public
             view
             virtual
             returns (bytes32 userOpHash)
         {

```
*Github:* [[137](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L137), [229](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L229)]


```solidity
File: src/SmartWallet/ERC1271.sol

/// @audit `result` not used
69:     function isValidSignature(bytes32 hash, bytes calldata signature) public view virtual returns (bytes4 result) {

```
*Github:* [[69](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L69)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

/// @audit `$` not used
212:     function _getMultiOwnableStorage() internal pure returns (MultiOwnableStorage storage $) {
             assembly ("memory-safe") {

```
*Github:* [[212](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L212)]



<a name="NC-63"></a> 
### [NC-63] Unused contract variables
The following state variables are defined but not used. It is recommended to check the code for logical omissions that cause them not to be used. If it's determined that they are not needed anywhere, it's best to remove them from the codebase to improve code clarity and minimize confusion.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

29:     address constant MODEXP_PRECOMPILE = 0x0000000000000000000000000000000000000005;

44:     uint256 constant minus_2modn = 0xFFFFFFFF00000000FFFFFFFFFFFFFFFFBCE6FAADA7179E84F3B9CAC2FC63254F;

```
*Github:* [[29](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L29), [44](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L44)]



<a name="NC-64"></a> 
### [NC-64] Solidity compiler version is not fixed
To prevent the actual contracts deployed from behaving differently depending on the compiler version, it is recommended to use a fixed solidity version.

*There are <b>6</b> instances of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

24: pragma solidity >=0.8.19 <0.9.0;

```
*Github:* [[24](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L24)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

2: pragma solidity ^0.8.23;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L2)]


```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

2: pragma solidity ^0.8.4;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L2)]


```solidity
File: src/SmartWallet/ERC1271.sol

2: pragma solidity ^0.8.4;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L2)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

2: pragma solidity ^0.8.4;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L2)]


```solidity
File: src/WebAuthnSol/WebAuthn.sol

2: pragma solidity ^0.8.0;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L2)]



<a name="NC-65"></a> 
### [NC-65] Expressions for constant values should use `immutable` rather than `constant`
While it doesn't save any gas because the compiler knows that developers often make this mistake, it's still best to use the right tool for the task at hand. There is a difference between `constant` variables and `immutable` variables, and they should each be used in their appropriate contexts. `constants` should be used for literal values written into the code, and `immutable` variables should be used for expressions, or values calculated in, or passed into the constructor.

<details>
<summary>
There are <b>18</b> instances (click to show):
</summary>

```solidity
File: src/FreshCryptoLib/FCL.sol

29:     address constant MODEXP_PRECOMPILE = 0x0000000000000000000000000000000000000005;

31:     uint256 constant p = 0xFFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF;

33:     uint256 constant a = 0xFFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFC;

35:     uint256 constant b = 0x5AC635D8AA3A93E7B3EBBD55769886BC651D06B0CC53B0F63BCE3C3E27D2604B;

37:     uint256 constant gx = 0x6B17D1F2E12C4247F8BCE6E563A440F277037D812DEB33A0F4A13945D898C296;

38:     uint256 constant gy = 0x4FE342E2FE1A7F9B8EE7EB4A7C0F9E162BCE33576B315ECECBB6406837BF51F5;

40:     uint256 constant n = 0xFFFFFFFF00000000FFFFFFFFFFFFFFFFBCE6FAADA7179E84F3B9CAC2FC632551;

42:     uint256 constant minus_2 = 0xFFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFD;

44:     uint256 constant minus_2modn = 0xFFFFFFFF00000000FFFFFFFFFFFFFFFFBCE6FAADA7179E84F3B9CAC2FC63254F;

46:     uint256 constant minus_1 = 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF;

```
*Github:* [[29](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L29), [31](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L31), [33](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L33), [35](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L35), [37](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L37), [38](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L38), [40](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L40), [42](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L42), [44](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L44), [46](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L46)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

43:     uint256 public constant REPLAYABLE_NONCE_KEY = 8453;

```
*Github:* [[43](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L43)]


```solidity
File: src/SmartWallet/ERC1271.sol

23:     bytes32 private constant _MESSAGE_TYPEHASH = keccak256("CoinbaseSmartWalletMessage(bytes32 hash)");

```
*Github:* [[23](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L23)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

36:     bytes32 private constant MUTLI_OWNABLE_STORAGE_LOCATION =

```
*Github:* [[36](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L36)]


```solidity
File: src/WebAuthnSol/WebAuthn.sol

40:     bytes1 private constant AUTH_DATA_FLAGS_UP = 0x01;

44:     bytes1 private constant AUTH_DATA_FLAGS_UV = 0x04;

47:     uint256 private constant P256_N_DIV_2 = FCL.n / 2;

51:     address private constant VERIFIER = address(0x100);

55:     bytes32 private constant EXPECTED_TYPE_HASH = keccak256('"type":"webauthn.get"');

```
*Github:* [[40](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L40), [44](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L44), [47](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L47), [51](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L51), [55](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L55)]


</details>


<a name="NC-66"></a> 
### [NC-66] Upgrade `openzeppelin` to the latest version (`5.0.2`)
These contracts import contracts from openzeppelin contracts but they are not using the latest version. For more information, please visit: [OpenZeppelin GitHub Releases](https://github.com/OpenZeppelin/openzeppelin-contracts/releases) It is recommended to always use the latest version to take advantage of updates and security fixes.

*There is one instance of this issue:*
```solidity

Global finding

```
*Github:* [[Global](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/)]



<a name="NC-67"></a> 
### [NC-67] Use the latest solidity version for deployment (`0.8.25`)
Upgrading to a newer Solidity release can optimize gas usage, take advantage of new features and improve overall contract efficiency. Where possible, based on compatibility requirements, it is recommended to use newer/latest solidity version to take advantage of the latest optimizations and features.

*There are <b>7</b> instances of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

24: pragma solidity >=0.8.19 <0.9.0;

```
*Github:* [[24](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L24)]


```solidity
File: src/MagicSpend/MagicSpend.sol

2: pragma solidity 0.8.23;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L2)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

2: pragma solidity ^0.8.23;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L2)]


```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

2: pragma solidity ^0.8.4;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L2)]


```solidity
File: src/SmartWallet/ERC1271.sol

2: pragma solidity ^0.8.4;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L2)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

2: pragma solidity ^0.8.4;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L2)]


```solidity
File: src/WebAuthnSol/WebAuthn.sol

2: pragma solidity ^0.8.0;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L2)]



<a name="NC-68"></a> 
### [NC-68] Use the Modern Upgradeable Contract Paradigm
Modern smart contract development often employs upgradeable contract structures, utilizing proxy patterns like OpenZeppelin’s Upgradeable Contracts. This paradigm separates logic and state, allowing developers to amend and enhance the contract's functionality without altering its state or the deployed contract address. Transitioning to this approach enhances long-term maintainability.

Resolution: Adopt a well-established proxy pattern for upgradeability, ensuring proper initialization and employing transparent proxies to mitigate potential risks. Embrace comprehensive testing and audit practices, particularly when updating contract logic, to ensure state consistency and security are preserved across upgrades. This ensures your contract remains robust and adaptable to future requirements.

*There are <b>4</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

18: contract MagicSpend is Ownable, IPaymaster {

```
*Github:* [[18](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L18)]


```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

13: contract CoinbaseSmartWalletFactory {

```
*Github:* [[13](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L13)]


```solidity
File: src/SmartWallet/ERC1271.sol

16: abstract contract ERC1271 {

```
*Github:* [[16](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L16)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

32: contract MultiOwnable {

```
*Github:* [[32](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L32)]



<a name="NC-69"></a> 
### [NC-69] Consider using modifiers for address control
Modifiers in Solidity can improve code readability and modularity by encapsulating repetitive checks, such as address validity checks, into a reusable construct. For example, an `onlyOwner` modifier can be used to replace repetitive `require(msg.sender == owner)` checks across several functions, reducing code redundancy and enhancing maintainability. To implement, define a modifier with the check, then apply the modifier to relevant functions.

*There are <b>4</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

94:         if (msg.sender != entryPoint()) revert Unauthorized();

```
*Github:* [[94](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L94)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

66:         if (msg.sender != entryPoint()) {

75:         if (msg.sender != entryPoint()) {

```
*Github:* [[66](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L66), [75](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L75)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

202:         if (isOwnerAddress(msg.sender) || (msg.sender == address(this))) {

```
*Github:* [[202](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L202)]



<a name="NC-70"></a> 
### [NC-70] Returning a struct instead of a bunch of variables is better
If a function returns [too many variables](https://docs.soliditylang.org/en/v0.8.21/contracts.html#returning-multiple-values), replacing them with a struct can improve code readability, maintainability and reusability.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

/// @audit 4 return variables
318:     function ecZZ_Dbl(uint256 x, uint256 y, uint256 zz, uint256 zzz)
             internal
             pure
             returns (uint256 P0, uint256 P1, uint256 P2, uint256 P3)
         {

/// @audit 4 return variables
344:     function ecZZ_AddN(uint256 x1, uint256 y1, uint256 zz1, uint256 zzz1, uint256 x2, uint256 y2)
             internal
             pure
             returns (uint256 P0, uint256 P1, uint256 P2, uint256 P3)
         {

```
*Github:* [[318](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L318), [344](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L344)]


```solidity
File: src/SmartWallet/ERC1271.sol

/// @audit 7 return variables
36:     function eip712Domain()
            external
            view
            virtual
            returns (
                bytes1 fields,
                string memory name,
                string memory version,
                uint256 chainId,
                address verifyingContract,
                bytes32 salt,
                uint256[] memory extensions
            )
        {

```
*Github:* [[36](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L36)]



<a name="NC-71"></a> 
### [NC-71] Common functions should be refactored to a common base contract
The functions below have the same implementation as is seen in other files. The functions should be refactored into functions of a common base contract.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

/// @audit seen in src/SmartWallet/CoinbaseSmartWallet.sol
304:     function entryPoint() public pure returns (address) {

```
*Github:* [[304](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L304)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

/// @audit seen in src/MagicSpend/MagicSpend.sol
217:     function entryPoint() public view virtual returns (address) {

```
*Github:* [[217](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L217)]



<a name="NC-72"></a> 
### [NC-72] Empty body - Consider commenting why

*There are <b>4</b> instances of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

144:                 } {}

164:                 for {} gt(minus_1, index) { index := sub(index, 1) } {

```
*Github:* [[144](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L144), [164](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L164)]


```solidity
File: src/MagicSpend/MagicSpend.sol

106:     receive() external payable {}

```
*Github:* [[106](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L106)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

330:     function _authorizeUpgrade(address) internal view virtual override(UUPSUpgradeable) onlyOwner {}

```
*Github:* [[330](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L330)]



<a name="NC-73"></a> 
### [NC-73] Names of `private`/`internal` functions should be prefixed with an underscore
It is recommended by the [Solidity Style Guide](https://docs.soliditylang.org/en/v0.8.20/style-guide.html#underscore-prefix-for-non-external-functions-and-variables)

<details>
<summary>
There are <b>11</b> instances (click to show):
</summary>

```solidity
File: src/FreshCryptoLib/FCL.sol

50:     function ecdsa_verify(bytes32 message, uint256 r, uint256 s, uint256 Qx, uint256 Qy) internal view returns (bool) {

78:     function ecAff_isOnCurve(uint256 x, uint256 y) internal pure returns (bool) {

94:     function FCL_nModInv(uint256 u) internal view returns (uint256 result) {

117:     function ecZZ_mulmuladd_S_asm(
             uint256 Q0,
             uint256 Q1, //affine rep for input point Q
             uint256 scalar_u,
             uint256 scalar_v
         ) internal view returns (uint256 X) {

274:     function ecAff_add(uint256 x0, uint256 y0, uint256 x1, uint256 y1) internal view returns (uint256, uint256) {

293:     function ecAff_IsZero(uint256, uint256 y) internal pure returns (bool flag) {

301:     function ecZZ_SetAff(uint256 x, uint256 y, uint256 zz, uint256 zzz)
             internal
             view
             returns (uint256 x1, uint256 y1)
         {

318:     function ecZZ_Dbl(uint256 x, uint256 y, uint256 zz, uint256 zzz)
             internal
             pure
             returns (uint256 P0, uint256 P1, uint256 P2, uint256 P3)
         {

344:     function ecZZ_AddN(uint256 x1, uint256 y1, uint256 zz1, uint256 zzz1, uint256 x2, uint256 y2)
             internal
             pure
             returns (uint256 P0, uint256 P1, uint256 P2, uint256 P3)
         {

374:     function FCL_pModInv(uint256 u) internal view returns (uint256 result) {

```
*Github:* [[50](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L50), [78](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L78), [94](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L94), [117](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L117), [274](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L274), [293](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L293), [301](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L301), [318](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L318), [344](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L344), [374](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L374)]


```solidity
File: src/WebAuthnSol/WebAuthn.sol

104:     function verify(bytes memory challenge, bool requireUV, WebAuthnAuth memory webAuthnAuth, uint256 x, uint256 y)
             internal
             view
             returns (bool)
         {
             if (webAuthnAuth.s > P256_N_DIV_2) {

```
*Github:* [[104](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L104)]


</details>


<a name="NC-74"></a> 
### [NC-74] Names of `private`/`internal` state variables should be prefixed with an underscore
It is recommended by the [Solidity Style Guide](https://docs.soliditylang.org/en/v0.8.20/style-guide.html#underscore-prefix-for-non-external-functions-and-variables)

<details>
<summary>
There are <b>16</b> instances (click to show):
</summary>

```solidity
File: src/FreshCryptoLib/FCL.sol

29:     address constant MODEXP_PRECOMPILE = 0x0000000000000000000000000000000000000005;

31:     uint256 constant p = 0xFFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFF;

33:     uint256 constant a = 0xFFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFC;

35:     uint256 constant b = 0x5AC635D8AA3A93E7B3EBBD55769886BC651D06B0CC53B0F63BCE3C3E27D2604B;

37:     uint256 constant gx = 0x6B17D1F2E12C4247F8BCE6E563A440F277037D812DEB33A0F4A13945D898C296;

38:     uint256 constant gy = 0x4FE342E2FE1A7F9B8EE7EB4A7C0F9E162BCE33576B315ECECBB6406837BF51F5;

40:     uint256 constant n = 0xFFFFFFFF00000000FFFFFFFFFFFFFFFFBCE6FAADA7179E84F3B9CAC2FC632551;

42:     uint256 constant minus_2 = 0xFFFFFFFF00000001000000000000000000000000FFFFFFFFFFFFFFFFFFFFFFFD;

44:     uint256 constant minus_2modn = 0xFFFFFFFF00000000FFFFFFFFFFFFFFFFBCE6FAADA7179E84F3B9CAC2FC63254F;

46:     uint256 constant minus_1 = 0xFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF;

```
*Github:* [[29](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L29), [31](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L31), [33](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L33), [35](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L35), [37](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L37), [38](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L38), [40](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L40), [42](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L42), [44](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L44), [46](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L46)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

36:     bytes32 private constant MUTLI_OWNABLE_STORAGE_LOCATION =

```
*Github:* [[36](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L36)]


```solidity
File: src/WebAuthnSol/WebAuthn.sol

40:     bytes1 private constant AUTH_DATA_FLAGS_UP = 0x01;

44:     bytes1 private constant AUTH_DATA_FLAGS_UV = 0x04;

47:     uint256 private constant P256_N_DIV_2 = FCL.n / 2;

51:     address private constant VERIFIER = address(0x100);

55:     bytes32 private constant EXPECTED_TYPE_HASH = keccak256('"type":"webauthn.get"');

```
*Github:* [[40](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L40), [44](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L44), [47](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L47), [51](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L51), [55](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L55)]


</details>


<a name="NC-75"></a> 
### [NC-75] Internal function calls within for loops
Making function calls or external calls within loops in Solidity can lead to inefficient gas usage, potential bottlenecks, and increased vulnerability to attacks. Each function call or external call consumes gas, and when executed within a loop, the gas cost multiplies, potentially causing the transaction to run out of gas or exceed block gas limits. This can result in transaction failure or unpredictable behavior.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

/// @audit `_call`
206:         for (uint256 i; i < calls.length;) {

```
*Github:* [[206](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L206)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

/// @audit `_addOwnerAtIndex`
/// @audit `_getMultiOwnableStorage`
163:         for (uint256 i; i < owners.length; i++) {

```
*Github:* [[163](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L163)]



<a name="NC-76"></a> 
### [NC-76] Variables should be named in mixedCase style
As the [Solidity Style Guide](https://docs.soliditylang.org/en/latest/style-guide.html#naming-styles) suggests: `arguments`, `local variables` and `mutable state variables` should be named in mixedCase style.

<details>
<summary>
There are <b>12</b> instances (click to show):
</summary>

```solidity
File: src/FreshCryptoLib/FCL.sol

/// @audit `Qx`
/// @audit `Qy`
50:     function ecdsa_verify(bytes32 message, uint256 r, uint256 s, uint256 Qx, uint256 Qy) internal view returns (bool) {

/// @audit `LHS`
83:             uint256 LHS = mulmod(y, y, p); // y^2

/// @audit `RHS`
84:             uint256 RHS = addmod(mulmod(mulmod(x, x, p), x, p), mulmod(x, a, p), p); // x^3+ax

/// @audit `Q0`
/// @audit `Q1`
117:     function ecZZ_mulmuladd_S_asm(

/// @audit `Q0`
118:         uint256 Q0,

/// @audit `Q1`
119:         uint256 Q1, //affine rep for input point Q

/// @audit `X`
122:     ) internal view returns (uint256 X) {

/// @audit `Y`
125:         uint256 Y;

/// @audit `H0`
127:         uint256 H0;

/// @audit `H1`
128:         uint256 H1;

/// @audit `P0`
321:         returns (uint256 P0, uint256 P1, uint256 P2, uint256 P3)

/// @audit `P0`
347:         returns (uint256 P0, uint256 P1, uint256 P2, uint256 P3)

```
*Github:* [[50](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L50), [83](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L83), [84](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L84), [117](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L117), [118](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L118), [119](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L119), [122](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L122), [125](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L125), [127](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L127), [128](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L128), [321](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L321), [347](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L347)]


</details>


<a name="NC-77"></a> 
### [NC-77] Event is missing `indexed` fields
Index event fields make the field more quickly accessible to off-chain tools that parse events. However, note that each index field costs extra gas during emission, so it's not necessarily best to index the maximum allowed per event (three fields). Each event should use three indexed fields if there are three or more fields, and gas usage is not particularly of concern for the events in question. If there are fewer than three fields, all of the fields should be indexed.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

45:     event MagicSpendWithdrawal(address indexed account, address indexed asset, uint256 amount, uint256 nonce);

```
*Github:* [[45](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L45)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

68:     event AddOwner(uint256 indexed index, bytes owner);

74:     event RemoveOwner(uint256 indexed index, bytes owner);

```
*Github:* [[68](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L68), [74](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L74)]



<a name="NC-78"></a> 
### [NC-78] Unspecific compiler version pragma

*There is one instance of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

24: pragma solidity >=0.8.19 <0.9.0;

```
*Github:* [[24](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L24)]



<a name="NC-79"></a> 
### [NC-79] Functions not used internally could be marked `external`

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

241:     function implementation() public view returns (address $) {

```
*Github:* [[241](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L241)]



<a name="NC-80"></a> 
### [NC-80] Default address(0) can be returned
Allowing a function in Solidity to return the default address (address(0)) can be problematic as it can represent uninitialized or invalid addresses. If such an address is utilized in transfer operations or other sensitive actions, it could lead to loss of funds or unpredicted behavior. It's prudent to include checks in your functions to prevent the return of the zero address, enhancing contract security.

*There are <b>5</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

/// @audit `address `
304:     function entryPoint() public pure returns (address) {

```
*Github:* [[304](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L304)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

/// @audit `address `
217:     function entryPoint() public view virtual returns (address) {

/// @audit `address $`
241:     function implementation() public view returns (address $) {

```
*Github:* [[217](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L217), [241](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L241)]


```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

/// @audit `address predicted`
64:     function getAddress(bytes[] calldata owners, uint256 nonce) external view returns (address predicted) {

```
*Github:* [[64](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L64)]


```solidity
File: src/SmartWallet/ERC1271.sol

/// @audit `address verifyingContract`
36:     function eip712Domain()
            external
            view
            virtual
            returns (
                bytes1 fields,
                string memory name,
                string memory version,
                uint256 chainId,
                address verifyingContract,
                bytes32 salt,
                uint256[] memory extensions
            )
        {

```
*Github:* [[36](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L36)]



<a name="NC-81"></a> 
### [NC-81] Payable functions which do not interact with the native token should not be payable
In Ethereum, a function marked `payable` can accept Ether. If a function is intended to work with Ether but isn't marked payable, it will reject any Ether sent to it, leading to failed transactions. Conversely, if a function doesn't involve Ether transactions but is mistakenly marked payable, it can inadvertently accept Ether, potentially locking it in the contract. Thus, functions that should handle Ether transfers must be correctly marked payable, and those that shouldn't must be non-payable. Proper function designation ensures the intended flow of Ether and guards against unintended Ether reception or loss.

*There are <b>7</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

212:     function entryPointDeposit(uint256 amount) external payable onlyOwner {

232:     function entryPointAddStake(uint256 amount, uint32 unstakeDelaySeconds) external payable onlyOwner {

```
*Github:* [[212](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L212), [232](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L232)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

114:     function initialize(bytes[] calldata owners) public payable virtual {

137:     function validateUserOp(UserOperation calldata userOp, bytes32 userOpHash, uint256 missingAccountFunds)
             public
             payable
             virtual
             onlyEntryPoint
             payPrefund(missingAccountFunds)
             returns (uint256 validationData)
         {

180:     function executeWithoutChainIdValidation(bytes calldata data) public payable virtual onlyEntryPoint {

196:     function execute(address target, uint256 value, bytes calldata data) public payable virtual onlyEntryPointOrOwner {

205:     function executeBatch(Call[] calldata calls) public payable virtual onlyEntryPointOrOwner {

```
*Github:* [[114](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L114), [137](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L137), [180](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L180), [196](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L196), [205](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L205)]



<a name="NC-82"></a> 
### [NC-82] Use `using` keyword when using specific imports rather than calling the specific import directly
In Solidity, the `using` keyword can streamline the use of library functions for specific types. Instead of calling library functions directly with their full import paths, you can declare a library once with `using` for a specific type. This approach makes your code more readable and concise. For example, instead of `LibraryName.functionName(variable)`, you would first declare `using LibraryName for TypeName;` at the contract level. After this, you can call library functions directly on variables of `TypeName` like `variable.functionName()`. This method not only enhances code clarity but also promotes cleaner and more organized code, especially when multiple functions from the same library are used frequently.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

/// @audit `WebAuthn`
319:             WebAuthn.WebAuthnAuth memory auth = abi.decode(sigWrapper.signatureData, (WebAuthn.WebAuthnAuth));

/// @audit `WebAuthn`
321:             return WebAuthn.verify({challenge: abi.encode(message), requireUV: false, webAuthnAuth: auth, x: x, y: y});

```
*Github:* [[319](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L319), [321](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L321)]




## Gas Optimizations

<a name="GAS-1"></a> 
### [GAS-1] Optimize gas by using do-while loops
Using `do-while` loops instead of `for` loops can be more gas-efficient. Even if you add an `if` condition to account for the case where the loop doesn't execute at all, a `do-while` loop can still be cheaper in terms of gas.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

206:         for (uint256 i; i < calls.length;) {

```
*Github:* [[206](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L206)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

163:         for (uint256 i; i < owners.length; i++) {

```
*Github:* [[163](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L163)]



<a name="GAS-2"></a> 
### [GAS-2] Multiple `address`/ID mappings can be combined into a single `mapping` of an `address`/ID to a `struct`, where appropriate
Saves a storage slot for the mapping. Depending on the circumstances and sizes of types, can avoid a Gsset (20000 gas) per mapping combined. Reads and subsequent writes can also be cheaper when a function requires both values and they both fit in the same storage slot. Finally, if both fields are accessed in the same function, can save ~42 gas per access due to not having to [recalculate the key's keccak256 hash](https://gist.github.com/IllIllI000/ec23a57daa30a8f8ca8b9681c8ccefb0) (Gkeccak256 - 30 gas) and that calculation's associated stack operations.

*There is one instance of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

37:     mapping(uint256 nonce => mapping(address user => bool used)) internal _nonceUsed;

```
*Github:* [[37](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L37)]



<a name="GAS-3"></a> 
### [GAS-3] Consider activating via-ir for deploying
By using `--via-ir` or `{"viaIR": true}`, the compiler is able to use more advanced [multi-function optimizations](https://docs.soliditylang.org/en/v0.8.17/ir-breaking-changes.html#solidity-ir-based-codegen-changes), for extra gas savings.

*There is one instance of this issue:*
```solidity

Global finding

```
*Github:* [[Global](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/)]



<a name="GAS-4"></a> 
### [GAS-4] Counting down in for statements is more gas efficient
Looping downwards in Solidity is more gas efficient due to how the EVM compares variables. In a 'for' loop that counts down, the end condition is usually to compare with zero, which is cheaper than comparing with another number. As such, restructure your loops to count downwards where possible.

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/MultiOwnable.sol

163:         for (uint256 i; i < owners.length; i++) {

```
*Github:* [[163](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L163)]



<a name="GAS-5"></a> 
### [GAS-5] Divisions can be `unchecked` to save gas
The expression `type(int).min/(-1)` is the only case where division causes an overflow. Therefore, uncheck can be used to [save gas](https://gist.github.com/DadeKuma/3bc597338ae774b8b3bd43280d55271f) in scenarios where it is certain that such an overflow will not occur.

*There is one instance of this issue:*
```solidity
File: src/WebAuthnSol/WebAuthn.sol

47:     uint256 private constant P256_N_DIV_2 = FCL.n / 2;

```
*Github:* [[47](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L47)]



<a name="GAS-6"></a> 
### [GAS-6] Do not calculate constants
Due to how constant variables are implemented (replacements at compile-time), an expression assigned to a constant variable is recomputed each time that the variable is used, which wastes some gas.

*There is one instance of this issue:*
```solidity
File: src/WebAuthnSol/WebAuthn.sol

47:     uint256 private constant P256_N_DIV_2 = FCL.n / 2;

```
*Github:* [[47](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L47)]



<a name="GAS-7"></a> 
### [GAS-7] Duplicated `require()`/`revert()` checks should be refactored to a modifier or function to save gas
Saves deployment costs.

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

/// @audit duplicated on line 155
151:                 revert InvalidNonceKey(key);

```
*Github:* [[151](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L151)]



<a name="GAS-8"></a> 
### [GAS-8] Increments can be `unchecked` to save gas
Using `unchecked` increments can save gas by bypassing the built-in overflow checks. This can save 30-40 gas per iteration. So it is recommended to use unchecked increments when overflow is not possible.

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/MultiOwnable.sol

163:         for (uint256 i; i < owners.length; i++) {

```
*Github:* [[163](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L163)]



<a name="GAS-9"></a> 
### [GAS-9] Initializers can be marked as payable to save deployment gas
Payable functions cost less gas to execute, because the compiler does not have to add extra checks to ensure that no payment is provided. Initializers can be safely marked as payable, because only the deployer or the factory contract would call the function without carrying any funds.

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

114:     function initialize(bytes[] calldata owners) public payable virtual {

```
*Github:* [[114](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L114)]



<a name="GAS-10"></a> 
### [GAS-10] Inline `modifier`s that are only used once, to save gas

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

91:     modifier payPrefund(uint256 missingAccountFunds) virtual {

```
*Github:* [[91](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L91)]



<a name="GAS-11"></a> 
### [GAS-11] `internal` functions only called once can be inlined to save gas
If an `internal` function is only used once, there is no need to modularize it, unless the function calling it would otherwise be too long and complex. Not inlining costs 20 to 40 gas because of two extra JUMP instructions and additional stack operations needed for function calls.

*There are <b>10</b> instances of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

/// @audit `ecAff_isOnCurve` is used only once
78:     function ecAff_isOnCurve(uint256 x, uint256 y) internal pure returns (bool) {

/// @audit `FCL_nModInv` is used only once
94:     function FCL_nModInv(uint256 u) internal view returns (uint256 result) {

/// @audit `ecZZ_mulmuladd_S_asm` is used only once
117:     function ecZZ_mulmuladd_S_asm(

/// @audit `ecAff_add` is used only once
274:     function ecAff_add(uint256 x0, uint256 y0, uint256 x1, uint256 y1) internal view returns (uint256, uint256) {

/// @audit `ecZZ_SetAff` is used only once
301:     function ecZZ_SetAff(uint256 x, uint256 y, uint256 zz, uint256 zzz)

/// @audit `ecZZ_Dbl` is used only once
318:     function ecZZ_Dbl(uint256 x, uint256 y, uint256 zz, uint256 zzz)

/// @audit `ecZZ_AddN` is used only once
344:     function ecZZ_AddN(uint256 x1, uint256 y1, uint256 zz1, uint256 zzz1, uint256 x2, uint256 y2)

/// @audit `FCL_pModInv` is used only once
374:     function FCL_pModInv(uint256 u) internal view returns (uint256 result) {

```
*Github:* [[78](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L78), [94](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L94), [117](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L117), [274](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L274), [301](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L301), [318](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L318), [344](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L344), [374](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L374)]


```solidity
File: src/SmartWallet/ERC1271.sol

/// @audit `_eip712Hash` is used only once
121:     function _eip712Hash(bytes32 hash) internal view virtual returns (bytes32) {

/// @audit `_hashStruct` is used only once
133:     function _hashStruct(bytes32 hash) internal view virtual returns (bytes32) {

```
*Github:* [[121](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L121), [133](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L133)]



<a name="GAS-12"></a> 
### [GAS-12] `keccak256()` hash of literals should only be computed once
The result of the hash should be stored in an immutable variable, and the variable should be used instead. If the hash is being used as a part of a function selector, the cast to `bytes4` should also only be done once.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/SmartWallet/ERC1271.sol

23:     bytes32 private constant _MESSAGE_TYPEHASH = keccak256("CoinbaseSmartWalletMessage(bytes32 hash)");

104:                 keccak256("EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)"),

```
*Github:* [[23](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L23), [104](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L104)]



<a name="GAS-13"></a> 
### [GAS-13] Low level `call` can be optimized with assembly
When using low-level calls, the `returnData` is copied to memory even if the variable is not utilized. The proper way to handle this is through a low level assembly call.

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

273:         (bool success, bytes memory result) = target.call{value: value}(data);

```
*Github:* [[273](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L273)]



<a name="GAS-14"></a> 
### [GAS-14] Multiple accesses of the same mapping/array key/index should be cached
The instances below point to the second+ access of a value inside a mapping/array, within a function. Caching a mapping's value in a local `storage` or `calldata` variable when the value is accessed [multiple times](https://gist.github.com/IllIllI000/ec23a57daa30a8f8ca8b9681c8ccefb0), saves ~42 gas per access due to not having to recalculate the key's keccak256 hash (Gkeccak256 - 30 gas) and that calculation's associated stack operations. Caching an array's struct avoids recalculating the array offsets into memory/calldata

*There are <b>3</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

/// @audit `_withdrawableETH[account]` is also accessed on line 156
159:         delete _withdrawableETH[account];

/// @audit `_withdrawableETH[msg.sender]` is also accessed on line 170
174:         delete _withdrawableETH[msg.sender];

/// @audit `_nonceUsed[withdrawRequest.nonce]` is also accessed on line 316
320:         _nonceUsed[withdrawRequest.nonce][account] = true;

```
*Github:* [[159](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L159), [174](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L174), [320](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L320)]



<a name="GAS-15"></a> 
### [GAS-15] Operator `>=`/`<=` costs less gas than operator `>`/`<`
The compiler uses opcodes `GT` and `ISZERO` for code that uses `>`, but only requires `LT` for `>=`. A similar behavior applies for `>`, which uses opcodes `LT` and `ISZERO`, but only requires `GT` for `<=`. It can save 3 gas for each. It should be converted to the `<=`/`>=` equivalent when comparing against integer literals.

*There are <b>8</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

117:         if (withdrawAmount < maxCost) {

133:         if (address(this).balance < withdrawAmount) {

160:         if (withdrawable > 0) {

188:         if (block.timestamp > withdrawRequest.expiry) {

```
*Github:* [[117](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L117), [133](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L133), [160](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L160), [188](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L188)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

206:         for (uint256 i; i < calls.length;) {

```
*Github:* [[206](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L206)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

163:         for (uint256 i; i < owners.length; i++) {

```
*Github:* [[163](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L163)]


```solidity
File: src/WebAuthnSol/WebAuthn.sol

109:         if (webAuthnAuth.s > P256_N_DIV_2) {

157:         bool valid = ret.length > 0;

```
*Github:* [[109](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L109), [157](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L157)]



<a name="GAS-16"></a> 
### [GAS-16] Optimize names to save gas
`public`/`external` function names and `public` member variable names can be optimized to save gas. See this [link](https://gist.github.com/IllIllI000/a5d8b486a8259f9f77891a919febd1a9) for an example of how it works. Below are the interfaces/abstract contracts that can be optimized so that the most frequently-called functions use the least amount of gas possible during method lookup. Method IDs that have two leading zero bytes can save 128 gas each during deployment, and renaming functions to have lower method IDs will save 22 gas per call, [per sorted position shifted](https://medium.com/joyso/solidity-how-does-function-name-affect-gas-consumption-in-smart-contract-47d270d8ac92)

*There are <b>4</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

/// @audit `validatePaymasterUserOp`, `postOp`, `withdrawGasExcess`, `withdraw`, `ownerWithdraw`, `entryPointDeposit`, `entryPointWithdraw`, `entryPointAddStake`, `entryPointUnlockStake`, `entryPointWithdrawStake`, `isValidWithdrawSignature`, `getHash`, `nonceUsed`, `entryPoint`
18: contract MagicSpend is Ownable, IPaymaster {

```
*Github:* [[18](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L18)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

/// @audit `initialize`, `validateUserOp`, `executeWithoutChainIdValidation`, `execute`, `executeBatch`, `entryPoint`, `getUserOpHashWithoutChainId`, `implementation`, `canSkipChainIdValidation`
20: contract CoinbaseSmartWallet is MultiOwnable, UUPSUpgradeable, Receiver, ERC1271 {

```
*Github:* [[20](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L20)]


```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

/// @audit `createAccount`, `getAddress`, `initCodeHash`
13: contract CoinbaseSmartWalletFactory {

```
*Github:* [[13](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L13)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

/// @audit `addOwnerAddress`, `addOwnerPublicKey`, `removeOwnerAtIndex`, `isOwnerAddress`, `isOwnerPublicKey`, `isOwnerBytes`, `ownerAtIndex`, `nextOwnerIndex`
32: contract MultiOwnable {

```
*Github:* [[32](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L32)]



<a name="GAS-17"></a> 
### [GAS-17] Reduce gas usage by moving to Solidity 0.8.19 or later
Solidity version 0.8.19 introduced a number of gas optimizations, refer to the [Solidity 0.8.19 Release Announcement](https://soliditylang.org/blog/2023/02/22/solidity-0.8.19-release-announcement/) for details.

*There are <b>4</b> instances of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

2: pragma solidity ^0.8.4;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L2)]


```solidity
File: src/SmartWallet/ERC1271.sol

2: pragma solidity ^0.8.4;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L2)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

2: pragma solidity ^0.8.4;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L2)]


```solidity
File: src/WebAuthnSol/WebAuthn.sol

2: pragma solidity ^0.8.0;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L2)]



<a name="GAS-18"></a> 
### [GAS-18] Remove or replace unused state variables
Saves a storage slot. If the variable is assigned a non-zero value, saves Gsset (20000 gas). If it's assigned a zero value, saves Gsreset (2900 gas). If the variable remains unassigned, there is no gas savings unless the variable is `public`, in which case the compiler-generated non-payable getter deployment cost is saved. If the state variable is overriding an interface's public function, mark the variable as `constant` or `immutable` so that it does not use a storage slot.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

29:     address constant MODEXP_PRECOMPILE = 0x0000000000000000000000000000000000000005;

44:     uint256 constant minus_2modn = 0xFFFFFFFF00000000FFFFFFFFFFFFFFFFBCE6FAADA7179E84F3B9CAC2FC63254F;

```
*Github:* [[29](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L29), [44](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L44)]



<a name="GAS-19"></a> 
### [GAS-19] The result of a function call should be cached rather than re-calling the function
The function calls in solidity are expensive. If the same result of the same function calls are to be used several times, the result should be cached to reduce the gas consumption of repeated calls.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

/// @audit `ecAff_IsZero` is called 2 times
274:     function ecAff_add(uint256 x0, uint256 y0, uint256 x1, uint256 y1) internal view returns (uint256, uint256) {

```
*Github:* [[274](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L274)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

/// @audit `_getMultiOwnableStorage` is called 2 times
102:     function removeOwnerAtIndex(uint256 index) public virtual onlyOwner {
             bytes memory owner = ownerAtIndex(index);

/// @audit `_getMultiOwnableStorage` is called 2 times
189:     function _addOwnerAtIndex(bytes memory owner, uint256 index) internal virtual {
             if (isOwnerBytes(owner)) revert AlreadyOwner(owner);

```
*Github:* [[102](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L102), [189](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L189)]



<a name="GAS-20"></a> 
### [GAS-20] There are comparisons to boolean literals (true and false), these can be simplified to save gas
In such instances you can simplify as follows: if ( == true) ==> if () | if ( == false) ==> if (!)

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

53:         if (alreadyDeployed == false) {

```
*Github:* [[53](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L53)]



<a name="GAS-21"></a> 
### [GAS-21] Use smaller sizes for struct variables if possible
In Solidity, each storage slot has a size of 32 bytes. If a struct contains multiple uint values, it's efficient to pack these into as few storage slots as possible to optimize gas usage. The EVM (Ethereum Virtual Machine) charges gas for each storage operation, so minimizing the number of slots used can result in substantial gas savings. This can be achieved by ordering struct fields according to their size or by using smaller data types where possible. However, developers must balance these optimizations with the need for code clarity and the precision requirements of their application. Always ensure that data packing does not compromise the functionality or security of the contract.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

/// @audit `amount`
/// @audit `nonce`
20:     struct WithdrawRequest {
            /// @dev The signature associated with this withdraw request.
            bytes signature;
            /// @dev The asset to withdraw. NOTE: Only ETH (associated with zero address) is supported for now.
            address asset;
            /// @dev The requested amount to withdraw.
            uint256 amount;
            /// @dev Unique nonce used to prevent replays.
            uint256 nonce;
            /// @dev The maximum expiry the withdraw request remains valid for.
            uint48 expiry;

```
*Github:* [[20](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L20)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

/// @audit `ownerIndex`
22:     struct SignatureWrapper {
            /// @dev The index indentifying owner (see MultiOwnable) who signed.
            uint256 ownerIndex;
            /// @dev An ABI encoded ECDSA signature (r, s, v) or WebAuthnAuth struct.
            bytes signatureData;

/// @audit `value`
30:     struct Call {
            /// @dev The target address to call.
            address target;
            /// @dev The value to associate with the call.
            uint256 value;
            /// @dev The raw call data.
            bytes data;

```
*Github:* [[22](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L22), [30](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L30)]



<a name="GAS-22"></a> 
### [GAS-22] Unlimited gas consumption risk due to external call recipients
When calling an external function without specifying a gas limit , the called contract may consume all the remaining gas, causing the tx to be reverted. To mitigate this, it is recommended to explicitly set a gas limit when making low level external calls.

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

273:         (bool success, bytes memory result) = target.call{value: value}(data);

```
*Github:* [[273](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L273)]



<a name="GAS-23"></a> 
### [GAS-23] Unused named return variables without optimizer waste gas
Consider changing the variable to be an unnamed one, since the variable is never assigned, nor is it returned by name. If the optimizer is not turned on, leaving the code as it is will also waste gas for the stack variable.

*There are <b>5</b> instances of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

/// @audit `flag` not used
293:     function ecAff_IsZero(uint256, uint256 y) internal pure returns (bool flag) {

```
*Github:* [[293](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L293)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

/// @audit `validationData` not used
137:     function validateUserOp(UserOperation calldata userOp, bytes32 userOpHash, uint256 missingAccountFunds)
             public
             payable
             virtual
             onlyEntryPoint
             payPrefund(missingAccountFunds)
             returns (uint256 validationData)
         {

/// @audit `userOpHash` not used
229:     function getUserOpHashWithoutChainId(UserOperation calldata userOp)
             public
             view
             virtual
             returns (bytes32 userOpHash)
         {

```
*Github:* [[137](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L137), [229](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L229)]


```solidity
File: src/SmartWallet/ERC1271.sol

/// @audit `result` not used
69:     function isValidSignature(bytes32 hash, bytes calldata signature) public view virtual returns (bytes4 result) {

```
*Github:* [[69](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L69)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

/// @audit `$` not used
212:     function _getMultiOwnableStorage() internal pure returns (MultiOwnableStorage storage $) {
             assembly ("memory-safe") {

```
*Github:* [[212](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L212)]



<a name="GAS-24"></a> 
### [GAS-24] Optimize external calls with assembly for memory efficiency
Using interfaces to make external contract calls in Solidity is convenient but can be inefficient in terms of memory utilization. Each such call involves creating a new memory location to store the data being passed, thus incurring memory expansion costs.

Inline assembly allows for optimized memory usage by re-using already allocated memory spaces or using the scratch space for smaller datasets. This can result in notable gas savings, especially for contracts that make frequent external calls.

Additionally, using inline assembly enables important safety checks like verifying if the target address has code deployed to it using `extcodesize(addr)` before making the call, mitigating risks associated with contract interactions.

*There are <b>4</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

/// @audit `.withdrawTo(...)`
223:         IEntryPoint(entryPoint()).withdrawTo(to, amount);

/// @audit `.unlockStake(...)`
240:         IEntryPoint(entryPoint()).unlockStake();

/// @audit `.withdrawStake(...)`
249:         IEntryPoint(entryPoint()).withdrawStake(to);

```
*Github:* [[223](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L223), [240](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L240), [249](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L249)]


```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

/// @audit `.initialize(...)`
54:             account.initialize(owners);

```
*Github:* [[54](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L54)]



<a name="GAS-25"></a> 
### [GAS-25] Use assembly in place of `abi.decode` to extract `calldata` values more efficiently
Instead of using `abi.decode`, we can use assembly to decode our desired calldata values directly. This will allow us to avoid decoding calldata values that we will not use. For more details on how to implement this, check the following [report](https://code4rena.com/reports/2023-05-juicebox#g-04-use-assembly-in-place-of-abidecode-to-extract-calldata-values-more-efficiently).

*There are <b>3</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

114:         WithdrawRequest memory withdrawRequest = abi.decode(userOp.paymasterAndData[20:], (WithdrawRequest));

```
*Github:* [[114](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L114)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

298:         SignatureWrapper memory sigWrapper = abi.decode(signature, (SignatureWrapper));

319:             WebAuthn.WebAuthnAuth memory auth = abi.decode(sigWrapper.signatureData, (WebAuthn.WebAuthnAuth));

```
*Github:* [[298](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L298), [319](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L319)]



<a name="GAS-26"></a> 
### [GAS-26] Use assembly to compute hashes to save gas
If the arguments to the encode call can fit into the scratch space (two words or fewer), then it's more efficient to use assembly to generate the hash (80 gas):

`keccak256(abi.encodePacked(x, y)) -> assembly {mstore(0x00, a); mstore(0x20, b); let hash := keccak256(0x00, 0x40); }`

<details>
<summary>
There are <b>13</b> instances (click to show):
</summary>

```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

235:         return keccak256(abi.encode(UserOperationLib.hash(userOp), entryPoint()));

```
*Github:* [[235](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L235)]


```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

82:         salt = keccak256(abi.encode(owners, nonce));

```
*Github:* [[82](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L82)]


```solidity
File: src/SmartWallet/ERC1271.sol

23:     bytes32 private constant _MESSAGE_TYPEHASH = keccak256("CoinbaseSmartWalletMessage(bytes32 hash)");

102:         return keccak256(

104:                 keccak256("EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)"),

105:                 keccak256(bytes(name)),

106:                 keccak256(bytes(version)),

122:         return keccak256(abi.encodePacked("\x19\x01", domainSeparator(), _hashStruct(hash)));

134:         return keccak256(abi.encode(_MESSAGE_TYPEHASH, hash));

```
*Github:* [[23](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L23), [102](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L102), [104](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L104), [105](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L105), [106](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L106), [122](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L122), [134](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L134)]


```solidity
File: src/WebAuthnSol/WebAuthn.sol

55:     bytes32 private constant EXPECTED_TYPE_HASH = keccak256('"type":"webauthn.get"');

117:         if (keccak256(bytes(_type)) != EXPECTED_TYPE_HASH) {

126:         if (keccak256(bytes(actualChallenge)) != keccak256(expectedChallenge)) {

126:         if (keccak256(bytes(actualChallenge)) != keccak256(expectedChallenge)) {

```
*Github:* [[55](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L55), [117](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L117), [126](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L126), [126](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L126)]


</details>


<a name="GAS-27"></a> 
### [GAS-27] Use assembly to emit events
To efficiently emit events, it's possible to utilize assembly by making use of scratch space and the free memory pointer. This approach has the advantage of potentially avoiding the costs associated with memory expansion.

However, it's important to note that in order to safely optimize this process, it is preferable to cache and restore the free memory pointer.

A good example of such practice can be seen in [Solady's](https://github.com/Vectorized/solady/blob/main/src/tokens/ERC1155.sol#L167) codebase.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

323:         emit MagicSpendWithdrawal(account, withdrawRequest.asset, withdrawRequest.amount, withdrawRequest.nonce);

```
*Github:* [[323](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L323)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

109:         emit RemoveOwner(index, owner);

195:         emit AddOwner(index, owner);

```
*Github:* [[109](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L109), [195](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L195)]



<a name="GAS-28"></a> 
### [GAS-28] Use assembly to validate `msg.sender`

*There are <b>4</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

94:         if (msg.sender != entryPoint()) revert Unauthorized();

```
*Github:* [[94](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L94)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

66:         if (msg.sender != entryPoint()) {

75:         if (msg.sender != entryPoint()) {

```
*Github:* [[66](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L66), [75](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L75)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

202:         if (isOwnerAddress(msg.sender) || (msg.sender == address(this))) {

```
*Github:* [[202](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L202)]



<a name="GAS-29"></a> 
### [GAS-29] Use assembly to write address/contract type storage values
Using `assembly { sstore(state.slot, addr)` instead of `state = addr` can save gas.

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

25:         implementation = erc4337;

```
*Github:* [[25](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L25)]



<a name="GAS-30"></a> 
### [GAS-30] Using a double `if` statement instead of a logical AND (`&&`)
Using a double `if` statement instead of a logical AND (`&&`) can provide similar short-circuiting behavior whereas double if is slightly [more gas efficient](https://gist.github.com/DadeKuma/931ce6794a050201ec6544dbcc31316c).

*There are <b>9</b> instances of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

79:         if (((0 == x) && (0 == y)) || x == p || y == p) {

131:             if (scalar_u == 0 && scalar_v == 0) return 0;

135:                 (H0 == 0) && (H1 == 0) //handling Q=-G

280:         if ((x0 == x1) && (y0 == y1)) {

```
*Github:* [[79](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L79), [131](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L131), [135](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L135), [280](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L280)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

148:         if (userOp.callData.length >= 4 && bytes4(userOp.callData[0:4]) == 0xbf6ba1fc) {

```
*Github:* [[148](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L148)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

164:             if (owners[i].length != 32 && owners[i].length != 64) {

168:             if (owners[i].length == 32 && uint256(bytes32(owners[i])) > type(uint160).max) {

```
*Github:* [[164](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L164), [168](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L168)]


```solidity
File: src/WebAuthnSol/WebAuthn.sol

138:         if (requireUV && (webAuthnAuth.authenticatorData[32] & AUTH_DATA_FLAGS_UV) != AUTH_DATA_FLAGS_UV) {

158:         if (success && valid) return abi.decode(ret, (uint256)) == 1;

```
*Github:* [[138](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L138), [158](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L158)]



<a name="GAS-31"></a> 
### [GAS-31] Consider using OZ EnumerateSet in place of nested mappings
Nested mappings and multi-dimensional arrays in Solidity operate through a process of double hashing, wherein the original storage slot and the first key are concatenated and hashed, and then this hash is again concatenated with the second key and hashed. This process can be quite gas expensive due to the double-hashing operation and subsequent storage operation (sstore).

A possible optimization involves manually concatenating the keys followed by a single hash operation and an sstore. However, this technique introduces the risk of storage collision, especially when there are other nested hash maps in the contract that use the same key types. Because Solidity is unaware of the number and structure of nested hash maps in a contract, it follows a conservative approach in computing the storage slot to avoid possible collisions.

OpenZeppelin's EnumerableSet provides a potential solution to this problem. It creates a data structure that combines the benefits of set operations with the ability to enumerate stored elements, which is not natively available in Solidity. EnumerableSet handles the element uniqueness internally and can therefore provide a more gas-efficient and collision-resistant alternative to nested mappings or multi-dimensional arrays in certain scenarios.

*There is one instance of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

37:     mapping(uint256 nonce => mapping(address user => bool used)) internal _nonceUsed;

```
*Github:* [[37](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L37)]



<a name="GAS-32"></a> 
### [GAS-32] Use a more recent version of solidity
- Use a solidity version of at least 0.8.2 to get simple compiler automatic inlining.
- Use a solidity version of at least 0.8.3 to get better struct packing and cheaper multiple storage reads.
- Use a solidity version of at least 0.8.4 to get custom errors, which are cheaper at deployment than revert()/require() strings.
- Use a solidity version of at least 0.8.10 to have external calls skip contract existence checks if the external call has a return value.

*There are <b>7</b> instances of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

24: pragma solidity >=0.8.19 <0.9.0;

```
*Github:* [[24](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L24)]


```solidity
File: src/MagicSpend/MagicSpend.sol

2: pragma solidity 0.8.23;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L2)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

2: pragma solidity ^0.8.23;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L2)]


```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

2: pragma solidity ^0.8.4;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L2)]


```solidity
File: src/SmartWallet/ERC1271.sol

2: pragma solidity ^0.8.4;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L2)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

2: pragma solidity ^0.8.4;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L2)]


```solidity
File: src/WebAuthnSol/WebAuthn.sol

2: pragma solidity ^0.8.0;

```
*Github:* [[2](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L2)]



<a name="GAS-33"></a> 
### [GAS-33] Use != 0 instead of > 0
Replace spotted instances with != 0 for uints as this uses less gas.

*There is one instance of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

160:         if (withdrawable > 0) {

```
*Github:* [[160](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L160)]



<a name="GAS-34"></a> 
### [GAS-34] Use `require` instead of `assert`
Prior to solc 0.8.0, `assert` used the invalid opcode which used up all the remaining gas while `require` used the revert opcode which refunded the gas and therefore the importance of using `require` instead of `assert` was greater. However, after 0.8.0, `assert` uses revert opcode just like `require` but creates a `Panic(uint256)` error instead of Error(string) created by require. Solidity documentation states: 'The assert function generates an error of type Panic(uint256). Code that works properly should never Panic, even on invalid external input. If this happens, you need to fix it in your contract. there's a mistake.

*There is one instance of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

150:         assert(mode != PostOpMode.postOpReverted);

```
*Github:* [[150](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L150)]



<a name="GAS-35"></a> 
### [GAS-35] Use `selfbalance()` instead of `address(this).balance`
Use assembly when getting a contract's balance of ETH.

You can use `selfbalance()` instead of `address(this).balance` when getting your contract's balance of ETH to save gas.
Additionally, you can use `balance(address)` instead of `address.balance()` when getting an external contract's balance of ETH.

*Saves 15 gas when checking internal balance, 6 for external*

*There are <b>2</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

133:         if (address(this).balance < withdrawAmount) {

134:             revert InsufficientBalance(withdrawAmount, address(this).balance);

```
*Github:* [[133](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L133), [134](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L134)]



<a name="GAS-36"></a> 
### [GAS-36] Consider Using Solady's Gas Optimized Lib for Math
In instances where many similar mathematical operations are performed, consider using Solday's math lib to benefit from the gas saving it can introduce.

*There is one instance of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

128:         validationData = (sigFailed ? 1 : 0) | (uint256(withdrawRequest.expiry) << 160);

```
*Github:* [[128](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L128)]



<a name="GAS-37"></a> 
### [GAS-37] Use `uint256(1)`/`uint256(2)` instead of `true`/`false` to save gas for changes
Avoids a Gsset (20000 gas) when changing from false to true, after having been true in the past. Since most of the bools aren't changed twice in one transaction, I've counted the amount of gas as half of the full amount, for each variable.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

37:     mapping(uint256 nonce => mapping(address user => bool used)) internal _nonceUsed;

```
*Github:* [[37](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L37)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

24:     mapping(bytes account => bool isOwner_) isOwner;

```
*Github:* [[24](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L24)]



<a name="GAS-38"></a> 
### [GAS-38] Use `unchecked` block for safe subtractions
If it can be confirmed that the subtraction operation will not overflow, using an unchecked block can save gas. For example, `require(x <= y); z = y - x;` can be optimized to `require(x <= y); unchecked { z = y - x; }`

*There are <b>2</b> instances of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

/// @audit this subtraction is checked on line 51
67:         x1 = addmod(x1, n - r, n);

```
*Github:* [[67](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L67)]


```solidity
File: src/MagicSpend/MagicSpend.sol

/// @audit this subtraction is checked on line 117
138:         _withdrawableETH[userOp.sender] += withdrawAmount - maxCost;

```
*Github:* [[138](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L138)]



<a name="GAS-39"></a> 
### [GAS-39] Using bitmap to store bool states can save gas
Using a bitmap instead of a bool array or a bool mapping to store boolean states can save gas fees. This is because the bitmap can store 256 boolean values in a single slot instead of 256 slots, which can save gas when writing bool values or when reading multiple bool values from the same slot.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

37:     mapping(uint256 nonce => mapping(address user => bool used)) internal _nonceUsed;

```
*Github:* [[37](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L37)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

24:     mapping(bytes account => bool isOwner_) isOwner;

```
*Github:* [[24](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L24)]



<a name="GAS-40"></a> 
### [GAS-40] Using `this` to access functions results in an external call, wasting gas
External calls have an overhead of 100 gas, which can be avoided by not referencing the function using `this`. Contracts are allowed to override their parents' functions and change the visibility from `external` to `public`, so make this change if it's required in order to call the function internally.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

133:         if (address(this).balance < withdrawAmount) {

134:             revert InsufficientBalance(withdrawAmount, address(this).balance);

```
*Github:* [[133](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L133), [134](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L134)]



<a name="GAS-41"></a> 
### [GAS-41] `abi.encodePacked` is more gas efficient than `abi.encode`
`abi.encode` pads all elementary types to 32 bytes, whereas `abi.encodePacked` will only use the minimal required memory to encode the data. See [here](https://docs.soliditylang.org/en/v0.8.11/abi-spec.html?highlight=encodepacked#non-standard-packed-mode) for more info.

<details>
<summary>
There are <b>13</b> instances (click to show):
</summary>

```solidity
File: src/MagicSpend/MagicSpend.sol

139:         context = abi.encode(maxCost, userOp.sender);

281:             abi.encode(

```
*Github:* [[139](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L139), [281](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L281)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

105:         owners[0] = abi.encode(address(0));

235:         return keccak256(abi.encode(UserOperationLib.hash(userOp), entryPoint()));

321:             return WebAuthn.verify({challenge: abi.encode(message), requireUV: false, webAuthnAuth: auth, x: x, y: y});

```
*Github:* [[105](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L105), [235](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L235), [321](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L321)]


```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

82:         salt = keccak256(abi.encode(owners, nonce));

```
*Github:* [[82](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L82)]


```solidity
File: src/SmartWallet/ERC1271.sol

103:             abi.encode(

134:         return keccak256(abi.encode(_MESSAGE_TYPEHASH, hash));

```
*Github:* [[103](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L103), [134](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/ERC1271.sol#L134)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

86:         _addOwner(abi.encode(owner));

94:         _addOwner(abi.encode(x, y));

118:         return _getMultiOwnableStorage().isOwner[abi.encode(account)];

128:         return _getMultiOwnableStorage().isOwner[abi.encode(x, y)];

```
*Github:* [[86](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L86), [94](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L94), [118](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L118), [128](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L128)]


```solidity
File: src/WebAuthnSol/WebAuthn.sol

149:         bytes memory args = abi.encode(messageHash, webAuthnAuth.r, webAuthnAuth.s, x, y);

```
*Github:* [[149](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L149)]


</details>


<a name="GAS-42"></a> 
### [GAS-42] Using bools for storage incurs overhead
Use uint256(1) and uint256(2) for true/false to avoid a Gwarmaccess (100 gas), and to avoid Gsset (20000 gas) when changing from ‘false’ to ‘true’, after having been ‘true’ in the past. See [source](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/58f635312aa21f947cae5f8578638a85aa2519f5/contracts/security/ReentrancyGuard.sol#L23-L27).

*There are <b>2</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

37:     mapping(uint256 nonce => mapping(address user => bool used)) internal _nonceUsed;

```
*Github:* [[37](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L37)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

24:     mapping(bytes account => bool isOwner_) isOwner;

```
*Github:* [[24](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L24)]



<a name="GAS-43"></a> 
### [GAS-43] Cache array length outside of loop
If not cached, the solidity compiler will always read the length of the array during each iteration. That is, if it is a storage array, this is an extra sload operation (100 additional extra gas for each iteration except for the first) and if it is a memory array, this is an extra mload operation (3 additional gas for each iteration except for the first).

*There are <b>2</b> instances of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

206:         for (uint256 i; i < calls.length;) {

```
*Github:* [[206](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L206)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

163:         for (uint256 i; i < owners.length; i++) {

```
*Github:* [[163](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L163)]



<a name="GAS-44"></a> 
### [GAS-44] Use `calldata` instead of `memory` for function arguments that do not get mutated
Mark data types as `calldata` instead of `memory` where possible. This makes it so that the data is not automatically loaded into memory. If the data passed into the function does not need to be changed (like updating values in an array), it can be passed in as `calldata`. The one exception to this is if the argument must later be passed into another function that takes an argument that specifies `memory` storage.

*There are <b>4</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

/// @audit make `withdrawRequest` as a calldata
181:     function withdraw(WithdrawRequest memory withdrawRequest) external {

/// @audit make `withdrawRequest` as a calldata
260:     function isValidWithdrawSignature(address account, WithdrawRequest memory withdrawRequest)

/// @audit make `withdrawRequest` as a calldata
279:     function getHash(address account, WithdrawRequest memory withdrawRequest) public view returns (bytes32) {

```
*Github:* [[181](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L181), [260](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L260), [279](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L279)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

/// @audit make `account` as a calldata
136:     function isOwnerBytes(bytes memory account) public view virtual returns (bool) {

```
*Github:* [[136](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L136)]



<a name="GAS-45"></a> 
### [GAS-45] Usage of `int`s/`uint`s smaller than 32 bytes incurs overhead
Using `int`s/`uint`s smaller than 32 bytes may cost more gas. This is because the EVM operates on 32 bytes at a time, so if an element is smaller than 32 bytes, the EVM must perform more operations to reduce the size of the element from 32 bytes to the desired size.

*There are <b>4</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

30:         uint48 expiry;

232:     function entryPointAddStake(uint256 amount, uint32 unstakeDelaySeconds) external payable onlyOwner {

```
*Github:* [[30](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L30), [232](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L232)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

302:             if (uint256(bytes32(ownerBytes)) > type(uint160).max) {

```
*Github:* [[302](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L302)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

168:             if (owners[i].length == 32 && uint256(bytes32(owners[i])) > type(uint160).max) {

```
*Github:* [[168](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L168)]



<a name="GAS-46"></a> 
### [GAS-46] Constructors can be marked as `payable` to save deployment gas
Payable functions cost less gas to execute, because the compiler does not have to add extra checks to ensure that no payment is provided. A constructor can be safely marked as payable, because only the deployer would be able to pass funds, and the project itself would not pass any funds.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

101:     constructor(address _owner) {

```
*Github:* [[101](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L101)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

102:     constructor() {

```
*Github:* [[102](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L102)]



<a name="GAS-47"></a> 
### [GAS-47] Functions guaranteed to revert when called by normal users can be marked `payable`
If a function modifier such as `onlyOwner` is used, the function will revert if a normal user tries to pay the function. Marking the function as `payable` will lower the gas cost for legitimate callers because the compiler will not include checks for whether a payment was provided.

<details>
<summary>
There are <b>13</b> instances (click to show):
</summary>

```solidity
File: src/MagicSpend/MagicSpend.sol

203:     function ownerWithdraw(address asset, address to, uint256 amount) external onlyOwner {

212:     function entryPointDeposit(uint256 amount) external payable onlyOwner {

222:     function entryPointWithdraw(address payable to, uint256 amount) external onlyOwner {

232:     function entryPointAddStake(uint256 amount, uint32 unstakeDelaySeconds) external payable onlyOwner {

239:     function entryPointUnlockStake() external onlyOwner {

248:     function entryPointWithdrawStake(address payable to) external onlyOwner {

```
*Github:* [[203](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L203), [212](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L212), [222](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L222), [232](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L232), [239](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L239), [248](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L248)]


```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

180:     function executeWithoutChainIdValidation(bytes calldata data) public payable virtual onlyEntryPoint {

196:     function execute(address target, uint256 value, bytes calldata data) public payable virtual onlyEntryPointOrOwner {

205:     function executeBatch(Call[] calldata calls) public payable virtual onlyEntryPointOrOwner {

330:     function _authorizeUpgrade(address) internal view virtual override(UUPSUpgradeable) onlyOwner {}

```
*Github:* [[180](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L180), [196](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L196), [205](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L205), [330](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L330)]


```solidity
File: src/SmartWallet/MultiOwnable.sol

85:     function addOwnerAddress(address owner) public virtual onlyOwner {

93:     function addOwnerPublicKey(bytes32 x, bytes32 y) public virtual onlyOwner {

102:     function removeOwnerAtIndex(uint256 index) public virtual onlyOwner {

```
*Github:* [[85](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L85), [93](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L93), [102](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L102)]


</details>


<a name="GAS-48"></a> 
### [GAS-48] `++i` costs less gas than `i++`, especially when it's used in `for`-loops (`--i`/`i--` too)
*Saves 5 gas per loop*

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/MultiOwnable.sol

163:         for (uint256 i; i < owners.length; i++) {

```
*Github:* [[163](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/MultiOwnable.sol#L163)]



<a name="GAS-49"></a> 
### [GAS-49] Using `private` rather than `public` for constants, saves gas
If needed, the values can be read from the verified contract source code, or if there are multiple values there can be a single getter function that [returns a tuple](https://github.com/code-423n4/2022-08-frax/blob/90f55a9ce4e25bceed3a74290b854341d8de6afa/src/contracts/FraxlendPair.sol#L156-L178) of the values of all currently-public constants. Saves **3406-3606 gas** in deployment gas due to the compiler not having to create non-payable getter functions for deployment calldata, not having to store the bytes of the value outside of where it's used, and not adding another entry to the method ID table

*There is one instance of this issue:*
```solidity
File: src/SmartWallet/CoinbaseSmartWallet.sol

43:     uint256 public constant REPLAYABLE_NONCE_KEY = 8453;

```
*Github:* [[43](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWallet.sol#L43)]



<a name="GAS-50"></a> 
### [GAS-50] Use assembly to check for `address(0)`
Saves 6 gas per instance.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

121:         if (withdrawRequest.asset != address(0)) {

335:         if (asset == address(0)) {

```
*Github:* [[121](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L121), [335](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L335)]



<a name="GAS-51"></a> 
### [GAS-51] `internal` functions not called by the contract should be removed
If the functions are required by an interface, the contract should inherit from that interface and use the `override` keyword

*There are <b>2</b> instances of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

50:     function ecdsa_verify(bytes32 message, uint256 r, uint256 s, uint256 Qx, uint256 Qy) internal view returns (bool) {

```
*Github:* [[50](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L50)]


```solidity
File: src/WebAuthnSol/WebAuthn.sol

104:     function verify(bytes memory challenge, bool requireUV, WebAuthnAuth memory webAuthnAuth, uint256 x, uint256 y)

```
*Github:* [[104](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L104)]



<a name="GAS-52"></a> 
### [GAS-52] Avoid updating storage when the value hasn't changed
In Ethereum, updating storage is costly in terms of gas. Therefore, it's beneficial to avoid redundant updates, particularly when the value being written is identical to the existing one. A comparison check before updating can prevent unnecessary operations, thus saving gas. The resolution could involve implementing a conditional check in your function to verify if the new value differs from the current one. If it's the same, the function could simply return without proceeding to the costly storage update. This simple adjustment in your code can lead to significant gas savings in scenarios where redundant updates might occur frequently.

*There are <b>3</b> instances of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

138:         _withdrawableETH[userOp.sender] += withdrawAmount - maxCost;

320:         _nonceUsed[withdrawRequest.nonce][account] = true;

```
*Github:* [[138](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L138), [320](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L320)]


```solidity
File: src/SmartWallet/CoinbaseSmartWalletFactory.sol

25:         implementation = erc4337;

```
*Github:* [[25](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/SmartWallet/CoinbaseSmartWalletFactory.sol#L25)]



<a name="GAS-53"></a> 
### [GAS-53] Cache address(this) when used more than once

*There is one instance of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

/// @audit `address(this)` is used more than once in this function
134:             revert InsufficientBalance(withdrawAmount, address(this).balance);

```
*Github:* [[134](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L134)]



<a name="GAS-54"></a> 
### [GAS-54] Where a value is casted more than once, consider caching the result to save gas
Casting values multiple times in Solidity can be gas-inefficient. When a value undergoes repeated type conversions, the EVM must execute additional operations for each cast, consuming more gas than necessary. To optimize for gas efficiency, cache the result of the initial cast in a local variable and reuse it, rather than performing multiple casts. This not only conserves gas but also enhances code readability, reducing potential error points. For example, instead of repeatedly casting an address to uint256, cast once, store the result in a local variable, and reference that variable in subsequent operations.

*There is one instance of this issue:*
```solidity
File: src/MagicSpend/MagicSpend.sol

/// @audit `address(this)` is casted more than once in this function
134:             revert InsufficientBalance(withdrawAmount, address(this).balance);

```
*Github:* [[134](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/MagicSpend/MagicSpend.sol#L134)]



<a name="GAS-55"></a> 
### [GAS-55] Consider not using libraries when implementing simple functionality.
When implementing certain functionalities in a smart contract, using libraries can sometimes incur additional costs compared to including the functionality directly within the contract. Libraries in Solidity are essentially contracts that get deployed separately and then linked to the main contract, so there's an overhead cost associated with calling them. If the functionality is relatively simple, this overhead can outweigh the benefits of code reuse and modularity provided by libraries. Thus, in such cases, implementing the functionality directly within the contract could be more gas-efficient. However, this approach should be balanced against considerations of code readability, maintainability, and the potential for code reuse.

*There are <b>2</b> instances of this issue:*
```solidity
File: src/FreshCryptoLib/FCL.sol

26: library FCL {

```
*Github:* [[26](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/FreshCryptoLib/FCL.sol#L26)]


```solidity
File: src/WebAuthnSol/WebAuthn.sol

18: library WebAuthn {

```
*Github:* [[18](https://github.com/code-423n4/2024-03-coinbase/blob/9ec85a7bccf41b9f320519a6f7b7960812edf7c9/src/WebAuthnSol/WebAuthn.sol#L18)]



